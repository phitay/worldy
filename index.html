<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Worldy</title>

    <link rel="icon" type="image/png" href="worldy1.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Nunito', 'sans-serif'],
                        hand: ['"Patrick Hand"', 'cursive']
                    },
                    colors: {
                        'app-gold': '#FFB800',
                        'app-dark': '#0a0a0a',
                        'app-gray': '#1E1E1E',
                    }
                }
            }
        }
    </script>

    <style>

        
        /* --- CODE MỚI: Áp dụng thanh cuộn đẹp cho TOÀN BỘ WEB --- */

        /* 1. Thiết lập kích thước cho toàn bộ thanh cuộn trên web */
        ::-webkit-scrollbar {
            width: 4px;  /* Độ rộng dọc */
            height: 4px; /* Độ cao ngang (nếu có) */
        }

        /* 2. Nền của thanh cuộn (để trong suốt) */
        ::-webkit-scrollbar-track {
            background: transparent; 
        }

        /* 3. Cái cục trượt (Thumb) */
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* Màu xám */
            border-radius: 10px; /* Bo tròn */
        }

        /* 4. Khi di chuột vào cục trượt */
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Sáng lên xíu */
        }

        /* --- CSS CHO MENU CHAT (Mới thêm) --- */
        .chat-menu {
            position: absolute;
            top: 100%; /* Hiện ngay dưới bong bóng chat */
            z-index: 50;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            min-width: 100px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none; /* Mặc định ẩn */
        }
        /* Hiển thị menu khi có class 'block' */
        .chat-menu.show {
            display: flex;
        }
        .chat-menu button {
            text-align: left;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: bold;
            color: #d1d5db;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .chat-menu button:hover {
            background-color: #374151;
            color: white;
        }
        .chat-menu button.delete-btn:hover {
            color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        /* Style cho input khi sửa tin nhắn */
        .chat-edit-input {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            width: 100%;
            font-size: 13px;
            outline: none;
        }

        /* --- CSS CHO MENU BÌNH LUẬN --- */
        .comment-menu {
            position: absolute;
            right: 0;
            top: 24px;
            background: #1f2937; /* Gray-800 */
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            z-index: 50;
            min-width: 100px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .comment-menu button {
            text-align: left;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: bold;
            color: #d1d5db;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .comment-menu button:hover {
            background-color: #374151;
            color: white;
        }
        .comment-menu button.delete-btn:hover {
            color: #ef4444; /* Red */
            background-color: rgba(239, 68, 68, 0.1);
        }
        .edit-input-wrapper {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        /* Hiệu ứng nháy sáng cho tin nhắn được chọn */
        /* Hiệu ứng nháy sáng cho tin nhắn - PHIÊN BẢN CẬP NHẬT */
        /* Hiệu ứng nháy sáng tin nhắn - UPDATE 30 GIÂY */
    
        
        /* Style cho text được tag */
        .mention-tag {
            color: #60A5FA; /* Màu xanh dương */
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mention-tag:hover {
            text-decoration: underline;
            color: #93C5FD;
        }

        /* Highlight khi tìm kiếm */
        /* Hiệu ứng highlight tìm kiếm */
        .search-highlight {
            background-color: #FFD700; /* Màu vàng */
            color: black;
            font-weight: bold;
            border-radius: 2px;
            padding: 0 2px;
        }

        /* Hiệu ứng khi đang chọn (Active) - Màu cam đậm hơn */
        .search-highlight.active {
            background-color: #FF4500; /* Màu cam đỏ */
            color: white;
            box-shadow: 0 0 10px rgba(255, 69, 0, 0.8);
            transform: scale(1.1); /* Phóng to nhẹ */
            display: inline-block;
        }
        
        /* Hiệu ứng nháy ĐỎ cho bình luận phản hồi */
        @keyframes highlight-pulse-red {
            0% { background-color: rgba(239, 68, 68, 0.4); border-color: #EF4444; transform: scale(1.02); }
            50% { background-color: rgba(239, 68, 68, 0.15); }
            100% { background-color: transparent; border-color: transparent; transform: scale(1); }
        }
        .comment-highlight-red {
            animation: highlight-pulse-red 2s ease-out forwards;
            border: 1px solid #EF4444;
            border-radius: 16px;
            transition: all 0.3s;
        }

        /* Hiệu ứng nháy sáng cho bình luận */
        @keyframes highlight-pulse {
            0% { background-color: rgba(255, 184, 0, 0.5); border-color: #FFB800; transform: scale(1.02); }
            50% { background-color: rgba(255, 184, 0, 0.2); }
            100% { background-color: transparent; border-color: transparent; transform: scale(1); }
        }
        .comment-highlight {
            animation: highlight-pulse 2s ease-out forwards;
            border: 1px solid #FFB800;
            border-radius: 16px;
            transition: all 0.3s;
        }
        /* --- DYNAMIC BACKGROUND --- */
        body {
            background-color: #000;
            background-image: 
                radial-gradient(at 0% 0%, rgba(76, 29, 149, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(255, 184, 0, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.05) 0px, transparent 50%);
            background-attachment: fixed;
            color: white;
            -webkit-tap-highlight-color: transparent;
            animation: bg-pulse 10s ease-in-out infinite alternate;
        }

        @keyframes bg-pulse {
            0% { background-size: 100% 100%; }
            100% { background-size: 110% 110%; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #cameraInput, #avatarInput { display: none; }
        
        .hidden-input { 
            position: absolute; 
            width: 1px; 
            height: 1px; 
            padding: 0; 
            margin: -1px; 
            overflow: hidden; 
            clip: rect(0,0,0,0); 
            border: 0; 
        }
        
        .glass {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Animations */
        button, input, select, .cursor-pointer, .transition-all { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        button:active { transform: scale(0.95); }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.4s ease-out forwards; }
        @keyframes zoom-in-soft { 0% { opacity: 0; transform: scale(0.92) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .animate-zoom-in { animation: zoom-in-soft 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        
        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .heart-animate { animation: heart-beat 0.3s ease-in-out; }

        /* Double Tap Heart Animation */
        @keyframes heart-popup {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            60% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        .double-tap-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: rgba(255, 255, 255, 0.9);
            animation: heart-popup 0.8s ease-out forwards;
            pointer-events: none;
            z-index: 20;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }

        /* Map Styles */
        .continent-path { fill: #2C2C2E; stroke: #444; stroke-width: 1.5; transition: all 0.3s ease; cursor: pointer; }
        .continent-group:hover .continent-path { fill: #3a3a3c; stroke: #FFB800; stroke-width: 2; filter: drop-shadow(0 0 8px rgba(255, 184, 0, 0.2)); }
        .map-pin { fill: #666; transition: all 0.3s ease; pointer-events: none; }
        .continent-group:hover .map-pin { fill: #FFB800; transform: translateY(-5px); }
        .map-label { font-size: 14px; fill: #888; font-weight: bold; text-anchor: middle; pointer-events: none; opacity: 0.7; transition: all 0.3s; }
        .continent-group:hover .map-label { opacity: 1; fill: white; font-size: 16px; }

        .color-radio:checked + label { transform: scale(1.2); border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* Audio Visualizer Effect */
        /* Hiệu ứng mặc định: TẮT (Ẩn đi và không chạy animation) */
        .audio-pulse {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 2px solid #FFB800;
            opacity: 0;           /* Ẩn đi khi chưa hát */
            animation: none;      /* Tắt chuyển động */
            transition: opacity 0.3s;
        }

        /* Khi wrapper có class 'is-playing' -> BẬT hiệu ứng */
        .is-playing .audio-pulse {
            opacity: 1;
            animation: pulse-ring 2s infinite;
        }

        /* Icon nhạc: Mặc định đứng yên */
        .music-icon {
            transform: scale(1);
            transition: transform 0.3s;
        }
        
        /* Icon nhạc: Khi hát thì nhảy (Bounce) */
        .is-playing .music-icon {
            animation: heart-beat 1s infinite; /* Tận dụng animation heart-beat có sẵn cho nảy */
        }

        /* Giữ nguyên keyframes pulse-ring cũ ở dưới... */
        .audio-pulse:nth-child(2) { animation-delay: 0.5s; }
        .audio-pulse:nth-child(3) { animation-delay: 1s; }
        
        @keyframes pulse-ring {
            0% { width: 100px; height: 100px; opacity: 0.8; }
            100% { width: 200px; height: 200px; opacity: 0; }
        }

        .play-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .paused .play-overlay, .ended .play-overlay { opacity: 1; }
        
        .ai-disabled { opacity: 0.3; cursor: not-allowed; pointer-events: auto !important; }

        #feedList.grid-view, 
        #friendFeedList.grid-view { /* <--- THÊM DÒNG NÀY */
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding-bottom: 80px;
        }

        /* Đảm bảo tất cả các thẻ chứa ảnh/video trong grid đều nhận bo góc */
        /* Áp dụng cho Grid Profile người khác và Profile của mình */
        #publicPostsGrid, #userPostsGrid {
            gap: 8px; /* Khoảng cách giữa các ô cho thoáng giống Friendzone */
        }

        #publicPostsGrid .post-card, 
        #userPostsGrid > div {
            border-radius: 8px !important; /* Bo cong 8px */
            overflow: hidden !important;   /* Cắt nội dung tràn góc */
            transform: translateZ(0);      /* Sửa lỗi hiển thị bo góc trên một số trình duyệt di động */
        }

        /* Đảm bảo ảnh/video bên trong bo theo cha */
        #publicPostsGrid img, #publicPostsGrid video,
        #userPostsGrid img, #userPostsGrid video {
            border-radius: inherit !important;
            object-fit: cover;
        }
        /* --- NEON LOGIN BACKGROUND (SMOOTH VERSION) --- */
        .neon-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px); /* Độ nhòe cao để tạo độ mềm */
            opacity: 0.6;
            will-change: transform; /* Giúp mượt mà về hiệu năng */
            mix-blend-mode: screen; /* Giúp màu hòa trộn đẹp hơn */
        }
        
        /* Animation mới: Trôi rộng hơn, xoay nhẹ, timeline chia đều */
        @keyframes float-smooth {
            0% { 
                transform: translate(0, 0) scale(1) rotate(0deg); 
            }
            33% { 
                /* Di chuyển xa hơn (80px) để tạo cảm giác trôi */
                transform: translate(80px, -50px) scale(1.1) rotate(20deg); 
            }
            66% { 
                transform: translate(-40px, 40px) scale(0.9) rotate(-10deg); 
            }
            100% { 
                transform: translate(0, 0) scale(1) rotate(0deg); 
            }
        }

        /* Hiệu ứng kính mờ cho form đăng nhập để nhìn xuyên thấu neon */
        .login-glass {
            background: rgba(20, 20, 20, 0.4); /* Màu đen trong suốt */
            backdrop-filter: blur(20px);      /* Làm mờ hậu cảnh */
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* --- HIỆU ỨNG NỀN CHUYỂN ĐỘNG (TỐI ƯU) --- */
        /* --- SỬA LẠI: HIỆU ỨNG NEON NGẬP TRÀN & TRẺ TRUNG --- */
        /* --- HIỆU ỨNG GRAVITY / FLOATING STREET STYLE --- */
        /* --- HIỆU ỨNG GRAVITY CORE: TẬP TRUNG TẠI TÂM --- */
        /* --- SỬA LỖI: CHỈ TRÔI MÀU, KHÔNG ZOOM KHUNG --- */
        /* --- HIỆU ỨNG CHAOS RIBBON: DẢI BĂNG HỖN LOẠN --- */
        /* --- HIỆU ỨNG CHAOS CORE (TÂM HỖN LOẠN) --- */
        /* --- HIỆU ỨNG DÒNG NƯỚC LỮNG LỜ (WATER TIDE) --- */
        /* --- HIỆU ỨNG NEBULA MORPHING (TINH VÂN BIẾN ẢO) --- */
        /* --- HIỆU ỨNG LIQUID MORPHING (CHẤT LỎNG BIẾN HÌNH) --- */
        /* --- HIỆU ỨNG HAI CỰC VA CHẠM (DUAL POLE COLLISION) --- */
        /* --- HIỆU ỨNG GIAO THOA SÓNG ĐẬP (HIGH-INTENSITY WAVE COLLISION) --- */
        /* --- HIỆU ỨNG GIAO THOA SÓNG TỪ 2 TỤ (DUAL-SOURCE INTERFERENCE) --- */
        /* --- HIỆU ỨNG IOS DYNAMIC GRADIENT (ORGANIC FLOW) --- */



        @keyframes ios-gradient-flow {
            0% {
                background-position: 0% 50%, 100% 50%, 50% 0%;
            }
            33% {
                background-position: 10% 40%, 90% 60%, 40% 10%;
            }
            66% {
                background-position: 50% 10%, 60% 90%, 10% 40%;
            }
            100% {
                background-position: 0% 50%, 100% 50%, 50% 0%;
            }
        }

        .animated-neon-bg {
            /* Quan trọng: Phóng to background để các khối màu hòa quyện mịn màng */
            background-size: 200% 200% !important;
            background-attachment: fixed;
            
            /* Chuyển động cực chậm và mượt (20 giây) để tạo cảm giác sang trọng */
            animation: ios-gradient-flow 20s ease-in-out infinite;
            
            /* Loại bỏ hoàn toàn các filter gây nhiễu chữ */
            will-change: background-position;
            transform: none !important;
        }

        /* Tối ưu hóa cho di động */
        @media (max-width: 768px) {
            #notifModal .w-full {
                max-width: 100% !important;
                border-radius: 0 !important; /* Phẳng hoàn toàn trên mobile để tạo cảm giác App chuyên nghiệp */
                height: 100% !important;
                margin-top: 0 !important;
            }

            /* Làm cho các mục thông báo trông giống các thẻ (cards) */
            #notifList .flex {
                margin: 8px 12px;
                border-radius: 18px !important;
                padding: 12px !important;
                background: rgba(255, 255, 255, 0.03); /* Nền cực nhẹ để tách biệt các thông báo */
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            #notifList .flex.bg-app-gold\/5 {
                background: rgba(255, 184, 0, 0.08) !important;
                border: 1px solid rgba(255, 184, 0, 0.2) !important;
            }

            /* Thu nhỏ avatar một chút trên mobile để dành chỗ cho văn bản */
            #notifList img, #notifList .w-9 {
                width: 42px !important;
                height: 42px !important;
            }

            /* Header thông báo cố định để dễ thao tác */
            #notifModal header {
                padding-top: env(safe-area-inset-top); /* Tránh tai thỏ trên iPhone */
            }
        }

        /* Giữ nguyên phong cách Desktop (như file gốc của bạn đã có modal max-w-md) */
        @media (min-width: 769px) {
            #notifModal .w-full {
                margin-top: 2rem !important;
                height: 80vh !important;
            }
        }

        /* Hiệu ứng cho bảng luật lệ */
        .rules-card {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 184, 0, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform-origin: top right;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .rules-card.hidden {
            opacity: 0;
            transform: scale(0.8) translateY(-10px);
            pointer-events: none;
        }

        /* Hiệu ứng bong bóng chat */
        .message-bubble {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 13px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .msg-me {
            background: #2563EB; /* Màu xanh của messenger */
            color: white;
            border-bottom-right-radius: 4px;
            margin-left: auto; /* Đẩy sang phải */
        }

        .msg-friend {
            background: #374151; /* Màu xám */
            color: white;
            border-bottom-left-radius: 4px;
            margin-right: auto; /* Đẩy sang trái */
        }

        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes msg-flash-perfect {
            0% { background-color: transparent; box-shadow: 0 0 0 0 transparent; }
            15% { background-color: rgba(255, 184, 0, 0.4); box-shadow: 0 0 25px 10px rgba(255, 184, 0, 0.7); border: 2px solid #FFB800 !important; }
            85% { background-color: rgba(255, 184, 0, 0.2); box-shadow: 0 0 15px 5px rgba(255, 184, 0, 0.4); border: 2px solid #FFB800 !important; }
            100% { background-color: transparent; box-shadow: 0 0 0 0 transparent; }
        }

        .msg-highlight-active {
            animation: msg-flash-perfect 15s ease-in-out forwards !important;
            position: relative;
            z-index: 100;
        }

        /* Style cho Tag trong Chat */
        .chat-mention {
            color: #60A5FA; /* Màu xanh dương sáng */
            font-weight: 800;
            background: rgba(37, 99, 235, 0.1);
            padding: 0 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        .chat-mention:hover {
            text-decoration: underline;
            background: rgba(37, 99, 235, 0.2);
        }

        /* --- BỔ SUNG CSS GRID CHO FRIEND ZONE --- */

        /* 1. Thiết lập lưới 3 cột cho Friend Zone */
       /* Gộp lại thành một và thêm các thuộc tính hỗ trợ viền màu */
        

        /* ÉP TẤT CẢ CÁC Ô TRONG FRIEND ZONE GRID PHẢI HIỆN VIỀN */
        /* Đảm bảo item trong Friendzone Grid hiển thị viền chuẩn */
        /* Gộp lại thành 1 đoạn duy nhất để không bị ghi đè lẫn nhau */
        /* 2. Thiết lập cho từng ô vuông */
        #friendFeedList.grid-view .post-card {
            aspect-ratio: 1/1 !important;
            margin: 0 !important;
            position: relative;
            background: #1a1a1a;
            border-radius: 8px !important; /* Bo góc cho đẹp */
            
            /* QUAN TRỌNG: Thiết lập để nhận border từ JS */
            box-sizing: border-box !important;
            border-width: 2px !important;
            border-style: solid !important;
            
            /* Xóa bỏ dòng border: none cũ nếu có */
        }
        /* Đảm bảo danh sách có khoảng cách để thấy hiệu ứng phát sáng */
     

        /* 3. ẨN TẤT CẢ thông tin thừa (Header, Caption, Nút Like, Ngày giờ...) */
        #friendFeedList.grid-view .post-header,    /* Avatar + Tên */
        #friendFeedList.grid-view .post-caption,   /* Caption (Status) */
        #friendFeedList.grid-view .post-actions,   /* Nút Tim, Comment */
        #friendFeedList.grid-view .post-time,      /* Thời gian */
        #friendFeedList.grid-view .post-footer {   /* Chân trang nếu có */
            display: none !important;
        }

        /* 4. Chỉnh ảnh/video full ô vuông */
        #friendFeedList.grid-view .post-image-container,
        #friendFeedList.grid-view .image-slider,
        #friendFeedList.grid-view .swiper,
        #friendFeedList.grid-view .swiper-wrapper,
        #friendFeedList.grid-view .swiper-slide {
            height: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        #friendFeedList.grid-view img,
        #friendFeedList.grid-view video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; /* Cắt ảnh vừa khung, không bị méo */
            border-radius: 0 !important;
        }

        /* 5. Xử lý trường hợp bài viết chỉ có chữ (không có ảnh) trong chế độ Grid */
        /* Hiện chữ nhỏ ở giữa nếu không có ảnh */
        #friendFeedList.grid-view .post-card:not(:has(img)):not(:has(video)) {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            padding: 5px;
        }

        #friendFeedList.grid-view .post-card:not(:has(img)):not(:has(video)) .post-caption {
            display: -webkit-box !important; /* Hiện lại caption nhưng giới hạn dòng */
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-align: center;
            font-size: 10px;
            color: #fff;
            margin: 0 !important;
        }

        /* --- FIX LỖI TAI THỎ IPHONE (SAFARI) --- */
        /* Class này sẽ tự động cộng thêm padding tương ứng với kích thước tai thỏ */
        /* --- CHỈ ÁP DỤNG TRÊN IOS (IPHONE/IPAD - SAFARI) --- */
        @supports (-webkit-touch-callout: none) {
            
            /* 1. Đẩy nội dung xuống để tránh Tai Thỏ cho tất cả cửa sổ full màn hình */
            :is(
                
                #loadingScreen, #authScreen, #uploadOverlay, #mediaOptionsModal,
                #mapModal, #commentModal, #notifModal, #likesModal, 
                #singlePostModal, #miniPreviewModal, #profileModal, #publicProfileModal, 
                #settingsModal, #confirmModal, #phitayAuthModal, #userInfoModal, 
                #chatModal, #chatSettingsModal, #chatArchiveModal, #friendZoneMediaOptions, 
                #friendDecisionModal, #searchModal, #friendZoneModal, #friendZoneAlbumModal, 
                #friendListModal, #friendZoneUploadOverlay, #audienceModal, #fzSearchModal, 
                #fzNotifModal, #msgNotifModal, #createGroupModal, #groupSettingsModal, 
                #seenByModal, #simpleFriendListModal, #deleteConfirmModal
            ) {
                padding-top: env(safe-area-inset-top) !important;
                padding-bottom: env(safe-area-inset-bottom) !important;
                height: 100% !important; 
                box-sizing: border-box !important;
            }

            /* 2. Dời nút X (đóng) xuống thấp hơn để không bị Tai Thỏ che */
            
            /* Nhóm nút có class top-6 (cách lề 1.5rem) -> Cộng thêm chiều cao tai thỏ */
            :is(
                #uploadOverlay, #mapModal, #commentModal, #likesModal, #singlePostModal, 
                #miniPreviewModal, #profileModal, #publicProfileModal, #userInfoModal, 
                #searchModal, #friendListModal, #friendZoneUploadOverlay, #fzSearchModal, 
                #msgNotifModal, #seenByModal
            ) .absolute.top-6 {
                top: calc(1.5rem + env(safe-area-inset-top)) !important;
            }

            /* Nhóm nút có class top-4 (cách lề 1rem) -> Cộng thêm chiều cao tai thỏ */
            :is(
                #notifModal, #settingsModal, #friendDecisionModal, 
                #fzNotifModal, #simpleFriendListModal, #groupSettingsModal
            ) .absolute.top-4 {
                top: calc(1rem + env(safe-area-inset-top)) !important;
            }

            /* 3. Xử lý riêng cho Header của Chat và FriendZone (dạng thanh ngang) */
            #chatModal > div > div:first-child, 
            #friendZoneModal header {
                padding-top: calc(10px + env(safe-area-inset-top)) !important;
                height: auto !important;
                align-items: flex-end !important; /* Căn nút xuống dưới */
                padding-bottom: 10px !important;
            }
        }

        /* --- HIỆU ỨNG VIỀN CHẠY (DATA FLOW) --- */
        /* --- 1. HIỆU ỨNG VIỀN CHẠY (DATA FLOW) --- */
        @keyframes dash-flow {
            to { stroke-dashoffset: -20; }
        }

        .dynamic-border {
            animation: dash-flow 1s linear infinite;
            /* Shadow nhẹ cho viền ở trạng thái bình thường */
            filter: drop-shadow(0 0 2px #FFB800); 
        }

        /* --- 2. HIỆU ỨNG CHỮ (SỬA LỖI FONT TIẾNG VIỆT) --- */
        @keyframes text-pulse {
            0% { opacity: 0.8; text-shadow: 0 0 2px black; }
            50% { opacity: 1; text-shadow: 0 0 10px #FFB800; }
            100% { opacity: 0.8; text-shadow: 0 0 2px black; }
        }

        .continent-label-tech {
            /* QUAN TRỌNG: Dùng Nunito để hỗ trợ tiếng Việt tuyệt đối */
            font-family: 'Nunito', sans-serif; 
            font-weight: 800; /* Nét rất đậm để dễ đọc trên nền tối */
            text-transform: uppercase;
            font-size: 10px; /* Chữ nhỏ gọn tinh tế */
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            
            /* Căn giữa tuyệt đối */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            
            /* Animation */
            animation: text-pulse 3s infinite ease-in-out;
            pointer-events: none; /* Để chuột xuyên qua chữ bấm được vào hình */
        }

        /* --- BẮT ĐẦU STYLE MỚI CHO FRIENDZONE --- */
        /* --- PHONG CÁCH MÁY ẢNH RETRO --- */
        /* --- BẮT ĐẦU STYLE CAMERA CÓ HIỆU ỨNG ĐỘNG --- */

        /* --- PHONG CÁCH MÁY ẢNH (DARK MODE - ĐỠ RỐI) --- */

        /* --- PHONG CÁCH MÁY ẢNH (DARK GREY - PREMIUM) --- */

        /* 1. Animation Nhiễu hạt (Giữ nguyên) */
        @keyframes grain-move {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -10%); }
            20% { transform: translate(-15%, 5%); }
            30% { transform: translate(7%, -25%); }
            40% { transform: translate(-5%, 25%); }
            50% { transform: translate(-15%, 10%); }
            60% { transform: translate(15%, 0%); }
            70% { transform: translate(0%, 15%); }
            80% { transform: translate(3%, 35%); }
            90% { transform: translate(-10%, 10%); }
        }

        /* [MỚI] Animation chỉ nháy màu chữ REC (Để không làm nhấp nháy 4 cái khung) */
        @keyframes blink-text-only {
            0%, 100% { color: rgba(255, 77, 77, 0.8); }
            50% { color: rgba(255, 77, 77, 0); }
        }

        /* 2. Style chính - Chỉ còn màu nền (Đã dọn sạch các góc) */
        .camera-art-bg {
            background-color: #181818; /* Màu xám đen than chì */
            position: relative;
            overflow: hidden;
            /* Đã xóa 4 góc ở đây để chuyển lên trên */
            z-index: 1;
        }

        /* 3. Lớp nhiễu hạt (Noise) - Giữ nguyên */
        .camera-art-bg::before {
            content: "";
            position: absolute;
            top: -100%; left: -100%; width: 300%; height: 300%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
            opacity: 0.04;
            animation: grain-move 0.5s steps(6) infinite;
            pointer-events: none;
            z-index: -1; 
        }

        /* 4. Scanlines & REC & 4 GÓC CAMERA (Gộp hết vào đây để nổi lên trên) */
        .camera-art-bg::after {
            content: "● REC  [00:00:12]";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; /* Phủ kín để vẽ khung */
            
            /* Cấu hình chữ REC */
            color: rgba(255, 77, 77, 0.8);
            font-family: monospace;
            font-weight: bold;
            font-size: 12px;
            display: flex; justify-content: flex-end; align-items: flex-start;
            padding-top: 25px; padding-right: 30px;
            box-sizing: border-box;
            
            /* Animation mới: Chỉ nháy chữ, KHÔNG nháy khung */
            animation: blink-text-only 2s infinite; 
            
            pointer-events: none; /* Cho phép click xuyên qua vào bài viết */
            z-index: 100; /* Đẩy lên cao hẳn để nổi trên bài viết (ngang hàng REC) */
            
            /* --- VẼ 4 GÓC CAMERA & SCANLINES TẠI ĐÂY --- */
            background-image:
                /* 4 Góc khung ngắm (Đưa từ dưới lên đây) */
                linear-gradient(to right, rgba(255,255,255,0.15) 2px, transparent 2px),
                linear-gradient(to bottom, rgba(255,255,255,0.15) 2px, transparent 2px),
                
                linear-gradient(to left, rgba(255,255,255,0.15) 2px, transparent 2px),
                linear-gradient(to bottom, rgba(255,255,255,0.15) 2px, transparent 2px),
                
                linear-gradient(to right, rgba(255,255,255,0.15) 2px, transparent 2px),
                linear-gradient(to top, rgba(255,255,255,0.15) 2px, transparent 2px),
                
                linear-gradient(to left, rgba(255,255,255,0.15) 2px, transparent 2px),
                linear-gradient(to top, rgba(255,255,255,0.15) 2px, transparent 2px),

                /* Scanlines (Giữ nguyên) */
                repeating-linear-gradient(
                    0deg,
                    rgba(0,0,0,0.2), 
                    rgba(0,0,0,0.2) 1px,
                    transparent 1px,
                    transparent 2px
                );
            
            /* Vị trí cho 4 góc và scanlines */
            background-position:
                20px 20px, 20px 20px,
                calc(100% - 20px) 20px, calc(100% - 20px) 20px,
                20px calc(100% - 20px), 20px calc(100% - 20px),
                calc(100% - 20px) calc(100% - 20px), calc(100% - 20px) calc(100% - 20px),
                0 0; /* Vị trí scanlines */
                
            background-size:
                30px 30px, 30px 30px,
                30px 30px, 30px 30px,
                30px 30px, 30px 30px,
                30px 30px, 30px 30px,
                100% 100%; /* Size scanlines */
                
            background-repeat: no-repeat;
        }

        /* --- KẾT THÚC STYLE MỚI --- */

        /* --- HIỆU ỨNG KÍNH NHÁM (FROSTED MATTE) --- */
        .glass-matte {
            /* Màu nền: Xám trắng rất nhạt và trong suốt */
            background: rgba(255, 255, 255, 0.03);
            
            /* Làm mờ hậu cảnh (Blur) */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            
            /* Viền: Mỏng và mờ, không sáng bóng */
            border: 1px solid rgba(255, 255, 255, 0.1);
            
            /* Đổ bóng nhẹ để tách lớp */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            position: relative;
            z-index: 10;
        }

        /* Lớp phủ tạo độ "NHÁM" (Texture) */
        .glass-matte::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            
            /* Sử dụng SVG noise để tạo hạt mịn */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
            
            opacity: 0.12; /* Điều chỉnh độ NHÁM tại đây (cao hơn = nhám hơn) */
            mix-blend-mode: overlay; /* Hòa trộn hạt vào nền kính */
            pointer-events: none; /* Không chặn click chuột */
            border-radius: inherit; /* Bo góc theo khung bài viết */
            z-index: -1;
        }

        /* --- HIỆU ỨNG VIỀN KIM TUYẾN LẤP LÁNH (GLITTER BORDER) --- */

        /* 1. Animation ánh sáng chạy qua viền */
        /* --- HIỆU ỨNG VIỀN LẤP LÁNH (GIỮ NGUYÊN MÀU GỐC) --- */

        /* --- HIỆU ỨNG KIM TUYẾN ĂN THEO MÀU VIỀN CÓ SẴN --- */

        @keyframes glitter-move {
            0% { background-position: 0% 0%; opacity: 0.8; }
            50% { opacity: 1; }
            100% { background-position: 200% 0%; opacity: 0.8; }
        }

        /* Class này chỉ tạo hiệu ứng, không quy định màu hay độ dày viền */
        .frame-glitter-effect {
            position: relative;
            /* Border thật sự sẽ do JS set (style="border:...") */
        }

        .frame-glitter-effect::after {
            content: "";
            position: absolute;
            /* Phủ trùm lên viền 2px của bài viết */
            inset: -2px; 
            border-radius: inherit; /* Bo góc theo bài viết */
            padding: 2px; /* Độ dày khớp với viền thật */
            
            /* Tạo hiệu ứng kim tuyến: Các vệt sáng trắng sắc nét chạy qua */
            background: linear-gradient(
                110deg, 
                transparent 25%, 
                rgba(255, 255, 255, 0.7) 45%, /* Hạt kim tuyến sáng */
                rgba(255, 255, 255, 1) 50%,   /* Điểm sáng nhất */
                rgba(255, 255, 255, 0.7) 55%, 
                transparent 75%
            );
            
            background-size: 200% 100%;
            animation: glitter-move 3s linear infinite;
            
            /* CẮT BỎ PHẦN GIỮA, CHỈ HIỂN THỊ TRÊN VIỀN */
            -webkit-mask: 
                linear-gradient(#fff 0 0) content-box, 
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            
            pointer-events: none;
            z-index: 20;

            /* QUAN TRỌNG: Chế độ hòa trộn làm viền màu phát sáng lấp lánh */
            /* Dùng 'screen' hoặc 'plus-lighter' để làm sáng màu nền bên dưới */
            mix-blend-mode: screen; 
        }


/* --- 3. LAYER PHITAY --- */
.leaflet-marker-pane { z-index: 600; }

    </style>
</head>
<body class="h-[100dvh] w-full flex flex-col items-center justify-center overflow-hidden 
             pt-[env(safe-area-inset-top)] 
             pb-[env(safe-area-inset-bottom)]">


    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-10 left-1/2 transform -translate-x-1/2 z-[999] flex items-center gap-3 bg-gray-900/90 backdrop-blur-md border border-white/10 text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 opacity-0 -translate-y-10 pointer-events-none">
        <i class="fa-solid fa-check-circle text-app-gold text-lg"></i>
        <span id="toastMessage" class="font-bold text-sm">Thông báo</span>
    </div>

    <div id="loadingScreen" class="fixed inset-0 z-[100] flex items-center justify-center bg-black transition-opacity duration-500">
        <div class="text-center w-3/4 max-w-md animate-zoom-in">
            <div class="text-app-gold text-6xl font-bold mb-6 animate-bounce">
                <i class="fa-solid fa-earth-americas"></i>
            </div>
            <p class="text-gray-400 font-bold tracking-widest text-xs uppercase mb-2" id="loadingText">Connecting...</p>
            <p class="text-red-500 text-sm font-bold hidden" id="configErrorMsg"></p>
        </div>
    </div>

    <div id="authScreen" class="fixed inset-0 z-[90] flex flex-col items-center justify-center bg-black p-6 hidden overflow-hidden">
        
        <div class="neon-blob bg-app-gold w-72 h-72 top-0 -left-20" 
             style="animation: float-smooth 20s infinite ease-in-out;"></div>
        
        <div class="neon-blob bg-purple-600 w-96 h-96 bottom-0 -right-20" 
             style="animation: float-smooth 25s infinite ease-in-out reverse;"></div>
        
        <div class="w-full max-w-sm relative animate-zoom-in z-10 login-glass rounded-3xl p-8">
            <div class="text-center mb-8 mt-2">
                <h1 class="text-app-gold text-5xl font-black mb-2 tracking-tighter drop-shadow-lg" style="text-shadow: 0 0 20px rgba(255,184,0,0.5);">WORLDY</h1>
                <p class="text-gray-300 font-medium text-sm tracking-wide" data-lang="auth_slogan">Chia sẻ khoảnh khắc toàn cầu</p>
            </div>

            <div id="loginForm" class="space-y-5">
                <div class="relative group">
                    <input type="text" id="loginUsername" 
                        maxlength="15" 
                        oninput="this.value = this.value.replace(/\s/g, '')" 
                        placeholder="Tên đăng nhập" 
                        autocapitalize="none" 
                        class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 pl-5 text-white focus:border-app-gold focus:bg-black/60 focus:ring-1 outline-none transition-all placeholder-gray-500 font-bold">
                    <i class="fa-solid fa-user absolute right-5 top-1/2 -translate-y-1/2 text-gray-500 group-hover:text-app-gold transition-colors"></i>
                </div>

                <div class="relative group">
                    <input type="password" id="loginPassword" placeholder="Mật khẩu" class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 pl-5 pr-12 text-white focus:border-app-gold focus:bg-black/60 focus:ring-1 outline-none transition-all placeholder-gray-500 font-bold">
                    <button onclick="togglePassword('loginPassword', this)" type="button" class="absolute right-0 top-0 h-full px-5 text-gray-500 hover:text-white transition-colors"><i class="fa-solid fa-eye"></i></button>
                </div>
                
                <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-app-gold to-yellow-600 text-black font-extrabold py-4 rounded-2xl hover:scale-[1.02] hover:shadow-[0_0_20px_rgba(255,184,0,0.4)] transition-all mt-6 shadow-lg" data-lang="btn_login">ĐĂNG NHẬP</button>
                
                <button id="guestLoginBtn" onclick="handleGuestLogin()" class="w-full bg-white/5 border border-white/10 text-gray-300 font-bold py-4 rounded-2xl hover:bg-white/10 hover:text-white transition-all flex items-center justify-center gap-2 backdrop-blur-md">
                    <i class="fa-solid fa-user-secret"></i> <span data-lang="btn_guest">Dùng ngay (Khách)</span>
                </button>
                
                <p class="text-gray-400 text-sm mt-6 cursor-pointer hover:text-white text-center transition-colors select-none" onclick="toggleAuthMode('register')">
                    <span data-lang="no_account">Chưa có nick?</span> <span class="text-app-gold font-bold underline decoration-2 underline-offset-4" data-lang="link_register">Đăng ký ngay</span>
                </p>
                <p class="text-center text-[10px] text-gray-500 italic mt-2 opacity-70">
                    * Web tối ưu hơn trên máy tính
                </p>
            </div>    

            <div id="registerForm" class="space-y-5 hidden relative">
                <div class="flex justify-end">
                    <button onclick="toggleRules()" type="button" class="text-[10px] font-bold text-app-gold border border-app-gold/30 px-2 py-1 rounded-lg hover:bg-app-gold/10 transition-all">
                        <i class="fa-solid fa-circle-info mr-1"></i> LUẬT ĐẶT TÊN
                    </button>
                </div>

                <div id="namingRules" class="rules-card hidden absolute top-10 right-0 left-0 z-[60] p-5 rounded-2xl animate-zoom-in">
                    <h4 class="text-app-gold font-black text-xs uppercase tracking-widest mb-3 flex items-center">
                        <i class="fa-solid fa-shield-halved mr-2"></i> Quy định tài khoản
                    </h4>
                    <ul class="space-y-3">
                        <li class="flex items-start gap-3">
                            <div class="w-5 h-5 rounded-full bg-app-gold/20 flex items-center justify-center shrink-0 mt-0.5">
                                <span class="text-[10px] font-bold text-app-gold">1</span>
                            </div>
                            <p class="text-[11px] text-gray-300"><b>Tên hiển thị:</b> Tối đa <b>9 ký tự</b> (có thể có dấu).</p>
                        </li>
                        <li class="flex items-start gap-3">
                            <div class="w-5 h-5 rounded-full bg-app-gold/20 flex items-center justify-center shrink-0 mt-0.5">
                                <span class="text-[10px] font-bold text-app-gold">2</span>
                            </div>
                            <p class="text-[11px] text-gray-300"><b>Tên đăng nhập:</b> Tối đa <b>15 ký tự</b>, viết liền, <b>không dấu</b>, không ký tự đặc biệt.</p>
                        </li>
                        <li class="flex items-start gap-3">
                            <div class="w-5 h-5 rounded-full bg-app-gold/20 flex items-center justify-center shrink-0 mt-0.5">
                                <span class="text-[10px] font-bold text-app-gold">3</span>
                            </div>
                            <p class="text-[11px] text-gray-300"><b>Mật khẩu:</b> Độ dài tối thiểu <b>4 ký tự</b>.</p>
                        </li>
                    </ul>
                    <button onclick="toggleRules()" type="button" class="w-full mt-4 py-2 bg-white/5 hover:bg-white/10 text-white text-[10px] font-bold rounded-xl transition-all">ĐÃ HIỂU</button>
                </div>

                <input type="text" id="regName" maxlength="9" placeholder="Tên hiển thị (Tối đa 9 ký tự)" class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 pl-5 text-white focus:border-app-gold focus:bg-black/60 focus:ring-1 outline-none font-bold placeholder-gray-500 transition-all">
                
                <div class="relative group">
                    <input type="text" id="regUsername" maxlength="15" placeholder="Tên đăng nhập (viết liền, không dấu)" class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 pl-5 text-white focus:border-app-gold focus:bg-black/60 focus:ring-1 outline-none font-bold placeholder-gray-500 transition-all">
                    <i class="fa-solid fa-at absolute right-5 top-1/2 -translate-y-1/2 text-gray-500 group-hover:text-app-gold transition-colors"></i>
                </div>

                <div class="relative group">
                    <input type="password" id="regPassword" placeholder="Mật khẩu (tối thiểu 4 ký tự)" class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 pl-5 pr-12 text-white focus:border-app-gold focus:bg-black/60 focus:ring-1 outline-none font-bold placeholder-gray-500 transition-all">
                    <button onclick="togglePassword('regPassword', this)" type="button" class="absolute right-0 top-0 h-full px-5 text-gray-500 hover:text-white transition-colors"><i class="fa-solid fa-eye"></i></button>
                </div>
                
                <button onclick="handleRegister()" class="w-full bg-white text-black font-extrabold py-4 rounded-2xl hover:bg-gray-200 hover:shadow-[0_0_20px_rgba(255,255,255,0.3)] transition-all mt-6 shadow-lg" data-lang="btn_register">TẠO TÀI KHOẢN</button>
                
                <p class="text-gray-400 text-sm mt-6 cursor-pointer hover:text-white text-center transition-colors select-none" onclick="toggleAuthMode('login')">
                    <span data-lang="has_account">Đã có nick?</span> <span class="text-app-gold font-bold underline decoration-2 underline-offset-4" data-lang="link_login">Đăng nhập</span>
                </p>

                <p class="text-center text-[10px] text-gray-500 italic mt-2 opacity-70">
                    * Web tối ưu hơn trên máy tính
                </p>
            </div>

            <div id="avatarSetupForm" class="space-y-6 hidden relative animate-fade-in">
                 <div class="text-center mb-6">
                    <h2 class="text-app-gold text-xl font-black uppercase tracking-widest">Ảnh đại diện</h2>
                    <p class="text-gray-400 text-xs mt-1">Chọn một bức ảnh thật chất nhé!</p>
                </div>

                <div class="relative w-28 h-28 mx-auto group cursor-pointer" onclick="document.getElementById('regAvatarInput').click()">
                    <div id="regAvatarPreview" class="w-full h-full rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center overflow-hidden bg-black/30 group-hover:border-app-gold transition-all">
                        <i class="fa-solid fa-camera text-3xl text-gray-500 group-hover:text-app-gold transition-colors"></i>
                    </div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 bg-app-gold rounded-full flex items-center justify-center text-black border-2 border-gray-900 shadow-lg">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </div>
                </div>
                
                <input type="file" id="regAvatarInput" accept="image/*" class="hidden" onchange="handleRegAvatarPreview(event)">

                <div class="space-y-3 pt-2">
                    <button onclick="saveAndEnterApp()" class="w-full bg-gradient-to-r from-app-gold to-yellow-600 text-black font-extrabold py-3.5 rounded-2xl hover:scale-[1.02] shadow-lg transition-all">
                        HOÀN TẤT
                    </button>
                    <button onclick="skipAndEnterApp()" class="w-full bg-transparent text-gray-500 font-bold py-3 rounded-xl hover:text-white transition-all text-xs">
                        Bỏ qua, tôi sẽ đặt sau
                    </button>
                </div>
            </div>

            <p id="authError" class="text-red-500 text-sm mt-4 font-bold min-h-[20px] text-center animate-pulse bg-black/20 rounded-lg"></p>
        </div>
    </div>

    <div id="appContainer" class="w-full h-full md:max-w-md md:rounded-[2.5rem] md:border-[3px] md:border-gray-700/30 bg-black/10 backdrop-blur-md relative flex flex-col hidden animate-fade-in shadow-[0_0_250px_rgba(0,0,0,1.5)] overflow-hidden">
        
        <header class="absolute top-0 w-full z-20 px-4 pt-[calc(env(safe-area-inset-top)+40px)] pb-4 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent pointer-events-none transition-all duration-300">
            <div class="pointer-events-auto flex items-center gap-2 bg-app-gray/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/10 hover:bg-app-gray transition-colors cursor-pointer group" onclick="toggleSettings()">
                <div class="w-7 h-7 rounded-full flex items-center justify-center overflow-hidden border border-white/20 group-hover:scale-105 transition-transform" id="headerAvatar"></div>
                <span class="font-bold text-sm truncate max-w-[90px] text-gray-200 group-hover:text-white transition-colors" id="headerName">Bạn</span>
            </div>
            
            <div class="pointer-events-auto flex flex-col items-center cursor-pointer group absolute left-1/2 -translate-x-1/2" onclick="toggleMapModal()">
                <h1 class="text-app-gold font-black text-xl tracking-[0.2em] select-none group-hover:scale-105 transition-transform drop-shadow-sm">WORLDY</h1>
                <span class="text-[9px] text-white/80 bg-white/10 px-2 py-0.5 rounded-full backdrop-blur-sm -mt-1 border border-white/10 flex items-center gap-1 group-hover:bg-white/20 group-hover:text-white transition-all">
                    <i class="fa-solid fa-earth-americas text-app-gold text-[8px]"></i> 
                    <span id="currentCommunityDisplay">Toàn Cầu</span>
                    <i class="fa-solid fa-chevron-down text-[8px] opacity-70"></i>
                </span>
            </div>

            <div class="pointer-events-auto flex items-center gap-3">

                <button onclick="toggleSearch()" class="w-9 h-9 flex items-center justify-center rounded-full bg-app-gray/50 backdrop-blur-sm border border-white/5 hover:bg-app-gray hover:border-white/20 transition-all cursor-pointer group">
                    <i class="fa-solid fa-magnifying-glass text-gray-300 text-sm group-hover:text-app-gold group-hover:scale-110 transition-transform"></i>
                </button>

                <button onclick="toggleNotifications()" class="relative w-9 h-9 flex items-center justify-center rounded-full bg-app-gray/50 backdrop-blur-sm border border-white/5 hover:bg-app-gray hover:border-white/20 transition-all cursor-pointer group">
                    <i class="fa-solid fa-bell text-gray-300 text-sm group-hover:text-app-gold group-hover:rotate-12 transition-transform"></i>
                    <span id="notifBadge" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full text-[8px] font-bold text-white flex items-center justify-center hidden border border-black shadow-sm">0</span>
                </button>

                <div class="w-9 h-9 flex items-center justify-center rounded-full bg-app-gray/50 backdrop-blur-sm border border-white/5 hover:bg-app-gray hover:border-white/20 transition-all cursor-pointer group" onclick="toggleViewMode()">
                    <i class="fa-solid fa-table-cells-large text-app-gold text-sm group-hover:scale-110 transition-transform" id="viewModeIcon"></i>
                </div>
            </div>
        </header>

        <main id="feedContainer" class="flex-1 overflow-y-auto no-scrollbar scroll-smooth pt-24 pb-28 px-3">
            <div id="emptyState" class="hidden flex flex-col items-center justify-center mt-32 opacity-50 animate-zoom-in">
                <div class="w-20 h-20 rounded-full bg-app-gray flex items-center justify-center mb-4">
                    <i class="fa-regular fa-images text-3xl text-gray-500"></i>
                </div>
                <p class="font-bold text-gray-400" data-lang="empty_feed_title">Khu vực này chưa có ảnh</p>
                <p class="text-xs text-gray-600 mt-1" data-lang="empty_feed_subtitle">Hãy là người đầu tiên check-in!</p>
            </div>
            <div id="feedList" class="flex flex-col gap-6 pb-10"></div>
        </main>

        <div id="uploadOverlay" class="absolute inset-0 z-[60] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center hidden animate-fade-in overflow-y-auto py-4">
            <div class="absolute top-6 right-6 z-40">
                <button onclick="closeCamera()" class="w-10 h-10 rounded-full bg-gray-800 text-white hover:bg-gray-700 hover:rotate-90 transition-all"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div id="uploadPreviewWrapper" class="w-[85%] aspect-[3/4] bg-gray-900 rounded-[2rem] overflow-hidden relative shadow-2xl border border-gray-800 mb-4 animate-zoom-in shadow-app-gold/5 flex items-center justify-center shrink-0 transition-colors duration-300">
                <div id="previewContainer" class="w-full h-full flex items-center justify-center bg-black"></div>
                <div id="uploadLoading" class="absolute inset-0 flex items-center justify-center bg-black/80 hidden flex-col backdrop-blur-sm z-50">
                    <div class="relative"><div class="w-12 h-12 border-4 border-app-gold/30 border-t-app-gold rounded-full animate-spin"></div></div>
                    <span class="text-white text-xs font-bold tracking-widest mt-4 animate-pulse" id="uploadStatusText" data-lang="uploading">UPLOADING...</span>
                </div>
            </div>
            
            <div class="w-[85%] flex gap-2 mb-4 animate-zoom-in shrink-0" style="animation-delay: 0.05s;">
                <div class="flex-1 relative">
                    <select id="uploadCommunitySelect" class="w-full bg-gray-900/80 border border-gray-700 text-white pl-4 pr-8 py-3 rounded-xl outline-none appearance-none focus:border-app-gold transition-all text-xs font-bold h-full"></select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-[10px] pointer-events-none"></i>
                </div>
                
                <div class="flex items-center gap-2 bg-gray-900/80 border border-gray-700 rounded-xl px-3 py-2">
                    <input type="radio" name="frameColor" value="gray" id="c_gray" class="hidden color-radio" checked onchange="updateFramePreview(this.value)">
                    <label for="c_gray" class="w-6 h-6 rounded-full bg-app-gray border border-gray-600 cursor-pointer block hover:scale-110 transition-transform"></label>
                    <input type="radio" name="frameColor" value="gold" id="c_gold" class="hidden color-radio" onchange="updateFramePreview(this.value)">
                    <label for="c_gold" class="w-6 h-6 rounded-full bg-app-gold border border-yellow-600 cursor-pointer block hover:scale-110 transition-transform"></label>
                    <input type="radio" name="frameColor" value="blue" id="c_blue" class="hidden color-radio" onchange="updateFramePreview(this.value)">
                    <label for="c_blue" class="w-6 h-6 rounded-full bg-blue-500 border border-blue-700 cursor-pointer block hover:scale-110 transition-transform"></label>
                    <input type="radio" name="frameColor" value="pink" id="c_pink" class="hidden color-radio" onchange="updateFramePreview(this.value)">
                    <label for="c_pink" class="w-6 h-6 rounded-full bg-pink-500 border border-pink-700 cursor-pointer block hover:scale-110 transition-transform"></label>
                </div>
            </div>

            <div class="w-[85%] relative mb-8 animate-zoom-in shrink-0" style="animation-delay: 0.1s;">
                <input type="text" id="captionInput" maxlength="100" placeholder="Nói gì đó (Max 100)..." class="w-full h-12 bg-gray-900/80 border border-gray-700 text-white px-6 py-3 pr-24 rounded-2xl outline-none text-center focus:border-app-gold focus:bg-black transition-all placeholder-gray-500 font-bold text-sm tracking-wide shadow-sm">
                <span class="absolute right-14 top-1/2 -translate-y-1/2 text-[10px] text-gray-500" id="charCount">0/100</span>
                <button id="aiMagicBtn" onclick="generateMagicCaption()" class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center rounded-xl text-app-gold hover:bg-app-gold/10 hover:scale-110 transition-all" title="AI Caption">
                    <i class="fa-solid fa-wand-magic-sparkles text-lg"></i>
                </button>
            </div>

            <button onclick="publishPost()" class="w-20 h-20 rounded-full bg-app-gold text-black text-3xl flex items-center justify-center shadow-[0_0_40px_rgba(255,184,0,0.4)] hover:scale-110 hover:shadow-[0_0_60px_rgba(255,184,0,0.6)] transition-all animate-zoom-in shrink-0" style="animation-delay: 0.2s;">
                <i class="fa-solid fa-paper-plane text-xl ml-1"></i>
            </button>
        </div>

        <div id="pullRefreshIndicator" class="absolute bottom-28 left-1/2 -translate-x-1/2 z-40 transition-all duration-200 opacity-0 scale-0 pointer-events-none">
            <div class="w-10 h-10 rounded-full bg-app-gold text-black flex items-center justify-center shadow-xl shadow-app-gold/30">
                <i class="fa-solid fa-rotate text-lg"></i>
            </div>
        </div>

        <div class="absolute bottom-[calc(10px+env(safe-area-inset-bottom))] left-1/2 transform -translate-x-1/2 w-[90%] max-w-[320px] z-50">
            <div class="glass rounded-full h-20 w-full grid grid-cols-3 items-center shadow-2xl shadow-black/50 relative">

                <div class="flex justify-center items-center">
                    <button id="homeBtn" class="flex flex-col items-center justify-center gap-0.5 text-gray-400 hover:text-white transition-all p-2 select-none touch-none group">
                        <i class="fa-solid fa-house text-xl pointer-events-none group-hover:scale-110 transition-transform"></i>
                        <span class="text-[8px] font-bold text-gray-600 group-hover:text-app-gold uppercase tracking-tighter transition-colors">Đúp để Load</span>
                    </button>
                </div>

                <div class="flex justify-center items-center relative h-full">
                    <button onclick="showMediaOptions()" class="absolute -top-6 w-16 h-16 bg-white border-[6px] border-black rounded-full flex items-center justify-center text-black shadow-xl hover:scale-110 hover:rotate-3 transition-all active:scale-95 group relative overflow-hidden z-50 cursor-pointer">
                        <div class="absolute inset-0 bg-gradient-to-tr from-gray-100 to-white pointer-events-none"></div>
                        <i class="fa-solid fa-plus text-2xl relative z-10 group-hover:text-app-dark transition-colors"></i>
                    </button>
                </div>

                <div class="flex justify-center items-center">
                    <button onclick="toggleProfile()" class="flex flex-col items-center justify-center gap-0.5 text-gray-400 hover:text-white transition-all p-2 group">
                        <i class="fa-solid fa-user text-xl group-hover:scale-110 transition-transform"></i>
                        <span class="text-[8px] font-bold text-gray-600 group-hover:text-app-gold uppercase tracking-tighter transition-colors">Album</span>
                    </button>
                </div>

            </div>
        </div>
        
        <div id="mediaOptionsModal" class="fixed inset-0 z-[60] bg-black/90 hidden flex flex-col justify-end pb-8 animate-fade-in" onclick="closeMediaOptions()">
            <div class="bg-app-dark rounded-t-3xl p-6 border-t border-gray-800 transform transition-transform duration-300 translate-y-0" onclick="event.stopPropagation()">
                <div class="w-12 h-1.5 bg-gray-700 rounded-full mx-auto mb-6"></div>
                <h3 class="text-center font-bold text-white mb-6 uppercase tracking-widest text-sm" data-lang="create_post_title">Tạo bài viết mới</h3>

                <div class="grid grid-cols-3 gap-4">
                    <div onclick="triggerInput('inputPhoto')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-blue-600/20 text-blue-500 flex items-center justify-center text-2xl group-hover:bg-blue-600 group-hover:text-white transition-colors border border-blue-500/30">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400" data-lang="btn_take_photo">Chụp ảnh</span>
                    </div>
                    
                    <div onclick="triggerInput('inputAudio')" class="flex flex-col items-center gap-2 cursor-pointer group">
                         <div class="w-14 h-14 rounded-2xl bg-purple-600/20 text-purple-500 flex items-center justify-center text-2xl group-hover:bg-purple-600 group-hover:text-white transition-colors border border-purple-500/30">
                            <i class="fa-solid fa-microphone"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400" data-lang="btn_record_audio">Ghi âm</span>
                    </div>
                     <div onclick="triggerInput('inputGallery')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-gray-700/50 text-gray-300 flex items-center justify-center text-2xl group-hover:bg-gray-600 group-hover:text-white transition-colors border border-gray-600/50">
                            <i class="fa-solid fa-image"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400" data-lang="btn_gallery">Thư viện</span>
                    </div>
                </div>

                <p class="text-center text-[10px] text-gray-600 mt-6 italic pointer-events-none" data-lang="upload_note">
                    *Lưu ý: Máy tính chỉ hỗ trợ tải file có sẵn.
                </p>
            </div>
        </div>

        <input type="file" id="inputPhoto" accept="image/*" capture="environment" class="hidden-input" onchange="handleFileSelect(event)" onclick="this.value=null">
        <input type="file" id="inputAudio" accept="audio/*, .mp3, .m4a, audio/mp4" class="hidden-input" onchange="handleFileSelect(event)" onclick="this.value=null">
        <input type="file" id="inputGallery" accept="image/*,video/*,audio/*" class="hidden-input" onchange="handleFileSelect(event)" onclick="this.value=null">
        
        <input type="file" id="avatarInput" accept="image/*" class="hidden-input" onchange="handleAvatarSelect(event)" onclick="this.value=null">
    </div>

    <div id="mapModal" class="fixed inset-0 z-[120] bg-black/95 hidden flex flex-col items-center justify-center p-4 animate-fade-in">
        <button onclick="toggleMapModal()" class="absolute top-4 right-4 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20 active:scale-95 transition-all">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <div class="w-full h-full flex flex-col items-center justify-center">
            <h3 class="text-center font-black text-app-gold text-2xl uppercase tracking-widest mb-1" data-lang="map_title">Bản Đồ Thế Giới</h3>
            <p class="text-center text-gray-500 text-xs mb-6" data-lang="map_subtitle">Chọn khu vực để xem tin tức</p>

            <div class="relative w-[80%] md:w-[60%] aspect-[4/3] rounded-2xl overflow-hidden border border-gray-800 shadow-2xl bg-[#191a1a]">
                
                <div id="leafletMap" class="w-full h-full z-0 outline-none bg-[#191a1a]"></div>
                
                <div class="absolute inset-0 z-[1000] cursor-default pointer-events-none"></div>

                <button onclick="switchCommunity('Toàn Cầu')" class="absolute bottom-4 left-4 z-[1001] bg-black/80 text-[#FFB800] border border-[#FFB800] px-4 py-2 rounded-lg font-bold text-xs shadow-lg hover:bg-gray-800 active:scale-95 transition-all pointer-events-auto">
                    Toàn Cầu 🌍
                </button>
            </div>

            <div class="w-[80%] md:w-[60%] mt-6 z-[125]">
                <div class="relative w-full mx-auto">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-earth-americas text-app-gold"></i>
                    </div>
                    <select id="mapSelect" onchange="switchCommunity(this.value)" class="block w-full pl-10 pr-4 py-3 bg-[#1f2937] border border-gray-600 text-white font-bold rounded-xl focus:ring-2 focus:ring-[#FFB800] focus:border-transparent outline-none appearance-none cursor-pointer shadow-lg">
                    </select>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-gray-400">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <style>
        /* Ẩn logo bản quyền góc dưới phải cho giao diện sạch sẽ */
        .leaflet-control-attribution { display: none; }
        
        /* Giao diện Popup tối màu */
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #1f2937; /* Gray-800 */
            color: white;
            border: 1px solid #FFB800;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .leaflet-popup-content { margin: 8px 12px; font-weight: bold; }

        /* Tái tạo hiệu ứng nhấp nháy PHITAY bằng CSS thuần */
        .phitay-pulse {
            width: 20px; height: 20px;
            background: #EF4444;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px #EF4444;
            position: relative;
        }
        .phitay-pulse::after {
            content: '';
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.6);
            animation: pulse-ring 1.5s infinite;
        }
        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(3); opacity: 0; }
        }
    </style>

    <div id="commentModal" class="fixed inset-0 z-[310] bg-black/95 hidden flex flex-col p-0 md:p-6 overflow-hidden animate-fade-in">
        <button onclick="closeComments()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="w-full max-w-md h-full flex flex-col bg-app-dark md:rounded-3xl md:border border-gray-800 mx-auto overflow-hidden animate-zoom-in">
            <div class="p-4 border-b border-gray-800 bg-app-gray text-center">
                <h3 class="font-bold text-white uppercase tracking-widest text-xs" data-lang="comments_title">Bình luận</h3>
            </div>
            <div id="commentsList" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div class="p-3 border-t border-gray-800 bg-app-gray flex gap-2 relative">
    
                <div id="tagSuggestions" class="hidden absolute bottom-full left-0 w-full bg-gray-900 border border-gray-700 rounded-t-2xl z-50 max-h-48 overflow-y-auto custom-scrollbar shadow-2xl animate-fade-in-up">
                </div>
                <input type="text" id="commentInput" maxlength="800" placeholder="Viết bình luận (@để tag)..." class="flex-1 bg-black border border-gray-700 rounded-full px-4 py-2 text-sm text-white focus:border-app-gold outline-none" autocomplete="off">
                <button onclick="submitComment()" class="w-10 h-10 rounded-full bg-app-gold text-black flex items-center justify-center"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="notifModal" class="fixed inset-0 z-[210] bg-black/95 hidden flex flex-col p-0 md:p-6 overflow-hidden animate-fade-in">
        <button onclick="toggleNotifications()" class="absolute top-4 right-4 z-50 w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md md:w-10 md:h-10">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        
        <div class="w-full max-w-md h-full flex flex-col bg-app-dark md:rounded-3xl md:border border-gray-800 mx-auto overflow-hidden animate-zoom-in">
            <div class="px-6 py-5 border-b border-gray-800 bg-app-gray/50 flex justify-between items-end">
                <div>
                    <h3 class="font-black text-white text-xl tracking-tight">Thông báo</h3>
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-0.5">Cập nhật mới nhất</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteAllMainNotifications()" class="text-[10px] bg-red-500/10 px-3 py-1.5 rounded-full hover:bg-red-500 hover:text-white text-red-500 transition-all font-bold border border-red-500/20 flex items-center gap-1.5" title="Xóa tất cả">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>

                    <button onclick="markAllRead()" class="text-[10px] bg-app-gold/10 px-3 py-1.5 rounded-full hover:bg-app-gold hover:text-black text-app-gold transition-all font-bold border border-app-gold/20 flex items-center gap-1.5">
                        <i class="fa-solid fa-check-double"></i> <span>Đã đọc</span>
                    </button>
                </div>
            </div>
            
            <div id="notifList" class="flex-1 overflow-y-auto p-0 pb-10 scroll-smooth no-scrollbar">
            </div>
        </div>
    </div>

    <div id="likesModal" class="fixed inset-0 z-[320] bg-black/95 hidden flex flex-col p-0 md:p-6 overflow-hidden animate-fade-in">
         <button onclick="document.getElementById('likesModal').classList.add('hidden')" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md">
            <i class="fa-solid fa-xmark"></i>
        </button>
        
        <div class="w-full h-full md:h-3/4 md:max-w-sm flex flex-col bg-app-dark md:rounded-3xl md:border border-gray-800 mx-auto md:mt-20 overflow-hidden animate-zoom-in">
            <div class="p-4 border-b border-gray-800 bg-app-gray text-center pt-8 md:pt-4">
                <h3 class="font-bold text-white uppercase tracking-widest text-xs">Đã thích</h3>
            </div>
            <div id="likesList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
        </div>
    </div>

    <div id="singlePostModal" class="fixed inset-0 z-[300] bg-black/95 hidden flex flex-col items-center justify-center p-4 animate-fade-in">
        <button onclick="closeSinglePost()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20 hover:rotate-90 transition-all">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <div class="w-full h-full max-w-md flex flex-col justify-center">
            <div id="singlePostContainer" class="w-full max-h-full overflow-y-auto no-scrollbar rounded-[2rem] animate-zoom-in">
                </div>
        </div>
    </div>

    <div id="miniPreviewModal" class="fixed inset-0 z-[350] bg-black/90 hidden flex flex-col items-center justify-center p-6 animate-fade-in backdrop-blur-md">
        <button onclick="closeMiniPreview()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20 transition-all">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>
        
        <div class="w-full max-w-md flex flex-col items-center animate-zoom-in relative">
            
            <div id="miniPreviewMedia" class="w-full max-h-[70vh] rounded-2xl overflow-hidden shadow-2xl border border-gray-800 bg-black relative mb-8 flex items-center justify-center">
                </div>

            <div onclick="jumpToPostFromMini()" class="cursor-pointer group flex flex-col items-center gap-2 py-4 px-6 rounded-xl hover:bg-white/5 transition-colors">
                <span class="text-app-gold font-black uppercase tracking-[0.2em] text-sm group-hover:scale-110 transition-transform shadow-app-gold/50 drop-shadow-lg flex items-center">
                    <i class="fa-solid fa-location-arrow mr-3 animate-pulse"></i> NHẢY ĐẾN BÀI VIẾT
                </span>
                <p class="text-[10px] text-gray-500 font-bold group-hover:text-gray-300 transition-colors">(Xem bài viết)</p>
            </div>

        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 z-[301] bg-black/95 hidden flex flex-col items-center p-0 md:p-6 overflow-hidden animate-fade-in">
        <button onclick="toggleProfile()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>
        <div class="w-full max-w-md h-full flex flex-col bg-app-dark md:rounded-3xl md:border border-gray-800 overflow-hidden animate-zoom-in">
            <div class="p-8 pb-6 text-center border-b border-gray-800 bg-gradient-to-b from-app-gray/80 to-app-dark">
                <div class="relative w-28 h-28 mx-auto mb-4">
                    <div class="w-full h-full rounded-full bg-gradient-to-tr from-app-gold to-yellow-600 flex items-center justify-center text-5xl font-bold text-black border-4 border-app-dark overflow-hidden shadow-lg shadow-app-gold/20" id="modalAvatarContainer">
                        <span id="modalAvatarText">?</span>
                        <img id="modalAvatarImg" src="" class="w-full h-full object-cover hidden">
                    </div>
                </div>
                
                <h2 class="text-3xl font-black text-white mb-2 tracking-tight" id="modalName">Tên bạn</h2>

                <p class="text-gray-500 text-xs font-mono font-bold uppercase tracking-widest inline-block px-3 py-1 rounded-full bg-white/5 border border-white/5" id="modalUsername">@username</p>

                <button onclick="openUserInfo()" class="mt-3 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white text-[10px] font-bold py-1.5 px-4 rounded-full border border-white/10 transition-all flex items-center gap-2 mx-auto">
                    <i class="fa-regular fa-id-card"></i> Xem Hồ Sơ Của Tôi
                </button>
                
                </div>
            <div class="flex-1 overflow-y-auto bg-black custom-scrollbar">
                <div id="albumState" class="h-full flex flex-col">
                    <div id="guestAlbumView" class="hidden flex-1 flex flex-col items-center justify-center text-center p-8 opacity-60">
                        <div class="w-20 h-20 rounded-full bg-gray-900 flex items-center justify-center mb-6 border border-gray-800">
                            <i class="fa-solid fa-lock text-3xl text-gray-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2" data-lang="guest_mode">Chế độ Khách</h3>
                        <p class="text-sm text-gray-500 max-w-[240px] leading-relaxed" data-lang="guest_hint">Tính năng Album không khả dụng cho tài khoản khách.</p>
                    </div>
                    <div id="userAlbumView" class="hidden w-full min-h-full bg-app-dark">
                        <div class="sticky top-0 z-10 flex items-center justify-between px-5 py-4 bg-app-dark/95 backdrop-blur border-b border-gray-800">
                            <h3 class="font-black text-white text-xs uppercase tracking-[0.15em] flex items-center gap-2">
                                <i class="fa-solid fa-grid-2 text-app-gold"></i> <span data-lang="my_gallery">Thư viện ảnh</span>
                            </h3>
                            <span class="text-[10px] font-bold text-gray-500 bg-gray-800 px-2 py-1 rounded-md" id="postCount">0 ẢNH</span>
                        </div>
                        <div id="userPostsGrid" class="grid grid-cols-3 gap-[1px]"></div>
                    </div>
                </div>
            </div>
            
        </div>
        <input type="file" id="avatarInput" accept="image/*" onchange="handleAvatarSelect(event)">
    </div>

    <div id="publicProfileModal" class="fixed inset-0 z-[302] bg-black/95 hidden flex flex-col items-center p-0 md:p-6 overflow-hidden animate-fade-in">
        <button onclick="closePublicProfile()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <div class="w-full max-w-md h-full flex flex-col bg-app-dark md:rounded-3xl md:border border-gray-800 overflow-hidden animate-zoom-in">
            <div class="p-8 pb-6 text-center border-b border-gray-800 bg-gradient-to-b from-gray-900 to-app-dark relative">
                <div class="relative w-24 h-24 mx-auto mb-3">
                    <div class="w-full h-full rounded-full border-2 border-gray-700 flex items-center justify-center overflow-hidden bg-gray-800" id="publicAvatarContainer">
                        </div>
                </div>
                <h2 class="text-2xl font-bold text-white mb-1" id="publicName">Name</h2>
                <p class="text-gray-500 text-xs font-mono uppercase tracking-widest" id="publicUsername">@username</p>

                <div id="friendActionContainer" class="mt-4 flex justify-center w-full px-8 hidden">
                    <button id="friendBtn" class="w-full py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg">
                        Loading...
                    </button>
                </div>
                
                <div class="mt-4 flex justify-center gap-6 text-xs">
                    <div class="text-center">
                        <span class="block font-bold text-white text-lg" id="publicPostCount">0</span>
                        <span class="text-gray-600 uppercase font-bold text-[10px]">Bài đăng</span>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto bg-black custom-scrollbar">
                <div class="w-full min-h-full bg-app-dark flex flex-col">
                    
                    <div id="publicPostsGrid" class="grid grid-cols-3 gap-[1px]"></div>
                    
                    <div id="publicEmptyState" class="hidden py-20 text-center opacity-50">
                        <i class="fa-regular fa-folder-open text-4xl text-gray-600 mb-3"></i>
                        <p class="text-gray-500 text-xs">Chưa có ảnh nào</p>
                    </div>

                    <div id="publicGuestView" class="hidden flex-1 flex flex-col items-center justify-center text-center p-8 opacity-60">
                        <div class="w-20 h-20 rounded-full bg-gray-900 flex items-center justify-center mb-6 border border-gray-800">
                            <i class="fa-solid fa-lock text-3xl text-gray-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-300 mb-2">Chế độ Khách</h3>
                        <p class="text-sm text-gray-500 max-w-[240px] leading-relaxed">Tính năng Album không khả dụng cho tài khoản khách.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[220] bg-black/95 hidden flex flex-col items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
        <button onclick="toggleSettings()" class="absolute top-4 right-4 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20 active:scale-95 transition-all">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <div class="w-full max-w-sm bg-app-dark rounded-3xl border border-gray-800 p-6 animate-zoom-in shadow-2xl relative flex flex-col max-h-[85dvh] overflow-y-auto overflow-x-hidden custom-scrollbar overscroll-contain">
            
            <div class="absolute top-0 right-0 w-32 h-32 bg-app-gold/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>

            <h3 class="text-center font-black text-white text-xl uppercase tracking-widest mb-8 flex items-center justify-center gap-2 shrink-0">
                <i class="fa-solid fa-gear text-app-gold animate-spin-slow" style="animation-duration: 10s;"></i> Cài Đặt
            </h3>

            <div class="space-y-4">
                
                <div class="bg-app-gray rounded-2xl p-4 flex items-center gap-4 border border-white/5">
                    <div class="relative w-14 h-14 group cursor-pointer shrink-0" onclick="triggerAvatarChange()">
                        <div id="settingAvatar" class="w-full h-full rounded-full bg-gray-700 flex items-center justify-center text-xl font-bold text-white overflow-hidden border-2 border-transparent group-hover:border-app-gold transition-all shadow-lg">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="absolute inset-0 rounded-full bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all backdrop-blur-[1px]">
                            <i class="fa-solid fa-camera text-white text-lg animate-bounce"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">Đang đăng nhập</p>
                        <p class="text-white font-bold text-lg truncate" id="settingName">User</p>
                    </div>
                </div>

                <div class="bg-app-gray rounded-2xl overflow-hidden border border-white/5">

                    <div onclick="openUserInfo()" class="bg-app-gray rounded-2xl p-4 flex items-center justify-between border border-white/5 cursor-pointer hover:bg-gray-800 transition-colors mt-4 mb-4 group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-blue-600/20 text-blue-500 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                <i class="fa-solid fa-id-card"></i>
                            </div>
                            <div>
                                <p class="text-white font-bold text-sm">Xem Hồ Sơ</p>
                                <p class="text-gray-500 text-[10px] font-bold">Thông tin chi tiết</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-600 text-xs group-hover:text-white group-hover:translate-x-1 transition-all"></i>
                    </div>

                    <div class="p-4 border-b border-gray-800">
                        <div class="flex items-center gap-3 text-white font-bold text-sm mb-3">
                            <i class="fa-solid fa-pen-nib text-gray-400 w-5"></i> Đổi tên hiển thị
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="settingNameInput" maxlength="9" placeholder="Nhập tên mới..." class="flex-1 bg-black/50 border border-gray-700 rounded-xl px-3 py-2 text-white text-sm focus:border-app-gold outline-none transition-all">
                            <button id="saveNameBtn" onclick="saveNameFromSettings()" class="bg-white text-black font-bold px-4 rounded-xl text-xs hover:bg-gray-200 transition-colors shadow-lg">LƯU</button>
                        </div>
                    </div>

                    <div class="p-4 border-b border-gray-800 flex justify-between items-center hover:bg-white/5 cursor-pointer transition-colors" onclick="triggerAvatarChange()">
                        <div class="flex items-center gap-3 text-white font-bold text-sm">
                            <i class="fa-solid fa-camera text-gray-400 w-5"></i> Đổi ảnh đại diện
                        </div>
                        <div class="w-8 h-8 rounded-full border border-gray-600 overflow-hidden relative shadow-sm bg-black">
                            <img id="settingSmallAvatar" src="" class="w-full h-full object-cover hidden">
                            <div id="settingSmallAvatarPlaceholder" class="w-full h-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white">?</div>
                        </div>
                    </div>

                    <div class="p-4 flex justify-between items-center hover:bg-white/5 cursor-pointer transition-colors" onclick="showToast('Chưa hỗ trợ ngôn ngữ khác!')">
                        <div class="flex items-center gap-3 text-white font-bold text-sm">
                            <i class="fa-solid fa-globe text-gray-400 w-5"></i> Ngôn ngữ
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 text-xs font-bold">Tiếng Việt</span>
                            <i class="fa-solid fa-chevron-right text-[10px] text-gray-600"></i>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t border-gray-800">
                    <div class="flex items-center gap-3 text-white font-bold text-sm mb-4">
                        <i class="fa-solid fa-palette text-gray-400 w-5"></i> Giao diện nền
                    </div>
                    <div class="flex gap-4 justify-between px-2 flex-wrap">
                        <button onclick="changeTheme('default')" data-theme="default" class="theme-btn w-9 h-9 rounded-full bg-gradient-to-br from-violet-600 to-indigo-600 border border-white/20 hover:scale-110 transition-all shadow-[0_0_15px_rgba(124,58,237,0.5)]" title="Mặc định"></button>
                        <button onclick="changeTheme('cyberpunk')" data-theme="cyberpunk" class="theme-btn w-9 h-9 rounded-full bg-gradient-to-br from-cyan-400 to-pink-500 border border-white/20 hover:scale-110 transition-all shadow-[0_0_15px_rgba(6,182,212,0.6)]" title="Cyberpunk"></button>
                        <button onclick="changeTheme('crimson')" data-theme="crimson" class="theme-btn w-9 h-9 rounded-full bg-gradient-to-br from-red-500 to-rose-700 border border-white/20 hover:scale-110 transition-all shadow-[0_0_15px_rgba(239,68,68,0.5)]" title="Huyết Nguyệt"></button>
                        <button onclick="changeTheme('matrix')" data-theme="matrix" class="theme-btn w-9 h-9 rounded-full bg-gradient-to-br from-green-500 to-emerald-700 border border-white/20 hover:scale-110 transition-all shadow-[0_0_15px_rgba(34,197,94,0.5)]" title="Ma Trận"></button>
                        <button onclick="changeTheme('midnight')" data-theme="midnight" class="theme-btn w-9 h-9 rounded-full bg-black border border-gray-600 hover:scale-110 transition-all shadow-[0_0_10px_rgba(255,255,255,0.15)]" title="Đêm Đen"></button>
                    </div>
                </div>

                <button onclick="requestLogout()" class="w-full bg-red-500/10 text-red-500 font-bold py-4 rounded-2xl border border-red-500/20 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center gap-2 mt-4 group">
                    <i class="fa-solid fa-arrow-right-from-bracket group-hover:rotate-180 transition-transform"></i> Đăng Xuất
                </button>
                
                <button onclick="openDeleteConfirm()" class="w-full bg-black text-gray-600 font-bold py-3 rounded-2xl border border-gray-800 hover:bg-gray-900 hover:text-gray-400 transition-all flex items-center justify-center gap-2 text-xs">
                    <i class="fa-solid fa-user-xmark"></i> Xóa tài khoản vĩnh viễn
                </button>
            </div>

            <p class="text-center text-gray-600 text-[10px] font-bold mt-6 tracking-widest shrink-0">Made By PHITAY</p>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 z-[850] bg-black/90 hidden flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-app-gray w-full max-w-xs rounded-3xl p-6 border border-gray-800 text-center animate-zoom-in shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2 mt-2" data-lang="confirm_title">Xác nhận</h3>
            <p class="text-gray-400 text-sm mb-8" id="confirmMessage">Bạn có chắc chắn?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="flex-1 bg-gray-800 text-white font-bold py-3.5 rounded-xl text-sm hover:bg-gray-700 transition-colors" data-lang="btn_cancel">Hủy</button>
                <button id="confirmYesBtn" class="flex-1 bg-white text-black font-bold py-3.5 rounded-xl text-sm hover:bg-gray-200">Đồng ý</button>
            </div>
        </div>
    </div>

    <div id="phitayAuthModal" class="fixed inset-0 z-[230] bg-black/95 hidden flex flex-col items-center justify-center p-6 animate-fade-in backdrop-blur-xl">
        <div class="w-full max-w-xs bg-gray-900 border border-red-900/50 rounded-3xl p-8 text-center shadow-[0_0_50px_rgba(220,38,38,0.2)] animate-zoom-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent"></div>
            
            <div class="w-16 h-16 bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/30">
                <i class="fa-solid fa-user-shield text-2xl text-red-500"></i>
            </div>
            
            <h3 class="text-red-500 font-black text-lg uppercase tracking-[0.2em] mb-1">PHITAY</h3>
            <p class="text-gray-500 text-xs mb-6 font-bold">Keypass</p>
            
            <input type="password" id="phitayPasswordInput" placeholder="Keypass..." class="w-full bg-black border border-gray-700 rounded-xl px-4 py-3 text-center text-white focus:border-red-500 outline-none transition-all mb-4 placeholder-gray-600 font-bold tracking-widest">
            
            <div class="flex gap-2">
                <button onclick="document.getElementById('phitayAuthModal').classList.add('hidden')" class="flex-1 bg-gray-800 text-gray-400 font-bold py-3 rounded-xl hover:bg-gray-700 text-xs">X</button>
                <button onclick="checkPhitayPass()" class="flex-1 bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 shadow-lg shadow-red-900/50 text-xs">OKE</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur-md border border-white/10 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl transition-all duration-300 opacity-0 -translate-y-10 pointer-events-none z-[999] flex items-center gap-3">
        <i class="fa-solid fa-check-circle text-app-gold text-lg"></i>
        <span id="toastMessage">Thông báo</span>
    </div>

    <div id="userInfoModal" class="fixed inset-0 z-[280] bg-black/95 hidden flex flex-col items-center justify-center p-4 md:p-6 animate-fade-in backdrop-blur-md">
    
        <button onclick="closeUserInfo()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <div class="w-full max-w-sm bg-app-dark rounded-[2rem] border border-gray-800 animate-zoom-in shadow-2xl relative overflow-hidden flex flex-col h-[85vh] md:h-[70vh]">
            <div class="relative shrink-0 pb-6 bg-gradient-to-b from-gray-900 to-app-dark z-20 shadow-xl">
                <div class="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-blue-600/20 to-transparent pointer-events-none"></div>
                
                <div class="flex flex-col items-center pt-8 relative z-10">
                    <div class="w-20 h-20 rounded-full p-1 bg-gradient-to-tr from-blue-500 to-purple-600 shadow-lg mb-3">
                        <div class="w-full h-full rounded-full bg-black flex items-center justify-center overflow-hidden" id="infoModalAvatar">
                            </div>
                    </div>

                    <h2 class="text-xl font-black text-white" id="infoModalName">User</h2>
                    <p class="text-gray-500 text-[10px] font-mono font-bold uppercase tracking-widest mb-3" id="infoModalUsername">@username</p>

                    <div class="w-full px-6 mt-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div onclick="openSimpleFriendList()" class="bg-white/5 py-2.5 rounded-2xl border border-white/10 flex flex-col items-center justify-center group cursor-pointer hover:bg-white/10 active:scale-95 transition-all">
                                <span class="text-app-gold text-lg font-black" id="infoModalFriendCount">0</span>
                                <span class="text-gray-500 text-[9px] font-bold uppercase tracking-widest">Bạn bè</span>
                            </div>

                            <button onclick="openFriendZone()" class="bg-app-gold py-2.5 rounded-2xl border border-yellow-600 flex flex-col items-center justify-center group hover:scale-[1.02] transition-all shadow-lg shadow-app-gold/20">
                                <i class="fa-solid fa-user-group text-black text-lg mb-0.5"></i>
                                <span class="text-black text-[9px] font-bold uppercase tracking-widest">Friend Zone</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex-1 bg-black/40 overflow-y-auto custom-scrollbar p-4 relative">
                
                <div class="flex justify-between items-center mb-3 ml-2 sticky top-0 bg-transparent z-10 backdrop-blur-sm pr-2 pt-2">
                    <h3 class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">Danh sách tin nhắn</h3>
                    
                    <button onclick="toggleMsgNotifications()" class="relative w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition-all group border border-white/5">
                        <i class="fa-solid fa-envelope text-gray-400 text-xs group-hover:text-white"></i>
                        <span id="userInfoMsgBadge" class="absolute -top-1 -right-1 min-w-[16px] h-4 bg-red-600 rounded-full border border-app-dark hidden flex items-center justify-center text-[9px] font-bold text-white px-1 shadow-sm"></span>
                    </button>
                </div>
                
                <div id="friendListContainer" class="flex flex-col gap-2 pb-4">
                </div>
                
            </div>
        </div>
    </div>

    <div id="chatModal" class="fixed inset-0 z-[290] bg-black/95 hidden flex flex-col items-center justify-center p-0 md:p-6 animate-fade-in backdrop-blur-md">
    
        <div class="w-full max-w-sm h-full md:h-[80vh] bg-app-dark md:rounded-[2rem] border border-gray-800 shadow-2xl relative overflow-hidden flex flex-col">
            
            <div class="px-4 py-3 bg-gray-900 border-b border-gray-800 flex items-center justify-between shrink-0 z-20">
                <div class="flex items-center gap-3">
                    <button onclick="closeChatModal()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white transition-all">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>

                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="visitChatPartnerProfile()">
                        
                        <div class="relative">
                            <div id="chatHeaderAvatar" class="w-9 h-9 rounded-full overflow-hidden border border-gray-700 bg-gray-800 flex items-center justify-center">
                                </div>
                            
                            <div id="chatHeaderDot" class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-[#0B0E11] rounded-full"></div>
                        </div>

                        <div>
                            <h3 class="font-bold text-white text-sm" id="chatHeaderName">User Name</h3>
                            <p id="chatHeaderStatus" class="text-[10px] text-gray-500 font-mono">Đang hoạt động</p> 
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-1">
    
                    <button onclick="openChatArchive()" class="w-8 h-8 rounded-full text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-all" title="Kho lưu trữ">
                        <i class="fa-solid fa-photo-film"></i>
                    </button>

                    <button onclick="openChatSettings()" class="w-8 h-8 rounded-full text-gray-400 hover:text-white hover:bg-white/10 flex items-center justify-center transition-all">
                        <i class="fa-solid fa-gear text-lg"></i>
                    </button>
                    
                </div>
            </div>

            <div id="msgSearchBar" class="hidden bg-gray-900 border-b border-gray-800 p-2 flex items-center gap-2 animate-fade-in shrink-0">
                <div class="flex-1 bg-black/50 border border-gray-700 rounded-xl flex items-center px-3 py-1.5 focus-within:border-app-gold transition-colors">
                    <i class="fa-solid fa-magnifying-glass text-gray-500 text-xs mr-2"></i>
                    
                    <input type="text" id="msgSearchInput" placeholder="Nhập từ khóa..." class="bg-transparent border-none outline-none text-white text-sm w-full font-bold placeholder-gray-600">
                    
                    <span id="searchResultCount" class="text-[10px] text-gray-400 font-mono whitespace-nowrap ml-2 min-w-[30px] text-center"></span>
                </div>

                <button onclick="navigateSearch('up')" class="w-8 h-8 rounded-full bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 flex items-center justify-center border border-white/5">
                    <i class="fa-solid fa-chevron-up"></i>
                </button>

                <button onclick="navigateSearch('down')" class="w-8 h-8 rounded-full bg-gray-800 text-gray-400 hover:text-white hover:bg-gray-700 flex items-center justify-center border border-white/5">
                    <i class="fa-solid fa-chevron-down"></i>
                </button>

                <button onclick="closeChatSearch()" class="w-8 h-8 rounded-full bg-red-900/20 text-red-500 hover:bg-red-900/40 flex items-center justify-center ml-1">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div id="chatMessages" class="flex-1 bg-black/50 overflow-y-auto p-4 space-y-3 custom-scrollbar scroll-smooth">
                </div>

            <div class="p-3 bg-gray-900 border-t border-gray-800 shrink-0 relative"> <div id="chatGroupTagSuggestions" class="hidden absolute bottom-full left-0 w-full bg-gray-900 border-t border-gray-700 z-50 max-h-40 overflow-y-auto custom-scrollbar shadow-2xl animate-fade-in-up mb-1 rounded-t-2xl">
                </div>
                <div class="flex items-end gap-2 bg-gray-800 p-2 rounded-2xl border border-gray-700 focus-within:border-app-gold transition-colors">
                    
                    <input type="file" id="chatFileInput" class="hidden" accept="image/*, .mp3, .m4a, .mp4, .mov" onchange="handleChatFileSelect(event)">
                    
                    <button onclick="document.getElementById('chatFileInput').click()" class="w-8 h-8 rounded-full text-gray-400 hover:text-white flex items-center justify-center shrink-0 transition-colors">
                        <i class="fa-solid fa-image"></i>
                    </button>
                    
                    <textarea id="chatInput" maxlength="800" rows="1" placeholder="Nhắn tin..." class="flex-1 bg-transparent text-white text-sm px-2 py-1.5 outline-none resize-none max-h-24 custom-scrollbar" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                    
                    <button onclick="sendChatMessage()" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg hover:bg-blue-500 transition-all shrink-0">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="chatSettingsModal" class="fixed inset-0 z-[300] bg-black/80 hidden flex flex-col items-center justify-center animate-fade-in backdrop-blur-sm" onclick="closeChatSettings()">
    
        <div class="bg-app-dark border border-gray-800 w-[90%] max-w-sm rounded-3xl overflow-hidden shadow-2xl animate-zoom-in relative" onclick="event.stopPropagation()">
            
            <div class="p-5 flex justify-between items-center bg-gray-900 border-b border-gray-800">
                <h3 class="text-white font-black text-lg uppercase tracking-wider">TÙY CHỌN TIN NHẮN</h3>
                <button onclick="closeChatSettings()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-6 bg-app-dark space-y-3">
                
                <button onclick="activateChatSearch()" class="w-full flex items-center gap-4 p-4 rounded-2xl bg-blue-600/10 border border-blue-500/20 group hover:bg-blue-600/20 hover:border-blue-500/50 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-blue-500/20 text-blue-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-magnifying-glass text-xl"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-bold text-blue-500 text-base">Tìm trong cuộc trò chuyện</p>
                        <p class="text-[10px] text-blue-400/60 font-bold mt-1">Tìm kiếm nội dung cũ</p>
                    </div>
                </button>

                <button onclick="confirmDeleteAllMessages()" class="w-full flex items-center gap-4 p-4 rounded-2xl bg-red-900/10 border border-red-500/20 group hover:bg-red-900/30 hover:border-red-500/50 transition-all cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-trash-can text-xl"></i>
                    </div>
                    <div class="text-left">
                        <p class="font-bold text-red-500 text-base">Xóa toàn bộ tin nhắn</p>
                        <p class="text-[10px] text-red-400/60 font-bold mt-1">Hành động này không thể hoàn tác</p>
                    </div>
                </button>

            </div>
            
        </div>
    </div>

    <div id="chatArchiveModal" class="fixed inset-0 z-[310] bg-black/95 hidden flex flex-col animate-fade-in backdrop-blur-xl">
        <div class="px-4 py-4 border-b border-gray-800 bg-gray-900 flex justify-between items-center shrink-0">
            <h3 class="text-white font-black text-lg uppercase tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-photo-film text-app-gold"></i> Kho lưu trữ
            </h3>
            <button onclick="closeChatArchive()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar bg-black p-1">
            <div id="chatArchiveGrid" class="grid grid-cols-3 gap-1">
                </div>
            
            <div id="chatArchiveEmpty" class="hidden flex flex-col items-center justify-center h-full text-gray-500 opacity-50 mt-20">
                <i class="fa-regular fa-images text-4xl mb-3"></i>
                <p class="text-xs">Chưa có ảnh hay video nào</p>
            </div>
        </div>
    </div>



    <div id="friendZoneMediaOptions" class="fixed inset-0 z-[310] bg-black/80 hidden flex flex-col items-center justify-end p-0 md:p-4 animate-fade-in" onclick="closeFriendZoneMediaOptions()">
        <div class="w-full max-w-md flex flex-col justify-end h-full pointer-events-none">
            <div class="bg-gray-900 rounded-t-3xl p-6 border-t border-gray-800 transform transition-transform duration-300 translate-y-0 shadow-2xl shadow-app-gold/10 pointer-events-auto" onclick="event.stopPropagation()">
                <div class="w-12 h-1.5 bg-gray-700 rounded-full mx-auto mb-6"></div>
                <h3 class="text-center font-bold text-white mb-6 uppercase tracking-widest text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-layer-group text-app-gold"></i> Đăng lên Friend Zone
                </h3>
                <div class="grid grid-cols-3 gap-4">
                    <div onclick="triggerFriendZoneUpload('photo')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-blue-600/20 text-blue-500 flex items-center justify-center text-2xl group-hover:bg-blue-600 group-hover:text-white transition-colors border border-blue-500/30">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400">Chụp ảnh</span>
                    </div>
                    <div onclick="triggerFriendZoneUpload('audio')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-purple-600/20 text-purple-500 flex items-center justify-center text-2xl group-hover:bg-purple-600 group-hover:text-white transition-colors border border-purple-500/30">
                            <i class="fa-solid fa-microphone"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400">Ghi âm</span>
                    </div>
                    <div onclick="triggerFriendZoneUpload('gallery')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-gray-700/50 text-gray-300 flex items-center justify-center text-2xl group-hover:bg-gray-600 group-hover:text-white transition-colors border border-gray-600/50">
                            <i class="fa-solid fa-image"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400">Thư viện</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fzInputPhoto" accept="image/*" capture="environment" class="hidden-input" onchange="handleFZFileSelect(event)" onclick="this.value=null">
    <input type="file" id="fzInputAudio" accept="audio/*, .mp3, .m4a, audio/mp4" class="hidden-input" onchange="handleFZFileSelect(event)" onclick="this.value=null">
    <input type="file" id="fzInputGallery" accept="image/*,video/*,audio/*, .mp4, .mov" class="hidden-input" onchange="handleFZFileSelect(event)" onclick="this.value=null">

    <div id="friendDecisionModal" class="fixed inset-0 z-[300] bg-black/95 hidden flex flex-col items-center justify-center p-6 animate-fade-in backdrop-blur-md">
        <div class="w-full max-w-xs bg-gray-900 border border-gray-700 rounded-3xl p-6 relative animate-zoom-in shadow-2xl">
            <button onclick="document.getElementById('friendDecisionModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>

            <div class="text-center">
                <div class="w-20 h-20 mx-auto rounded-full p-1 bg-gradient-to-r from-app-gold to-yellow-600 mb-4 shadow-lg shadow-app-gold/20">
                    <div class="w-full h-full rounded-full bg-black overflow-hidden flex items-center justify-center" id="fdModalAvatar">
                        </div>
                </div>
                
                <h3 class="text-white font-bold text-lg mb-1" id="fdModalName">User Name</h3>
                <p class="text-gray-400 text-xs mb-6">đã gửi lời mời kết bạn</p>

                <div class="flex gap-3">
                    <button onclick="processFriendDecision('decline')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold py-3 rounded-xl transition-all text-xs">
                        TỪ CHỐI
                    </button>
                    <button onclick="processFriendDecision('accept')" class="flex-1 bg-app-gold hover:bg-yellow-400 text-black font-bold py-3 rounded-xl transition-all text-xs shadow-lg shadow-app-gold/20">
                        CHẤP NHẬN
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="searchModal" class="fixed inset-0 z-[900] bg-black/95 hidden flex flex-col items-center p-6 animate-fade-in backdrop-blur-md">
        <button onclick="toggleSearch()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>

        <div class="w-full max-w-md mt-12 animate-zoom-in flex flex-col h-full">
            <h3 class="text-center font-black text-white text-xl uppercase tracking-widest mb-6 flex items-center justify-center gap-2">
                <i class="fa-solid fa-magnifying-glass text-app-gold"></i> Tìm bạn bè
            </h3>

            <div class="relative w-full mb-6">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <span class="text-app-gold font-bold">@</span>
                </div>
                <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="Nhập tên đăng nhập..." class="w-full bg-gray-900 border border-gray-700 text-white pl-10 pr-4 py-4 rounded-2xl outline-none focus:border-app-gold focus:bg-black transition-all font-bold tracking-wide" autocomplete="off">
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div id="searchResultsList" class="flex flex-col gap-2">
                    <div class="text-center text-gray-600 text-xs mt-10 italic opacity-50">
                        Nhập chính xác tên đăng nhập để tìm kiếm
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    

    <input type="file" id="fzInputPhoto" accept="image/*" capture="environment" class="hidden-input" onchange="handleFZFileSelect(event)" onclick="this.value=null">
    <input type="file" id="fzInputAudio" accept="audio/*, .mp3, .m4a, audio/mp4" class="hidden-input" onchange="handleFZFileSelect(event)" onclick="this.value=null">
    <input type="file" id="fzInputGallery" accept="image/*,video/*,audio/*, .mp4, .mov" class="hidden-input" onchange="handleFZFileSelect(event)" onclick="this.value=null">

    <div id="friendZoneModal" class="fixed inset-0 z-[290] bg-black/95 hidden flex flex-col items-center justify-center animate-fade-in backdrop-blur-md p-0 md:p-6">
        <div class="w-full h-full md:max-w-md md:rounded-3xl md:border md:border-white/10 camera-art-bg relative flex flex-col shadow-2xl overflow-hidden">
            
            <header class="absolute top-0 w-full z-20 px-4 pt-[calc(env(safe-area-inset-top)+40px)] pb-4 flex justify-between items-center bg-gradient-to-b from-black/90 to-transparent pointer-events-none">
                <button onclick="closeFriendZone()" class="pointer-events-auto w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md hover:bg-white/20 transition-all">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                
                <div class="flex flex-col items-center">
                    <h1 class="text-app-gold font-black text-xl tracking-[0.2em] drop-shadow-sm">FRIEND ZONE</h1>
                    <span class="text-[9px] text-white/80 bg-white/10 px-2 py-0.5 rounded-full backdrop-blur-sm -mt-1 border border-white/10 flex items-center gap-1">
                        <i class="fa-solid fa-user-group text-app-gold text-[8px]"></i> <span>Chỉ bạn bè</span>
                    </span>
                </div>

                <div class="pointer-events-auto flex items-center gap-2">
                    <button onclick="toggleFriendListModal()" class="w-9 h-9 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-sm hover:bg-white/20 transition-all text-white">
                        <i class="fa-solid fa-address-book text-xs"></i>
                    </button>

                    <button onclick="toggleFriendZoneNotifications()" class="relative w-9 h-9 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-sm hover:bg-white/20 transition-all text-white">
                        <i class="fa-solid fa-bell text-xs"></i>
                        <span id="fzNotifBadge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full text-[7px] font-bold flex items-center justify-center hidden"></span>
                    </button>

                    <div onclick="toggleFriendZoneViewMode()" class="w-9 h-9 flex items-center justify-center rounded-full bg-white/10 backdrop-blur-sm hover:bg-white/20 transition-all text-app-gold cursor-pointer">
                        <i class="fa-solid fa-table-cells-large text-xs" id="fzViewModeIcon"></i>
                    </div>
                </div>
            </header>

            <main id="friendZoneContainer" class="flex-1 overflow-y-auto no-scrollbar scroll-smooth pt-24 pb-28 px-3 bg-transparent">
                <div id="friendFeedList" class="flex flex-col gap-6 pb-10"></div>
                
                <div id="friendZoneEmpty" class="hidden flex flex-col items-center justify-center mt-32 opacity-50 animate-zoom-in">
                    <div class="w-20 h-20 rounded-full bg-gray-900 flex items-center justify-center mb-4 border border-gray-800">
                        <i class="fa-solid fa-user-group text-3xl text-gray-500"></i>
                    </div>
                    <p class="font-bold text-gray-400 text-sm">Khu vực này đang trống</p>
                    <p class="text-[10px] text-gray-600 mt-1 max-w-[200px] text-center">Hãy kết bạn thêm hoặc đăng bài để thấy khoảnh khắc tại đây!</p>
                </div>
            </main>
            <div id="fzPullRefreshIndicator" class="absolute bottom-28 left-1/2 -translate-x-1/2 z-40 transition-all duration-200 opacity-0 scale-0 pointer-events-none">
                <div class="w-10 h-10 rounded-full bg-app-gold text-black flex items-center justify-center shadow-xl shadow-app-gold/30">
                    <i class="fa-solid fa-rotate text-lg"></i>
                </div>
            </div>

            <div class="absolute bottom-[calc(10px+env(safe-area-inset-bottom))] left-1/2 transform -translate-x-1/2 w-[90%] max-w-[320px] z-50">
                <div class="glass rounded-full h-20 w-full grid grid-cols-3 items-center shadow-2xl shadow-black/50 relative">

                    <div class="flex justify-center items-center">
                        <button onclick="handleFriendZoneHome()" id="fzHomeBtn" class="flex flex-col items-center justify-center gap-0.5 text-app-gold hover:text-yellow-200 transition-all p-2 select-none touch-none group">
                            <i class="fa-solid fa-house text-xl pointer-events-none group-hover:scale-110 transition-transform"></i>
                            <span class="text-[8px] font-bold text-yellow-600 group-hover:text-white uppercase tracking-tighter transition-colors">Đúp để Load</span>
                        </button>
                    </div>

                    <div class="flex justify-center items-center relative h-full">
                        <button onclick="openFriendZoneMediaOptions()" class="absolute -top-6 w-16 h-16 bg-app-gold border-[6px] border-black rounded-full flex items-center justify-center text-black shadow-xl hover:scale-110 hover:rotate-3 transition-all active:scale-95 group relative overflow-hidden z-50 cursor-pointer">
                            <div class="absolute inset-0 bg-gradient-to-tr from-yellow-400 to-app-gold pointer-events-none"></div>
                            <i class="fa-solid fa-plus text-2xl relative z-10 group-hover:text-white transition-colors"></i>
                        </button>
                    </div>

                    <div class="flex justify-center items-center">
                        <button onclick="openFriendZoneAlbum()" class="flex flex-col items-center justify-center gap-0.5 text-app-gold hover:text-yellow-200 transition-all p-2 group">
                            <i class="fa-solid fa-user text-xl group-hover:scale-110 transition-transform"></i>
                            <span class="text-[8px] font-bold text-yellow-600 group-hover:text-white uppercase tracking-tighter transition-colors">Album</span>
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="friendZoneAlbumModal" class="fixed inset-0 z-[300] bg-black/95 hidden flex flex-col items-center justify-center animate-zoom-in p-0 md:p-6 backdrop-blur-md">
        <div class="w-full h-full md:max-w-md bg-app-dark md:rounded-3xl md:border md:border-gray-800 shadow-2xl relative flex flex-col overflow-hidden">
            <div class="px-5 py-4 bg-app-dark/95 backdrop-blur border-b border-gray-800 flex justify-between items-center sticky top-0 z-10 shadow-lg">
                <h3 id="fzAlbumTitle" class="font-black text-app-gold text-xs uppercase tracking-[0.15em] flex items-center gap-2">
                    <i class="fa-solid fa-images"></i> <span>ALBUM CÁ NHÂN FRIENDZONE</span>
                </h3>
                <button onclick="closeFriendZoneAlbum()" class="w-8 h-8 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20 transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div id="friendZoneAlbumGrid" class="flex-1 overflow-y-auto grid grid-cols-3 gap-[1px] content-start pb-20 custom-scrollbar bg-black"></div>
        </div>
    </div>

    <div id="friendListModal" class="fixed inset-0 z-[350] bg-black/95 hidden flex flex-col items-center p-6 animate-fade-in backdrop-blur-md">
        <button onclick="toggleFriendListModal()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div class="w-full max-w-md mt-12 animate-zoom-in h-full flex flex-col">
            <h3 class="text-center font-black text-app-gold text-lg uppercase tracking-widest mb-2">
                <i class="fa-solid fa-address-book mr-2"></i> DANH BẠ
            </h3>
            <p class="text-center text-gray-500 text-xs mb-6">Chọn bạn bè để xem Album Friend Zone</p>

            <div class="flex-1 overflow-y-auto custom-scrollbar relative">
                <div id="fzContactList" class="flex flex-col gap-3 pb-10">
                    </div>
            </div>
        </div>
    </div>

    <div id="friendZoneUploadOverlay" class="fixed inset-0 z-[320] bg-black/95 backdrop-blur-xl flex flex-col items-center justify-center hidden animate-fade-in p-0 md:p-6">
        <div class="w-full h-full md:max-w-md md:rounded-3xl md:border md:border-white/10 bg-black/95 relative flex flex-col items-center justify-center overflow-y-auto custom-scrollbar">
            
            <div class="absolute top-6 right-6 z-40">
                <button onclick="closeFZCamera()" class="w-10 h-10 rounded-full bg-gray-800 text-white hover:bg-gray-700 hover:rotate-90 transition-all"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            
            <div class="absolute top-6 left-1/2 -translate-x-1/2 z-40 bg-app-gold/10 px-4 py-1.5 rounded-full border border-app-gold/20 backdrop-blur-md">
                <span class="text-app-gold text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-user-group"></i> Friend Zone
                </span>
            </div>
            
            <div id="fzUploadPreviewWrapper" class="w-[85%] aspect-[3/4] bg-gray-900 rounded-[2rem] overflow-hidden relative shadow-2xl border border-gray-800 mb-4 animate-zoom-in shadow-app-gold/5 flex items-center justify-center shrink-0 transition-colors duration-300">
                <div id="fzPreviewContainer" class="w-full h-full flex items-center justify-center bg-black"></div>
                <div id="fzUploadLoading" class="absolute inset-0 flex items-center justify-center bg-black/80 hidden flex-col backdrop-blur-sm z-50">
                    <div class="relative"><div class="w-12 h-12 border-4 border-app-gold/30 border-t-app-gold rounded-full animate-spin"></div></div>
                    <span class="text-white text-xs font-bold tracking-widest mt-4 animate-pulse">ĐANG ĐĂNG...</span>
                </div>
            </div>
            
            <div class="w-[85%] flex items-center gap-2 mb-4 animate-zoom-in shrink-0" style="animation-delay: 0.05s;">
    
                <div class="flex-1 cursor-pointer group" onclick="openAudienceModal()">
                    <div class="flex items-center justify-between bg-gray-900/80 border border-gray-700 rounded-xl px-3 py-2 shadow-lg group-hover:border-app-gold transition-all h-10">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <i class="fa-solid fa-earth-americas text-app-gold text-xs shrink-0" id="audienceIconDisplay"></i>
                            <span class="text-white text-[10px] font-bold truncate" id="audienceTextDisplay">Tất cả bạn bè</span>
                        </div>
                        <i class="fa-solid fa-chevron-down text-gray-500 text-[10px] ml-1 shrink-0"></i>
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-gray-900/80 border border-gray-700 rounded-xl px-3 py-2 shadow-lg h-10 shrink-0">
                    <input type="radio" name="fzFrameColor" value="gray" id="fzc_gray" class="hidden color-radio" checked onchange="updateFZFramePreview(this.value)">
                    <label for="fzc_gray" class="w-5 h-5 rounded-full bg-app-gray border border-gray-600 cursor-pointer block hover:scale-110 transition-transform" title="Mặc định"></label>
                    
                    <input type="radio" name="fzFrameColor" value="gold" id="fzc_gold" class="hidden color-radio" onchange="updateFZFramePreview(this.value)">
                    <label for="fzc_gold" class="w-5 h-5 rounded-full bg-app-gold border border-yellow-600 cursor-pointer block hover:scale-110 transition-transform" title="Vàng"></label>
                    
                    <input type="radio" name="fzFrameColor" value="blue" id="fzc_blue" class="hidden color-radio" onchange="updateFZFramePreview(this.value)">
                    <label for="fzc_blue" class="w-5 h-5 rounded-full bg-blue-500 border border-blue-700 cursor-pointer block hover:scale-110 transition-transform" title="Xanh"></label>
                    
                    <input type="radio" name="fzFrameColor" value="pink" id="fzc_pink" class="hidden color-radio" onchange="updateFZFramePreview(this.value)">
                    <label for="fzc_pink" class="w-5 h-5 rounded-full bg-pink-500 border border-pink-700 cursor-pointer block hover:scale-110 transition-transform" title="Hồng"></label>
                </div>

            </div>

            <div class="w-[85%] relative mb-4 animate-zoom-in shrink-0" style="animation-delay: 0.1s;">
                <input type="text" id="fzCaptionInput" maxlength="100" placeholder="Nói gì đó (Max 100)..." 
                    class="w-full h-9 bg-gray-900/80 border border-gray-700 text-white px-4 py-1.5 pr-24 rounded-xl outline-none text-center focus:border-app-gold focus:bg-black transition-all placeholder-gray-500 font-bold text-xs tracking-wide shadow-sm">
                
                <span class="absolute right-10 top-1/2 -translate-y-1/2 text-[9px] text-gray-500 font-bold" id="fzCharCount">0/100</span>

                <button onclick="generateFZMagicCaption()" class="absolute right-1 top-1/2 -translate-y-1/2 w-7 h-7 flex items-center justify-center rounded-lg text-app-gold hover:bg-app-gold/10 hover:scale-110 transition-all">
                    <i class="fa-solid fa-wand-magic-sparkles text-[10px]"></i>
                </button>
            </div>

            <button onclick="publishFriendZonePost()" class="w-16 h-16 rounded-full bg-app-gold text-black text-2xl flex items-center justify-center shadow-[0_0_30px_rgba(255,184,0,0.3)] hover:scale-110 hover:shadow-[0_0_50px_rgba(255,184,0,0.5)] transition-all animate-zoom-in shrink-0" style="animation-delay: 0.2s;">
                <i class="fa-solid fa-paper-plane text-lg ml-0.5"></i>
            </button>
        </div>
    </div>

    <div id="audienceModal" class="fixed inset-0 z-[360] bg-black/95 hidden flex flex-col items-center justify-center p-6 animate-fade-in backdrop-blur-md">
        <div class="w-full max-w-sm bg-app-dark rounded-[2rem] border border-gray-800 shadow-2xl overflow-hidden flex flex-col h-[70vh] animate-zoom-in">
            
            <div class="p-5 border-b border-gray-800 bg-gray-900 flex justify-between items-center shrink-0">
                <h3 class="font-black text-white text-sm uppercase tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-user-shield text-app-gold"></i> Ai có thể xem?
                </h3>
                <button onclick="closeAudienceModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
                    <i class="fa-solid fa-check"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2">
                
                <div onclick="toggleAudienceOption('ALL')" id="opt-ALL" class="flex items-center justify-between p-4 rounded-xl bg-app-gold/10 border border-app-gold cursor-pointer transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-app-gold text-black flex items-center justify-center text-lg"><i class="fa-solid fa-earth-americas"></i></div>
                        <div>
                            <p class="text-white font-bold text-sm">Tất cả bạn bè</p>
                            <p class="text-gray-400 text-[10px]">Mọi người trong danh bạ</p>
                        </div>
                    </div>
                    <div class="w-6 h-6 rounded-full border-2 border-app-gold flex items-center justify-center">
                        <div class="w-3 h-3 bg-app-gold rounded-full" id="check-ALL"></div>
                    </div>
                </div>

                <div onclick="toggleAudienceOption('SELF')" id="opt-SELF" class="flex items-center justify-between p-4 rounded-xl bg-gray-800/50 border border-gray-700 cursor-pointer hover:bg-gray-800 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gray-700 text-gray-300 flex items-center justify-center text-lg"><i class="fa-solid fa-lock"></i></div>
                        <div>
                            <p class="text-white font-bold text-sm">Chỉ mình tôi</p>
                            <p class="text-gray-400 text-[10px]">Lưu làm kỷ niệm riêng</p>
                        </div>
                    </div>
                    <div class="w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center">
                        <div class="w-3 h-3 bg-app-gold rounded-full hidden" id="check-SELF"></div>
                    </div>
                </div>

                <div class="my-4 border-t border-gray-800"></div>
                <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-2 px-1">Chọn bạn bè cụ thể</p>

                <div id="audienceFriendList" class="space-y-2 pb-4">
                    </div>

            </div>
        </div>
    </div>

    <div id="friendZoneMediaOptions" class="fixed inset-0 z-[310] bg-black/90 hidden flex flex-col justify-end pb-8 animate-fade-in p-0 md:p-6" onclick="closeFriendZoneMediaOptions()">
        <div class="w-full h-full flex flex-col justify-end pointer-events-none items-center">
            <div class="w-full md:max-w-md bg-app-dark rounded-t-3xl p-6 border-t border-gray-800 transform transition-transform duration-300 translate-y-full shadow-2xl pointer-events-auto" onclick="event.stopPropagation()">
                <div class="w-12 h-1.5 bg-gray-700 rounded-full mx-auto mb-6"></div>
                <h3 class="text-center font-bold text-white mb-6 uppercase tracking-widest text-sm flex items-center justify-center gap-2">
                    <i class="fa-solid fa-layer-group text-app-gold"></i> Đăng lên Friend Zone
                </h3>
                <div class="grid grid-cols-3 gap-4">
                    <div onclick="triggerFriendZoneUpload('photo')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-blue-600/20 text-blue-500 flex items-center justify-center text-2xl group-hover:bg-blue-600 group-hover:text-white transition-colors border border-blue-500/30">
                            <i class="fa-solid fa-camera"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400">Chụp ảnh</span>
                    </div>
                    <div onclick="triggerFriendZoneUpload('audio')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-purple-600/20 text-purple-500 flex items-center justify-center text-2xl group-hover:bg-purple-600 group-hover:text-white transition-colors border border-purple-500/30">
                            <i class="fa-solid fa-microphone"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400">Ghi âm</span>
                    </div>
                    <div onclick="triggerFriendZoneUpload('gallery')" class="flex flex-col items-center gap-2 cursor-pointer group">
                        <div class="w-14 h-14 rounded-2xl bg-gray-700/50 text-gray-300 flex items-center justify-center text-2xl group-hover:bg-gray-600 group-hover:text-white transition-colors border border-gray-600/50">
                            <i class="fa-solid fa-image"></i>
                        </div>
                        <span class="text-[10px] font-bold text-gray-400">Thư viện</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="fzSearchModal" class="fixed inset-0 z-[350] bg-black/95 hidden flex flex-col items-center p-6 animate-fade-in backdrop-blur-md">
        <button onclick="toggleFriendZoneSearch()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="w-full max-w-md mt-12 animate-zoom-in">
            <h3 class="text-center font-black text-app-gold text-lg uppercase tracking-widest mb-6">
                <i class="fa-solid fa-user-tag mr-2"></i> TÌM BẠN BÈ
            </h3>
            <div class="relative w-full mb-6">
                <input type="text" id="fzSearchInput" oninput="handleFriendZoneSearch(this.value)" placeholder="Nhập tên bạn bè..." class="w-full bg-gray-900 border border-gray-700 text-white pl-4 pr-4 py-4 rounded-2xl outline-none focus:border-app-gold transition-all font-bold">
                <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
            </div>
            <div id="fzSearchResults" class="flex flex-col gap-2 overflow-y-auto max-h-[60vh] custom-scrollbar">
                <p class="text-center text-gray-600 text-xs italic">Nhập tên để tìm trong danh sách bạn bè</p>
            </div>
        </div>
    </div>

    <div id="fzNotifModal" class="fixed inset-0 z-[350] bg-black/95 hidden flex flex-col p-0 md:p-6 overflow-hidden animate-fade-in">
        <button onclick="toggleFriendZoneNotifications()" class="absolute top-4 right-4 z-50 w-12 h-12 rounded-full bg-white/10 text-white flex items-center justify-center backdrop-blur-md md:w-10 md:h-10 hover:bg-white/20 transition-all">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>
        
        <div class="w-full max-w-md h-full flex flex-col bg-app-dark md:rounded-3xl md:border border-gray-800 mx-auto overflow-hidden animate-zoom-in shadow-2xl">
            <div class="px-6 py-5 border-b border-gray-800 bg-app-gray/50 flex justify-between items-end shrink-0">
                <div>
                    <h3 class="font-black text-app-gold text-xl tracking-tight">Friend Zone</h3>
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest mt-0.5">Thông báo riêng tư</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteAllFZNotifications()" class="text-[10px] bg-red-500/10 px-3 py-1.5 rounded-full hover:bg-red-500 hover:text-white text-red-500 transition-all font-bold border border-red-500/20 flex items-center gap-1.5" title="Xóa sạch">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>

                    <button onclick="markAllFZRead()" class="text-[10px] bg-app-gold/10 px-3 py-1.5 rounded-full hover:bg-app-gold hover:text-black text-app-gold transition-all font-bold border border-app-gold/20 flex items-center gap-1.5 group">
                        <i class="fa-solid fa-check-double group-hover:scale-110 transition-transform"></i> <span>Đã đọc</span>
                    </button>
                </div>
            </div>
            
            <div id="fzNotifList" class="flex-1 overflow-y-auto p-4 pb-10 scroll-smooth custom-scrollbar space-y-2"></div>
        </div>
    </div>

    <div id="msgNotifModal" class="fixed inset-0 z-[360] bg-black/95 hidden flex flex-col items-center justify-center p-6 animate-fade-in backdrop-blur-md">
        <button onclick="toggleMsgNotifications()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-white/10 text-white flex items-center justify-center hover:bg-white/20">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div class="w-full max-w-sm bg-app-dark rounded-[2rem] border border-gray-800 animate-zoom-in shadow-2xl overflow-hidden flex flex-col h-[60vh]">
            <div class="p-5 border-b border-gray-800 bg-gray-900 flex justify-between items-center">
                <h3 class="font-black text-white text-sm uppercase tracking-widest">
                    <i class="fa-solid fa-comments text-blue-500 mr-2"></i> Tin nhắn đến
                </h3>
                
                <div class="flex gap-2">
                    <button onclick="deleteAllMsgNotifications()" class="w-7 h-7 rounded-full bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white flex items-center justify-center transition-all" title="Xóa tất cả">
                        <i class="fa-solid fa-trash-can text-[10px]"></i>
                    </button>

                    <button onclick="markAllMsgRead()" class="text-[10px] font-bold text-gray-500 hover:text-white bg-white/5 px-3 py-1 rounded-full transition-all">
                        Đã đọc hết
                    </button>
                </div>
            </div>

            <div id="msgNotifList" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2 bg-black/50">
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="fixed inset-0 z-[350] bg-black/95 hidden flex flex-col items-center justify-center p-6 animate-fade-in backdrop-blur-md">
        <div class="w-full max-w-sm bg-app-dark rounded-3xl border border-gray-800 shadow-2xl overflow-hidden flex flex-col h-[80vh] animate-zoom-in">
            <div class="p-5 border-b border-gray-800 bg-gray-900 flex justify-between items-center">
                <h3 class="font-black text-white text-lg uppercase tracking-widest">Tạo Nhóm Chat</h3>
                <button onclick="document.getElementById('createGroupModal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="p-4 space-y-4 flex-1 overflow-y-auto custom-scrollbar">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1">Tên nhóm</label>
                    <input type="text" id="newGroupName" maxlength="20" placeholder="Nhập tên nhóm..." class="w-full mt-1 bg-black border border-gray-700 text-white px-4 py-3 rounded-xl outline-none focus:border-app-gold font-bold">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Chọn thành viên</label>
                    <div id="selectMemberContainer" class="space-y-2">
                        </div>
                </div>
            </div>

            <div class="p-4 border-t border-gray-800 bg-gray-900">
                <button onclick="confirmCreateGroup()" class="w-full bg-app-gold text-black font-bold py-3 rounded-xl hover:bg-yellow-400 transition-all shadow-lg">
                    <i class="fa-solid fa-users mr-2"></i> TẠO NHÓM
                </button>
            </div>
        </div>
    </div>

    <div id="groupSettingsModal" class="fixed inset-0 z-[320] bg-black/95 hidden flex flex-col items-center justify-center p-0 md:p-6 animate-fade-in backdrop-blur-md">
        <div class="w-full max-w-sm h-full md:h-[85vh] bg-app-dark md:rounded-[2rem] border border-gray-800 shadow-2xl relative overflow-hidden flex flex-col">
            
            <div class="px-4 py-4 bg-gray-900 border-b border-gray-800 flex items-center justify-between shrink-0">
                <button onclick="document.getElementById('groupSettingsModal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white transition-all">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
                <h3 class="font-black text-white text-sm uppercase tracking-widest">Cài đặt nhóm</h3>
                <div class="w-8"></div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8">
                <div class="flex flex-col items-center gap-4">
                    <div class="relative group cursor-pointer" onclick="triggerGroupAvatarChange()">
                        <div id="groupSettingAvatar" class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center text-3xl text-white border-4 border-gray-800 shadow-xl overflow-hidden">
                            <i class="fa-solid fa-users"></i>
                        </div>
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                            <i class="fa-solid fa-camera text-white"></i>
                        </div>
                        <input type="file" id="groupAvatarInput" class="hidden" accept="image/*" onchange="handleGroupAvatarSelect(event)">
                    </div>
                    
                    <div class="w-full space-y-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Tên nhóm</label>
                        <div class="flex gap-2">
                            <input type="text" id="groupSettingNameInput" maxlength="20" class="flex-1 bg-black border border-gray-700 rounded-xl px-4 py-2 text-white text-sm focus:border-app-gold outline-none">
                            <button onclick="updateGroupName()" class="bg-app-gold text-black px-4 rounded-xl text-[10px] font-bold hover:bg-yellow-400">LƯU</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <h4 class="text-[10px] font-bold text-gray-500 uppercase ml-1">Thêm thành viên</h4>
                        <i class="fa-solid fa-user-plus text-app-gold text-xs"></i>
                    </div>
                    <div id="addMemberToGroupList" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-1">
                        </div>
                </div>

                <div class="space-y-3">
                    <h4 id="groupMemberCountLabel" class="text-[10px] font-bold text-gray-500 uppercase ml-1">Thành viên</h4>
                    <div id="currentGroupMemberList" class="space-y-2">
                        </div>
                </div>                   

                <div id="deleteGroupContainer" class="hidden pt-6 border-t border-gray-800">
                    <button onclick="confirmDeleteGroup()" class="w-full bg-red-900/10 border border-red-500/30 text-red-500 font-bold py-3 rounded-xl hover:bg-red-600 hover:text-white transition-all shadow-lg flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-trash-can group-hover:rotate-12 transition-transform"></i> GIẢI TÁN NHÓM
                    </button>
                    <p class="text-[9px] text-gray-600 text-center mt-2 italic">Hành động này sẽ xóa nhóm vĩnh viễn.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="seenByModal" class="fixed inset-0 z-[400] bg-black/80 hidden flex flex-col items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
        <div class="w-full max-w-xs bg-app-dark rounded-2xl border border-gray-800 shadow-2xl overflow-hidden flex flex-col max-h-[60vh] animate-zoom-in">
            <div class="p-3 border-b border-gray-800 bg-gray-900 flex justify-between items-center">
                <h3 class="font-bold text-white text-xs uppercase tracking-widest ml-2">Đã xem bởi</h3>
                <button onclick="document.getElementById('seenByModal').classList.add('hidden')" class="w-7 h-7 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-all">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div id="seenByList" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
        </div>
    </div>

    <div id="simpleFriendListModal" class="fixed inset-0 z-[500] bg-black/60 hidden flex items-center justify-center p-4 animate-fade-in backdrop-blur-sm">
        <div class="w-full max-w-[340px] bg-[#121212] rounded-[2.5rem] border border-white/10 shadow-2xl overflow-hidden flex flex-col h-[500px] animate-zoom-in">
            
            <div class="px-6 pt-10 pb-4 relative shrink-0 border-b border-white/5 bg-white/5">
                <div class="absolute top-4 right-4 flex items-center gap-2">
                    <button onclick="toggleSearch()" class="w-8 h-8 rounded-xl bg-white/5 hover:bg-white/10 text-white flex items-center justify-center transition-all group">
                        <i class="fa-solid fa-magnifying-glass text-[10px] group-hover:text-app-gold"></i>
                    </button>

                    <button onclick="closeSimpleFriendList()" class="w-8 h-8 rounded-xl bg-white/5 hover:bg-white/10 text-white flex items-center justify-center transition-all">
                        <i class="fa-solid fa-xmark text-xs"></i>
                    </button>
                </div>

                <div>
                    <h3 class="font-black text-white text-lg tracking-tight">Bạn bè</h3>
                    <p id="simpleFriendCount" class="text-[9px] text-app-gold font-bold uppercase tracking-[0.1em] mt-0.5">0 thành viên</p>
                </div>
            </div>

            <div id="simpleFriendListContent" class="flex-1 overflow-y-auto px-4 py-4 space-y-2 custom-scrollbar">
                </div>
        </div>
    </div>


    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black/95 z-[250] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div class="bg-gray-900 w-full max-w-sm rounded-2xl border border-red-500/50 shadow-[0_0_30px_rgba(239,68,68,0.3)] overflow-hidden animate-zoom-in">
            
            <div class="bg-red-500/10 p-6 text-center border-b border-red-500/20">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                    <i class="fa-solid fa-triangle-exclamation text-3xl text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-red-500 uppercase tracking-widest">Cảnh báo nguy hiểm</h3>
            </div>
            
            <div class="p-6 text-center">
                <p class="text-gray-300 text-sm leading-relaxed mb-4">
                    Hành động này sẽ <b class="text-red-400">XÓA VĨNH VIỄN</b> tài khoản, bài viết và mọi dữ liệu của bạn.<br>
                    Bạn sẽ không thể khôi phục lại được nữa.<br>
                    
                    <span class="block mt-3 text-orange-500 font-bold text-xs uppercase border border-orange-500/30 bg-orange-500/10 py-2 rounded-lg">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                        Lưu ý: Tên đăng nhập sẽ bị khóa vĩnh viễn và không thể tạo lại!
                    </span>
                </p>

                <div class="mb-6 relative">
                    <label class="block text-[10px] text-gray-500 uppercase font-bold mb-2 tracking-wider">
                        Nhập chính xác chữ "PHITAY" để xác nhận
                    </label>
                    <input type="text" id="confirmDeleteInput" oninput="checkDeleteKey()" placeholder="PHITAY" 
                        class="w-full bg-black/50 border border-gray-700 text-white font-bold text-center rounded-xl py-3 focus:border-red-500 focus:outline-none focus:ring-1 focus:ring-red-500 transition-all placeholder-gray-700 tracking-widest">
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="cancelDelete()" class="py-3 px-4 rounded-xl bg-gray-800 text-gray-400 font-bold hover:bg-gray-700 transition-colors">
                        Hủy bỏ
                    </button>
                    
                    <button id="btnFinalDelete" onclick="executeDeleteAccount()" disabled 
                        class="py-3 px-4 rounded-xl bg-red-600 text-white font-bold shadow-lg shadow-red-900/50 flex items-center justify-center gap-2 opacity-50 cursor-not-allowed transition-all">
                        <i class="fa-solid fa-trash"></i> Xóa ngay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="promoteConfirmModal" class="fixed inset-0 bg-black/80 z-[600] hidden flex items-center justify-center animate-fade-in backdrop-blur-sm">
        <div class="bg-gray-800 w-[90%] max-w-sm rounded-2xl p-6 border border-white/10 shadow-2xl transform transition-all scale-100">
            
            <div class="w-16 h-16 rounded-full bg-app-gold/10 flex items-center justify-center mx-auto mb-4 border border-app-gold/20">
                <i class="fa-solid fa-crown text-3xl text-app-gold animate-bounce"></i>
            </div>

            <h3 class="text-xl text-white font-bold text-center mb-2">Cấp quyền Admin?</h3>
            
            <p class="text-gray-400 text-center text-sm mb-6 leading-relaxed">
                Bạn có chắc chắn muốn bầu thành viên <br>
                <b id="promoteTargetName" class="text-white text-base">User Name</b> <br>
                làm Quản trị viên của nhóm này không?
            </p>

            <div class="flex gap-3">
                <button onclick="closePromoteModal()" class="flex-1 py-3 rounded-xl bg-gray-700 text-gray-300 font-bold hover:bg-gray-600 transition-colors">
                    Hủy bỏ
                </button>
                <button onclick="executePromoteAction()" class="flex-1 py-3 rounded-xl bg-app-gold text-black font-bold hover:bg-yellow-400 transition-colors shadow-lg shadow-yellow-500/20">
                    Đồng ý
                </button>
            </div>
        </div>
    </div>


    

    <script>
        // --- 1. CẤU HÌNH ---
        const LOCAL_GEMINI_API_KEY = "AIzaSyBQqkdMJCW-IrlROny6RmNeyxxjRrGsYFY";
        const LOCAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCtq8bF1F57GzG5qSZs3Jz2G4ZBtTWbMN8",
            authDomain: "worldy-9ce90.firebaseapp.com",
            projectId: "worldy-9ce90",
            storageBucket: "worldy-9ce90.firebasestorage.app",
            messagingSenderId: "30944042050",
            appId: "1:30944042050:web:60af05ff7072cefc52e1db"
        };

        const CONTINENTS = ["Toàn Cầu", "Châu Á", "Châu Âu", "Châu Phi", "Bắc Mỹ", "Nam Mỹ", "Châu Đại Dương", "Nam Cực"];
        const CONTINENT_MAP = {
            "Toàn Cầu": "comm_global",
            "Châu Á": "comm_as",
            "Châu Âu": "comm_eu",
            "Châu Phi": "comm_af",
            "Bắc Mỹ": "comm_na",
            "Nam Mỹ": "comm_sa",
            "Châu Đại Dương": "comm_oc",
            "Nam Cực": "comm_an"
        };

        // --- CẤU HÌNH GIAO DIỆN NỀN (NEON DARK) ---
        // --- CẤU HÌNH GIAO DIỆN NỀN (ĐÃ NÂNG CẤP MÀU NEON ĐẬM ĐÀ) ---
        // --- CẤU HÌNH MÀU NEON ĐẬM (STREET STYLE) ---
        // --- CẤU HÌNH MÀU TẬP TRUNG TẠI TÂM (CENTER FOCUS) ---
        // --- CẤU HÌNH MÀU DẠNG DẢI BĂNG (RIBBON STYLE) ---
        // --- CẤU HÌNH MÀU DẠNG XOÁY/DẢI BĂNG (VORTEX RIBBON) ---
        // --- CẤU HÌNH MÀU NHẸ NHÀNG, TRÔI Ở GIỮA (SOFT CENTER FLOW) ---
        // --- CẤU HÌNH MÀU TINH VÂN (NEBULA STYLE) ---
        // --- CẤU HÌNH MÀU DẠNG KHỐI BIẾN HÌNH (MORPHING BLOB) ---
        // --- CẤU HÌNH 2 ĐẦU CỰC QUANG (AURORA DUAL ENDS) ---
        // --- CẤU HÌNH GIAO THOA SÓNG MẠNH (WAVE COLLISION THEMES) ---
        // --- CẤU HÌNH GIAO THOA 2 TỤ (DUAL-POLE RIPPLES) ---
        // --- CẤU HÌNH MÀU DYNAMIC IOS STYLE (2 TỤ & GIAO THOA) ---
        const APP_THEMES = {
            'default': {
                name: 'Mặc định',
                color: 'bg-purple-600',
                // Tụ 1: Tím đậm (Góc trên) | Tụ 2: Vàng Neon (Góc dưới) | Giữa: Xanh lá nhạt
                css: `
                    radial-gradient(at 0% 0%, rgba(139, 92, 246, 0.5) 0px, transparent 55%),
                    radial-gradient(at 100% 100%, rgba(234, 179, 8, 0.45) 0px, transparent 55%),
                    radial-gradient(at 50% 50%, rgba(16, 185, 129, 0.2) 0px, transparent 60%)
                `
            },
            'cyberpunk': {
                name: 'Cyberpunk',
                color: 'bg-cyan-500',
                // Cyan mạnh ở trên, Hồng mạnh ở dưới, giao nhau tạo ra màu tím mờ ở giữa
                css: `
                    radial-gradient(at 0% 10%, rgba(6, 182, 212, 0.5) 0px, transparent 60%),
                    radial-gradient(at 100% 90%, rgba(236, 72, 153, 0.5) 0px, transparent 60%),
                    radial-gradient(at 50% 50%, rgba(6, 182, 212, 0.15) 0px, transparent 50%)
                `
            },
            'crimson': {
                name: 'Huyết Nguyệt',
                color: 'bg-red-600',
                // Tụ 1: Đỏ Neon cực sáng (at 0% 0%) 
                // Tụ 2: Đỏ thẫm như máu - gần như đen (at 100% 100%)
                // Giữa: Đỏ rượu vang loang lổ (at 50% 50%)
                css: `
                    radial-gradient(at 0% 0%, rgba(255, 0, 0, 0.7) 0px, transparent 50%),
                    radial-gradient(at 100% 100%, rgba(40, 0, 0, 0.9) 0px, transparent 60%),
                    radial-gradient(at 50% 50%, rgba(180, 0, 0, 0.3) 0px, transparent 70%)
                `
            },
            'matrix': {
                name: 'Ma Trận',
                color: 'bg-green-500',
                // Tụ 1: Xanh lá chuối cực sáng - Neon Green (at 0% 0%)
                // Tụ 2: Xanh đen sâu thẳm - Deep Forest (at 100% 100%)
                // Giữa: Xanh lục mờ (at 50% 50%)
                css: `
                    radial-gradient(at 0% 0%, rgba(0, 255, 100, 0.7) 0px, transparent 50%),
                    radial-gradient(at 100% 100%, rgba(0, 20, 0, 0.9) 0px, transparent 60%),
                    radial-gradient(at 50% 50%, rgba(0, 100, 50, 0.3) 0px, transparent 70%)
                `
            },
            'midnight': {
                name: 'Đêm Đen',
                color: 'bg-gray-800',
                css: 'none' 
            }
        };

        function changeTheme(themeKey) {

            if (!currentUser || currentUser.isGuest) {
                // Nếu là khách mà bấm vào màu KHÁC midnight thì mới báo lỗi
                if (themeKey !== 'midnight') {
                    showToast("Tài khoản khách không hỗ trợ đổi giao diện nền!", "error");
                    if (navigator.vibrate) navigator.vibrate(50);
                    return; // Chặn không cho đổi
                }
                // Nếu themeKey là 'midnight', cho phép chạy tiếp xuống dưới để áp dụng nền đen
            }


            const theme = APP_THEMES[themeKey];
            if (!theme) return;


            // 1. Áp dụng hình nền (CSS Gradient)
            document.body.style.backgroundImage = theme.css;
            
            // 2. [MỚI] Xử lý chuyển động
            if (themeKey === 'midnight') {
                // Nếu là màu đen -> Tắt chuyển động cho nhẹ máy
                document.body.classList.remove('animated-neon-bg');
                document.body.style.backgroundColor = '#000000'; // Đảm bảo đen tuyền
            } else {
                // Các màu khác -> Bật hiệu ứng trôi
                document.body.classList.add('animated-neon-bg');
            }

            // 3. Lưu vào bộ nhớ máy
            localStorage.setItem('lm_theme', themeKey);

            // 4. Cập nhật giao diện nút bấm (Highlight nút đang chọn)
            document.querySelectorAll('.theme-btn').forEach(btn => {
                if(btn.dataset.theme === themeKey) {
                    btn.classList.add('ring-2', 'ring-white', 'scale-110');
                } else {
                    btn.classList.remove('ring-2', 'ring-white', 'scale-110');
                }
            });

            // 5. Lưu vào Database nếu đã đăng nhập
            if (currentUser && !currentUser.isGuest) {
                currentUser.theme = themeKey;
                localStorage.setItem('lm_user', JSON.stringify(currentUser));

                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .doc(currentUser.username).update({ theme: themeKey })
                    .catch(err => console.log("Lỗi lưu theme:", err));
            }
        }

        // --- CHỈ CÒN TIẾNG VIỆT ---
        const TRANSLATIONS = {
            vi: {
                auth_slogan: "Chia sẻ khoảnh khắc toàn cầu",
                btn_login: "ĐĂNG NHẬP",
                btn_guest: "Dùng ngay (Khách)",
                btn_register: "ĐĂNG KÝ",
                no_account: "Chưa có nick?",
                has_account: "Đã có nick?",
                link_register: "Đăng ký",
                link_login: "Đăng nhập",
                empty_feed_title: "Khu vực này chưa có ảnh",
                empty_feed_subtitle: "Hãy là người đầu tiên check-in!",
                map_title: "Bản Đồ Thế Giới",
                map_subtitle: "Chọn châu lục",
                comm_global: "Khu vực Toàn Cầu",
                comm_na: "Khu vực Bắc Mỹ", comm_sa: "Khu vực Nam Mỹ", comm_eu: "Khu vực Châu Âu", comm_af: "Khu vực Châu Phi", comm_as: "Khu vực Châu Á", comm_oc: "Khu vực Châu Đại Dương", comm_an: "Khu vực Nam Cực",
                comments_title: "Bình luận",
                btn_save: "LƯU",
                guest_mode: "Chế độ Khách",
                guest_label: "Khách",
                guest_hint: "Tính năng Album không khả dụng cho tài khoản khách.",
                my_gallery: "Thư viện ảnh",
                btn_logout: "Đăng Xuất",
                confirm_title: "Xác nhận",
                btn_cancel: "Hủy",
                toast_updated: "Đã cập nhật!",
                toast_error: "Có lỗi xảy ra.",
                placeholder_comment: "Viết bình luận...",
                placeholder_caption: "Nói gì đó (max 100)...",
                placeholder_reg_name: "Tên hiển thị",
                placeholder_reg_username: "Tên đăng nhập",
                placeholder_reg_password: "Mật khẩu",
                ai_thinking: "AI đang nghĩ...",
                uploading: "ĐANG GỬI...",
                just_now: "Vừa xong",
                ai_unsupported: "Chức năng AI viết caption sẽ không hỗ trợ cho video và file âm thanh",
                create_post_title: "Tạo bài viết mới",
                btn_take_photo: "Chụp ảnh",
                btn_record_audio: "Ghi âm",
                btn_gallery: "Thư viện",
                upload_note: "*Lưu ý: Máy tính chỉ hỗ trợ tải file có sẵn.",
                notif_title: "Thông báo",
                notif_mark_read: "Đã đọc",
                notif_empty: "Chưa có thông báo nào",
                notif_like: "đã thích bài viết của bạn.",
                notif_comment: "đã bình luận về bài viết.",
                notif_post_success: "đã đăng bài viết mới tại",
                notif_just_now: "Vừa xong",
                access_granted: "Đã mở khóa PHITAY!"
            }
        };

        let currentLang = 'vi'; // Cố định Tiếng Việt

        let firebaseConfig, appId;
        let apiKey = ""; 
        let isRunningLocal = false;

        // --- INIT CODE ---
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'life-moments-final-features-v28-fixed';
            } else {
                isRunningLocal = true;
                if (LOCAL_FIREBASE_CONFIG.apiKey === "DUMMY_KEY_FOR_DEMO" || LOCAL_FIREBASE_CONFIG.apiKey === "") {
                    throw new Error("Local Config Missing");
                }
                firebaseConfig = LOCAL_FIREBASE_CONFIG;
                appId = 'life-moments-local';
                if (LOCAL_GEMINI_API_KEY !== "HÃY_DÁN_API_KEY_GEMINI_VÀO_ĐÂY") apiKey = LOCAL_GEMINI_API_KEY;
            }
        } catch (e) {
            console.error("Config Setup:", e);
            if (e.message === "Local Config Missing" || isRunningLocal) {
                setTimeout(() => {
                    const errorMsg = document.getElementById('configErrorMsg');
                    errorMsg.innerHTML = `LỖI CẤU HÌNH`;
                    errorMsg.classList.remove('hidden');
                    document.getElementById('loadingText').classList.add('hidden');
                }, 1000);
            }
            firebaseConfig = { apiKey: "dummy" };
            appId = 'dummy';
        }

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- STATE ---
        window.aiMemory = {};

        let currentUser = null; 
        let friendStatusUnsubscribe = null; // Biến quản lý lắng nghe nút kết bạn
        let unreadMap = {};
        let isConnected = false;
        let recentPostsCache = []; 
        let currentCommunity = 'Toàn Cầu'; 
        let currentPostIdForComments = null;
        let commentsUnsubscribe = null;
        let replyState = null;
        let selectedFile = null; 
        let feedObserver = null;
        let currentViewMode = 'list'; 
        let pendingPhitayPost = null;

        let fzUnsubFriends1 = null; // Theo dõi danh sách bạn (chiều 1)
        let fzUnsubFriends2 = null; // Theo dõi danh sách bạn (chiều 2)
        let fzUnsubPosts = null;    // Theo dõi bài viết

        // Biến lưu dữ liệu thô (để vẽ giao diện mà không cần tải lại)
        let fzRawPosts = [];        // Kho chứa tất cả bài viết tải về
        let fzFriendList1 = [];     // Danh sách bạn bè chiều 1
        let fzFriendList2 = [];     // Danh sách bạn bè chiều 2
        let fzFinalFriendIds = [];  // Danh sách bạn bè chốt (đã gộp và lọc trùng)

        // --- THÊM BIẾN MỚI ---
        let currentUserUnsubscribe = null; // Biến quản lý radar theo dõi user
        let isDeletingAccount = false;     // Cờ báo hiệu đang thực hiện xóa (để tránh máy đang xóa bị văng ra giữa chừng)

        // --- THÊM HÀM MỚI: THEO DÕI TRẠNG THÁI TÀI KHOẢN ---
        function monitorCurrentUser() {
            // Không cần theo dõi nếu là Khách
            if (!currentUser || currentUser.isGuest) return;

            // Ngắt kết nối cũ nếu có để tránh trùng lặp
            if (currentUserUnsubscribe) currentUserUnsubscribe();

            // Bắt đầu lắng nghe sự thay đổi của tài khoản trên Database
            currentUserUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('users')
                .doc(currentUser.username)
                .onSnapshot(doc => {
                    // NẾU TÀI KHOẢN KHÔNG CÒN TỒN TẠI (Đã bị xóa)
                    // VÀ máy này KHÔNG PHẢI là máy đang bấm nút xóa (biến isDeletingAccount == false)
                    if (!doc.exists && !isDeletingAccount) {
                        alert("Phiên đăng nhập đã hết hạn hoặc tài khoản đã bị xóa. Ứng dụng sẽ tự động đăng xuất.");
                        localStorage.removeItem('lm_user'); // Xóa bộ nhớ máy
                        location.reload(); // Tải lại trang (Văng ra màn hình đăng nhập)
                    }
                }, error => {
                    console.log("Lỗi theo dõi user:", error);
                });
        }

        // --- FUNCTIONS ---
        
        function updateUI() {
            if(!currentUser) return;

            // 1. Cập nhật Header (Góc trên cùng)
            const headerName = document.getElementById('headerName');
            if(headerName) headerName.textContent = currentUser.displayName;
            
            const hAvt = document.getElementById('headerAvatar');
            if (hAvt) {
                if (currentUser.avatarUrl) {
                    hAvt.innerHTML = `<img src="${currentUser.avatarUrl}" class="w-full h-full object-cover">`;
                } else if (currentUser.isGuest) {
                    hAvt.innerHTML = `<i class="fa-solid fa-user-secret text-white"></i>`;
                } else {
                    hAvt.innerHTML = currentUser.displayName.charAt(0).toUpperCase();
                }
            }

            // 2. Cập nhật Modal Profile (Album ảnh)
            const modalName = document.getElementById('modalName');
            if (modalName) modalName.textContent = currentUser.displayName;
            
            const modalUsername = document.getElementById('modalUsername');
            if (modalUsername) {
                let usernameDisplay = '@' + currentUser.username;
                if(currentUser.isGuest) {
                     usernameDisplay = (typeof TRANSLATIONS !== 'undefined' ? TRANSLATIONS[currentLang].guest_label : "Khách") + ' ' + currentUser.username.split('_')[1]; 
                }
                modalUsername.textContent = usernameDisplay;
            }

            // (Phần này để tránh lỗi nếu bạn lỡ xóa input tên ở bước trước)
            const editNameInput = document.getElementById('editNameInput');
            if (editNameInput) {
                editNameInput.value = currentUser.displayName;
            }

            const mAvtText = document.getElementById('modalAvatarText');
            const mAvtImg = document.getElementById('modalAvatarImg');
            
            if (mAvtText && mAvtImg) {
                if (currentUser.avatarUrl) {
                    mAvtText.classList.add('hidden');
                    mAvtImg.src = currentUser.avatarUrl;
                    mAvtImg.classList.remove('hidden');
                } else if (currentUser.isGuest) {
                    mAvtText.innerHTML = '<i class="fa-solid fa-user-secret"></i>';
                    mAvtText.classList.remove('hidden');
                    mAvtImg.classList.add('hidden');
                } else {
                    mAvtText.textContent = currentUser.displayName.charAt(0).toUpperCase();
                    mAvtText.classList.remove('hidden');
                    mAvtImg.classList.add('hidden');
                }
            }

            // 3. Cập nhật Modal Settings (Cài đặt)
            
            // 3.1 Cập nhật Tên trong cài đặt
            const settingName = document.getElementById('settingName');
            if (settingName) settingName.textContent = currentUser.displayName;

            // 3.2 Cập nhật Avatar LỚN trong cài đặt
            const settingAvatar = document.getElementById('settingAvatar');
            if (settingAvatar) {
                if (currentUser.avatarUrl) {
                    settingAvatar.innerHTML = `<img src="${currentUser.avatarUrl}" class="w-full h-full object-cover">`;
                } else if (currentUser.isGuest) {
                    settingAvatar.innerHTML = '<i class="fa-solid fa-user-secret text-2xl"></i>';
                } else {
                    settingAvatar.innerHTML = currentUser.displayName.charAt(0).toUpperCase();
                }
            }

            // 3.3 [MỚI THÊM] Cập nhật Avatar NHỎ trong cài đặt (Cái bạn đang cần)
            const smallAvtImg = document.getElementById('settingSmallAvatar');
            const smallAvtPlc = document.getElementById('settingSmallAvatarPlaceholder');
            
            if (smallAvtImg && smallAvtPlc) {
                if (currentUser.avatarUrl) {
                    smallAvtImg.src = currentUser.avatarUrl;
                    smallAvtImg.classList.remove('hidden');
                    smallAvtPlc.classList.add('hidden');
                } else if (currentUser.isGuest) {
                    smallAvtImg.classList.add('hidden');
                    smallAvtPlc.innerHTML = '<i class="fa-solid fa-user-secret"></i>';
                    smallAvtPlc.classList.remove('hidden');
                } else {
                    smallAvtImg.classList.add('hidden');
                    smallAvtPlc.textContent = currentUser.displayName.charAt(0).toUpperCase();
                    smallAvtPlc.classList.remove('hidden');
                }
            }
        }

        function updateFramePreview(colorCode) {
            const previewWrapper = document.getElementById('uploadPreviewWrapper');
            if (previewWrapper) {
                const style = getFrameColorStyle(colorCode);
                
                // 1. Set viền và bóng đổ (Code cũ)
                previewWrapper.style.border = `2px solid ${style.borderColor}`;
                if (colorCode !== 'gray') {
                    previewWrapper.style.boxShadow = style.shadow;
                } else {
                    previewWrapper.style.boxShadow = 'none';
                }

                // 2. [THÊM MỚI]: Thêm class lấp lánh nếu có màu (khác gray)
                if (colorCode && colorCode !== 'gray') {
                    previewWrapper.classList.add('frame-glitter-effect');
                } else {
                    previewWrapper.classList.remove('frame-glitter-effect');
                }
            }
        }

        function getDisplayContinent(comm) {
             const key = CONTINENT_MAP[comm];
             return key ? TRANSLATIONS[currentLang][key] : comm;
        }

        function setLanguage() {
            const lang = 'vi';
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (TRANSLATIONS[lang][key]) el.textContent = TRANSLATIONS[lang][key];
            });

            const t = TRANSLATIONS[lang];
            
            if(document.getElementById('commentInput')) document.getElementById('commentInput').placeholder = t.placeholder_comment;
            if(document.getElementById('captionInput')) document.getElementById('captionInput').placeholder = t.placeholder_caption;
            if(document.getElementById('editNameInput')) document.getElementById('editNameInput').placeholder = 'Đổi tên hiển thị';
            if(document.getElementById('loginUsername')) document.getElementById('loginUsername').placeholder = 'Tên đăng nhập';
            if(document.getElementById('loginPassword')) document.getElementById('loginPassword').placeholder = 'Mật khẩu';
            if(document.getElementById('regName')) document.getElementById('regName').placeholder = t.placeholder_reg_name;
            if(document.getElementById('regUsername')) document.getElementById('regUsername').placeholder = t.placeholder_reg_username;
            if(document.getElementById('regPassword')) document.getElementById('regPassword').placeholder = t.placeholder_reg_password;

            const currentDisplay = document.getElementById('currentCommunityDisplay');
            if(currentDisplay) {
                 currentDisplay.textContent = getDisplayContinent(currentCommunity);
            }

            if(currentUser) updateUI();
            
            const mapSelect = document.getElementById('mapSelect');
            const uploadSelect = document.getElementById('uploadCommunitySelect');
            
            const repopulate = (sel) => {
                if(!sel) return;
                const currentVal = sel.value;
                sel.innerHTML = '';
                CONTINENTS.forEach(c => {
                   const opt = document.createElement('option');
                   opt.value = c; 
                   const key = CONTINENT_MAP[c];
                   let text = key ? TRANSLATIONS[lang][key] : c;
                   if(c === "Toàn Cầu") text = text +  " 🌍";
                   opt.text = text;
                   sel.appendChild(opt);
                });
                sel.value = currentVal;
            };
            
            repopulate(mapSelect);
            repopulate(uploadSelect);
        }
        
        function toggleViewMode() {
            currentViewMode = currentViewMode === 'list' ? 'grid' : 'list';
            const icon = document.getElementById('viewModeIcon');
            const feedList = document.getElementById('feedList');
            
            if (currentViewMode === 'grid') {
                icon.className = 'fa-solid fa-list text-app-gold text-sm group-hover:scale-110 transition-transform';
                feedList.classList.add('grid-view');
            } else {
                icon.className = 'fa-solid fa-table-cells-large text-app-gold text-sm group-hover:scale-110 transition-transform';
                feedList.classList.remove('grid-view');
            }
            subscribeToFeed(); 
        }

        function triggerInput(id) {
            closeMediaOptions(); 
            document.getElementById(id).click();
        }

        function showMediaOptions() {
            document.getElementById('mediaOptionsModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('mediaOptionsModal').querySelector('div').classList.remove('translate-y-full');
            }, 10);
        }

        function closeMediaOptions() {
             const modalContent = document.getElementById('mediaOptionsModal').querySelector('div');
             modalContent.classList.add('translate-y-full');
             setTimeout(() => {
                 document.getElementById('mediaOptionsModal').classList.add('hidden');
             }, 300);
        }

        async function callGemini(prompt, imageBase64 = null) {
            if (isRunningLocal && (!apiKey || apiKey.length < 10)) throw new Error("Missing API Key");
            const keyToUse = isRunningLocal ? apiKey : ""; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`;
            let contents = [{ parts: [{ text: prompt }] }];
            if (imageBase64) {
                 if(imageBase64.startsWith('data:image')) {
                     const cleanBase64 = imageBase64.split(',')[1] || imageBase64;
                     contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: cleanBase64 } });
                 }
            }
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents }) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error";
            } catch (e) { throw e; }
        }

        async function generateMagicCaption() {
            const img = document.getElementById('imagePreview');
            const input = document.getElementById('captionInput');
            const charCount = document.getElementById('charCount');

            if (!selectedFile || !selectedFile.type.startsWith('image/')) {
                return showToast(TRANSLATIONS[currentLang].ai_unsupported);
            }

            // Cập nhật Prompt: Nhấn mạnh giới hạn nghiêm ngặt
            const prompt = "Viết một caption hài hước, ngắn gọn cho ảnh này. BẮT BUỘC dưới 100 ký tự. Không dùng ngoặc kép.";
            
            const btn = document.getElementById('aiMagicBtn');
            const originalIcon = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            input.placeholder = "AI đang nghĩ...";
            input.value = ""; 

            try {
                let result = await callGemini(prompt, img.src);
                
                // --- CHỐT CHẶN CUỐI CÙNG: ÉP CỨNG 100 KÝ TỰ ---
                if (result.length > 100) {
                    result = result.substring(0, 100); 
                }

                let i = 0;
                const typeInterval = setInterval(() => {
                    input.value += result.charAt(i);
                    if (charCount) {
                        charCount.textContent = `${input.value.length}/100`;
                    }
                    i++;
                    if (i >= result.length) {
                        clearInterval(typeInterval);
                    }
                }, 30);
            } catch (e) { 
                showToast("AI Busy!"); 
            } finally { 
                btn.innerHTML = originalIcon; 
                input.placeholder = TRANSLATIONS[currentLang].placeholder_caption; 
            }
        }

        async function performAIAction(prompt, iconSelector, targetType) {
            const imgPreview = document.getElementById('imagePreview');
            const captionInput = document.getElementById('captionInput');
            if (!imgPreview.src || imgPreview.src.length < 100) return showToast("Chọn ảnh trước");
            const btnIcon = document.querySelector(iconSelector);
            const btn = btnIcon.parentNode;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            if(targetType === 'input') captionInput.placeholder = TRANSLATIONS[currentLang].ai_thinking;
            try {
                let result = await callGemini(prompt, imgPreview.src);
                if (result.length > 100) result = result.substring(0, 97) + "..."; 
                if (targetType === 'input') {
                    captionInput.value = "";
                    let i = 0;
                    const typeInterval = setInterval(() => {
                        captionInput.value += result.charAt(i); i++;
                        if (i > result.length) clearInterval(typeInterval);
                    }, 30);
                }
            } catch (e) { showToast("AI Busy!"); } 
            finally { btn.innerHTML = originalIcon; if(targetType === 'input') captionInput.placeholder = TRANSLATIONS[currentLang].placeholder_caption; }
        }

        async function requestAnalyzePost(postId, btnElement) {
            // 1. XÁC ĐỊNH NÚT BẤM (QUAN TRỌNG)
            // Ưu tiên lấy nút được truyền vào qua biến 'this' (btnElement)
            // Nếu không có (undefined), mới tìm theo ID (cách cũ - dễ lỗi khi trùng ID)
            const btn = btnElement || document.getElementById(`analyze-btn-${postId}`);
            
            if (!btn) return; // Nếu không tìm thấy nút thì dừng

            // 2. TÌM DỮ LIỆU BÀI VIẾT
            // Tìm trong cache bài viết gần đây
            let post = recentPostsCache.find(p => p.id === postId);

            // [Fallback] Nếu đang xem trong chế độ Mini Preview hoặc Single Post mà chưa có trong cache
            // (Trường hợp mở từ thông báo hoặc deep link)
            if (!post && typeof currentMiniPost !== 'undefined' && currentMiniPost && currentMiniPost.id === postId) {
                post = currentMiniPost;
            }

            // Kiểm tra tính hợp lệ
            if (!post || !post.imageUrl || post.mediaType !== 'image') {
                showToast("Chỉ hỗ trợ phân tích hình ảnh!");
                return;
            }
            
            // 3. HIỆU ỨNG LOADING
            // Lưu lại nội dung cũ của nút (để khôi phục nếu lỗi)
            const originalContent = btn.innerHTML;
            
            // Đổi icon thành vòng xoay và chặn click
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
            btn.classList.add('pointer-events-none');
            
            try {
        const prompt = "Mô tả ngắn gọn nội dung ảnh này.";
        const result = await callGemini(prompt, post.imageUrl);

        // --- BƯỚC 1: GHI VÀO SỔ NHỚ (Để vào Full Mode không bị mất) ---
        if(!window.aiMemory) window.aiMemory = {};
        window.aiMemory[postId] = result; 

        // --- BƯỚC 2: LƯU VÀO DATABASE RIÊNG TƯ (Để tắt máy mở lại vẫn còn) ---
        const userId = currentUser.uid || currentUser.username;
        const analysisId = `${postId}_${userId}`;
        await db.collection('artifacts').doc(appId)
            .collection('public').doc('data')
            .collection('ai_results').doc(analysisId)
            .set({ 
                result: result, 
                userId: userId, 
                postId: postId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp() 
            });

        // --- BƯỚC 3: VẼ LẠI GIAO DIỆN NGAY LẬP TỨC (Để người dùng xem luôn) ---
        const allContainers = document.querySelectorAll(`.ai-sync-container-${postId}`);

        // Nếu không tìm thấy class (trường hợp cũ), fallback về ID
        if (allContainers.length === 0) {
            const fallbackContainer = document.getElementById(`ai-section-container-${postId}`) || btn.parentElement;
            if(fallbackContainer) allContainers = [fallbackContainer];
        }

        // Duyệt qua tất cả các nơi (List chính, FriendZone, Fullmode) và cập nhật cùng lúc
        allContainers.forEach(container => {
            container.className = `pb-2 ai-sync-container-${postId}`; // Giữ lại class để đồng bộ tiếp
            container.innerHTML = `
                <div class="mt-3 bg-black/40 rounded-2xl p-4 border border-white/5 relative mx-1 animate-fade-in">
                    <div class="flex justify-between cursor-pointer" onclick="toggleAISummary('${postId}', this)">
                        <div class="flex gap-2 items-center">
                            <i class="fa-solid fa-wand-magic-sparkles text-app-gold text-xs"></i>
                            <span class="text-[10px] uppercase font-black text-app-gold">AI Phân tích</span>
                        </div>
                        <i class="fa-solid fa-chevron-down text-gray-500 text-xs rotate-180" id="ai-chevron-${postId}"></i>
                    </div>
                    <div id="ai-content-${postId}">
                        <p class="text-xs text-gray-300 leading-relaxed italic mt-2 pl-3 border-l-2 border-app-gold/30">"${result}"</p>
                    </div>
                </div>`;
        });

            
            } catch (e) { 
                // 6. XỬ LÝ LỖI
                console.error("AI Error:", e);
                
                // Hiện thông báo lỗi lên nút
                btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Lỗi';
                
                // Sau 2 giây, trả lại trạng thái nút ban đầu để người dùng bấm lại
                setTimeout(() => {
                    btn.innerHTML = originalContent; 
                    btn.classList.remove('pointer-events-none');
                }, 2000);
            }
        }

        function toggleAISummary(postId, triggerEl) {
            // FIX: Tìm phần tử content dựa trên vị trí nút bấm (triggerEl) thay vì ID toàn cục
            let content, chevron;

            if (triggerEl) {
                // Tìm ngược lên cha (container) rồi tìm xuống con
                const wrapper = triggerEl.closest('.bg-black\\/40'); 
                if (wrapper) {
                    content = wrapper.querySelector(`[id^="ai-content-"]`);
                    chevron = wrapper.querySelector(`[id^="ai-chevron-"]`);
                }
            }

            // Fallback cho trường hợp cũ
            if (!content) content = document.getElementById(`ai-content-${postId}`);
            if (!chevron) chevron = document.getElementById(`ai-chevron-${postId}`);

            if (content) { 
                content.classList.toggle('hidden'); 
                if (chevron) chevron.classList.toggle('rotate-180'); 
            }
        }

        // --- CẬP NHẬT: THÊM THAM SỐ isFriendZone Ở CUỐI ---
        // --- THAY THẾ TOÀN BỘ HÀM openComments BẰNG ĐOẠN NÀY ---
        // --- BƯỚC 2: HÀM OPEN COMMENTS (ĐẦY ĐỦ) ---
        // --- [BẢO MẬT] HÀM MỞ BÌNH LUẬN ĐÃ ĐƯỢC VÁ LỖI ---
        
        async function openComments(postId, redHighlightId = null, yellowHighlightId = null, isFriendZone = false) {
            currentPostIdForComments = postId;
            
            // --- BƯỚC 1: LẤY DỮ LIỆU BÀI ĐĂNG & KIỂM TRA BẢO MẬT ---
            let postData = recentPostsCache.find(p => p.id === postId);
            try {
                if (!postData) {
                    const postDoc = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('posts').doc(postId).get();
                    if (postDoc.exists) postData = { id: postDoc.id, ...postDoc.data() };
                }
                // Logic kiểm tra quyền xem (Giữ nguyên như cũ)
                if (postData && postData.community === 'FRIEND_ZONE' && postData.authorId !== currentUser.username) {
                    const relationId = getRelationId(currentUser.username, postData.authorId);
                    const relDoc = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('relationships')
                        .doc(relationId).get();
                    const isRealtimeFriend = relDoc.exists && relDoc.data().status === 'accepted';
                    if (!isRealtimeFriend) {
                        showToast("⛔ Không thể xem bình luận: Hai người không còn là bạn bè.");
                        closeSinglePost(); 
                        return;
                    }
                    let isAllowedBySettings = false;
                    if (!postData.allowedViewers || postData.allowedViewers.length === 0) isAllowedBySettings = true;
                    else if (postData.allowedViewers.includes('ALL')) isAllowedBySettings = true;
                    else if (postData.allowedViewers.includes(currentUser.username)) isAllowedBySettings = true;
                    if (!isAllowedBySettings) {
                        showToast("⛔ Bạn không có quyền xem bình luận này.");
                        closeSinglePost();
                        return;
                    }
                }
            } catch (e) { console.error("Lỗi kiểm tra bảo mật comment:", e); return; }

            // [MỚI] Xác định xem người dùng hiện tại có phải chủ bài đăng không
            const isPostAuthor = postData && postData.authorId === currentUser.username;

            cancelReply(); 
            prepareFriendsForTagging();
            
            document.getElementById('commentModal').classList.remove('hidden');
            document.getElementById('commentsList').innerHTML = '<div class="text-center text-gray-500 text-xs py-4"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            
            if (commentsUnsubscribe) commentsUnsubscribe();
            
            commentsUnsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments')
                .where('postId', '==', postId).onSnapshot(snapshot => {
                    const list = document.getElementById('commentsList'); 
                    list.innerHTML = '';
                    
                    let allComments = [];
                    snapshot.forEach(doc => allComments.push({id: doc.id, ...doc.data()}));
                    
                    if (allComments.length === 0) {
                        const emptyText = "Chưa có bình luận";
                        list.innerHTML = `<div class="text-center text-gray-500 text-xs py-10 opacity-50"><i class="fa-regular fa-comment-dots text-3xl mb-2"></i><br>${emptyText}</div>`;
                        return;
                    }

                    const rootComments = allComments.filter(c => !c.replyToId).sort((a, b) => a.timestamp - b.timestamp);
                    const replyComments = allComments.filter(c => c.replyToId);

                    let targetElementRed = null; 
                    let targetElementYellow = null;

                    const renderSingleComment = (c, isReply) => {
                        const div = document.createElement('div');
                        
                        let highlightClass = '';
                        if (redHighlightId && c.id === redHighlightId) {
                            highlightClass = 'comment-highlight-red bg-red-500/10';
                            div.id = `comment-${c.id}`;
                            targetElementRed = div;
                        } 
                        else if (yellowHighlightId && c.id === yellowHighlightId) {
                            highlightClass = 'comment-highlight bg-app-gold/10';
                            div.id = `comment-${c.id}`;
                            targetElementYellow = div;
                        }

                        const indentClass = isReply ? 'ml-12 mt-1 relative before:content-[""] before:absolute before:-left-4 before:top-0 before:bottom-1/2 before:w-3 before:border-l before:border-b before:border-gray-700 before:rounded-bl-xl' : 'mb-3';
                        
                        div.className = `flex gap-3 items-start animate-fade-in p-1 rounded-2xl transition-all group/comment ${highlightClass} ${indentClass}`;

                        // Avatar logic (Giữ nguyên)
                        let avatar;
                        const avatarSize = isReply ? "w-6 h-6 text-[10px]" : "w-8 h-8 text-xs";
                        if (c.userAvatar) avatar = `<img src="${c.userAvatar}" class="${avatarSize} rounded-full object-cover">`;
                        else if (c.isGuest) avatar = `<div class="${avatarSize} rounded-full bg-gray-800 flex items-center justify-center text-white border border-gray-700"><i class="fa-solid fa-user-secret"></i></div>`;
                        else avatar = `<div class="${avatarSize} rounded-full bg-gray-700 flex items-center justify-center font-bold text-white">${c.userName.charAt(0).toUpperCase()}</div>`;
                        
                        const likes = c.likes || [];
                        const isLiked = likes.some(l => l.uid === currentUser.username);
                        const realCommentLikeCount = likes.filter(l => !l.isGuest).length;
                        
                        const profileFunc = isFriendZone ? 'viewFriendZoneProfile' : 'viewUserProfile';
                        const profileAction = `document.getElementById('commentModal').classList.add('hidden'); ${profileFunc}('${c.userId}')`;

                        let contentHTML = '';
                        let menuButtonHTML = '';
                        let actionsHTML = '';

                        // Logic hiển thị nội dung
                        // --- TÌM ĐOẠN NÀY TRONG HÀM openComments -> renderSingleComment VÀ THAY THẾ ---

                        // Logic hiển thị nội dung
                        if (c.isDeleted) {
                            // 1. Khai báo biến mặc định (QUAN TRỌNG: Phải có dòng này)
                            let deletedText = "Bình luận này đã bị xóa";

                            // 2. Kiểm tra xem có phải chủ bài viết xóa không?
                            // Điều kiện: Có người xóa (c.deletedBy) VÀ người xóa là chủ bài viết (postData.authorId)
                            if (c.deletedBy && postData && c.deletedBy === postData.authorId && c.deletedBy !== c.userId) {
                                deletedText = "Chủ bài viết đã xóa bình luận này";
                            }

                            // 3. Gán nội dung vào HTML
                            contentHTML = `<span class="italic text-gray-500 text-xs">${deletedText}</span>`;
                            
                            menuButtonHTML = ''; // Đã xóa thì ẩn menu
                            
                            actionsHTML = `
                                <div class="flex items-center gap-3 px-2 h-4">
                                    <p class="text-[9px] text-gray-600 font-bold">${timeAgo(c.timestamp)}</p>
                                </div>`;
                        } else {
                            // ... (Phần 'else' hiển thị bình luận bình thường GIỮ NGUYÊN không được xóa) ...
                            // Nếu bạn lỡ xóa phần else, hãy báo tôi để tôi gửi lại đầy đủ.
                            // [LOGIC MỚI VỀ QUYỀN HẠN]
                            const isMyComment = currentUser && c.userId === currentUser.username;
                            
                            // Hiển thị menu nếu là chủ bình luận HOẶC chủ bài đăng
                            const showMenu = isMyComment || isPostAuthor;

                            if (showMenu) {
                                // Tạo các nút trong menu tùy theo quyền
                                let menuItems = `
                                    <button onclick="copyCommentText('${c.text.replace(/'/g, "\\'")}')"><i class="fa-regular fa-copy mr-2"></i>Sao chép</button>
                                `;

                                // Nút Sửa: Chỉ chủ bình luận mới được sửa
                                if (isMyComment) {
                                    menuItems += `<button onclick="enableEditComment('${c.id}', '${c.text.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pen mr-2"></i>Chỉnh sửa</button>`;
                                }

                                // Nút Xóa: Chủ bình luận HOẶC Chủ bài đăng đều được xóa
                                // (Vì đã check showMenu ở trên nên chắc chắn 1 trong 2 là true)
                                menuItems += `<button onclick="deleteCommentAction('${c.id}', '${c.postId}')" class="delete-btn"><i class="fa-solid fa-trash mr-2"></i>Xóa</button>`;

                                menuButtonHTML = `
                                    <button onclick="toggleCommentMenu(event, '${c.id}')" class="opacity-100 transition-opacity text-gray-500 hover:text-white px-2">
                                        <i class="fa-solid fa-ellipsis-vertical text-xs"></i>
                                    </button>
                                    <div id="menu-content-${c.id}" class="hidden">
                                        ${menuItems}
                                    </div>
                                `;
                            } else {
                                // Nếu không có quyền sửa/xóa, chỉ hiện nút copy khi hover
                                menuButtonHTML = `
                                    <button onclick="copyCommentText('${c.text.replace(/'/g, "\\'")}')" class="opacity-100 transition-opacity text-gray-500 hover:text-white px-2" title="Sao chép">
                                        <i class="fa-regular fa-copy text-xs"></i>
                                    </button>
                                `;
                            }

                            const editedLabel = c.isEdited ? `<span class="text-[8px] text-gray-500 italic ml-1">(đã sửa)</span>` : '';
                            contentHTML = `<span id="comment-content-${c.id}" class="text-gray-200">${formatCommentText(c.text, isFriendZone)}</span>${editedLabel}`;

                            actionsHTML = `
                                <div class="flex items-center gap-3 px-2">
                                    <p class="text-[9px] text-gray-500 font-bold">${timeAgo(c.timestamp)}</p>
                                    
                                    <div class="flex items-center gap-1 cursor-pointer group/like">
                                        <button onclick="toggleCommentLike('${c.id}', ${JSON.stringify(likes).replace(/"/g, '&quot;')})" class="text-[10px] font-bold hover:scale-125 transition-transform ${isLiked ? 'text-red-500' : 'text-gray-400 group-hover/like:text-red-500'}">Thích</button>
                                        
                                        <div class="flex items-center gap-0.5 bg-gray-800/50 px-1.5 py-0.5 rounded-full hover:bg-gray-700 transition-colors" onclick='showLikesList(${JSON.stringify(likes).replace(/"/g, '&quot;')}, ${isFriendZone})'>
                                            <i class="fa-solid fa-heart text-[8px] text-red-500"></i>
                                            <span class="text-[9px] text-white font-bold">${realCommentLikeCount}</span>
                                        </div>
                                    </div>

                                    <button onclick="startReply('${c.id}', '${c.userName}', '${c.userId}')" class="text-[10px] font-bold text-gray-400 hover:text-white transition-colors">Phản hồi</button>
                                </div>`;
                        }

                        div.innerHTML = `
                            <div class="cursor-pointer hover:scale-110 transition-transform shrink-0 z-10" onclick="${profileAction}">
                                ${avatar}
                            </div>

                            <div class="flex flex-col gap-1 w-full min-w-0 relative">
                                <div class="flex items-start gap-2 group-hover/comment:pr-6 transition-all">
                                    <div class="bg-gray-800 rounded-2xl px-3 py-2 text-sm relative w-fit max-w-full break-words">
                                        <span class="font-bold text-app-gold text-xs cursor-pointer hover:underline mr-1" onclick="${profileAction}">
                                            ${c.userName}
                                        </span>
                                        ${contentHTML}
                                    </div>
                                    
                                    <div class="relative mt-2">
                                        ${menuButtonHTML}
                                    </div>
                                </div>

                                ${actionsHTML}
                            </div>`;
                            
                        list.appendChild(div);
                    };

                    const renderRepliesRecursive = (parentId) => {
                        const children = replyComments.filter(r => r.replyToId === parentId).sort((a, b) => a.timestamp - b.timestamp);
                        children.forEach(child => {
                            renderSingleComment(child, true); 
                            renderRepliesRecursive(child.id); 
                        });
                    };

                    rootComments.forEach(parent => {
                        renderSingleComment(parent, false);
                        renderRepliesRecursive(parent.id);
                    });

                    if (targetElementRed) {
                        setTimeout(() => targetElementRed.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
                    } else if (targetElementYellow) {
                        setTimeout(() => targetElementYellow.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
                    }
                });
        }

        // Các hàm hỗ trợ cho Reply
        function startReply(commentId, userName, userId) {
            // Lưu thêm notifyId vào replyState để lát nữa dùng
            replyState = { id: commentId, name: userName, notifyId: userId }; 
            const input = document.getElementById('commentInput');
            input.placeholder = `Đang trả lời ${userName}...`;
            input.focus();
            
            // Hiện nút hủy reply nếu chưa có
            let cancelBtn = document.getElementById('cancelReplyBtn');
            if (!cancelBtn) {
                const container = input.parentNode;
                const div = document.createElement('div');
                div.id = 'replyIndicator';
                div.className = 'absolute bottom-full left-0 w-full bg-gray-800 p-2 text-xs text-gray-400 flex justify-between items-center border-t border-gray-700 rounded-t-xl animate-fade-in';
                div.innerHTML = `<span>Đang trả lời <b class="text-white">${userName}</b></span> <button id="cancelReplyBtn" class="text-white hover:text-red-500 font-bold px-2">✕</button>`;
                container.insertBefore(div, input); // Chèn lên trên input
                
                // Gắn sự kiện hủy
                document.getElementById('cancelReplyBtn').onclick = cancelReply;
                
                // Sửa lại bo góc input cho đẹp
                input.classList.remove('rounded-full');
                input.classList.add('rounded-b-xl', 'rounded-t-none');
            } else {
                // Update text nếu đang reply người khác
                document.getElementById('replyIndicator').querySelector('span').innerHTML = `Đang trả lời <b class="text-white">${userName}</b>`;
            }
        }

        function cancelReply() {
            replyState = null;
            const input = document.getElementById('commentInput');
            if(input) {
                input.placeholder = TRANSLATIONS[currentLang].placeholder_comment;
                input.value = '';
                input.classList.add('rounded-full');
                input.classList.remove('rounded-b-xl', 'rounded-t-none');
            }
            const indicator = document.getElementById('replyIndicator');
            if (indicator) indicator.remove();
        }

        function closeComments() {
            const modal = document.getElementById('commentModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            if (typeof commentsUnsubscribe === 'function') {
                commentsUnsubscribe();
            }
            currentPostIdForComments = null;
        }

        // --- BƯỚC 3: SỬA HÀM GỬI BÌNH LUẬN ---
        // --- BƯỚC 2: SỬA HÀM GỬI BÌNH LUẬN (CHÍNH XÁC KHU VỰC) ---
        async function submitComment() { 
            const input = document.getElementById('commentInput'); 
            const text = input.value.trim(); 
            if (!text || text.length > 1000) {
                if(text.length > 1000) showToast("Bình luận tối đa 800 ký tự!");
                return;
            }
            const suggestBox = document.getElementById('tagSuggestions');

            if (!text || !currentPostIdForComments) return; 
            
            const pid = currentPostIdForComments;
            const isReply = !!replyState;
            const replyData = replyState ? { replyToId: replyState.id, replyToName: replyState.name } : {};
            const savedNotifyId = replyState ? replyState.notifyId : null;

            input.value = ''; 
            if(suggestBox) suggestBox.classList.add('hidden'); 
            cancelReply(); 

            try { 
                const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').add({ 
                    postId: pid, 
                    userId: currentUser.username, 
                    userName: currentUser.displayName, 
                    userAvatar: currentUser.avatarUrl || null, 
                    isGuest: currentUser.isGuest || false, 
                    text: text, 
                    timestamp: Date.now(),
                    ...replyData 
                }); 
                
                // --- [SỬA] Chỉ tăng số đếm nếu KHÔNG PHẢI là khách ---
                if (!currentUser.isGuest) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(pid).update({
                        commentCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
                // ---------------------------------------------------

                // Phần logic gửi thông báo giữ nguyên
                let comm = 'Toàn Cầu';
                let postImg = null;
                let authorId = null;
                let allowedViewers = ['ALL']; 

                let postData = recentPostsCache.find(x => x.id === pid);
                if (!postData) {
                    const postDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(pid).get();
                    if(postDoc.exists) postData = postDoc.data();
                }

                if (postData) {
                    comm = postData.community;
                    postImg = postData.imageUrl;
                    authorId = postData.authorId;
                    if (postData.allowedViewers) allowedViewers = postData.allowedViewers;
                }

                const checkPermission = (targetId) => {
                    if (comm !== 'FRIEND_ZONE') return true; 
                    if (authorId === targetId) return true;  
                    if (allowedViewers.includes('ALL')) return true;
                    if (allowedViewers.includes(targetId)) return true;
                    return false; 
                };

                const mentions = [...text.matchAll(/@([a-zA-Z0-9_]+)/g)].map(m => m[1]);
                const uniqueMentions = [...new Set(mentions)];

                uniqueMentions.forEach(taggedUserId => {
                    if (taggedUserId === currentUser.username) return;
                    const isFriend = friendsForTagging.some(f => f.id === taggedUserId);
                    if (isFriend) {
                        if (checkPermission(taggedUserId)) {
                            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').add({
                                recipientId: taggedUserId,
                                senderId: currentUser.username,
                                senderName: currentUser.displayName,
                                senderAvatar: currentUser.avatarUrl || null,
                                type: 'mention',
                                postId: pid,
                                postImage: postImg,
                                extraInfo: "đã nhắc đến bạn trong bình luận",
                                relatedId: docRef.id,
                                timestamp: Date.now(),
                                isRead: false,
                                community: comm
                            });
                        }
                    }
                });

                if (isReply) {
                    let targetIdToNotify = savedNotifyId;
                    if (!targetIdToNotify) {
                        const originalCommentDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').doc(replyData.replyToId).get();
                        if (originalCommentDoc.exists) targetIdToNotify = originalCommentDoc.data().userId;
                    }

                    if (targetIdToNotify && targetIdToNotify !== currentUser.username && !uniqueMentions.includes(targetIdToNotify)) {
                        if (checkPermission(targetIdToNotify)) {
                            sendNotification(targetIdToNotify, 'reply_comment', pid, postImg, "", docRef.id, replyData.replyToId, comm);
                        }
                    }
                } else {
                    if(authorId && authorId !== currentUser.username && !uniqueMentions.includes(authorId)) {
                        sendNotification(authorId, 'comment', pid, postImg, "", docRef.id, null, comm); 
                    }
                }

            } catch (e) { 
                console.error("Lỗi gửi bình luận:", e); 
                showToast("Có lỗi xảy ra khi gửi bình luận.");
            } 
        }


        // --- BƯỚC 2: SỬA HÀM LIKE BÀI VIẾT ---
        // --- BƯỚC 1: SỬA HÀM LIKE BÀI VIẾT (AN TOÀN HƠN) ---
        async function toggleLike(postId, likes = []) {
            if(!currentUser) return;
            const uid = currentUser.username; 
            const name = currentUser.displayName;
            const avatar = currentUser.avatarUrl || null; 

            const existingIndex = likes.findIndex(l => l.uid === uid);
            let newLikes = [...likes];
            let isAdding = false;
            
            if (existingIndex > -1) {
                newLikes.splice(existingIndex, 1); 
            } else { 
                // --- [SỬA] Thêm cờ isGuest ---
                newLikes.push({ 
                    uid, 
                    name, 
                    avatar, 
                    isGuest: currentUser.isGuest // Lưu trạng thái khách
                }); 
                isAdding = true; 
                // ----------------------------
            } 
            
            try { 
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).update({ likes: newLikes }); 
                
                if(isAdding) {
                    let comm = 'Toàn Cầu'; 
                    let postImg = null;
                    let authorId = null;

                    const p = recentPostsCache.find(x => x.id === postId); 
                    
                    if(p) {
                        comm = p.community;
                        postImg = p.imageUrl;
                        authorId = p.authorId;
                    } else {
                        const docSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).get();
                        if (docSnap.exists) {
                            const data = docSnap.data();
                            comm = data.community;
                            postImg = data.imageUrl;
                            authorId = data.authorId;
                        }
                    }

                    if (authorId) {
                        sendNotification(authorId, 'like', postId, postImg, "", null, null, comm);
                    }
                }
            } catch(e) { console.error("Lỗi Like:", e); }
        }

        // --- BƯỚC 4: SỬA HÀM LIKE BÌNH LUẬN ---
        // --- BƯỚC 3: SỬA HÀM LIKE BÌNH LUẬN ---
        async function toggleCommentLike(commentId, likes = []) {
            if(!currentUser) return;
            const uid = currentUser.username; 
            const name = currentUser.displayName;
            const avatar = currentUser.avatarUrl || null; 

            const existingIndex = likes.findIndex(l => l.uid === uid);
            let newLikes = [...likes];
            let isAdding = false;
            
            if (existingIndex > -1) {
                newLikes.splice(existingIndex, 1); 
            } else { 
                // --- [SỬA] Thêm isGuest ---
                newLikes.push({ 
                    uid, 
                    name, 
                    avatar,
                    isGuest: currentUser.isGuest
                }); 
                isAdding = true; 
                // --------------------------
            } 
            
            try { 
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').doc(commentId).update({ likes: newLikes }); 
                
                if(isAdding) {
                    const commentDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').doc(commentId).get();
                    if(commentDoc.exists) {
                        const cData = commentDoc.data();
                        
                        let comm = 'Toàn Cầu';
                        const p = recentPostsCache.find(x => x.id === cData.postId);
                        
                        if(p) {
                            comm = p.community;
                        } else {
                            const postDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(cData.postId).get();
                            if(postDoc.exists) comm = postDoc.data().community;
                        }

                        if(cData.userId !== currentUser.username) {
                            sendNotification(cData.userId, 'like_comment', cData.postId, null, "bình luận", commentId, null, comm);
                        }
                    }
                }
            } catch(e) { console.error(e); }
        }

        // --- CẬP NHẬT: THÊM THAM SỐ isFriendZone ---
        function showLikesList(likes = [], isFriendZone = false) {
            const modal = document.getElementById('likesModal'); 
            const list = document.getElementById('likesList'); 
            list.innerHTML = '';
            
            if(likes.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 text-xs py-4">Chưa có ai tim.</p>';
            } else {
                likes.forEach(user => {
                    const div = document.createElement('div'); 
                    div.className = 'flex items-center gap-3 py-3 border-b border-gray-800 animate-fade-in';
                    
                    let avatarHTML;
                    if (user.avatar) {
                        avatarHTML = `<img src="${user.avatar}" class="w-10 h-10 rounded-full object-cover border border-gray-600">`;
                    } else if (user.uid && user.uid.startsWith('guest_')) {
                        avatarHTML = `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-white border border-gray-700"><i class="fa-solid fa-user-secret"></i></div>`;
                    } else {
                        avatarHTML = `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-bold text-white">${user.name.charAt(0).toUpperCase()}</div>`;
                    }

                    // --- QUAN TRỌNG: Kiểm tra đang ở đâu để mở Profile phù hợp ---
                    const profileFunc = isFriendZone ? 'viewFriendZoneProfile' : 'viewUserProfile';
                    // SỬA: Đóng thêm cả 'commentModal' để Album không bị chìm
                    const clickAction = `document.getElementById('likesModal').classList.add('hidden'); document.getElementById('commentModal').classList.add('hidden'); ${profileFunc}('${user.uid}')`;

                    div.innerHTML = `
                        <div class="cursor-pointer hover:scale-110 transition-transform" onclick="${clickAction}">
                            ${avatarHTML}
                        </div>
                        
                        <div class="flex flex-col justify-center">
                            <span class="text-sm font-bold text-white cursor-pointer hover:underline hover:text-app-gold transition-colors" onclick="${clickAction}">
                                ${user.name}
                            </span>
                        </div>`;
                    
                    list.appendChild(div);
                });
            }
            modal.classList.remove('hidden');
        }

        let lastTap = 0;
        function handleMediaTap(e, postId, likes) {
            const currentTime = new Date().getTime(); const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                toggleLike(postId, likes);
                const container = e.currentTarget;
                const heart = document.createElement('i');
                heart.className = 'fa-solid fa-heart double-tap-heart'; 
                container.appendChild(heart);
                setTimeout(() => heart.remove(), 1000);
            } 
            else {
                const container = e.currentTarget;
                if (!container) return;
                const media = container.querySelector('video, audio');
                if(media) {
                    if (media.ended) {
                        media.currentTime = 0;
                        media.play();
                    } else if (media.paused) {
                        media.play();
                    } else {
                        media.pause();
                    }
                }
            }
            lastTap = currentTime;
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = msg;
            t.classList.remove('opacity-0', '-translate-y-10'); setTimeout(() => t.classList.add('opacity-0', '-translate-y-10'), 3000);
        }

        function requestDelete(id) {
            showConfirm(TRANSLATIONS[currentLang].confirm_title + "?", async () => {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(id).delete();
                showToast("Đã xóa.");
            });
        }

        function showConfirm(msg, onYes) {
            document.getElementById('confirmMessage').textContent = msg; document.getElementById('confirmModal').classList.remove('hidden');
            const btnYes = document.getElementById('confirmYesBtn'); if(!btnYes) return;
            const newBtn = btnYes.cloneNode(true); 
            btnYes.parentNode.replaceChild(newBtn, btnYes);
            newBtn.onclick = () => { onYes(); closeConfirm(); };
        }
        function closeConfirm() { document.getElementById('confirmModal').classList.add('hidden'); }

        async function init() {
            // --- BẮT ĐẦU ĐOẠN CODE CHẶN KHÁCH TRÊN MOBILE ---
            
            // --- THÊM ĐOẠN NÀY VÀO ĐẦU HÀM ---
            // Nếu chưa từng chỉnh màu (Khách, Mới đăng ký) -> Tự động chọn 'midnight' (Đen)
            const savedTheme = localStorage.getItem('lm_theme') || 'midnight';
            changeTheme(savedTheme);
            setLanguage(); // Luôn set tiếng Việt
            
            const uploadSelect = document.getElementById('uploadCommunitySelect'); const mapSelect = document.getElementById('mapSelect');
            if (uploadSelect.options.length === 0) {
                CONTINENTS.forEach(c => {
                   const opt1 = document.createElement('option'); opt1.value = c; opt1.text = c; 
                   if(c === "Toàn Cầu") opt1.selected = true; uploadSelect.appendChild(opt1);
                   const opt2 = document.createElement('option'); opt2.value = c; opt2.text = c; mapSelect.appendChild(opt2);
                });
                setLanguage();
            }

            if (document.getElementById('configErrorMsg').innerHTML) return;
            
            feedObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const media = entry.target;
                    if (!entry.isIntersecting) {
                        if (!media.paused) media.pause();
                    }
                });
            }, { threshold: 0.5 }); 

            // --- PULL TO REFRESH LOGIC ---
            const homeBtn = document.getElementById('homeBtn');
            const pullIndicator = document.getElementById('pullRefreshIndicator');
            let startY = 0;
            let isDragging = false;
            let lastHomeTap = 0; // <--- THÊM DÒNG NÀY ĐỂ CHECK CLICK ĐÚP
            const threshold = 80;

            const handleStart = (y) => {
                startY = y;
                isDragging = false;
                pullIndicator.style.transition = 'none'; // Remove transition for instant drag follow
            };

            const handleMove = (y) => {
                const deltaY = y - startY;
                if (deltaY < -10) { // Dragging Up
                    isDragging = true;
                    // Visual Feedback
                    const pullDistance = Math.min(Math.abs(deltaY), 150); // Cap at 150px
                    const opacity = Math.min(pullDistance / threshold, 1);
                    
                    pullIndicator.style.transform = `translate(-50%, -${pullDistance}px) scale(${opacity})`;
                    pullIndicator.style.opacity = opacity;
                    pullIndicator.querySelector('i').style.transform = `rotate(${pullDistance * 2}deg)`;
                }
            };

            const handleEnd = (y) => {
                const deltaY = y - startY;
                pullIndicator.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                if (isDragging && deltaY < -threshold) {
                    // TRƯỜNG HỢP 1: VUỐT MẠNH LÊN (Giữ nguyên logic cũ)
                    const icon = pullIndicator.querySelector('i');
                    icon.classList.add('fa-spin');
                    pullIndicator.style.transform = `translate(-50%, -${threshold}px) scale(1.2)`;
                    pullIndicator.style.opacity = '1';
                    
                    refreshFeed();
                    
                    setTimeout(() => {
                        icon.classList.remove('fa-spin');
                        pullIndicator.style.opacity = '0';
                        pullIndicator.style.transform = 'translate(-50%, 0) scale(0)';
                    }, 1000);

                } else if (!isDragging || deltaY > -10) {
                    // TRƯỜNG HỢP 2: CLICK (TAP)
                    
                    const now = Date.now();
                    // Nếu khoảng cách giữa 2 lần bấm nhỏ hơn 300ms -> Là Click Đúp
                    if (now - lastHomeTap < 300) {
                        // --- XỬ LÝ CLICK ĐÚP: Refresh + Hiệu ứng ---
                        
                        // 1. Tạo hiệu ứng xoay cho icon ngôi nhà
                        const homeIcon = homeBtn.querySelector('i');
                        homeIcon.classList.add('fa-spin'); 
                        setTimeout(() => homeIcon.classList.remove('fa-spin'), 1000);

                        // 2. Load lại feed
                        refreshFeed();
                        
                    } else {
                        // --- XỬ LÝ CLICK ĐƠN: Lướt lên đầu ---
                        scrollToTop();
                    }
                    
                    // Cập nhật lại thời gian bấm
                    lastHomeTap = now;

                    // Reset indicator (ẩn cái nút tròn vàng đi nếu lỡ hiện ra chút xíu)
                    pullIndicator.style.opacity = '0';
                    pullIndicator.style.transform = 'translate(-50%, 0) scale(0)';
                } else {
                    // Kéo chưa đủ lực thì ẩn đi
                    pullIndicator.style.opacity = '0';
                    pullIndicator.style.transform = 'translate(-50%, 0) scale(0)';
                }
            };

            // Touch Events (Mobile)
            homeBtn.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientY), {passive: true});
            homeBtn.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientY), {passive: true});
            homeBtn.addEventListener('touchend', (e) => handleEnd(e.changedTouches[0].clientY));

            // Mouse Events (Desktop)
            homeBtn.addEventListener('mousedown', (e) => handleStart(e.clientY));
            window.addEventListener('mousemove', (e) => { if(startY) handleMove(e.clientY); }); // Listen on window to catch drags outside button
            window.addEventListener('mouseup', (e) => { 
                if(startY) { 
                    handleEnd(e.clientY); 
                    startY = 0; // Reset
                }
            });
            // -----------------------------

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
                else await auth.signInAnonymously();
                auth.onAuthStateChanged(user => {
                    if (user) {
                        isConnected = true; document.getElementById('loadingScreen').classList.add('hidden');
                        const saved = localStorage.getItem('lm_user');
                        if (saved) { currentUser = JSON.parse(saved); enterApp(); }
                        else document.getElementById('authScreen').classList.remove('hidden');
                    }
                });
            } catch (e) { document.getElementById('loadingText').textContent = "ERROR"; }
        }

        function enterApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            currentCommunity = 'Toàn Cầu';
            const uploadSelect = document.getElementById('uploadCommunitySelect');
            if(uploadSelect) uploadSelect.value = 'Toàn Cầu';
            
            updateUI(); 
            setLanguage();
            subscribeToFeed();
            subscribeToNotifications(); 
            
            // --- THÊM DÒNG NÀY VÀO ĐÂY ---
            subscribeToFZNotifications(); 
            // ----------------------------

            startRelationshipMonitor();

            monitorCurrentUser();
        }

        async function handleGuestLogin() {
            // 1. Kiểm tra xem có phải điện thoại không
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            // 2. Nếu là điện thoại -> Hiện thông báo và CHẶN luôn
            if (isMobile) {
                showToast("Chế độ Khách chỉ dành cho Máy tính!");
                return; // Dừng lại, không cho đăng nhập
            }

            // 3. Nếu là máy tính -> Chạy tiếp code đăng nhập như bình thường
            if (!isConnected) return;
            const username = `guest_${Date.now()}`;
            const user = { username: username, displayName: `G${Math.floor(Math.random()*1000)}`, password: "", isGuest: true, avatarUrl: null };
            try {
                const userRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(username);
                await userRef.set(user); loginSuccess({ username, ...user });
            } catch(e) { loginSuccess(user); }
        }

        // --- LOGIC CHỌN AVATAR SAU ĐĂNG KÝ ---
        let pendingUser = null;         // Lưu tạm thông tin user vừa đăng ký
        let pendingAvatarBase64 = null; // Lưu tạm ảnh avatar vừa chọn

        // 1. Xem trước ảnh khi chọn
        function handleRegAvatarPreview(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                // Nén ảnh sơ bộ bằng Canvas để giảm dung lượng (giống logic cũ)
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas');
                    const ctx = c.getContext('2d');
                    c.width = 150; // Resize về 150x150
                    c.height = 150;
                    ctx.drawImage(img, 0, 0, 150, 150);
                    
                    pendingAvatarBase64 = c.toDataURL('image/jpeg', 0.6); // Chất lượng 60%
                    
                    // Hiển thị ra giao diện
                    document.getElementById('regAvatarPreview').innerHTML = `<img src="${pendingAvatarBase64}" class="w-full h-full object-cover">`;
                }
            };
            reader.readAsDataURL(file);
        }

        // 2. Lưu ảnh và vào App
        async function saveAndEnterApp() {
            if (!pendingUser) return;
            
            // --- THÊM ĐOẠN KIỂM TRA NÀY ---
            // Nếu chưa có dữ liệu ảnh, báo lỗi và dừng lại ngay (return)
            if (!pendingAvatarBase64) {
                document.getElementById('authError').textContent = "Bạn chưa chọn ảnh nào cả! Hãy chọn ảnh hoặc nhấn nút 'Bỏ qua'.";
                return; // Lệnh này quan trọng nhất: nó ngăn code chạy tiếp xuống dưới
            }
            // ------------------------------
            
            // Đoạn dưới giữ nguyên: Nếu có ảnh thì lưu
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                    .doc(pendingUser.username).update({ avatarUrl: pendingAvatarBase64 });
                
                // Cập nhật object cục bộ
                pendingUser.avatarUrl = pendingAvatarBase64;
            } catch (e) {
                console.error("Lỗi lưu avatar:", e);
            }
            
            // Chỉ chạy đến đây nếu đã qua được cửa kiểm tra ở trên
            completeRegistrationProcess();
        }

        // 3. Bỏ qua và vào App
        function skipAndEnterApp() {
            if (!pendingUser) return;
            completeRegistrationProcess();
        }

        // 4. Hoàn tất chung
        function completeRegistrationProcess() {
            loginSuccess(pendingUser, "Chào mừng thành viên mới! 🎉");
            
            // Reset giao diện về mặc định
            pendingUser = null;
            pendingAvatarBase64 = null;
            document.getElementById('avatarSetupForm').classList.add('hidden');
            document.getElementById('regAvatarPreview').innerHTML = '<i class="fa-solid fa-camera text-3xl text-gray-500 group-hover:text-app-gold transition-colors"></i>';
            // Không cần hiện lại registerForm vì loginSuccess sẽ ẩn toàn bộ authScreen
        }

        async function handleRegister() {
            const regUsernameInput = document.getElementById('regUsername');
            const usernameRaw = regUsernameInput.value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const errorDisplay = document.getElementById('authError');

            // 1. Tên hiển thị (Max 9)
            if (name.length > 9) {
                errorDisplay.textContent = "Tên hiển thị không được quá 9 ký tự!";
                return;
            }

            // 2. Tên đăng nhập (Max 15, không dấu, không cách)
            // Regex này chặn đứng mọi ký tự có dấu và ký tự đặc biệt
            const usernameRegex = /^[a-zA-Z0-9]+$/;
            
            if (usernameRaw.length > 15) {
                errorDisplay.textContent = "Tên đăng nhập tối đa 15 ký tự!";
                return;
            }

            if (usernameRaw.includes(' ')) {
                errorDisplay.textContent = "Tên đăng nhập phải viết liền, không khoảng trắng!";
                return;
            }

            if (!usernameRegex.test(usernameRaw)) {
                errorDisplay.textContent = "Tên đăng nhập không được có dấu hoặc ký tự đặc biệt!";
                return;
            }

            const username = usernameRaw.toLowerCase(); // Chuyển về chữ thường để check
            try {
                const banRef = db.collection('artifacts').doc(appId)
                    .collection('public').doc('data')
                    .collection('blacklisted_usernames').doc(username);
                
                const banDoc = await banRef.get();
                if (banDoc.exists) {
                    errorDisplay.textContent = "Tên đăng nhập này đã bị khóa vĩnh viễn (do chủ cũ đã xóa)!";
                    return; // Dừng lại ngay, không cho đăng ký
                }
            } catch (e) {
                console.error("Lỗi check ban:", e);
            }
            // --- [KẾT THÚC CODE MỚI] ---

            // 3. Mật khẩu (Min 4)
            if (password.length < 4) {
                errorDisplay.textContent = "Mật khẩu phải từ 4 ký tự trở lên!";
                return;
            }

            if (!name || !usernameRaw || !password) {
                errorDisplay.textContent = "Vui lòng điền đủ thông tin!";
                return;
            }

            try {
                const username = usernameRaw.toLowerCase();
                const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(username);
                const doc = await ref.get();
                
                if (doc.exists) {
                    errorDisplay.textContent = "Tên đăng nhập này đã bị người khác sử dụng!";
                    return;
                }
                
                const user = { 
                    displayName: name, 
                    password: password, 
                    joined: Date.now(), 
                    isGuest: false, 
                    avatarUrl: null,
                    theme: 'midnight'
                };
                
                await ref.set(user); 
                pendingUser = { username, ...user }; // Lưu tạm user
                
                // Chuyển đổi giao diện
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('avatarSetupForm').classList.remove('hidden');
                errorDisplay.textContent = ""; // Xóa lỗi nếu có
            } catch (e) { 
                errorDisplay.textContent = "Lỗi kết nối. Vui lòng thử lại!"; 
            }
        }

        async function handleLogin() {
            // Tự động loại bỏ khoảng trắng và chuyển về chữ thường để khớp với Database
            const usernameRaw = document.getElementById('loginUsername').value;
            const username = usernameRaw.trim().toLowerCase().replace(/\s/g, '');
            const password = document.getElementById('loginPassword').value.trim();
            const errorDisplay = document.getElementById('authError');

            if (!username || !password) {
                errorDisplay.textContent = "Vui lòng nhập tên đăng nhập và mật khẩu!";
                return;
            }

            // Chặn ngay nếu người dùng cố tình nhập quá 15 ký tự (phòng trường hợp dùng tool)
            if (username.length > 15) {
                errorDisplay.textContent = "Tên đăng nhập không hợp lệ!";
                return;
            }

            try {
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(username).get();
                
                if (!doc.exists || doc.data().password !== password) {
                    errorDisplay.textContent = "Tài khoản không tồn tại hoặc sai mật khẩu!";
                    return;
                }
                
                loginSuccess({ username, ...doc.data() }, "Mừng bạn quay trở lại! ❤️");
            } catch (e) { 
                console.error(e);
                errorDisplay.textContent = "Lỗi kết nối mạng!"; 
            }
        }

        function loginSuccess(user, message = "Đăng nhập thành công!") { 
            showToast(message);
            currentUser = user; 
            localStorage.setItem('lm_user', JSON.stringify(user)); 
            
            // 1. Cập nhật ngay khi vào
            updateMyStatus(true); 

            // 2. [MỚI] TẠO NHỊP TIM: Cứ 2 phút cập nhật lastSeen 1 lần
            // Để đảm bảo nếu đang dùng thì luôn Online, còn tắt máy thì sau 5 phút sẽ tự Offline
            if (window.heartbeatInterval) clearInterval(window.heartbeatInterval);
            window.heartbeatInterval = setInterval(() => {
                updateMyStatus(true);
            }, 2 * 60 * 1000); // 2 phút

            // 3. Sự kiện tắt tab
            window.addEventListener('beforeunload', () => {
                updateMyStatus(false);
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') updateMyStatus(true);
                // Không set false ngay khi ẩn tab để tránh nhấp nháy, 
                // hãy để logic "thời gian" tự xử lý
            });
            
            if (user.isGuest) {
            // Ép khách dùng midnight bất kể trước đó họ có lưu gì
            changeTheme('midnight');
            }

            if (user.theme) changeTheme(user.theme);
            else changeTheme('midnight');

            enterApp(); 
        }


        // --- [MỚI] HÀM CẬP NHẬT TRẠNG THÁI ---
        function updateMyStatus(isOnline) {
            if (!currentUser) return;
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                .doc(currentUser.username)
                .update({
                    isOnline: isOnline,
                    lastSeen: Date.now()
                }).catch(err => console.log("Lỗi cập nhật status:", err));
        }

        function requestLogout() {
            // 1. Đóng bảng cài đặt
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) settingsModal.classList.add('hidden');

            // 2. Hiện bảng xác nhận
            showConfirm(TRANSLATIONS[currentLang].btn_logout + "?", async () => {
                // --- [SỬA] BÁO OFFLINE TRƯỚC KHI XÓA USER ---
                if (currentUser) {
                    try {
                        // Cố gắng báo offline lên server
                        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                            .doc(currentUser.username)
                            .update({ 
                                isOnline: false,
                                lastSeen: Date.now() 
                            });
                    } catch (e) {
                        console.log("Lỗi gửi status offline:", e);
                    }
                }
                // ---------------------------------------------

                // Xóa timer nhịp tim
                if (window.heartbeatInterval) clearInterval(window.heartbeatInterval);

                currentUser = null;
                localStorage.removeItem('lm_user');

                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('loadingScreen').classList.remove('hidden');
                document.getElementById('loadingText').textContent = "Đang đăng xuất...";

                // Reload trang
                const baseUrl = window.location.href.split('?')[0].split('#')[0];
                const form = document.createElement('form');
                form.method = 'GET';
                form.action = baseUrl;
                form.style.display = 'none';
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'refresh_timestamp';
                input.value = new Date().getTime();
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            });
        }


        // --- CHỨC NĂNG XÓA TÀI KHOẢN (ĐÃ NÂNG CẤP BẢO MẬT) ---

        // 1. Mở bảng xác nhận & Reset trạng thái nút xóa
        function openDeleteConfirm() {

            if (currentUser && (currentUser.username.startsWith('guest_') || currentUser.isAnonymous)) {
                if (typeof showToast === 'function') {
                    showToast("Tài khoản khách không được phép xóa tài khoản!", "error");
                } else {
                    alert("Tài khoản khách không thể xóa tài khoản!");
                }
                return; // <--- QUAN TRỌNG: Dừng hàm tại đây, không cho chạy tiếp
            }

            // Đóng bảng cài đặt cũ
            document.getElementById('settingsModal').classList.add('hidden');
            
            // --- PHẦN MỚI THÊM: RESET Ô NHẬP & KHÓA NÚT ---
            const input = document.getElementById('confirmDeleteInput');
            const btn = document.getElementById('btnFinalDelete');
            
            if (input && btn) {
                input.value = ''; // Xóa trắng ô nhập cũ
                
                // Khóa nút lại ngay lập tức
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('hover:bg-red-700', 'shadow-lg');
            }
            // ---------------------------------------------

            // Mở bảng cảnh báo đỏ
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        // 2. Hủy xóa - Quay lại cài đặt
        function cancelDelete() {
            document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        // 3. (HÀM MỚI) Kiểm tra xem người dùng đã nhập đúng chữ "XÓA" chưa
        function checkDeleteKey() {
            const input = document.getElementById('confirmDeleteInput');
            const btn = document.getElementById('btnFinalDelete');
            
            if (!input || !btn) return;

            // Lấy chữ người dùng nhập, xóa khoảng trắng thừa, đổi thành CHỮ HOA
            const text = input.value.trim().toUpperCase();

            // So sánh
            if (text === 'PHITAY') {
                // ĐÚNG -> Mở khóa nút
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('hover:bg-red-700', 'shadow-lg'); // Thêm hiệu ứng đẹp
            } else {
                // SAI -> Khóa nút
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('hover:bg-red-700', 'shadow-lg');
            }
        }

        // 4. Thực thi xóa thật (Giữ nguyên logic Firebase của bạn)
        async function executeDeleteAccount() {
            const btn = document.getElementById('btnFinalDelete');
            if (btn.disabled) return;
            if (!currentUser) return;
            if (currentUser.username.startsWith('guest_') || currentUser.isAnonymous) {
                // Đóng modal xác nhận lại (nếu đang mở)
                document.getElementById('deleteConfirmModal').classList.add('hidden');
                
                // Hiện thông báo lỗi
                if (typeof showToast === 'function') {
                    showToast("Tài khoản khách không thể thực hiện chức năng này!", "error");
                } else {
                    alert("Tài khoản khách không thể xóa tài khoản!");
                }
                return; // <--- DỪNG NGAY LẬP TỨC
            }

            const username = currentUser.username;
            const publicPath = db.collection('artifacts').doc(appId).collection('public').doc('data');

            document.getElementById('deleteConfirmModal').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('loadingText').textContent = "ĐANG TRUY QUÉT VÀ DỌN DẸP TOÀN BỘ HỆ THỐNG...";

            try {

                // --- [BẮT ĐẦU CODE MỚI] GHI VÀO SỔ TỬ THẦN ---
                // Lưu lại username này vào collection 'blacklisted_usernames' để không ai dùng lại được
                await publicPath.collection('blacklisted_usernames').doc(username).set({
                    bannedAt: Date.now(),
                    originalName: currentUser.displayName || "Unknown"
                });
                // --- [KẾT THÚC CODE MỚI] ---

                if (typeof handleGroupsBeforeDelete === 'function') {
                    await handleGroupsBeforeDelete(username);
                }

                const deletePromises = [];
                
                // --- 1. XỬ LÝ BÌNH LUẬN ĐA CẤP (QUAN TRỌNG NHẤT) ---
                const myCommentsSnap = await publicPath.collection('comments').where('userId', '==', username).get();
            const postCommentReductions = {};
            
            // [THÊM MỚI]: Biến này giúp tránh đếm trùng lặp
            const processedIds = new Set();

            // Hàm đệ quy thu thập tất cả các phản hồi cấp dưới
            async function collectNestedReplies(parentId, postId) {
                // [ĐÃ SỬA]: Dùng 'replyToId' thay vì 'parentId'
                const replies = await publicPath.collection('comments').where('replyToId', '==', parentId).get();
                
                for (const r of replies.docs) {
                    // [QUAN TRỌNG]: Nếu bình luận này đã được xử lý rồi thì bỏ qua ngay
                    if (processedIds.has(r.id)) continue;
                    
                    processedIds.add(r.id); // Đánh dấu đã xử lý

                    await collectNestedReplies(r.id, postId); // Đệ quy tìm tiếp cấp dưới
                    deletePromises.push(r.ref.delete()); // Xóa phản hồi
                    
                    // Cộng thêm vào số lượng cần trừ
                    postCommentReductions[postId] = (postCommentReductions[postId] || 0) + 1;
                }
            }

            for (const cDoc of myCommentsSnap.docs) {
                // [QUAN TRỌNG]: Nếu comment này đã được xử lý (do là con của comment trước đó) thì bỏ qua vòng lặp này
                if (processedIds.has(cDoc.id)) continue;

                const pid = cDoc.data().postId;
                if (pid) {
                    processedIds.add(cDoc.id); // Đánh dấu comment gốc này là đã xử lý
                    postCommentReductions[pid] = (postCommentReductions[pid] || 0) + 1; // Đếm chính nó
                    await collectNestedReplies(cDoc.id, pid); // Tìm và đếm các con cháu
                }
                deletePromises.push(cDoc.ref.delete());
            }

                // Cập nhật số lượng bình luận bài viết (Trừ một lần duy nhất tổng số đã xóa)
                for (const pid in postCommentReductions) {
                    deletePromises.push(publicPath.collection('posts').doc(pid).update({
                        commentCount: firebase.firestore.FieldValue.increment(-postCommentReductions[pid])
                    }));
                }

                // --- 2. XỬ LÝ LIKE & AVATAR (Mảng Object) ---
                const postsSnap = await publicPath.collection('posts').get();
                postsSnap.forEach(postDoc => {
                    const pData = postDoc.data();
                    if (pData.likes && Array.isArray(pData.likes)) {
                        const newLikes = pData.likes.filter(l => l.uid !== username && l.username !== username);
                        if (newLikes.length !== pData.likes.length) {
                            deletePromises.push(postDoc.ref.update({
                                likes: newLikes,
                                realLikeCount: Math.max(0, (pData.realLikeCount || 0) - (pData.likes.length - newLikes.length))
                            }));
                        }
                    }
                });

                // --- 3. XỬ LÝ BẠN BÈ & NHÓM CHAT (Cập nhật theo thực tế) ---
                const friendsSnap = await publicPath.collection('users').where('friends', 'array-contains', username).get();
                friendsSnap.forEach(fDoc => {
                    const newList = (fDoc.data().friends || []).filter(f => f !== username);
                    deletePromises.push(fDoc.ref.update({
                        friends: newList,
                        simpleFriendCount: newList.length
                    }));
                });

                const groupsSnap = await publicPath.collection('groups').where('members', 'array-contains', username).get();
                groupsSnap.forEach(gDoc => {
                    const newMems = (gDoc.data().members || []).filter(m => m !== username);
                    deletePromises.push(gDoc.ref.update({
                        members: newMems,
                        groupMemberCount: newMems.length
                    }));
                });

                // --- 4. XÓA THÔNG BÁO (Triệt để 2 chiều) ---
                const noti2 = await publicPath.collection('notifications').where('recipientId', '==', username).get();
                noti2.forEach(d => deletePromises.push(d.ref.delete()));

                // --- 5. XÓA BÀI VIẾT, ALBUM & MỐI QUAN HỆ CỦA CHÍNH HỌ ---
                const myPosts = await publicPath.collection('posts').where('authorId', '==', username).get();
                myPosts.forEach(d => deletePromises.push(d.ref.delete()));

                const myAlbums = await publicPath.collection('albums').where('authorId', '==', username).get();
                myAlbums.forEach(d => deletePromises.push(d.ref.delete()));

                const r1 = await publicPath.collection('relationships').where('user1', '==', username).get();
                const r2 = await publicPath.collection('relationships').where('user2', '==', username).get();
                r1.forEach(d => deletePromises.push(d.ref.delete()));
                r2.forEach(d => deletePromises.push(d.ref.delete()));

                // --- THỰC THI TOÀN BỘ DỌN DẸP ---
                await Promise.all(deletePromises);

                // --- BƯỚC CUỐI: XÓA DANH TÍNH USER (Out mọi máy khác) ---
                await publicPath.collection('users').doc(username).delete();

                // Xóa Local Storage và Reload
                localStorage.removeItem('lm_user');
                document.getElementById('loadingText').innerHTML = "<span class='text-green-500'>ĐÃ XÓA SẠCH VĨNH VIỄN DỮ LIỆU!<br>Hẹn gặp lại bạn.</span>";
                
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (e) {
                console.error("Lỗi xóa:", e);
                localStorage.removeItem('lm_user');
                location.reload();
            }
        }



        


    

        function toggleProfile() {
            const modal = document.getElementById('profileModal');
            
            if (modal.classList.contains('hidden')) {
                // MỞ MODAL
                modal.classList.remove('hidden');
                
                // 1. Logic hiển thị Album (Giữ nguyên)
                if (currentUser.isGuest) {
                    document.getElementById('guestAlbumView').classList.remove('hidden');
                    document.getElementById('userAlbumView').classList.add('hidden');
                } else {
                    document.getElementById('guestAlbumView').classList.add('hidden');
                    document.getElementById('userAlbumView').classList.remove('hidden');
                    loadUserAlbum();
                }

                // 2. Logic hiển thị Avatar (Chỉ hiển thị, không click)
                const mAvtText = document.getElementById('modalAvatarText');
                const mAvtImg = document.getElementById('modalAvatarImg');
                
                if (currentUser.avatarUrl) {
                    mAvtText.classList.add('hidden');
                    mAvtImg.src = currentUser.avatarUrl;
                    mAvtImg.classList.remove('hidden');
                } else if (currentUser.isGuest) {
                    mAvtText.innerHTML = '<i class="fa-solid fa-user-secret"></i>';
                    mAvtText.classList.remove('hidden');
                    mAvtImg.classList.add('hidden');
                } else {
                    mAvtText.textContent = currentUser.displayName.charAt(0).toUpperCase();
                    mAvtText.classList.remove('hidden');
                    mAvtImg.classList.add('hidden');
                }

            } else {
                // ĐÓNG MODAL
                modal.classList.add('hidden'); 
            }
        }

        // Hàm mở profile người khác
        async function viewUserProfile(targetUserId) {

            if (friendStatusUnsubscribe) {
                friendStatusUnsubscribe();
                friendStatusUnsubscribe = null;
            }

            // 1. Đóng các cửa sổ khác
            const modalsToClose = ['simpleFriendListModal','searchModal', 'notifModal', 'settingsModal', 'userInfoModal', 'mapModal', 'friendZoneModal', 'friendZoneAlbumModal'];
            modalsToClose.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // 2. Nếu bấm vào chính mình -> Mở profile cá nhân
            if (currentUser && targetUserId === currentUser.username) {
                toggleProfile();
                return;
            }

            const modal = document.getElementById('publicProfileModal');
            modal.classList.remove('hidden');

            checkFriendStatus(targetUserId); 
            
            // --- SỬA LỖI: Reset giao diện dùng đúng ID trong HTML ---
            document.getElementById('publicName').textContent = "Đang tải...";
            document.getElementById('publicUsername').textContent = "...";
            document.getElementById('publicUsername').className = "text-gray-500 text-xs font-mono uppercase tracking-widest"; 
            
            // Reset Avatar Container (Thay vì set src cho img không tồn tại)
            const avtContainer = document.getElementById('publicAvatarContainer');
            avtContainer.className = "w-full h-full rounded-full border-2 border-gray-700 flex items-center justify-center overflow-hidden bg-gray-800";
            avtContainer.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>';
            
            // Reset Grid
            document.getElementById('publicPostsGrid').innerHTML = '';
            document.getElementById('publicPostsGrid').classList.remove('hidden');
            document.getElementById('publicPostCount').innerText = '-';
            document.getElementById('publicEmptyState').classList.add('hidden');
            document.getElementById('publicGuestView').classList.add('hidden');

            try {
                const isTargetGuest = targetUserId.startsWith('guest_');

                // Lấy thông tin User
                let userData = { displayName: "Người dùng", avatarUrl: null };
                if (!isTargetGuest) {
                    const userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(targetUserId).get();
                    if (!userDoc.exists) {
                        // Nếu không tìm thấy user -> Thông báo và đóng modal ngay
                        showToast("Tài khoản này không tồn tại hoặc đã bị xóa.", "error");
                        
                        // Ẩn modal ngay lập tức (vì ở trên đã lỡ mở rồi)
                        modal.classList.add('hidden'); 
                        return; // Dừng hàm, không chạy code phía dưới nữa
                    }

                    userData = userDoc.data();


                } else {
                    userData.displayName = "Khách " + targetUserId.split('_')[1];
                }

                // --- XỬ LÝ HIỂN THỊ HEADER ---
                // 1. Cập nhật Tên và THÊM CLASS ĐỒNG BỘ (sync-group-name-...)
                const nameEl = document.getElementById('publicName');
                nameEl.textContent = userData.displayName;
                // Reset class để tránh bị trùng ID cũ nếu mở nhiều profile liên tiếp, sau đó thêm class sync
                nameEl.setAttribute('class', `text-2xl font-bold text-white mb-1 sync-group-name-${targetUserId}`);
                
                if (isTargetGuest) {
                    // TRƯỜNG HỢP 1: LÀ KHÁCH
                    document.getElementById('publicUsername').textContent = "TÀI KHOẢN KHÁCH";
                    document.getElementById('publicUsername').className = "text-gray-500 text-xs font-mono font-bold uppercase tracking-widest bg-white/5 px-3 py-1 rounded-full border border-white/5";

                    avtContainer.className = "w-full h-full rounded-full bg-app-gold flex items-center justify-center overflow-hidden border-4 border-app-dark shadow-lg shadow-app-gold/20";
                    avtContainer.innerHTML = `<i class="fa-solid fa-user-secret text-4xl text-black"></i>`;

                    document.getElementById('publicPostsGrid').classList.add('hidden');
                    document.getElementById('publicGuestView').classList.remove('hidden');
                    document.getElementById('publicPostCount').innerText = "0";

                } else {
                    // TRƯỜNG HỢP 2: LÀ USER ĐĂNG KÝ
                    document.getElementById('publicUsername').textContent = "@" + targetUserId;
    
                    // 2. Cập nhật Avatar và THÊM CLASS ĐỒNG BỘ (sync-group-avatar-...)
                    if (userData.avatarUrl) {
                        // Thêm class sync-group-avatar-${targetUserId} vào thẻ img
                        avtContainer.innerHTML = `<img src="${userData.avatarUrl}" class="w-full h-full object-cover sync-group-avatar-${targetUserId}">`;
                    } else {
                        const char = userData.displayName ? userData.displayName.charAt(0).toUpperCase() : "?";
                        // Nếu muốn đồng bộ cả khi chưa có avatar (chuyển từ chữ sang ảnh), bạn cần logic phức tạp hơn.
                        // Tạm thời hiển thị chữ:
                        avtContainer.innerHTML = `<div class="text-2xl font-bold text-gray-400">${char}</div>`;
                    }

                    // Tải ảnh (LỌC BỎ FRIEND ZONE ĐỂ TÁCH BIỆT)
                    const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                        .where('authorId', '==', targetUserId).get();

                    let posts = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // CHỈ LẤY BÀI CÔNG KHAI (Không phải FriendZone, không phải Phitay)
                        if (data.community !== 'PHITAY' && data.community !== 'FRIEND_ZONE') {
                            posts.push({id: doc.id, ...data});
                        }
                    });

                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    document.getElementById('publicPostCount').innerText = posts.length;

                    const grid = document.getElementById('publicPostsGrid');
                    
                    if (posts.length === 0) {
                        document.getElementById('publicEmptyState').classList.remove('hidden');
                    } else {
                        posts.forEach(post => {
                            const div = document.createElement('div');
    
                            // 1. Khai báo class gốc
                            let userProfileClass = 'post-card aspect-square bg-gray-800 relative group overflow-hidden cursor-pointer rounded-lg box-border';

                            // 2. [LOGIC MỚI] Kiểm tra màu để thêm hiệu ứng lấp lánh
                            if (post.frameColor && post.frameColor !== 'gray') {
                                userProfileClass = 'frame-glitter-effect ' + userProfileClass;
                            }

                            // 3. Gán class
                            div.className = userProfileClass;

                            // 4. Set viền và bóng đổ
                            const borderStyle = getFrameColorStyle(post.frameColor || 'gray');
                            div.style.border = `2px solid ${borderStyle.borderColor}`;
                            
                            if (post.frameColor && post.frameColor !== 'gray') {
                                div.style.boxShadow = borderStyle.shadow;
                                div.style.zIndex = "1";
                            }
                            
                            let mediaContent;
                            // Bổ sung: Class 'rounded-lg' vào trực tiếp các thẻ img/video/div bên trong
                            if(post.mediaType === 'video') {
                                mediaContent = `<video src="${post.imageUrl}#t=0.1" class="w-full h-full object-cover rounded-lg"></video><i class="fa-solid fa-play absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/80"></i>`;
                            } else if(post.mediaType === 'audio') {
                                mediaContent = `<div class="w-full h-full bg-gray-900 flex items-center justify-center rounded-lg"><i class="fa-solid fa-music text-gray-500"></i></div>`;
                            } else {
                                mediaContent = `<img src="${post.imageUrl}" class="w-full h-full object-cover rounded-lg">`;
                            }
                            
                            div.innerHTML = mediaContent;
                            div.onclick = () => openMiniPreview(post); 
                            grid.appendChild(div);
                        });
                    }
                }

            } catch (e) {
                console.error(e);
                showToast("Không thể tải hồ sơ này");
                closePublicProfile();
            }
        }

        function closePublicProfile() {
            document.getElementById('publicProfileModal').classList.add('hidden');
            
            // Ngắt lắng nghe nút kết bạn khi đóng modal
            if (friendStatusUnsubscribe) {
                friendStatusUnsubscribe();
                friendStatusUnsubscribe = null;
            }

            
            
        }

        // Hàm bật tắt Cài đặt & Cập nhật dữ liệu
        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                
                if(currentUser) {
                    // Cập nhật thông tin Header
                    document.getElementById('settingName').textContent = currentUser.displayName;
                    
                    // --- XỬ LÝ ẨN/HIỆN INPUT TÊN CHO KHÁCH ---
                    const nameInput = document.getElementById('settingNameInput');
                    const saveBtn = document.getElementById('saveNameBtn');

                    if (currentUser.isGuest) {
                        // NẾU LÀ KHÁCH:
                        nameInput.value = currentUser.displayName + " (Khách)";
                        nameInput.disabled = true;
                        nameInput.classList.add('opacity-50', 'cursor-not-allowed');
                        if(saveBtn) saveBtn.classList.add('hidden');
                    } else {
                        // NẾU LÀ USER THƯỜNG:
                        nameInput.value = currentUser.displayName;
                        nameInput.disabled = false;
                        nameInput.classList.remove('opacity-50', 'cursor-not-allowed');
                        if(saveBtn) saveBtn.classList.remove('hidden');
                    }

                    // --- CẬP NHẬT AVATAR (Đã sửa lỗi hiển thị cho Khách) ---
                    const sAvt = document.getElementById('settingAvatar');
                    const smallAvtImg = document.getElementById('settingSmallAvatar');
                    const smallAvtPlc = document.getElementById('settingSmallAvatarPlaceholder');
                    
                    if (currentUser.avatarUrl) {
                        // Trường hợp 1: Có ảnh đại diện
                        sAvt.innerHTML = `<img src="${currentUser.avatarUrl}" class="w-full h-full object-cover">`;
                        smallAvtImg.src = currentUser.avatarUrl;
                        smallAvtImg.classList.remove('hidden');
                        smallAvtPlc.classList.add('hidden');
                    } else if (currentUser.isGuest) {
                        // Trường hợp 2: LÀ KHÁCH -> HIỆN ICON BÍ ẨN
                        sAvt.innerHTML = '<i class="fa-solid fa-user-secret text-2xl"></i>';
                        smallAvtImg.classList.add('hidden');
                        smallAvtPlc.innerHTML = '<i class="fa-solid fa-user-secret"></i>';
                        smallAvtPlc.classList.remove('hidden');
                    } else {
                        // Trường hợp 3: User thường chưa có ảnh -> Hiện chữ cái đầu
                        const char = currentUser.displayName.charAt(0).toUpperCase();
                        sAvt.innerHTML = char;
                        smallAvtImg.classList.add('hidden');
                        smallAvtPlc.textContent = char;
                        smallAvtPlc.classList.remove('hidden');
                    }
                }
            } else {
                modal.classList.add('hidden');
            }
        }

        // Hàm Lưu tên từ phần Cài đặt (Logic giống hệt saveProfile cũ)
        async function saveNameFromSettings() {
            const newName = document.getElementById('settingNameInput').value.trim();
            if (newName.length > 9) { showToast("Tên tối đa 9 ký tự thôi!"); return; }

            if(newName && !currentUser.isGuest) {
                try {
                    showToast("Đang đồng bộ toàn hệ thống...");
                    
                    // 1. Cập nhật User gốc
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(currentUser.username).update({ displayName: newName });
                    currentUser.displayName = newName; 
                    localStorage.setItem('lm_user', JSON.stringify(currentUser)); 
                    updateUI(); toggleSettings(); 
                    
                    const batch = db.batch();
                    
                    // 2. Cập nhật Posts (Tác giả bài viết)
                    const snapP = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').where('authorId', '==', currentUser.username).get();
                    snapP.docs.forEach(doc => batch.update(doc.ref, { authorName: newName })); 
                    
                    // 3. Cập nhật Notifications (Người gửi thông báo)
                    const snapN = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').where('senderId', '==', currentUser.username).get();
                    snapN.docs.forEach(doc => batch.update(doc.ref, { senderName: newName }));

                    await batch.commit(); // Lưu đợt 1

                    // 4. Cập nhật Likes trong POSTS (Danh sách người thích bài viết)
                    const snapAllPosts = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').get();
                    const batchLikes = db.batch();
                    snapAllPosts.docs.forEach(doc => {
                        const p = doc.data();
                        if (p.likes && Array.isArray(p.likes)) {
                            let changed = false;
                            const newL = p.likes.map(u => { if(u.uid === currentUser.username) { changed=true; return {...u, name: newName}; } return u; });
                            if(changed) batchLikes.update(doc.ref, { likes: newL });
                        }
                    });
                    await batchLikes.commit(); // Lưu đợt 2

                    // 5. [QUAN TRỌNG NHẤT] Cập nhật COMMENTS (Tác giả, Likes, VÀ Tên Phản Hồi)
                    const snapAllComments = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').get();
                    const batchCLikes = db.batch();
                    
                    // Bước 5a: Tạo bản đồ ID -> Tác giả (Để biết ai là chủ của bình luận gốc)
                    const commentOwnerMap = {};
                    snapAllComments.docs.forEach(doc => {
                        commentOwnerMap[doc.id] = doc.data().userId;
                    });

                    // Bước 5b: Quét và cập nhật
                    snapAllComments.docs.forEach(doc => {
                        const c = doc.data();
                        let updates = {};
                        let isModified = false;

                        // A. Nếu mình là tác giả comment -> Đổi tên tác giả
                        if (c.userId === currentUser.username) {
                            updates.userName = newName;
                            isModified = true;
                        }

                        // B. Nếu mình đã like comment này -> Đổi tên trong danh sách like
                        if (c.likes && Array.isArray(c.likes)) {
                            let likeChanged = false;
                            const newLikes = c.likes.map(u => { 
                                if(u.uid === currentUser.username) { likeChanged=true; return {...u, name: newName}; } 
                                return u; 
                            });
                            if(likeChanged) {
                                updates.likes = newLikes;
                                isModified = true;
                            }
                        }

                        // C. [MỚI] Nếu comment này đang trả lời một comment CỦA MÌNH -> Sửa tên "Phản hồi..."
                        if (c.replyToId && commentOwnerMap[c.replyToId] === currentUser.username) {
                            updates.replyToName = newName;
                            isModified = true;
                        }

                        if (isModified) {
                            batchCLikes.update(doc.ref, updates);
                        }
                    });
                    await batchCLikes.commit(); // Lưu đợt cuối

                    showToast("Đã đổi tên & đồng bộ xong!");
                } catch(e) { console.error(e); showToast("Lỗi khi lưu!"); }
            } else if (currentUser.isGuest) { showToast("Khách không được đổi tên!"); }
        }

        // --- BƯỚC 1: SỬA ALBUM TRANG CHÍNH (ẨN BÀI FRIEND ZONE) ---
        function loadUserAlbum() {
            if (!currentUser || currentUser.isGuest) return;
            
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                .where('authorId', '==', currentUser.username).get().then(snapshot => {
                    const grid = document.getElementById('userPostsGrid'); 
                    grid.innerHTML = ''; 
                    
                    let posts = []; 
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // --- ĐOẠN QUAN TRỌNG NHẤT ---
                        // Chỉ lấy bài KHÔNG PHẢI PHITAY và KHÔNG PHẢI FRIEND_ZONE
                        // Điều này giúp tách biệt hoàn toàn 2 khu vực
                        if (data.community !== 'PHITAY' && data.community !== 'FRIEND_ZONE') {
                            posts.push({id: doc.id, ...data});
                        }
                        // -----------------------------
                    }); 
                    
                    document.getElementById('postCount').innerText = `${posts.length} ẢNH`; 
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (posts.length === 0) {
                        grid.innerHTML = `
                            <div class="col-span-3 flex flex-col items-center justify-center py-20 opacity-50 text-gray-500 animate-fade-in">
                                <i class="fa-regular fa-images text-4xl mb-3"></i>
                                <p class="text-xs font-bold uppercase tracking-wider">Chưa có ảnh nào</p>
                            </div>
                        `;
                    } else {
                        posts.forEach(post => {
                            const div = document.createElement('div');
    
                            // 1. Khai báo class gốc
                            let albClass = 'aspect-square bg-gray-800 relative group overflow-hidden cursor-pointer';

                            // 2. [LOGIC MỚI] Kiểm tra màu để thêm hiệu ứng lấp lánh
                            if (post.frameColor && post.frameColor !== 'gray') {
                                albClass = 'frame-glitter-effect ' + albClass;
                            }
                            
                            // 3. Gán class
                            div.className = albClass;

                            // 4. Set viền màu
                            const borderStyle = getFrameColorStyle(post.frameColor);
                            div.style.border = `2px solid ${borderStyle.borderColor}`;
                            
                            div.onclick = () => openMiniPreview(post); 

                            let mediaContent;
                            if(post.mediaType === 'video') {
                                mediaContent = `<video src="${post.imageUrl}#t=0.1" class="w-full h-full object-cover rounded-lg"></video><i class="fa-solid fa-play absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/80"></i>`;
                            } else if(post.mediaType === 'audio') {
                                mediaContent = `
                                    <div class="w-full h-full bg-black flex items-center justify-center rounded-lg">
                                        <div class="w-10 h-10 rounded-full bg-app-gold flex items-center justify-center shadow-lg">
                                            <i class="fa-solid fa-music text-black"></i>
                                        </div>
                                    </div>`;
                            } else {
                                mediaContent = `<img src="${post.imageUrl}" class="w-full h-full object-cover rounded-lg">`;
                            }
                            
                            div.innerHTML = mediaContent; 
                            grid.appendChild(div);
                        });
                    }
                });
        }

       let singlePostUnsubscribe = null; 

       // --- LOGIC CỬA SỔ MINI & NHẢY BÀI VIẾT ---
        // --- LOGIC CỬA SỔ MINI & NHẢY BÀI VIẾT (ĐÃ SỬA) ---
        let currentMiniPost = null; // 1. Thay đổi: Lưu cả bài viết (Object) thay vì chỉ lưu ID

        function openMiniPreview(post) {
            const modal = document.getElementById('miniPreviewModal');
            const mediaContainer = document.getElementById('miniPreviewMedia');
            
            // Lưu lại toàn bộ dữ liệu bài viết
            currentMiniPost = post;
            
            // Render nội dung (Ảnh/Video)
            let html = '';
            if(post.mediaType === 'video') {
                // Thêm playsinline và webkit-playsinline
html = `<video src="${post.imageUrl}" class="w-full h-full object-contain max-h-[70vh]" controls autoplay muted playsinline webkit-playsinline></video>`;
            } else if (post.mediaType === 'audio') {
                html = `<div class="w-full h-full flex items-center justify-center bg-gray-900 aspect-square"><i class="fa-solid fa-music text-6xl text-app-gold animate-bounce"></i></div>`;
            } else {
                html = `<img src="${post.imageUrl}" class="w-full h-full object-contain max-h-[70vh]">`;
            }
            mediaContainer.innerHTML = html;
            
            modal.classList.remove('hidden');
        }

        function closeMiniPreview() {
            document.getElementById('miniPreviewModal').classList.add('hidden');
            document.getElementById('miniPreviewMedia').innerHTML = ''; 
            currentMiniPost = null; 
        }

        function jumpToPostFromMini() {
            // Lấy dữ liệu bài viết đã lưu
            const postToOpen = currentMiniPost;
            
            if (!postToOpen) return;

            // Đóng cửa sổ xem trước (Mini Preview)
            closeMiniPreview(); 
            
            // Danh sách các modal CẦN ĐÓNG (để dọn dẹp màn hình)
            let modalsToClose = [
                'profileModal', 
                'publicProfileModal', 
                'commentModal', 
                'likesModal', 
                'mapModal', 
                'settingsModal',
                'friendZoneAlbumModal' // Luôn đóng Album để hiển thị bài viết chi tiết
            ];

            // --- SỬA ĐOẠN NÀY: KIỂM TRA THÔNG MINH ---
            // Nếu bài viết KHÔNG PHẢI của Friend Zone -> Thì mới đóng Friend Zone
            // (Giữ lại Friend Zone làm nền nếu đang xem bài của nó)
            if (postToOpen.community !== 'FRIEND_ZONE') {
                modalsToClose.push('friendZoneModal');
            }
            // ------------------------------------------
            
            modalsToClose.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });

            // Mở bài viết chi tiết
            openSinglePost(postToOpen);
        }

        async function openSinglePost(postData) {
            // 1. Dừng video/audio đang chạy nền
            document.querySelectorAll('#feedList video, #feedList audio, #friendFeedList video, #friendFeedList audio').forEach(media => {
                media.pause();
            });

            // --- [BẢO MẬT NÂNG CAO] CHECK QUYỀN REALTIME ---
            if (postData.community === 'FRIEND_ZONE' && postData.authorId !== currentUser.username) {
                // Bước 1: Kiểm tra bắt buộc - PHẢI LÀ BẠN BÈ HIỆN TẠI
                // (Chống việc xem qua thông báo cũ hoặc tag cũ sau khi đã unfriend)
                let isRealtimeFriend = false;
                const relationId = getRelationId(currentUser.username, postData.authorId);

                try {
                    // Gọi trực tiếp lên Server để check (không dùng cache)
                    const relDoc = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('relationships')
                        .doc(relationId).get();
                    
                    if (relDoc.exists && relDoc.data().status === 'accepted') {
                        isRealtimeFriend = true;
                    }
                } catch (e) {
                    console.error("Lỗi kiểm tra bảo mật:", e);
                }

                if (!isRealtimeFriend) {
                    showToast("⛔ Không thể xem: Hai người không còn là bạn bè.");
                    closeSinglePost(); // Đóng nếu lỡ mở
                    return; // Dừng ngay lập tức
                }

                // Bước 2: Kiểm tra cài đặt riêng tư của bài viết (Specific Viewers)
                let isAllowedBySettings = false;
                if (!postData.allowedViewers || postData.allowedViewers.length === 0) isAllowedBySettings = true;
                else if (postData.allowedViewers.includes('ALL')) isAllowedBySettings = true;
                else if (postData.allowedViewers.includes(currentUser.username)) isAllowedBySettings = true;

                if (!isAllowedBySettings) {
                    showToast("⛔ Bạn không có quyền xem bài viết này (Quyền riêng tư).");
                    closeSinglePost();
                    return;
                }
            }
            // --- [KẾT THÚC BẢO MẬT] ---

            const modal = document.getElementById('singlePostModal');
            const container = document.getElementById('singlePostContainer');
            
            modal.classList.remove('hidden');
            container.innerHTML = ''; 

            // Hàm render nội bộ cho Modal (Giữ nguyên logic cũ của bạn)
            const renderTargetPost = (pData) => {
                const originalMainMode = currentViewMode;
                const originalFZMode = typeof currentFZViewMode !== 'undefined' ? currentFZViewMode : 'list';

                currentViewMode = 'list'; 
                if(typeof currentFZViewMode !== 'undefined') currentFZViewMode = 'list';

                container.innerHTML = ''; 
                
                // Vẽ bài viết
                const isFZ = pData.community === 'FRIEND_ZONE';
                renderPost(container, pData.id, pData, isFZ);

                currentViewMode = originalMainMode;
                if(typeof currentFZViewMode !== 'undefined') currentFZViewMode = originalFZMode;
                
                // Xử lý ID media
                const mediaInModal = container.querySelector('video, audio');
                if (mediaInModal) {
                    const uniqueModalId = `modal-media-${postData.id}`;
                    mediaInModal.id = uniqueModalId;
                    const muteBtn = container.querySelector('button[onclick*="toggleMute"]');
                    if (muteBtn) {
                        muteBtn.setAttribute('onclick', `event.stopPropagation(); toggleMute('${uniqueModalId}', '${postData.mediaType}')`);
                    }
                    if (postData.mediaType === 'audio' && !mediaInModal.paused) {
                        const wrapper = container.querySelector('.audio-wrapper');
                        if(wrapper) wrapper.classList.add('is-playing');
                    }
                }
            };

            renderTargetPost(postData);

            if (singlePostUnsubscribe) singlePostUnsubscribe(); 
            
            singlePostUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('posts').doc(postData.id)
                .onSnapshot(doc => {
                    if(doc.exists) {
                        const currentScroll = container.scrollTop;
                        // Khi có update (ví dụ like), kiểm tra lại quyền 1 lần nữa cho chắc
                        const updatedData = {id: doc.id, ...doc.data()};
                        
                        // Check lại quyền trong realtime (phòng trường hợp tác giả đổi quyền lúc mình đang xem)
                        if (updatedData.community === 'FRIEND_ZONE' && updatedData.authorId !== currentUser.username) {
                            // Logic check nhanh cho update realtime (không cần gọi DB lần nữa cho đỡ lag, chỉ check setting)
                            let stillAllowed = false;
                            if (!updatedData.allowedViewers || updatedData.allowedViewers.includes('ALL') || updatedData.allowedViewers.includes(currentUser.username)) stillAllowed = true;
                            
                            if (!stillAllowed) {
                                closeSinglePost();
                                showToast("Quyền riêng tư của bài viết đã thay đổi.");
                                return;
                            }
                        }

                        renderTargetPost(updatedData);
                        container.scrollTop = currentScroll; 
                    } else {
                        closeSinglePost();
                        showToast("Bài viết không còn tồn tại");
                    }
                });
        }

        function closeSinglePost() {
            const modal = document.getElementById('singlePostModal');
            const container = document.getElementById('singlePostContainer');

            modal.classList.add('hidden');
            
            if (singlePostUnsubscribe) {
                singlePostUnsubscribe();
                singlePostUnsubscribe = null;
            }

            // --- BẮT ĐẦU ĐOẠN SỬA ---
            const media = container.querySelector('video, audio');
            if(media) {
                media.pause();
                media.src = ""; // Xóa nguồn để triệt tiêu âm thanh ngay lập tức
                media.load();
            }
            // --- KẾT THÚC ĐOẠN SỬA ---
            setTimeout(() => { container.innerHTML = ''; }, 300);
        }

        function triggerAvatarChange() { if (!currentUser.isGuest) document.getElementById('avatarInput').click(); }

        function handleAvatarSelect(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image(); img.src = ev.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                    c.width = 150; c.height = 150; ctx.drawImage(img, 0, 0, 150, 150);
                    saveAvatarToDB(c.toDataURL('image/jpeg', 0.6));
                }
            }; reader.readAsDataURL(file); e.target.value = '';
        }

        async function saveAvatarToDB(base64) {
            try {
                showToast("Đang tải ảnh lên...");
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(currentUser.username).update({ avatarUrl: base64 });
                currentUser.avatarUrl = base64; 
                localStorage.setItem('lm_user', JSON.stringify(currentUser)); 
                updateUI();
                
                showToast("Đang đồng bộ dữ liệu...");
                const batch = db.batch();

                // Update Post Author & Comment Author
                const snapP = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').where('authorId', '==', currentUser.username).get();
                snapP.docs.forEach(doc => batch.update(doc.ref, { authorAvatarUrl: base64 })); 
                
                const snapC = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').where('userId', '==', currentUser.username).get();
                snapC.docs.forEach(doc => batch.update(doc.ref, { userAvatar: base64 })); 

                const snapN = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').where('senderId', '==', currentUser.username).get();
                snapN.docs.forEach(doc => batch.update(doc.ref, { senderAvatar: base64 }));
                
                await batch.commit();

                // Update Likes in Posts
                const snapAllPosts = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').get();
                const batchLikes = db.batch();
                snapAllPosts.docs.forEach(doc => {
                    const p = doc.data();
                    if (p.likes) {
                        let changed = false;
                        const newL = p.likes.map(u => { if(u.uid===currentUser.username){changed=true; return {...u, avatar:base64};} return u;});
                        if(changed) batchLikes.update(doc.ref, { likes: newL });
                    }
                });
                await batchLikes.commit();

                // [MỚI] Update Likes in Comments
                const snapAllComments = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').get();
                const batchCLikes = db.batch();
                snapAllComments.docs.forEach(doc => {
                    const c = doc.data();
                    if (c.likes) {
                        let changed = false;
                        const newL = c.likes.map(u => { if(u.uid===currentUser.username){changed=true; return {...u, avatar:base64};} return u;});
                        if(changed) batchCLikes.update(doc.ref, { likes: newL });
                    }
                });
                await batchCLikes.commit();

                showToast("Đã cập nhật Avatar xong!");
            } catch (e) { console.error(e); showToast("Lỗi cập nhật!"); }
        }

        async function saveProfile() {
            const newName = document.getElementById('editNameInput').value.trim();
            
            // --- THÊM ĐOẠN KIỂM TRA NÀY ---
            if (newName.length > 10) {
                showToast("Tên tối đa 10 ký tự thôi!");
                return;
            }
            // -----------------------------

            if(newName && !currentUser.isGuest) {
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(currentUser.username).update({ displayName: newName });
                    currentUser.displayName = newName; localStorage.setItem('lm_user', JSON.stringify(currentUser)); updateUI();
                    showToast("Updating name...");
                    const snapshotP = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').where('authorId', '==', currentUser.username).get();
                    const batchP = db.batch(); snapshotP.docs.forEach(doc => batchP.update(doc.ref, { authorName: newName })); await batchP.commit();
                    const snapshotC = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').where('userId', '==', currentUser.username).get();
                    const batchC = db.batch(); snapshotC.docs.forEach(doc => batchC.update(doc.ref, { userName: newName })); await batchC.commit();
                    showToast(TRANSLATIONS[currentLang].toast_updated);
                } catch(e) { showToast("Error"); }
            }
        }

        function downloadImage(base64, filename) {
            const link = document.createElement('a'); link.href = base64; link.download = filename;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- CẤU HÌNH BẢN ĐỒ ---
        // --- LOGIC BẢN ĐỒ MỚI (ĐÃ SỬA LỖI NAM CỰC) ---
        // --- LOGIC BẢN ĐỒ (ĐÃ FIX HIỂN THỊ NAM CỰC) ---
        // Cấu hình dữ liệu châu lục
        // --- LOGIC BẢN ĐỒ ---
        // --- LOGIC BẢN ĐỒ ---
        // --- LOGIC BẢN ĐỒ ---
        // --- CẤU HÌNH DỮ LIỆU ---
        // --- LOGIC BẢN ĐỒ ---
        // --- LOGIC BẢN ĐỒ ---
        // --- DỮ LIỆU CHÂU LỤC (Tọa độ gốc) ---
        const continentsData = [
            { name: 'Bắc Mỹ', center: [45, -100], bounds: [[80, -170], [10, -50]] },
            { name: 'Nam Mỹ', center: [-15, -60], bounds: [[12, -85], [-55, -30]] },
            { name: 'Châu Âu', center: [50, 15], bounds: [[70, -10], [35, 40]] },
            { name: 'Châu Phi', center: [0, 20], bounds: [[37, -20], [-35, 55]] },
            { name: 'Châu Á', center: [35, 100], bounds: [[80, 40], [0, 150]] },
            { name: 'Châu Đại Dương', center: [-25, 140], bounds: [[0, 110], [-50, 180]] },
            { name: 'Nam Cực', center: [-75, 0], bounds: [[-60, -180], [-90, 180]] }
        ];

        let mapInstance = null;
        let mapResizeObserver = null;
        let continentsLayerGroup = null; // Nhóm chứa các hình vẽ để dễ xóa đi vẽ lại

        function initRealMap() {
            if (mapInstance) {
                fitMapToScreen();
                return;
            }

            // 1. Khởi tạo Map
            mapInstance = L.map('leafletMap', {
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                touchZoom: false,
                boxZoom: false,
                keyboard: false,
                attributionControl: false,
                zoomSnap: 0,
                zoomDelta: 0.1
            });

            // 2. Tile Layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 10,
                minZoom: 0
            }).addTo(mapInstance);

            // 3. Tạo nhóm quản lý Layer (Để vẽ lại viền liên tục)
            continentsLayerGroup = L.layerGroup().addTo(mapInstance);

            // 4. Marker PHITAY (Giữ nguyên, không cần cắt)
            const phitayIcon = L.divIcon({
                className: 'custom-div-icon pointer-events-auto cursor-pointer',
                html: `<div class="phitay-pulse"></div><div style="color:#EF4444;font-weight:900;font-size:9px;margin-top:25px;text-align:center;width:60px;margin-left:-20px;text-shadow:0 1px 2px black">PHITAY</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            L.marker([16.0, 112.0], { 
                icon: phitayIcon,
                zIndexOffset: 1000 // <--- THÊM DÒNG NÀY: Cộng thêm 1000 điểm z-index để luôn nổi trên mọi thứ
            }).addTo(mapInstance).on('click', () => {
                if(typeof requestPhitayAccess === 'function') requestPhitayAccess();
            });

            // 5. Observer theo dõi thay đổi kích thước
            const mapContainer = document.getElementById('leafletMap');
            if (mapResizeObserver) mapResizeObserver.disconnect();
            
            mapResizeObserver = new ResizeObserver(() => {
                if (mapInstance) {
                    mapInstance.invalidateSize();
                    fitMapToScreen(); // Gọi hàm này sẽ kích hoạt vẽ lại viền
                }
            });
            mapResizeObserver.observe(mapContainer);

            // Chạy lần đầu
            fitMapToScreen();
        }

        function fitMapToScreen() {
            if(!mapInstance) return;

            // 1. Ép bản đồ vào khung
            const targetBounds = [[-90, -180], [75, 180]];
            mapInstance.fitBounds(targetBounds, { padding: [0, 0], animate: false });

            // 2. Đợi 1 chút để Leaflet cập nhật tọa độ xong -> Vẽ lại viền bám mép
            setTimeout(() => {
                drawClippedContinents();
            }, 50);
        }

        // --- HÀM MỚI: VẼ VIỀN BÁM MÉP KHUNG ---
        // --- HÀM VẼ VIỀN (PHONG CÁCH TỐI GIẢN - TECH STYLE) ---
        // --- HÀM VẼ VIỀN ĐỘNG (DYNAMIC BORDER) ---
        function drawClippedContinents() {
            if (!mapInstance || !continentsLayerGroup) return;

            continentsLayerGroup.clearLayers();

            const mapBounds = mapInstance.getBounds();
            const mapNorth = mapBounds.getNorth();
            const mapSouth = mapBounds.getSouth();
            const mapEast = mapBounds.getEast();
            const mapWest = mapBounds.getWest();

            continentsData.forEach(cont => {
                // Tính toán cắt gọt (Clipping logic)
                const cNorth = cont.bounds[0][0];
                const cWest = cont.bounds[0][1];
                const cSouth = cont.bounds[1][0];
                const cEast = cont.bounds[1][1];

                const drawNorth = Math.min(cNorth, mapNorth);
                const drawSouth = Math.max(cSouth, mapSouth);
                const drawEast = Math.min(cEast, mapEast);
                const drawWest = Math.max(cWest, mapWest);

                if (drawNorth > drawSouth && drawEast > drawWest) {
                    const clippedBounds = [[drawNorth, drawWest], [drawSouth, drawEast]];

                    // --- VẼ HÌNH CHỮ NHẬT (TRẠNG THÁI BÌNH THƯỜNG) ---
                    const rect = L.rectangle(clippedBounds, {
                        color: '#FFB800',   
                        weight: 0.6,        // <--- ĐỘ DÀY SIÊU MẢNH (Theo ý bạn)
                        dashArray: '4, 8',  // Nét đứt thưa
                        opacity: 0.6,       // Viền mờ nhẹ
                        fillColor: '#FFB800',
                        fillOpacity: 0.008,     // <--- BÌNH THƯỜNG TRONG SUỐT
                        lineCap: 'square',
                        className: 'dynamic-border' // Kích hoạt animation chạy
                    }).addTo(continentsLayerGroup);

                    // --- HIỆU ỨNG HOVER (PHÁT SÁNG CẢ KHU VỰC) ---
                    rect.on('mouseover', function() {
                        this.setStyle({ 
                            weight: 2,          // Viền đậm hơn một chút
                            opacity: 1,         // Viền sáng rõ (100%)
                            color: '#FFF',
                            dashArray: null,    // Hóa thành nét liền
                            
                            fillOpacity: 0.15,  // <--- QUAN TRỌNG: Sáng nhẹ bên trong (15%)
                                                // Tạo cảm giác như bật đèn cho khu vực đó
                            
                            className: ''       // Tạm dừng animation chạy để focus
                        });
                    });

                    // Chuột rời đi -> Trở về trạng thái mảnh và đứt quãng
                    rect.on('mouseout', function() {
                        this.setStyle({ 
                            weight: 0.6,        // Quay về siêu mảnh
                            opacity: 0.6, 
                            dashArray: '4, 8',
                            fillOpacity: 0.008,     // Tắt đèn bên trong
                            className: 'dynamic-border'
                        });
                    });

                    rect.on('click', () => switchCommunity(cont.name));

                    // --- VẼ CHỮ (ĐÃ FIX PHÔNG TIẾNG VIỆT) ---
                    if (mapBounds.contains(cont.center)) {
                        L.marker(cont.center, {
                            icon: L.divIcon({
                                // Sử dụng class mới 'continent-label-tech'
                                className: 'pointer-events-auto cursor-pointer',
                                html: `<div class="continent-label-tech" style="width:150px;">${cont.name}</div>`
                            })
                        }).addTo(continentsLayerGroup).on('click', () => switchCommunity(cont.name));
                    }
                }
            });
        }
        // --- HÀM TOGGLE MAP MODAL ĐÃ SỬA ĐỔI ---
        function toggleMapModal() {
            const modal = document.getElementById('mapModal');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                
                // Cập nhật dropdown
                const mapSelect = document.getElementById('mapSelect');
                if (mapSelect) mapSelect.value = currentCommunity;

                // Chờ modal hiện ra rồi mới vẽ map để tính toán đúng kích thước
                setTimeout(() => {
                    initRealMap();
                }, 100);
                
            } else {
                modal.classList.add('hidden');
            }
        }

        // Thêm sự kiện lắng nghe khi xoay màn hình hoặc đổi kích thước cửa sổ
        window.addEventListener('resize', () => {
            if (!document.getElementById('mapModal').classList.contains('hidden')) {
                setTimeout(fitMapToScreen, 300);
            }
        });

        function switchCommunity(comm) {
            currentCommunity = comm; 
            document.getElementById('currentCommunityDisplay').innerText = getDisplayContinent(comm);
            
            const uploadSelect = document.getElementById('uploadCommunitySelect');
            const mapSelect = document.getElementById('mapSelect');

            if (comm !== 'PHITAY') {
                if (uploadSelect) {
                    const opt = uploadSelect.querySelector('option[value="PHITAY"]');
                    if (opt) opt.remove();
                }
                if (mapSelect) {
                    const opt = mapSelect.querySelector('option[value="PHITAY"]');
                    if (opt) opt.remove();
                }
            }
            
            if(comm !== 'all' && uploadSelect) {
                uploadSelect.value = comm;
            }
            
            toggleMapModal(); 
            subscribeToFeed(); 
            showToast(`${getDisplayContinent(comm)}`);
        }

        function getFrameColorStyle(colorCode) {
            switch(colorCode) {
                case 'gold': return { borderColor: '#FFB800', shadow: '0 0 15px rgba(255, 184, 0, 0.3)' };
                case 'blue': return { borderColor: '#3B82F6', shadow: '0 0 15px rgba(59, 130, 246, 0.3)' };
                case 'pink': return { borderColor: '#EC4899', shadow: '0 0 15px rgba(236, 72, 153, 0.3)' };
                case 'gray': default: return { borderColor: '#374151', shadow: 'none' };
            }
        }

        let feedUnsubscribe = null; // Biến quản lý kết nối

        function subscribeToFeed() {
            // 1. NGẮT KẾT NỐI CŨ (Quan trọng để Reset hoạt động)
            if (feedUnsubscribe) {
                feedUnsubscribe(); 
                feedUnsubscribe = null;
            }

            // 2. TẠO KẾT NỐI MỚI
            feedUnsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                .onSnapshot(snapshot => {
                    const list = document.getElementById('feedList'); list.innerHTML = ''; recentPostsCache = []; let allPosts = [];
                    snapshot.forEach(doc => allPosts.push({id: doc.id, ...doc.data()}));
                    allPosts = allPosts.filter(post => post.community === currentCommunity);
                    allPosts.sort((a, b) => b.timestamp - a.timestamp);
                    const displayPosts = allPosts.slice(0, 50);
                    if (displayPosts.length === 0) document.getElementById('emptyState').classList.remove('hidden');
                    else document.getElementById('emptyState').classList.add('hidden');
                    displayPosts.forEach(post => { recentPostsCache.push(post); renderPost(list, post.id, post); });
                });
        }

        // --- CẬP NHẬT: THÊM THAM SỐ isFriendZone ---
        // --- CẬP NHẬT: THÊM THAM SỐ isFriendZone ---
        function renderPost(container, id, post, isFriendZone = false) { 
            const isMine = currentUser && post.authorId === currentUser.username; 
            const div = document.createElement('div'); 
            div.id = 'post-' + id; 
            
            // --- SỬA LỖI TẠI ĐÂY: đổi postData thành post ---
            div.dataset.authorId = post.authorId; 
            // -----------------------------------------------

            const frameStyle = getFrameColorStyle(post.frameColor); 
            const profileAction = isFriendZone ? `viewFriendZoneProfile('${post.authorId}')` : `viewUserProfile('${post.authorId}')`;
            const activeViewMode = isFriendZone ? currentFZViewMode : currentViewMode;

            // Tính số like THẬT (không tính khách)
            const likes = post.likes || []; 
            const realLikeCount = likes.filter(l => !l.isGuest).length;
            const isLiked = likes.some(l => l.uid === currentUser.username); 
            const heartIconClass = isLiked ? "fa-solid fa-heart text-red-500 heart-animate" : "fa-regular fa-heart text-white"; 

            if (activeViewMode === 'grid') { 
                // Thêm box-border để viền 2px chui vào trong, không bị mất cạnh
                div.className = 'aspect-square bg-gray-800 relative group overflow-hidden cursor-pointer border border-gray-800 rounded-lg box-border'; 
    
                // Gán viền màu (Đảm bảo dùng frameStyle giống trang chính)
                div.style.setProperty('border', `2px solid ${frameStyle.borderColor}`, 'important');
                div.style.boxSizing = 'border-box';

                if (post.frameColor && post.frameColor !== 'gray') {
                    div.style.setProperty('box-shadow', frameStyle.shadow, 'important');
                    // Thêm một chút độ sáng để viền màu nổi bật hơn trong Grid
                    div.style.zIndex = "1";
                }
                
                let thumbnail = ''; 
                // Lấy URL từ post.imageUrl hoặc từ phần tử đầu tiên của mảng post.media (cho FriendZone)
                const mediaUrl = post.imageUrl || (post.media && post.media.length > 0 ? post.media[0].url : '');
                const mediaType = post.mediaType || (post.media && post.media.length > 0 ? post.media[0].type : 'image');

                if(mediaType === 'video') {
                    thumbnail = `<video src="${mediaUrl}" class="w-full h-full object-cover pointer-events-none" playsinline muted preload="metadata"></video><i class="fa-solid fa-play absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white drop-shadow-md"></i>`;
                } else if(mediaType === 'audio') {
                    thumbnail = `<div class="w-full h-full bg-black flex items-center justify-center"><i class="fa-solid fa-music text-app-gold text-2xl"></i></div>`; 
                } else {
                    thumbnail = `<img src="${mediaUrl}" class="w-full h-full object-cover pointer-events-none">`; 
                }
                
                div.innerHTML = thumbnail;
                div.onclick = () => {
                    if (typeof renderTargetPost === 'function') renderTargetPost(id);
                    else if (typeof openSinglePost === 'function') openSinglePost(post);
                }; 

            } else { 
                // Quay lại hiệu ứng kính lỏng (Liquid Glass) nhưng tăng độ đậm của màu nền (từ 15% lên 25%)
                // Kiểm tra xem bài viết đang được render vào đâu?
                // Nếu render vào 'singlePostContainer' (modal xem chi tiết) thì dùng nền ĐẶC
                // Nếu render ở danh sách ngoài thì dùng nền KÍNH TRONG
                const parentId = container.id || '';
                const isSingleView = parentId === 'singlePostContainer';

                if (isSingleView) {
    // 1. Class gốc của Full màn hình
    let fullViewClass = 'bg-[#1E1E1E] border border-white/10 shadow-xl rounded-[2rem] p-3 animate-fade-in-up transition-all duration-300 media-content';
    
    // 2. [LOGIC MỚI] Kiểm tra màu -> Thêm lấp lánh
    if (post.frameColor && post.frameColor !== 'gray') {
        fullViewClass = 'frame-glitter-effect ' + fullViewClass;
    }
    
    div.className = fullViewClass;

                } else {
                    // --- GIAO DIỆN DANH SÁCH (FEED): KÍNH LỎNG (LIQUID GLASS) ---
                    
                    // 1. Khai báo chuỗi class gốc (Giao diện kính lỏng mặc định)
                    let finalClass = 'bg-gradient-to-br from-white/15 to-white/5 backdrop-blur-2xl border border-white/20 shadow-lg rounded-[2rem] p-3 animate-fade-in-up transition-all duration-300 media-content';

                    // 2. [LOGIC MỚI] Kiểm tra: Nếu có màu VÀ không phải màu 'gray' (mặc định) -> Thì mới thêm hiệu ứng lấp lánh
                    if (post.frameColor && post.frameColor !== 'gray') {
                        finalClass = 'frame-glitter-effect ' + finalClass;
                    }

                    // 3. Gán chuỗi class đã xử lý vào thẻ div
                    div.className = finalClass;
                }

                // --- CÁC DÒNG DƯỚI GIỮ NGUYÊN (Vẽ viền màu thật) ---
                div.style.border = `2px solid ${frameStyle.borderColor}`; 
                if (post.frameColor && post.frameColor !== 'gray') div.style.boxShadow = frameStyle.shadow; 
                
                let avatarHTML; 
                if (post.authorAvatarUrl) {
                    avatarHTML = `<img src="${post.authorAvatarUrl}" class="w-10 h-10 rounded-full object-cover border border-gray-600 shadow-md">`; 
                } else if (post.authorId && typeof post.authorId === 'string' && post.authorId.startsWith('guest_')) {
                    avatarHTML = `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-white border border-gray-700 shadow-md"><i class="fa-solid fa-user-secret"></i></div>`; 
                } else {
                    // Thêm kiểm tra post.authorName để không lỗi charAt
                    const name = post.authorName || "U";
                    avatarHTML = `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-600 flex items-center justify-center text-white font-bold text-sm border border-gray-600 shadow-md">${name.charAt(0).toUpperCase()}</div>`; 
                }
                
                // --- SỬA PHẦN AI SECTION Ở ĐÂY ---
                // Tạo một ID duy nhất cho container AI của bài viết này
                const aiContainerId = `ai-section-container-${id}`;

                const rememberedResult = window.aiMemory && window.aiMemory[id];
                
                // Mặc định ban đầu sẽ hiện nút bấm
                let aiSection = '';
                if (post.mediaType === 'image') {
                    if (rememberedResult) {
                        aiSection = `
                            <div id="${aiContainerId}" class="pb-2 ai-sync-container-${id}">
                                <div class="mt-3 bg-black/40 rounded-2xl p-4 border border-white/5 relative mx-1">
                                    <div class="flex justify-between cursor-pointer" onclick="toggleAISummary('${id}', this)">
                                        <div class="flex gap-2 items-center">
                                            <i class="fa-solid fa-wand-magic-sparkles text-app-gold text-xs"></i>
                                            <span class="text-[10px] uppercase font-black text-app-gold">AI Phân tích</span>
                                        </div>
                                        <i class="fa-solid fa-chevron-down text-gray-500 text-xs" id="ai-chevron-${id}"></i>
                                    </div>
                                    <div id="ai-content-${id}" class="hidden">
                                        <p class="text-xs text-gray-300 leading-relaxed italic mt-2 pl-3 border-l-2 border-app-gold/30">"${rememberedResult}"</p>
                                    </div>
                                </div>
                            </div>`;
                    } else {
                        // Nếu chưa có trong sổ nhớ, hiện nút bấm mặc định
                        aiSection = `
                            <div id="${aiContainerId}" class="mt-2 flex justify-end px-2 ai-sync-container-${id}">
                                <button id="analyze-btn-${id}" onclick="requestAnalyzePost('${id}', this)" 
                                    class="text-[10px] bg-white/5 border border-white/10 text-gray-400 hover:text-white px-4 py-2 rounded-full flex gap-2 items-center transition-all hover:bg-white/10">
                                    <i class="fa-solid fa-robot"></i> AI Phân tích
                                </button>
                            </div>`;
                    }
                }
                // HÀM KIỂM TRA RIÊNG TƯ: Nếu đã từng phân tích rồi thì tự hiển thị kết quả
                // HÀM KIỂM TRA RIÊNG TƯ: Nếu đã từng phân tích rồi thì tự hiển thị kết quả
                if (post.mediaType === 'image' && currentUser) {
                    const analysisId = `${id}_${currentUser.uid || currentUser.username}`;
                    db.collection('artifacts').doc(appId)
                        .collection('public').doc('data')
                        .collection('ai_results').doc(analysisId).get().then(doc => {
                            if (doc.exists) {
                                const result = doc.data().result;
                                let containerEl = div.querySelector(`#${aiContainerId}`);
                            
                                // Dự phòng: Nếu chưa gắn vào DOM hoặc lỗi query, mới tìm fallback (hiếm khi xảy ra)
                                if (!containerEl) containerEl = document.getElementById(aiContainerId);
                                if (containerEl) {
                                    containerEl.className = "pb-2"; // Reset class container
                                    containerEl.innerHTML = `
                                        <div class="mt-3 bg-black/40 rounded-2xl p-4 border border-white/5 relative mx-1">
                                            <div class="flex justify-between cursor-pointer" onclick="toggleAISummary('${id}', this)">
                                                <div class="flex gap-2 items-center">
                                                    <i class="fa-solid fa-wand-magic-sparkles text-app-gold text-xs"></i>
                                                    <span class="text-[10px] uppercase font-black text-app-gold">AI Phân tích</span>
                                                </div>
                                                <i class="fa-solid fa-chevron-down text-gray-500 text-xs" id="ai-chevron-${id}"></i>
                                            </div>
                                            <div id="ai-content-${id}" class="hidden">
                                                <p class="text-xs text-gray-300 leading-relaxed italic mt-2 pl-3 border-l-2 border-app-gold/30">"${result}"</p>
                                            </div>
                                        </div>`;

                                    // [QUAN TRỌNG] Đồng bộ ngược lại vào bộ nhớ đệm để lần sau không phải gọi DB nữa
                                    if(!window.aiMemory) window.aiMemory = {};
                                    window.aiMemory[id] = result;
                                }
                            }
                        });
                }
                                // ---------------------------------

                const date = new Date(post.timestamp); 
                const timeFormatted = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} - ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                
                const commKey = CONTINENT_MAP[post.community]; 
                let displayComm = commKey ? TRANSLATIONS[currentLang][commKey] : post.community; 
                if (post.community === 'FRIEND_ZONE') displayComm = "Friend Zone";

                let locationTag = post.community ? `<span class="text-[9px] text-gray-400 bg-black/20 px-2 py-0.5 rounded ml-2 border border-white/5 whitespace-nowrap"><i class="fa-solid fa-globe text-app-gold mr-1"></i>${displayComm}</span>` : ''; 
                
                let mediaHTML = ''; 
                let downloadFilename = `moment_${id}`; 
                if (post.mediaType === 'video') downloadFilename += '.mp4'; 
                else if (post.mediaType === 'audio') downloadFilename += '.mp3'; 
                else downloadFilename += '.jpg'; 
                let downloadIcon = `<button onclick="downloadImage('${post.imageUrl}', '${downloadFilename}')" class="text-gray-500 hover:text-white mr-2 relative z-10"><i class="fa-solid fa-download text-sm"></i></button>`; 
                
                if (post.mediaType === 'video') { 
                    const start = post.trimStart || 0; 
                    mediaHTML = `<video src="${post.imageUrl}" class="w-full h-full object-cover" autoplay muted playsinline webkit-playsinline preload="auto" id="vid-feed-${id}" onloadedmetadata="this.currentTime=${start}" onended="this.currentTime=${start}; this.pause();"></video><div class="absolute bottom-4 right-4 z-10"><button onclick="event.stopPropagation(); toggleMute('vid-feed-${id}')" class="bg-black/50 text-white rounded-full p-2 w-8 h-8 flex items-center justify-center hover:bg-black/80"><i class="fa-solid fa-volume-xmark"></i></button></div>`; 
                } else if (post.mediaType === 'audio') { 
                    mediaHTML = `<div class="audio-wrapper w-full h-full bg-black flex flex-col items-center justify-center relative overflow-hidden transition-all duration-500"><div class="audio-pulse" style="animation-delay: 0s;"></div><div class="audio-pulse" style="animation-delay: 1s;"></div><div class="z-10 bg-app-gold w-16 h-16 rounded-full flex items-center justify-center shadow-[0_0_20px_#FFB800]"><i class="fa-solid fa-music text-black text-2xl music-icon"></i></div><audio src="${post.imageUrl}" autoplay muted id="aud-feed-${id}" onplay="this.closest('.audio-wrapper').classList.add('is-playing')" onpause="this.closest('.audio-wrapper').classList.remove('is-playing')" onended="this.currentTime=0; this.pause(); this.closest('.audio-wrapper').classList.remove('is-playing')"></audio><div class="absolute bottom-4 right-4 z-20"><button onclick="event.stopPropagation(); toggleMute('aud-feed-${id}', 'audio')" class="bg-white/20 text-white rounded-full p-2 w-8 h-8 flex items-center justify-center hover:bg-white/40"><i class="fa-solid fa-volume-xmark"></i></button></div></div>`; 
                } else { mediaHTML = `<img src="${post.imageUrl}" class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-105">`; } 

                const dblTapWrapper = `<div class="w-full aspect-[3/4] bg-black rounded-[1.5rem] overflow-hidden relative border border-gray-800/50 shadow-inner group cursor-pointer" onclick="handleMediaTap(event, '${id}', ${JSON.stringify(likes).replace(/"/g, '&quot;')})">
                    ${mediaHTML}
                    ${post.caption ? `
                        <div class="absolute bottom-0 left-0 w-full h-full pointer-events-none flex items-end justify-center pb-6 bg-gradient-to-t from-black/80 via-transparent to-transparent">
                            <p class="w-full text-white text-center text-xl font-hand leading-relaxed drop-shadow-md transition-transform group-hover:-translate-y-2 break-words whitespace-pre-line px-4" style="text-wrap: balance;">
                                ${post.caption.trim()}
                            </p>
                        </div>` : ''}
                </div>`;
                const commentCount = post.commentCount || 0;

                div.innerHTML = `
                <div class="flex items-center gap-3 px-2 mb-3 mt-1">
                    <div class="cursor-pointer transition-transform hover:scale-105 relative z-10" onclick="${profileAction}">
                        ${avatarHTML}
                    </div>

                    <div class="flex-1 min-w-0 h-full flex flex-col justify-center cursor-pointer self-stretch" onclick="openFullPostById('${id}')" title="Xem chi tiết">
                        <div class="flex items-center flex-wrap gap-y-1">
                            <p class="font-bold text-white text-sm truncate mr-1 cursor-pointer hover:underline relative z-10" onclick="event.stopPropagation(); ${profileAction}">
                                ${post.authorName}
                            </p>
                            ${locationTag}
                        </div>
                        <p class="text-[10px] font-bold text-gray-500 mt-0.5">${timeFormatted}</p>
                    </div>

                    ${downloadIcon}
                    ${isMine ? `<button onclick="requestDelete('${id}')" class="ml-auto text-gray-600 hover:text-red-500 w-8 h-8 rounded-full relative z-10"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                </div>
                
                ${dblTapWrapper}
                
                <div class="flex items-center mt-4 px-2">
                    <div class="flex gap-4 items-center shrink-0">
                        <div class="flex flex-col items-center">
                            <button onclick='toggleLike("${id}", ${JSON.stringify(likes).replace(/"/g, '&quot;')})' class="text-xl hover:scale-110 transition-transform"><i class="${heartIconClass}"></i></button>
                            <span class="text-[10px] text-gray-400 cursor-pointer hover:text-white" onclick='showLikesList(${JSON.stringify(likes).replace(/"/g, '&quot;')}, ${isFriendZone})'>${realLikeCount}</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <button onclick="openComments('${id}', null, null, ${isFriendZone})" class="text-xl text-white hover:scale-110 transition-transform"><i class="fa-regular fa-comment"></i></button>
                            <span class="text-[10px] text-gray-400 cursor-pointer" onclick="openComments('${id}', null, null, ${isFriendZone})">${commentCount}</span>
                        </div>
                    </div>
                    <div class="flex-1 self-stretch min-h-[40px] cursor-pointer mx-2" onclick="openFullPostById('${id}')" title="Xem chi tiết"></div>
                </div>
                
                <div class="pb-2">
                    ${aiSection}
                </div>
                `; 
                
                const mediaEl = div.querySelector('video, audio'); 
                if (mediaEl && feedObserver) feedObserver.observe(mediaEl); 
            } 
            container.appendChild(div); 
        }

        // --- MEDIA FUNCTIONS ---
        function checkVideoLoop(video, start, end) {
            if (video.currentTime >= end) {
                video.currentTime = start;
                video.play();
            }
        }
        
        function toggleMute(id, type = 'video') {
            const el = document.getElementById(id);
            if(el) {
                el.muted = !el.muted;
                // Tìm nút bấm nằm cùng cấp hoặc trong cùng wrapper để đổi Icon
                const btn = el.closest('div').querySelector('button i') || el.parentNode.querySelector('button i');
                if(btn) {
                    btn.className = el.muted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
                }
                
                // Nếu bật âm thanh mà nhạc đang dừng thì cho chạy luôn
                if(!el.muted && el.paused) {
                    el.play().catch(e => console.log("Auto-play blocked"));
                }
            }
        }

        function triggerCamera() { document.getElementById('cameraInput').click(); }
        
        function handleFileSelect(e) {
            const file = e.target.files[0]; if (!file) return;
            selectedFile = file; 
            
            const uploadSelect = document.getElementById('uploadCommunitySelect');
            if(uploadSelect) uploadSelect.value = currentCommunity;
            
            if (file.type.startsWith('image/')) {
                document.getElementById('previewContainer').innerHTML = '<img id="imagePreview" src="" class="w-full h-full object-cover">';
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image(); img.src = ev.target.result;
                    img.onload = () => {
                         const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                         const s = 800/Math.max(img.width, img.height);
                         c.width = img.width*s; c.height = img.height*s;
                         ctx.drawImage(img,0,0,c.width,c.height);
                         document.getElementById('imagePreview').src = c.toDataURL('image/jpeg', 0.7);
                         document.getElementById('uploadOverlay').classList.remove('hidden');
                    }
                }; reader.readAsDataURL(file);
            } 
            else if (file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                const url = URL.createObjectURL(file);
                const isVideo = file.type.startsWith('video/');
                const tag = isVideo ? `<video id="mediaPreview" src="${url}" class="w-full h-full object-cover" autoplay loop muted></video>` : `<div class="w-full h-full flex items-center justify-center bg-black"><i class="fa-solid fa-music text-app-gold text-4xl animate-bounce"></i><audio id="mediaPreview" src="${url}" loop></audio></div>`;
                document.getElementById('previewContainer').innerHTML = tag;
                document.getElementById('uploadOverlay').classList.remove('hidden');
            }
        }

        async function compressImageFile(file) {
            return new Promise((resolve) => {
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     const img = new Image(); img.src = e.target.result;
                     img.onload = () => {
                         const canvas = document.createElement('canvas');
                         let width = img.width; let height = img.height;
                         if(width > 800) { height *= 800/width; width = 800; }
                         canvas.width = width; canvas.height = height;
                         const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                         resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                     }
                 }; reader.readAsDataURL(file);
            });
        }

        function closeCamera() {
            document.getElementById('uploadOverlay').classList.add('hidden');
            document.getElementById('previewContainer').innerHTML = ''; 
            document.getElementById('captionInput').value = '';
            document.getElementById('uploadCommunitySelect').value = 'Toàn Cầu';
            document.getElementById('charCount').textContent = '0/100';
            document.getElementById('c_gray').checked = true; // Chọn lại nút màu xám
            updateFramePreview('gray');
            selectedFile = null;
        }

        async function publishPost() { 
            const caption = document.getElementById('captionInput').value; 
            const comm = document.getElementById('uploadCommunitySelect').value; 
            const colorRadios = document.getElementsByName('frameColor'); 
            let selectedColor = 'gray'; 
            for (const r of colorRadios) { if(r.checked) selectedColor = r.value; } 
            
            if (!selectedFile) return; 
            
            document.getElementById('uploadLoading').classList.remove('hidden'); 
            
            const limitMB = 0.75; // (~768KB)
    
            if (!selectedFile.type.startsWith('image/') && selectedFile.size > limitMB * 1024 * 1024) { 
                showToast(`File quá nặng (> ${limitMB * 1000}KB). Server Free giới hạn 1MB.`); 
                document.getElementById('uploadLoading').classList.add('hidden'); 
                return; 
            } 
            
            try { 
                let base64Data = ""; 
                let mediaType = 'image'; 
                
                if (selectedFile.type.startsWith('image/')) { 
                    base64Data = await compressImageFile(selectedFile); 
                } else { 
                    mediaType = selectedFile.type.startsWith('video/') ? 'video' : 'audio'; 
                    base64Data = await new Promise((resolve) => { 
                        const reader = new FileReader(); 
                        reader.onloadend = () => resolve(reader.result); 
                        reader.readAsDataURL(selectedFile); 
                    }); 

                    // 👇👇👇 ĐOẠN MỚI THÊM ĐỂ SỬA LỖI MOV 👇👇👇
                    // Nếu là file MOV, đổi header sang MP4 để trình duyệt xem được
                    if (selectedFile.name.toLowerCase().endsWith('.mov')) {
                        base64Data = base64Data.replace('data:video/quicktime;', 'data:video/mp4;');
                    }
                    // 👆👆👆 KẾT THÚC ĐOẠN SỬA 👆👆👆
                } 
                
                const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').add({ 
                    authorId: currentUser.username, 
                    authorName: currentUser.displayName, 
                    authorAvatarUrl: currentUser.avatarUrl || null, 
                    imageUrl: base64Data, 
                    mediaType: mediaType, 
                    caption: caption, 
                    community: comm, 
                    timestamp: Date.now(), 
                    aiSummary: null, 
                    frameColor: selectedColor, 
                    likes: [], 
                    trimStart: 0,
                    commentCount: 0 
                }); 

                const locationDisplay = getDisplayContinent(comm);

                // THAY ĐỔI: Nếu là ảnh thì gửi base64, nếu là video/audio thì gửi chuỗi định danh 'video'/'audio'
                const notificationThumb = mediaType === 'image' ? base64Data : mediaType;
                sendNotification(currentUser.username, 'post', docRef.id, notificationThumb, locationDisplay);

                // KẾT THÚC SỬA
                
                closeCamera(); 
                showToast("Đã đăng!"); 
                scrollToTop(); 
            } catch (e) { 
                showToast(e.message || "Lỗi đăng bài."); 
                console.error(e); 
            } 
            document.getElementById('uploadLoading').classList.add('hidden'); 
        }

        function toggleAuthMode(mode) {
            document.getElementById('authError').textContent = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('regName').value = '';
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('loginForm').classList.toggle('hidden', mode !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', mode !== 'register');
        }

        function togglePassword(id, btn) {
            const inp = document.getElementById(id);
            inp.type = inp.type === 'password' ? 'text' : 'password';
            btn.querySelector('i').classList.toggle('fa-eye');
            btn.querySelector('i').classList.toggle('fa-eye-slash');
        }

        document.getElementById('captionInput').addEventListener('input', function() {
            if(this.value.length > 100) this.value = this.value.slice(0, 100);
            document.getElementById('charCount').textContent = `${this.value.length}/100`;
        });
        
        function scrollToTop() { document.getElementById('feedContainer').scrollTo(0,0); }
        function refreshFeed() { 
            // Hàm này sẽ được gọi khi kéo lên
            showToast("Đang làm mới..."); 
            subscribeToFeed(); 
            scrollToTop(); 
        }
        // --- LOGIC THÔNG BÁO (MỚI) ---

        // 1. Hàm gửi thông báo
        // Hàm gửi thông báo (Đã cập nhật thêm tham số relatedId ở cuối)
        // Thêm tham số relatedParentId ở cuối
        // --- CẬP NHẬT: THÊM THAM SỐ community VÀO DB ---
        // --- BƯỚC 1: SỬA HÀM GỬI THÔNG BÁO ĐỂ NHẬN DIỆN KHU VỰC ---
        async function sendNotification(recipientId, type, postId, postImage, extraInfo = "", relatedId = null, relatedParentId = null, specificCommunity = null) {
            if (!currentUser) return;
            if (recipientId === currentUser.username && type !== 'post') return; 

            let finalImage = postImage;
            if (type === 'friend_request' || type === 'friend_accept') {
                finalImage = null;
            }

            try {
                // Mặc định là Toàn Cầu
                let community = 'Toàn Cầu'; 

                // ƯU TIÊN 1: Nếu có truyền tham số specificCommunity (từ hàm Like/Comment gửi sang) -> Lấy luôn
                if (specificCommunity) {
                    community = specificCommunity;
                } 
                // ƯU TIÊN 2: Nếu không truyền, mới bắt đầu đoán (Logic cũ)
                else if (postId) {
                    if (currentCommunity === 'FRIEND_ZONE' || (pendingPhitayPost && pendingPhitayPost.community === 'FRIEND_ZONE')) {
                        community = 'FRIEND_ZONE';
                    }
                    const fzModal = document.getElementById('friendZoneModal');
                    if (!fzModal.classList.contains('hidden')) {
                        community = 'FRIEND_ZONE';
                    }
                }

                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').add({
                    recipientId: recipientId,
                    senderId: currentUser.username,
                    senderName: currentUser.displayName,
                    senderAvatar: currentUser.avatarUrl || null,
                    type: type,
                    postId: postId || null,
                    postImage: finalImage,
                    extraInfo: extraInfo, 
                    relatedId: relatedId,
                    relatedParentId: relatedParentId,
                    timestamp: Date.now(),
                    isRead: false,
                    community: community // Lưu chính xác khu vực vào đây
                });
            } catch (e) { console.error("Lỗi gửi thông báo:", e); }
        }

        // Hàm cập nhật hoặc xóa thông báo khi tin nhắn thay đổi
        async function syncNotification(msgId, newText, isDeleted = false) {
            try {
                // Tìm tất cả thông báo liên quan đến tin nhắn này (dựa vào relatedId)
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('notifications')
                    .where('relatedId', '==', msgId)
                    .get();

                if (snapshot.empty) return;

                const batch = db.batch();

                snapshot.docs.forEach(doc => {
                    if (isDeleted) {
                        // Trường hợp 1: Xóa tin nhắn -> Xóa luôn thông báo
                        batch.delete(doc.ref);
                    } else {
                        // Trường hợp 2: Sửa tin nhắn -> Cập nhật nội dung thông báo
                        // Lưu ý: Giữ lại prefix nếu có (ví dụ: "Nhóm ABC: ...")
                        let currentInfo = doc.data().extraInfo || "";
                        
                        // Logic đơn giản: Thay thế nội dung cũ bằng nội dung mới
                        // Hoặc bạn có thể set cứng format mới
                        let updatedInfo = "";
                        
                        if (currentInfo.includes(":")) {
                            // Nếu là thông báo nhóm (có dạng "Nhóm X: Nội dung")
                            const prefix = currentInfo.split(':')[0]; 
                            updatedInfo = `${prefix}: "${newText}" (đã sửa)`;
                        } else {
                            // Tin nhắn riêng
                            updatedInfo = `Đã gửi một tin nhắn: "${newText}" (đã sửa)`;
                        }

                        batch.update(doc.ref, { 
                            extraInfo: updatedInfo,
                            isRead: false // Tùy chọn: Đánh dấu chưa đọc lại để người kia chú ý (hoặc bỏ dòng này)
                        });
                    }
                });

                await batch.commit();
                console.log("Đã đồng bộ thông báo!");
            } catch (e) {
                console.error("Lỗi đồng bộ thông báo:", e);
            }
        }

        // 2. Hàm nhận thông báo (Đã cập nhật: Hiển thị ghi chú cho KHÁCH)
        // --- SỬA HÀM THÔNG BÁO CHÍNH (LOẠI BỎ FRIEND ZONE RA KHỎI ĐÂY) ---
        // 2. Hàm nhận thông báo (Đã cập nhật: Hiển thị ghi chú cho KHÁCH + THÊM NGÀY GIỜ)
        // 2. Hàm nhận thông báo (Đã cập nhật: LỌC BỎ TIN NHẮN RIÊNG)
        let notifUnsubscribe = null;
        function subscribeToNotifications() {
            if (!currentUser) return;

            // Logic cho khách
            if (currentUser.isGuest) {
                const list = document.getElementById('notifList');
                const badge = document.getElementById('notifBadge');
                if(badge) badge.classList.add('hidden'); 
                if(list) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs gap-4 opacity-70 px-6 text-center animate-fade-in">
                            <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center border border-white/10">
                                <i class="fa-solid fa-user-lock text-2xl text-gray-400"></i>
                            </div>
                            <div class="space-y-1">
                                <p class="font-bold text-white text-sm uppercase tracking-wider">Chế độ Khách</p>
                                <p>Tài khoản khách không dùng chức năng thông báo.</p>
                            </div>
                        </div>`;
                }
                if (notifUnsubscribe) { notifUnsubscribe(); notifUnsubscribe = null; }
                return;
            }

            // Logic cho User thường
            if (notifUnsubscribe) notifUnsubscribe();

            notifUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('notifications')
                .where('recipientId', '==', currentUser.username)
                .limit(50) 
                .onSnapshot(snapshot => {
                    const list = document.getElementById('notifList');
                    const badge = document.getElementById('notifBadge');
                    
                    let rawNotifs = [];
                    snapshot.forEach(doc => rawNotifs.push({ id: doc.id, ...doc.data() }));
                    
                    // --- [QUAN TRỌNG] BỘ LỌC ĐÃ SỬA ---
                    // Lọc bỏ Friend Zone VÀ Lọc bỏ Private Message (Tin nhắn riêng)
                    let notifs = rawNotifs.filter(n => 
                        n.community !== 'FRIEND_ZONE' && 
                        n.type !== 'private_message'
                    );
                    // ----------------------------------

                    notifs.sort((a, b) => b.timestamp - a.timestamp);

                    if (notifs.length === 0) {
                        list.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs gap-3 opacity-50"><i class="fa-regular fa-bell-slash text-3xl"></i><p>Chưa có thông báo nào</p></div>';
                        badge.classList.add('hidden'); 
                        return;
                    }

                    let unreadCount = notifs.filter(n => !n.isRead).length;
                    let html = '';

                    notifs.forEach(n => {
                        let text = "";
                        let icon = "";
                        
                        const dateObj = new Date(n.timestamp);
                        const formattedTime = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2, '0')} - ${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;

                        if (n.type === 'like') {
                            text = "đã thích bài viết của bạn.";
                            icon = '<i class="fa-solid fa-heart text-red-500 text-[10px]"></i>';
                        } else if (n.type === 'like_comment') {
                            text = "đã thích bình luận của bạn.";
                            icon = '<i class="fa-solid fa-heart text-pink-500 text-[10px]"></i>';
                        } else if (n.type === 'reply_comment') {
                            text = "đã trả lời bình luận của bạn.";
                            icon = '<i class="fa-solid fa-reply text-blue-400 text-[10px]"></i>';
                        } else if (n.type === 'mention') {
                            text = "đã nhắc đến bạn trong bình luận.";
                            icon = '<i class="fa-solid fa-at text-purple-500 text-[10px]"></i>';
                        } else if (n.type === 'comment') {
                            text = "đã bình luận về bài viết.";
                            icon = '<i class="fa-solid fa-comment text-blue-500 text-[10px]"></i>';
                        } else if (n.type === 'friend_request') {
                            text = "đã gửi lời mời kết bạn.";
                            icon = '<i class="fa-solid fa-user-plus text-app-gold text-[10px]"></i>';
                        } else if (n.type === 'friend_accept') {
                            text = "đã chấp nhận lời mời kết bạn.";
                            icon = '<i class="fa-solid fa-handshake text-green-500 text-[10px]"></i>';
                        } else if (n.type === 'post') {
                            const locationName = n.extraInfo || "Toàn Cầu";
                            text = `đã đăng bài viết mới tại <span class="text-app-gold font-bold">${locationName}</span>`;
                            icon = '<i class="fa-solid fa-circle-check text-green-500 text-[10px]"></i>';
                        }

                        const bgClass = n.isRead 
                            ? 'opacity-60 border-transparent' 
                            : 'bg-app-gold/5 border border-app-gold/30 shadow-[inset_0_0_10px_rgba(255,184,0,0.05)]';
                        
                        let avatar = n.senderAvatar ? `<img src="${n.senderAvatar}" class="w-9 h-9 rounded-full object-cover border border-gray-600">` : `<div class="w-9 h-9 rounded-full bg-gray-700 flex items-center justify-center text-white text-xs font-bold">${n.senderName.charAt(0)}</div>`;

                        let thumb = '';
                        if(n.postImage) {
                            if(n.postImage.startsWith('data:image')) {
                                thumb = `<img src="${n.postImage}" class="w-9 h-9 rounded-md object-cover border border-gray-600 ml-auto shadow-sm">`;
                            } else {
                                let iconClass = 'fa-file'; 
                                let iconColor = 'text-gray-500';
                                if(n.postImage === 'video') { iconClass = 'fa-circle-play'; iconColor = 'text-blue-400'; } 
                                else if(n.postImage === 'audio') { iconClass = 'fa-music'; iconColor = 'text-app-gold'; }
                                thumb = `<div class="w-9 h-9 rounded-md bg-gray-800 border border-gray-700 ml-auto flex items-center justify-center shadow-inner"><i class="fa-solid ${iconClass} ${iconColor} text-xs"></i></div>`;
                            }
                        }

                        let clickAction = '';
                        if (n.type === 'friend_request') {
                            clickAction = `handleFriendRequestNotifClick('${n.id}', '${n.senderId}')`;
                        } else if (n.type === 'friend_accept') { 
                            clickAction = `handleSimpleRead('${n.id}')`;
                        } else {
                            clickAction = `handleNotifClick('${n.id}', '${n.postId}', '${n.relatedId || ''}', '${n.relatedParentId || ''}')`;
                        }

                        html += `
                        <div onclick="${clickAction}" class="relative flex items-center gap-3 p-4 mb-1 rounded-xl transition-all ${bgClass} cursor-pointer hover:bg-white/10 group pr-10">
                            <button onclick="deleteNotification(event, '${n.id}')" class="absolute top-1/2 -translate-y-1/2 right-2 w-7 h-7 rounded-full bg-black/20 text-gray-500 hover:text-red-500 hover:bg-red-500/10 flex items-center justify-center transition-all opacity-100 z-20" title="Xóa thông báo này">
                                <i class="fa-solid fa-xmark"></i>
                            </button>

                            <div class="relative">${avatar}<div class="absolute -bottom-1 -right-1 w-4 h-4 bg-app-dark rounded-full border border-gray-700 flex items-center justify-center">${icon}</div></div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-300"><span class="font-bold text-white">${n.senderName}</span> ${text}</p>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <p class="text-[9px] text-gray-400 font-bold">${timeAgo(n.timestamp)}</p>
                                    <span class="text-[8px] text-gray-600">•</span>
                                    <p class="text-[9px] text-gray-500 font-mono">${formattedTime}</p>
                                </div>
                            </div>
                            ${thumb}
                        </div>`;
                    });
                    
                    list.innerHTML = html;
                    
                    if (unreadCount > 0) { 
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount; 
                        badge.classList.remove('hidden'); 
                    } else { 
                        badge.classList.add('hidden'); 
                    }
                });
        }

        // 3. Xử lý khi bấm vào thông báo
        // 3. Xử lý khi bấm vào thông báo
        // 3. Xử lý khi bấm vào thông báo
        async function handleNotifClick(notifId, postId, targetMsgId = null, relatedParentId = null) {
            // ========================================================================
            // [PHẦN MỚI THÊM]: KIỂM TRA NGƯỜI GỬI CÓ TỒN TẠI KHÔNG TRƯỚC
            // ========================================================================
            try {
                // Lấy thông báo để xem ai gửi
                const checkDoc = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('notifications')
                    .doc(notifId).get();

                if (checkDoc.exists) {
                    const nData = checkDoc.data();
                    // Nếu có người gửi (và không phải SYSTEM) -> Kiểm tra xem user đó còn không
                    if (nData.senderId && nData.senderId !== 'SYSTEM') {
                        const senderCheck = await db.collection('artifacts').doc(appId)
                            .collection('public').doc('data').collection('users')
                            .doc(nData.senderId).get();

                        if (!senderCheck.exists) {
                            showToast("Người dùng này không tồn tại hoặc đã xóa tài khoản.", "error");
                            
                            // Vẫn đánh dấu đã đọc (dùng đúng dòng code của bạn)
                            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
                            
                            return; // <--- DỪNG HÀM NGAY TẠI ĐÂY
                        }
                    }
                }
            } catch (err) {
                console.error("Lỗi kiểm tra user:", err);
            }
            // 1. Đánh dấu thông báo là đã đọc
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
            
            toggleNotifications(); 

            // 2. NHẬN DIỆN THÔNG BÁO TIN NHẮN (PostId rỗng)
            if (!postId || postId === 'null' || postId === 'undefined') {
                const notifDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).get();
                if (!notifDoc.exists) return;
                
                const nData = notifDoc.data();
                const msgId = nData.relatedId; // ID tin nhắn cụ thể cần tìm

                // QUAN TRỌNG: Gán ID vào biến chờ toàn cục trước khi mở chat
                pendingMessageScrollId = msgId; 

                if (nData.community === 'GROUP_CHAT' && nData.relatedParentId) {
                    // TRƯỜNG HỢP: TIN NHẮN NHÓM
                    const groupId = nData.relatedParentId;
                    const msgId = nData.relatedId; // Lấy lại msgId cho chắc
                    const groupDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(groupId).get();
                    
                    if (groupDoc.exists) {
                        const gData = groupDoc.data();
                        
                        if (gData.members && gData.members.includes(currentUser.username)) {
                            startGroupChat(groupId, gData.name, gData.members, msgId, gData.avatarUrl);
                        } else {
                            showToast("Bạn không còn là thành viên của nhóm này.");
                        }
                    } else {
                        showToast("Nhóm không tồn tại.");
                    }
                } else {
                    // TRƯỜNG HỢP: TIN NHẮN RIÊNG
                    startChatWith(nData.senderId, nData.senderName, null, msgId);
                }
                return;
            }

            // 3. LOGIC CHO BÀI VIẾT (ĐÃ SỬA ĐỂ NHẢY VÀO BÌNH LUẬN + HIGHLIGHT GỐC)
            try {
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).get();
                if (doc.exists) {
                    const postData = {id: doc.id, ...doc.data()};

                    if (postData.community === 'PHITAY' && currentCommunity !== 'PHITAY') {
                        pendingPhitayPost = postData; // Lưu bài viết vào biến chờ (biến này đã có sẵn trong logic checkPhitayPass của bạn)
                        requestPhitayAccess(true);    // Mở bảng nhập mật khẩu
                        return;                       // Dừng ngay lập tức, không mở bài viết
                    }
                    
                    // Mở bài viết chi tiết
                    openSinglePost(postData);

                    // --- [ĐOẠN ĐÃ SỬA]: MỞ BÌNH LUẬN VÀ HIGHLIGHT CẢ 2 ---
                    // Nếu có targetMsgId (ID tin nhắn trả lời)
                    if (targetMsgId && targetMsgId !== 'null' && targetMsgId !== 'undefined') {
                        setTimeout(() => {
                            // Gọi openComments: 
                            // Param 1: PostID
                            // Param 2: ID cần tô đỏ (targetMsgId - tin trả lời)
                            // Param 3: ID cần tô vàng (relatedParentId - tin gốc) -> ĐÃ SỬA CHỖ NÀY
                            // Param 4: isFriendZone = false
                            
                            // Xử lý null cho chắc chắn nếu không có relatedParentId
                            const parentIdToHighlight = (relatedParentId && relatedParentId !== 'null' && relatedParentId !== 'undefined') ? relatedParentId : null;
                            
                            openComments(postId, targetMsgId, parentIdToHighlight, false);
                        }, 500); // Đợi 0.5s cho Modal bài viết hiện lên
                    }
                    // ---------------------------------------------------
                } else {
                    showToast("Bài viết không còn tồn tại");
                }
            } catch(e) { console.error(e); }
        }

        // --- HÀM XỬ LÝ KHI BẤM VÀO THÔNG BÁO FRIEND ZONE ---
        async function handleFZNotifClick(notifId, postId, targetRedId = null, targetYellowId = null) {

            // ========================================================================
            // [PHẦN MỚI THÊM]: KIỂM TRA NGƯỜI GỬI CÓ TỒN TẠI KHÔNG TRƯỚC
            // ========================================================================
            try {
                // Lấy thông tin thông báo để biết ai gửi
                const checkDoc = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('notifications')
                    .doc(notifId).get();

                if (checkDoc.exists) {
                    const nData = checkDoc.data();
                    
                    // Nếu có người gửi (và không phải SYSTEM) -> Kiểm tra User
                    if (nData.senderId && nData.senderId !== 'SYSTEM') {
                        const senderCheck = await db.collection('artifacts').doc(appId)
                            .collection('public').doc('data').collection('users')
                            .doc(nData.senderId).get();

                        if (!senderCheck.exists) {
                            // NẾU USER ĐÃ XÓA -> BÁO LỖI
                            showToast("Người dùng này không tồn tại hoặc đã xóa tài khoản.", "error");
                            
                            // Vẫn chạy lệnh đánh dấu đã đọc (như code gốc của bạn) để tắt thông báo
                            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
                            
                            return; // <--- DỪNG HÀM NGAY TẠI ĐÂY (Không mở bài viết nữa)
                        }
                    }
                }
            } catch (err) {
                console.error("Lỗi kiểm tra user:", err);
            }
            // 1. Đánh dấu đã đọc
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
            
            // 2. Đóng bảng thông báo Friend Zone
            toggleFriendZoneNotifications(); 
            
            // 3. Xử lý mở bài viết và bình luận
            try {
                // Kiểm tra xem bài viết có trong cache chưa, nếu chưa thì fetch (đã được xử lý bởi openFullPostById -> openSinglePost)
                // Tuy nhiên để chắc chắn lấy đúng data mới nhất, ta query nhẹ
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').doc(postId).get();
                
                if (doc.exists) {
                    const postData = {id: doc.id, ...doc.data()};
                    
                    // Mở bài viết chi tiết (với chế độ FZ)
                    openSinglePost(postData);
                    
                    // 4. LOGIC MỞ BÌNH LUẬN (GIỐNG TRANG CHÍNH)
                    // Nếu có targetRedId (Reply ID) hoặc targetYellowId (Comment ID) -> MỞ MODAL COMMENT
                    if ((targetRedId && targetRedId !== 'undefined') || (targetYellowId && targetYellowId !== 'undefined')) {
                        setTimeout(() => {
                            // Tham số thứ 4 là isFriendZone = true
                            openComments(postId, targetRedId || null, targetYellowId || null, true);
                        }, 500); // Đợi modal bài viết hiện lên rồi mới mở comment
                    }
                } else {
                    showToast("Bài viết không còn tồn tại");
                }
            } catch(e) { 
                console.error(e); 
                showToast("Lỗi mở bài viết");
            }
        }

        async function handleFriendRequestNotifClick(notifId, senderId) {

            const userCheck = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(senderId).get();
            
            if (!userCheck.exists) {
                showToast("Người dùng này không tồn tại hoặc đã xóa tài khoản.", "error");
                // Đánh dấu đã đọc để ẩn đi
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
                return;
            }

            // 1. Đánh dấu thông báo là đã đọc trong Database
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
            
            // 2. Đóng bảng thông báo
            toggleNotifications();
            
            // 3. Mở hồ sơ người gửi lời mời
            viewUserProfile(senderId);
        }

        // Hàm tắt/mở bảng thông báo
        function toggleNotifications() { document.getElementById('notifModal').classList.toggle('hidden'); }

        // Hàm đánh dấu tất cả là đã đọc
        // Hàm đánh dấu đã đọc cho TRANG CHÍNH (Loại bỏ Friend Zone)
        async function markAllRead() {
            if (!currentUser) return;
            
            try {
                const batch = db.batch();
                // Lấy tất cả thông báo chưa đọc
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications')
                    .where('recipientId', '==', currentUser.username)
                    .where('isRead', '==', false)
                    .get();

                if (snap.empty) return;

                let count = 0;
                snap.forEach(d => {
                    const data = d.data();
                    // QUAN TRỌNG: Chỉ đánh dấu nếu KHÔNG PHẢI là Friend Zone
                    if (data.community !== 'FRIEND_ZONE') {
                        batch.update(d.ref, { isRead: true });
                        count++;
                    }
                });

                if (count > 0) {
                    await batch.commit();
                    // showToast("Đã đánh dấu đọc các thông báo chung"); // Bật dòng này nếu muốn hiện thông báo
                }
            } catch (e) {
                console.error("Lỗi markAllRead:", e);
            }
        }

        // Hàm tính thời gian
        // --- CẬP NHẬT: CÔNG CỤ TÍNH NGÀY GIỜ CHUẨN (Fix lỗi năm mới) ---
        function timeAgo(dateParam) {
            if (!dateParam) return '';
            
            // Chấp nhận cả timestamp (số) và đối tượng Date
            const date = typeof dateParam === 'object' ? dateParam : new Date(dateParam);
            const now = new Date();
            
            const seconds = Math.round((now - date) / 1000);
            const minutes = Math.round(seconds / 60);
            
            const isToday = now.toDateString() === date.toDateString();
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const isYesterday = yesterday.toDateString() === date.toDateString();

            // 1. Vừa xong (dưới 1 phút)
            if (seconds < 60) return 'Vừa xong';
            
            // 2. Dưới 60 phút
            if (minutes < 60) return `${minutes} phút trước`;

            // 3. Trong hôm nay (Hiện giờ:phút)
            if (isToday) {
                const h = String(date.getHours()).padStart(2, '0');
                const m = String(date.getMinutes()).padStart(2, '0');
                return `Hôm nay lúc ${h}:${m}`;
            }

            // 4. Hôm qua
            if (isYesterday) {
                const h = String(date.getHours()).padStart(2, '0');
                const m = String(date.getMinutes()).padStart(2, '0');
                return `Hôm qua lúc ${h}:${m}`;
            }

            // 5. Cũ hơn (Hiện đầy đủ Ngày/Tháng/Năm)
            // Code này lấy năm từ chính bài viết (date.getFullYear) nên sang năm sau vẫn đúng
            const d = String(date.getDate()).padStart(2, '0');
            const mo = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');

            return `${h}:${m} ${d}/${mo}/${y}`;
        }

        // --- LOGIC TAG BẠN BÈ (@MENTION) ---

        // --- BIẾN LƯU TẠM THÔNG TIN NGƯỜI SẮP ĐƯỢC BẦU ---
        let pendingPromoteData = null;

        // 1. Hàm mở Modal xác nhận
        function openPromoteModal(groupId, userId, userName) {
            // Lưu thông tin vào biến tạm
            pendingPromoteData = { groupId, userId, userName };

            // Cập nhật tên lên giao diện
            document.getElementById('promoteTargetName').textContent = userName;

            // Hiện Modal
            document.getElementById('promoteConfirmModal').classList.remove('hidden');
        }

        // 2. Hàm đóng Modal
        function closePromoteModal() {
            document.getElementById('promoteConfirmModal').classList.add('hidden');
            pendingPromoteData = null; // Xóa biến tạm
        }

        // 3. Hàm thực thi (Khi bấm nút Đồng Ý)
        function executePromoteAction() {
            if (!pendingPromoteData) return;
            
            // Gọi hàm Database (Hàm này ở Bước 4)
            promoteMemberToAdminDB(
                pendingPromoteData.groupId, 
                pendingPromoteData.userId, 
                pendingPromoteData.userName
            );
            
            // Đóng modal
            closePromoteModal();
        }

        let friendsForTagging = []; // Cache danh sách bạn bè
        let isTaggingMode = false;

        // 1. Hàm tải danh sách bạn bè để chuẩn bị cho việc Tag (Gọi khi mở Comment)
        async function prepareFriendsForTagging() {
            if (!currentUser) return;
            friendsForTagging = [];

            try {
                // Lấy danh sách ID bạn bè
                const friendIds = new Set();
                
                // Query chiều 1
                const snap1 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user1', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap1.forEach(doc => friendIds.add(doc.data().user2));

                // Query chiều 2
                const snap2 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user2', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap2.forEach(doc => friendIds.add(doc.data().user1));

                // Tải thông tin chi tiết (Tên, Avatar)
                const ids = Array.from(friendIds);
                if (ids.length === 0) return;

                // Lưu ý: Firestore 'in' query giới hạn 10 items, nên tốt nhất loop qua lấy cho đơn giản
                // Hoặc query user collection (nếu database nhỏ). Ở đây ta dùng loop fetch để chắc ăn.
                for (const fid of ids) {
                    const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(fid).get();
                    if (doc.exists) {
                        const u = doc.data();
                        friendsForTagging.push({
                            id: fid,
                            name: u.displayName,
                            avatar: u.avatarUrl
                        });
                    }
                }
            } catch (e) {
                console.error("Lỗi tải bạn bè để tag:", e);
            }
        }

        // 2. Lắng nghe sự kiện nhập liệu vào ô Comment
        document.getElementById('commentInput').addEventListener('input', function(e) {

            if (currentUser && currentUser.isGuest) return;

            const val = this.value;
            const cursorPos = this.selectionStart;
            
            // Tìm từ đang gõ tại vị trí con trỏ
            const textBeforeCursor = val.slice(0, cursorPos);
            const lastWordRegex = /@(\w*)$/;
            const match = textBeforeCursor.match(lastWordRegex);

            const suggestBox = document.getElementById('tagSuggestions');

            if (match) {
                const query = match[1].toLowerCase(); // Từ khóa sau dấu @
                
                // Lọc danh sách bạn bè khớp với từ khóa (tìm theo tên hiển thị hoặc id)
                const matches = friendsForTagging.filter(f => 
                    f.id.toLowerCase().includes(query) || 
                    f.name.toLowerCase().includes(query)
                );

                if (matches.length > 0) {
                    renderTagSuggestions(matches, query);
                    suggestBox.classList.remove('hidden');
                } else {
                    suggestBox.classList.add('hidden');
                }
            } else {
                suggestBox.classList.add('hidden');
            }
        });

        // 3. Hiển thị danh sách gợi ý
        function renderTagSuggestions(list, query) {
            const box = document.getElementById('tagSuggestions');
            box.innerHTML = '';

            list.forEach(user => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 hover:bg-white/10 cursor-pointer border-b border-gray-800 last:border-0 transition-colors";
                
                let avatarHTML = user.avatar 
                    ? `<img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover">`
                    : `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white">${user.name.charAt(0)}</div>`;

                div.innerHTML = `
                    ${avatarHTML}
                    <div class="flex-1 min-w-0">
                        <p class="text-white text-sm font-bold truncate">${user.name}</p>
                        <p class="text-gray-500 text-[10px]">@${user.id}</p>
                    </div>
                `;

                div.onclick = () => selectTag(user.id);
                box.appendChild(div);
            });
        }

        // 4. Chọn người để Tag
        function selectTag(userId) {
            const input = document.getElementById('commentInput');
            const val = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = val.slice(0, cursorPos);
            
            // Thay thế đoạn @... bằng @userId
            const lastAtPos = textBeforeCursor.lastIndexOf('@');
            const newVal = val.slice(0, lastAtPos) + `@${userId} ` + val.slice(cursorPos);
            
            input.value = newVal;
            document.getElementById('tagSuggestions').classList.add('hidden');
            input.focus();
        }

        // 5. Hàm xử lý hiển thị nội dung Comment (Render Link Tag)
        // Hàm này thay thế text @username thành HTML span có màu
        // --- SỬA HÀM NÀY ĐỂ BẤM TAG SẼ ĐÓNG COMMENT VÀ MỞ PROFILE ---
        // --- SỬA HÀM NÀY: XỬ LÝ CLICK VÀO TAG @MENTION ---
        function formatCommentText(text, isFriendZone = false) {
            // 1. Xác định hàm đích: Nếu ở FriendZone thì mở Profile FZ, ngược lại mở Profile thường
            const targetFunc = isFriendZone ? 'viewFriendZoneProfile' : 'viewUserProfile';

            // Regex tìm chuỗi @username (chữ cái, số, gạch dưới)
            return text.replace(/@([a-zA-Z0-9_]+)/g, (match, username) => {
                
                // 2. Tạo lệnh khi bấm vào:
                // - Bước A: Đóng ngay modal bình luận (document.getElementById('commentModal').classList.add('hidden');)
                // - Bước B: Gọi hàm xem profile (targetFunc)
                // Lưu ý: Hàm viewUserProfile đã có sẵn dòng "if (id === currentUser) -> mở Album của mình"
                
                const clickAction = `document.getElementById('commentModal').classList.add('hidden'); ${targetFunc}('${username}')`;
                
                // Trả về thẻ HTML span có sự kiện onclick
                return `<span class="mention-tag" onclick="${clickAction}">${match}</span>`;
            });
        }

        window.onload = init;
        
        // --- LOGIC PHITAY ---

        // 1. Hàm mở cửa sổ nhập pass
        function requestPhitayAccess(fromNotif = false) {
            // Nếu gọi từ bản đồ thì mới cần đóng bản đồ

            if (currentUser && currentUser.isGuest) {
                showToast("Tài khoản khách không được phép truy cập khu vực này!");
                return;
            }
            
            if (!fromNotif) {
                document.getElementById('mapModal').classList.add('hidden');
            }
            
            // Hiện modal nhập pass
            const modal = document.getElementById('phitayAuthModal');
            const input = document.getElementById('phitayPasswordInput');
            modal.classList.remove('hidden');
            input.value = ''; 
            input.focus();
        }

        // 2. Hàm kiểm tra pass
        function checkPhitayPass() {
            const input = document.getElementById('phitayPasswordInput');
            const val = input.value.trim();
            
            // Kiểm tra mật khẩu
            if (val === '0502') { 
                document.getElementById('phitayAuthModal').classList.add('hidden');
                
                // --- LOGIC MỚI: NẾU ĐANG CHỜ MỞ BÀI VIẾT TỪ THÔNG BÁO ---
                if (pendingPhitayPost) {
                    openSinglePost(pendingPhitayPost); // Mở bài viết bí mật ra
                    pendingPhitayPost = null; // Reset biến nhớ
                    showToast("Đã mở khóa bài viết PHITAY!");
                    return; // Dừng lại, không chuyển feed chính
                }
                // ---------------------------------------------------------

                // Logic cũ (Vào khu vực PHITAY từ bản đồ)
                currentCommunity = 'PHITAY'; 
                
                const displayLabel = "PHITAY";
                document.getElementById('currentCommunityDisplay').innerText = displayLabel;
                document.getElementById('currentCommunityDisplay').className = "text-red-500 font-black tracking-widest"; 
                
                const addOptionToMenu = (selectId) => {
                    const sel = document.getElementById(selectId);
                    if (sel) {
                        let opt = sel.querySelector('option[value="PHITAY"]');
                        if (!opt) {
                            opt = document.createElement('option');
                            opt.value = 'PHITAY';
                            opt.text = '🔒 PHITAY';
                            sel.appendChild(opt);
                        }
                        sel.value = 'PHITAY';
                    }
                };

                addOptionToMenu('uploadCommunitySelect');
                addOptionToMenu('mapSelect');            

                subscribeToFeed(); 
                showToast(TRANSLATIONS[currentLang].access_granted);
            } else {
                input.classList.add('animate-pulse', 'border-red-500');
                showToast("Sai mật khẩu!");
                setTimeout(() => input.classList.remove('animate-pulse'), 500);
            }
        }

        // 3. SỬA HÀM loadUserAlbum ĐỂ ẨN ẢNH PHITAY (QUAN TRỌNG)
        // Bạn tìm hàm loadUserAlbum cũ và thay bằng hàm này:
        // --- SỬA ALBUM TRANG CHÍNH (ẨN BÀI FRIEND ZONE) ---
        function loadUserAlbum() {
            if (!currentUser || currentUser.isGuest) return;
            
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                .where('authorId', '==', currentUser.username).get().then(snapshot => {
                    const grid = document.getElementById('userPostsGrid'); 
                    grid.innerHTML = ''; 
                    
                    let posts = []; 
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // --- ĐOẠN QUAN TRỌNG NHẤT (ĐÃ SỬA) ---
                        // Chỉ lấy bài KHÔNG PHẢI PHITAY và KHÔNG PHẢI FRIEND_ZONE
                        // Điều này giúp tách biệt hoàn toàn:
                        // - Album chính: Chỉ hiện bài đăng Public
                        // - Album Friend Zone: Chỉ hiện bài đăng Friend Zone
                        if (data.community !== 'PHITAY' && data.community !== 'FRIEND_ZONE') {
                            posts.push({id: doc.id, ...data});
                        }
                        // --------------------------------------
                    }); 
                    
                    document.getElementById('postCount').innerText = `${posts.length} ẢNH`; 
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    if (posts.length === 0) {
                        grid.innerHTML = `
                            <div class="col-span-3 flex flex-col items-center justify-center py-20 opacity-50 text-gray-500 animate-fade-in">
                                <i class="fa-regular fa-images text-4xl mb-3"></i>
                                <p class="text-xs font-bold uppercase tracking-wider">Chưa có ảnh nào</p>
                            </div>
                        `;
                    } else {
                        posts.forEach(post => {
                            const div = document.createElement('div');
                            div.className = 'aspect-square bg-gray-800 relative group overflow-hidden cursor-pointer';
                            const borderStyle = getFrameColorStyle(post.frameColor);
                            div.style.border = `2px solid ${borderStyle.borderColor}`;
                            
                            div.onclick = () => openMiniPreview(post); 

                            let mediaContent;
                            if(post.mediaType === 'video') {
                                mediaContent = `<video src="${post.imageUrl}#t=0.1" class="w-full h-full object-cover"></video><i class="fa-solid fa-play absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/80"></i>`;
                            } else if(post.mediaType === 'audio') {
                                mediaContent = `
                                    <div class="w-full h-full bg-black flex items-center justify-center">
                                        <div class="w-10 h-10 rounded-full bg-app-gold flex items-center justify-center shadow-lg">
                                            <i class="fa-solid fa-music text-black"></i>
                                        </div>
                                    </div>`;
                            } else {
                                mediaContent = `<img src="${post.imageUrl}" class="w-full h-full object-cover">`;
                            }
                            
                            div.innerHTML = mediaContent; 
                            grid.appendChild(div);
                        });
                    }
                });
        }

        // Hàm mới: Tìm bài viết trong cache và mở giao diện chi tiết (Single Post Modal)
        function openFullPostById(id) {
            // Tìm bài viết trong danh sách đã tải (recentPostsCache)
            const post = recentPostsCache.find(p => p.id === id);
            if (post) {
                openSinglePost(post); // Gọi hàm mở giao diện chi tiết cũ
            }
        }

        // --- LOGIC HỒ SƠ CÁ NHÂN (MỚI) ---
        // --- LOGIC MỚI: QUẢN LÝ BẠN BÈ & TIN NHẮN ---

        async function openUserInfo() {
            if (!currentUser) return;

            if (currentUser.isGuest) {
                showToast("Khách không thể truy cập Hồ sơ!");
                return;
            }

            // 1. Đóng các cửa sổ khác
            const modalsToClose = ['settingsModal', 'profileModal', 'searchModal', 'notifModal', 'mapModal', 'publicProfileModal'];
            modalsToClose.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // 2. Điền thông tin cơ bản (Header)
            document.getElementById('infoModalName').textContent = currentUser.displayName;
            
            let userDisplay = '@' + currentUser.username;
            if (currentUser.isGuest) {
                userDisplay = 'KHÁCH ' + currentUser.username.split('_')[1];
            }
            document.getElementById('infoModalUsername').textContent = userDisplay;

            const avtDiv = document.getElementById('infoModalAvatar');
            if (currentUser.avatarUrl) {
                avtDiv.innerHTML = `<img src="${currentUser.avatarUrl}" class="w-full h-full object-cover">`;
            } else if (currentUser.isGuest) {
                avtDiv.innerHTML = `<i class="fa-solid fa-user-secret text-3xl text-gray-500"></i>`;
            } else {
                avtDiv.innerHTML = `<span class="text-3xl font-bold text-white">${currentUser.displayName.charAt(0).toUpperCase()}</span>`;
            }

            // 3. Mở Modal
            document.getElementById('userInfoModal').classList.remove('hidden');

            // 4. Tải danh sách bạn bè
            loadFriendList();

            subscribeToMsgBadge();
        }

        // --- CẬP NHẬT HÀM loadFriendList ---
        async function loadFriendList() {
            clearFriendListListeners();
            const listContainer = document.getElementById('friendListContainer');
            const countLabel = document.getElementById('infoModalFriendCount');
            
            if (currentUser.isGuest) { /* Giữ nguyên logic khách cũ */ return; }

            listContainer.innerHTML = '<div class="text-center pt-10"><i class="fa-solid fa-circle-notch fa-spin text-app-gold"></i></div>';

            try {
                listContainer.innerHTML = '';

                // --- PHẦN 1: LOAD NHÓM CHAT (MỚI) ---
                const groupContainer = document.createElement('div');
                groupContainer.className = "mb-4 pb-4 border-b border-white/10";
                
                // Header phần nhóm + Nút tạo nhóm
                groupContainer.innerHTML = `
                    <div class="flex justify-between items-center mb-3 px-1">
                        <h3 class="text-gray-500 text-[10px] font-bold uppercase tracking-widest">Nhóm chat</h3>
                        <button onclick="openCreateGroupModal()" class="text-[10px] bg-white/10 hover:bg-app-gold hover:text-black text-white px-2 py-1 rounded-md transition-all font-bold">
                            <i class="fa-solid fa-plus mr-1"></i> Tạo
                        </button>
                    </div>
                    <div id="groupListContent" class="flex flex-col gap-2"></div>
                `;
                listContainer.appendChild(groupContainer);

                const groupContent = groupContainer.querySelector('#groupListContent');

                // Query Groups
                const groupSnap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                    .where('members', 'array-contains', currentUser.username).get();

                if (groupSnap.empty) {
                    groupContent.innerHTML = '<p class="text-gray-600 text-[10px] italic text-center">Chưa tham gia nhóm nào</p>';
                } else {
                    groupSnap.forEach(doc => {
                        const group = {id: doc.id, ...doc.data()};
                        renderGroupItem(groupContent, group);
                    });
                }

                // --- PHẦN 2: LOAD BẠN BÈ (CODE CŨ GIỮ NGUYÊN) ---
                // (Bạn dán lại logic load bạn bè cũ vào đây, phía dưới phần nhóm)
                // ... Logic tải friendIds ...
                
                const friendsMap = new Map();
                // ... (Code query relationship cũ) ...
                const snap1 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user1', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap1.forEach(doc => { friendsMap.set(doc.data().user2, { id: doc.data().user2 }); });
                
                const snap2 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user2', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap2.forEach(doc => { friendsMap.set(doc.data().user1, { id: doc.data().user1 }); });
                
                const friendIds = Array.from(friendsMap.keys());
                countLabel.textContent = `${friendIds.length} Bạn bè`;
                
                // Vẽ danh sách bạn bè
                for (const friendId of friendIds) {
                    const userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(friendId).get();
                    if (userDoc.exists) {
                        renderFriendItem(listContainer, friendId, userDoc.data());
                    }
                }
                
                // Update badge unread
                Object.keys(unreadMap).forEach(senderId => {
                    const badge = document.getElementById(`badge-friend-${senderId}`);
                    if (badge) badge.classList.remove('hidden');
                });

            } catch(e) { console.error(e); }
        }

        // --- [SỬA BƯỚC 5] Thay thế toàn bộ hàm renderGroupItem ---
        function renderGroupItem(container, group) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition-all cursor-pointer group";
            
            const groupAvatarId = `group-avatar-img-${group.id}`;
            const groupNameId = `group-name-text-${group.id}`;
            const badgeId = `badge-group-${group.id}`;

            const hasUnread = unreadGroupMap[group.id] ? true : false;
            const badgeClass = hasUnread ? "animate-pulse" : "hidden"; 

            let avatarHTML;
            if (group.avatarUrl) {
                avatarHTML = `<img id="${groupAvatarId}" src="${group.avatarUrl}" class="w-10 h-10 rounded-full object-cover border border-gray-600">`;
            } else {
                avatarHTML = `<div id="${groupAvatarId}" class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center text-white font-bold"><i class="fa-solid fa-users"></i></div>`;
            }

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    ${avatarHTML}
                    <div>
                        <h4 id="${groupNameId}" class="text-white font-bold text-sm leading-tight">${group.name}</h4>
                        <p class="text-gray-500 text-[10px] truncate max-w-[120px]">${group.members.length} thành viên</p>
                    </div>
                </div>
                <div class="relative w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-app-gold group-hover:text-black transition-all">
                    <i class="fa-solid fa-message text-xs"></i>
                    <span id="${badgeId}" class="absolute -top-1 -right-1 w-3 h-3 bg-red-600 rounded-full border-2 border-app-dark ${badgeClass}"></span>
                </div>
            `;
            
            // --- SỬA Ở ĐÂY: Truyền thêm group.avatarUrl vào hàm ---
            div.onclick = () => startGroupChat(group.id, group.name, group.members, null, group.avatarUrl);
            container.appendChild(div);

            monitorGroupStatus(group.id);
        }

        // --- HÀM MỚI: LẮNG NGHE REALTIME AVATAR & TÊN NHÓM ---
        // --- HÀM LẮNG NGHE REALTIME: AVATAR & TÊN NHÓM ---
        function monitorGroupStatus(groupId) {
            const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                .doc(groupId)
                .onSnapshot(doc => {
                    if (!doc.exists) return;
                    const data = doc.data();

                    // 1. CẬP NHẬT TÊN NHÓM (MỚI THÊM)
                    const nameEl = document.getElementById(`group-name-text-${groupId}`);
                    if (nameEl && data.name) {
                        nameEl.textContent = data.name;
                    }

                    // 2. CẬP NHẬT AVATAR (GIỮ NGUYÊN LOGIC AN TOÀN)
                    const avatarEl = document.getElementById(`group-avatar-img-${groupId}`);
                    if (avatarEl) {
                        if (data.avatarUrl) {
                            if (avatarEl.tagName === 'IMG') {
                                if (avatarEl.src !== data.avatarUrl) avatarEl.src = data.avatarUrl;
                            } else {
                                const newImg = document.createElement('img');
                                newImg.id = `group-avatar-img-${groupId}`;
                                newImg.src = data.avatarUrl;
                                newImg.className = "w-10 h-10 rounded-full object-cover border border-gray-600";
                                avatarEl.replaceWith(newImg);
                            }
                        } else {
                            if (avatarEl.tagName === 'IMG') {
                                const newDiv = document.createElement('div');
                                newDiv.id = `group-avatar-img-${groupId}`;
                                newDiv.className = "w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center text-white font-bold";
                                newDiv.innerHTML = '<i class="fa-solid fa-users"></i>';
                                avatarEl.replaceWith(newDiv);
                            }
                        }
                    }
                });

            if (window.friendListListeners) {
                window.friendListListeners.push(unsub);
            }
        }


        // --- [SỬA BƯỚC 2] Thay thế toàn bộ hàm renderFriendItem ---
        function renderFriendItem(container, friendId, friendData) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition-all group";
            
            const avatarBoxId = `friend-avatar-box-${friendId}`;
            const nameTextId = `friend-name-text-${friendId}`;

            // Logic Avatar ban đầu
            let avatarHTML = friendData.avatarUrl 
                ? `<img src="${friendData.avatarUrl}" class="w-10 h-10 rounded-full object-cover">`
                : `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-white font-bold">${friendData.displayName.charAt(0).toUpperCase()}</div>`;

            // Logic Status ban đầu
            const now = Date.now();
            const lastSeen = friendData.lastSeen || 0;
            const diffMinutes = (now - lastSeen) / 60000;
            const isRealOnline = (friendData.isOnline === true) && (diffMinutes < 5);
            const initialColor = isRealOnline ? "bg-green-500 shadow-[0_0_8px_#22c55e]" : "bg-gray-500";

            const hasUnread = unreadMap[friendId] ? true : false;
            const badgeClass = hasUnread ? "animate-pulse" : "hidden animate-pulse"; 

            // --- SỬA Ở ĐÂY: Trong nút button bên dưới, ta thêm tham số thứ 3 là friendData.avatarUrl ---
            div.innerHTML = `
                <div class="flex items-center gap-3 cursor-pointer" onclick="viewUserProfile('${friendId}')">
                    <div class="relative">
                        <div id="${avatarBoxId}" class="w-10 h-10">
                            ${avatarHTML}
                        </div>
                        
                        <div id="status-dot-${friendId}" class="absolute bottom-0 right-0 w-3 h-3 ${initialColor} border-2 border-app-dark rounded-full transition-colors duration-300"></div>
                    </div>
                    <div>
                        <h4 id="${nameTextId}" class="text-white font-bold text-sm leading-tight">${friendData.displayName}</h4>
                        <p class="text-gray-500 text-[10px] truncate max-w-[120px]">@${friendId}</p>
                    </div>
                </div>
                
                <button onclick="startChatWith('${friendId}', '${friendData.displayName}', '${friendData.avatarUrl || ''}')" class="relative w-9 h-9 rounded-full bg-blue-600/20 text-blue-500 flex items-center justify-center hover:bg-blue-600 hover:text-white transition-all shadow-lg">
                    <i class="fa-brands fa-facebook-messenger"></i>
                    <span id="badge-friend-${friendId}" class="absolute -top-0.5 -right-0.5 w-3 h-3 bg-red-600 rounded-full border-2 border-app-dark ${badgeClass}"></span>
                </button>
            `;
            
            container.appendChild(div);

            monitorFriendStatus(friendId);
        }

        // --- [HÀM MỚI] LẮNG NGHE TRẠNG THÁI TỪNG BẠN BÈ ---
        function monitorFriendStatus(friendId) {
            const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users')
                .doc(friendId)
                .onSnapshot(doc => {
                    if (!doc.exists) return;
                    const data = doc.data();

                    // 1. CẬP NHẬT TRẠNG THÁI ONLINE/OFFLINE (Giữ nguyên logic cũ)
                    const dotEl = document.getElementById(`status-dot-${friendId}`);
                    if (dotEl) {
                        const now = Date.now();
                        const lastSeen = data.lastSeen || 0;
                        const diffMinutes = (now - lastSeen) / 60000;
                        const isRealOnline = (data.isOnline === true) && (diffMinutes < 5);
                        
                        if (isRealOnline) {
                            dotEl.className = "absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-app-dark rounded-full shadow-[0_0_8px_#22c55e] transition-colors duration-300";
                        } else {
                            dotEl.className = "absolute bottom-0 right-0 w-3 h-3 bg-gray-500 border-2 border-app-dark rounded-full transition-colors duration-300";
                        }
                    }

                    // 2. [MỚI] CẬP NHẬT TÊN HIỂN THỊ REALTIME
                    const nameEl = document.getElementById(`friend-name-text-${friendId}`);
                    if (nameEl && data.displayName) {
                        nameEl.textContent = data.displayName;
                    }

                    // 3. [MỚI] CẬP NHẬT AVATAR REALTIME
                    const avtBox = document.getElementById(`friend-avatar-box-${friendId}`);
                    if (avtBox) {
                        if (data.avatarUrl) {
                            avtBox.innerHTML = `<img src="${data.avatarUrl}" class="w-10 h-10 rounded-full object-cover">`;
                        } else {
                            const char = data.displayName ? data.displayName.charAt(0).toUpperCase() : "?";
                            avtBox.innerHTML = `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-white font-bold">${char}</div>`;
                        }
                    }
                });

            window.friendListListeners.push(unsub);
        }

        // --- [THÊM MỚI] BIẾN LƯU CÁC GÓI LẮNG NGHE STATUS BẠN BÈ ---
        window.friendListListeners = [];

        function clearFriendListListeners() {
            if (window.friendListListeners) {
                window.friendListListeners.forEach(unsub => unsub());
            }
            window.friendListListeners = [];
        }


        // Hàm đóng UserInfo Modal
        // --- SỬA HÀM ĐÓNG MODAL (CHUẨN) ---
        // --- HÀM ĐÓNG MODAL CHUẨN (Thay thế cho hàm cũ) ---
        function closeUserInfo() {
            // 1. Ẩn giao diện
            const modal = document.getElementById('userInfoModal');
            if (modal) modal.classList.add('hidden');
            
            // 2. NGẮT KẾT NỐI REALTIME (Quan trọng)
            // Nếu không có đoạn này, danh sách bạn bè vẫn ngầm chạy gây tốn pin/nóng máy
            if (typeof clearFriendListListeners === 'function') {
                clearFriendListListeners();
            }
        }

        // --- LOGIC HỆ THỐNG BẠN BÈ (FRIEND SYSTEM) ---

        let currentTargetUserForFriend = null;

        // 1. Hàm tạo ID duy nhất cho mối quan hệ (A kết bạn B hay B kết bạn A đều ra 1 ID giống nhau)
        function getRelationId(user1, user2) {
            const sorted = [user1, user2].sort();
            return `${sorted[0]}_${sorted[1]}`;
        }

        // 2. Hàm kiểm tra và hiển thị nút (Gọi hàm này khi mở Public Profile)
        // --- CẬP NHẬT: CHECK FRIEND STATUS (REALTIME) ---
        



        function checkFriendStatus(targetUserId) {
            const container = document.getElementById('friendActionContainer');
            const btn = document.getElementById('friendBtn');
            
            // Reset listener cũ nếu có
            if (friendStatusUnsubscribe) {
                friendStatusUnsubscribe();
                friendStatusUnsubscribe = null;
            }

            // Không hiện nút nếu xem chính mình hoặc target là Khách
            if (!currentUser || targetUserId === currentUser.username || targetUserId.startsWith('guest_') || currentUser.isGuest) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            // Set trạng thái loading ban đầu
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>'; 
            btn.className = "w-full py-2.5 rounded-xl font-bold text-xs bg-gray-800 text-gray-400 cursor-wait";
            btn.onclick = null;

            currentTargetUserForFriend = targetUserId;
            const relationId = getRelationId(currentUser.username, targetUserId);


            // --- BẮT ĐẦU LẮNG NGHE REALTIME ---
            friendStatusUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('relationships')
                .doc(relationId)
                .onSnapshot(doc => {
                    if (!doc.exists) {
                        // TRẠNG THÁI: CHƯA KẾT BẠN (Hoặc đã hủy/bị xóa)
                        renderFriendButton('add');
                    } else {
                        const data = doc.data();
                        if (data.status === 'accepted') {
                            // TRẠNG THÁI: BẠN BÈ -> Tự động chuyển nút thành "Bạn bè"
                            renderFriendButton('friend');
                        } else if (data.status === 'pending') {
                            if (data.actionUser === currentUser.username) {
                                // TRẠNG THÁI: ĐÃ GỬI LỜI MỜI (Mình gửi)
                                renderFriendButton('sent');
                            } else {
                                // TRẠNG THÁI: CHỜ CHẤP NHẬN (Họ gửi cho mình)
                                renderFriendButton('accept');
                            }
                        }
                    }
                }, error => {
                    console.error("Lỗi lắng nghe trạng thái bạn bè:", error);
                    btn.innerText = "Lỗi kết nối";
                });
        }

        // 3. Hàm Render giao diện nút
        function renderFriendButton(status) {
            const btn = document.getElementById('friendBtn');
            
            // Reset style cơ bản
            btn.className = "w-full py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95";

            if (status === 'add') {
                btn.classList.add('bg-app-gold', 'text-black', 'hover:bg-yellow-400');
                btn.innerHTML = '<i class="fa-solid fa-user-plus"></i> KẾT BẠN';
                btn.onclick = () => handleFriendAction('send');
            } 
            else if (status === 'sent') {
                btn.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-red-900/50', 'hover:text-red-400');
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> ĐÃ GỬI (HỦY)';
                btn.onclick = () => handleFriendAction('cancel');
            } 
            else if (status === 'accept') {
                // Xóa class cũ và tạo giao diện 2 nút
                btn.className = "flex gap-2 w-full"; 
                btn.innerHTML = `
                    <button onclick="handleFriendAction('decline')" class="flex-1 bg-gray-800 text-gray-400 font-bold py-2.5 rounded-xl hover:bg-gray-700 transition-all text-xs">
                        TỪ CHỐI
                    </button>
                    <button onclick="handleFriendAction('accept')" class="flex-1 bg-blue-600 text-white font-bold py-2.5 rounded-xl hover:bg-blue-700 transition-all text-xs shadow-lg animate-pulse">
                        CHẤP NHẬN
                    </button>
                `;
                // Vì chúng ta chèn button bên trong button (btn gốc), 
                // ta cần loại bỏ sự kiện click của btn gốc để tránh xung đột
                btn.onclick = null; 
            } 
            else if (status === 'friend') {
                // Thêm class group và hover để đổi màu nút
                btn.className = "w-full py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg active:scale-95 bg-green-600/20 text-green-500 border border-green-500/50 hover:bg-red-900/20 hover:text-red-500 hover:border-red-500 group";
                
                // Thêm "pointer-events-none" vào các thẻ span để click xuyên qua được vào nút bấm chính
                btn.innerHTML = `
                    <span class="group-hover:hidden pointer-events-none">
                        <i class="fa-solid fa-user-group mr-1"></i> BẠN BÈ
                    </span>
                    <span class="hidden group-hover:inline pointer-events-none">
                        <i class="fa-solid fa-user-xmark mr-1"></i> HỦY KẾT BẠN
                    </span>
                `;
                
                // Gán lại sự kiện click trực tiếp
                btn.onclick = (e) => {
                    e.stopPropagation(); // Ngăn chặn ảnh hưởng đến các thành phần bên dưới
                    handleFriendAction('unfriend');
                };
            }
        }

        // 4. Hàm xử lý hành động (Gửi, Hủy, Chấp nhận, Xóa)
        async function handleFriendAction(action) {
            if (!currentTargetUserForFriend || !currentUser) return;

            if (currentUser.isGuest) {
                showToast("Khách không thể kết bạn!");
                return;
            }

            const targetId = currentTargetUserForFriend;
            const relationId = getRelationId(currentUser.username, targetId);
            const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships').doc(relationId);

            // Hiển thị trạng thái đang xử lý (tùy chọn)
            const container = document.getElementById('friendActionContainer');

            try {
                if (action === 'send') {
                    await ref.set({
                        user1: currentUser.username,
                        user2: targetId,
                        actionUser: currentUser.username, // Người thực hiện hành động cuối cùng
                        status: 'pending',
                        timestamp: Date.now()
                    });
                    // Gửi thông báo cho họ
                    sendNotification(targetId, 'friend_request', null, null, "lời mời kết bạn");
                    renderFriendButton('sent');
                } 
                // Tìm trong hàm handleFriendAction(action)
                // Tìm đoạn này trong hàm handleFriendAction(action)
                else if (action === 'cancel' || action === 'unfriend' || action === 'decline') {
                    const performDelete = async () => {
                        try {
                            await ref.delete(); // Xóa dữ liệu trên Firestore
                            showToast(action === 'unfriend' ? "Đã hủy kết bạn" : "Đã hủy yêu cầu");
                            renderFriendButton('add'); // Cập nhật lại nút thành "KẾT BẠN"
                        } catch (err) {
                            console.error("Lỗi xóa:", err);
                            showToast("Lỗi kết nối database");
                        }
                    };

                    if (action === 'unfriend') {
                        // Sử dụng hàm showConfirm đẹp mắt có sẵn trong code của bạn
                        showConfirm("Bạn chắc chắn muốn hủy kết bạn với người này?", performDelete);
                    } else {
                        // Hủy yêu cầu hoặc từ chối thì không cần hỏi lại
                        performDelete();
                    }
                }
                else if (action === 'accept') {
                    await ref.update({
                        status: 'accepted',
                        actionUser: currentUser.username,
                        timestamp: Date.now()
                    });
                    // Gửi thông báo ngược lại cho người mời
                    sendNotification(targetId, 'friend_accept', null, null, "đã trở thành bạn bè");
                    renderFriendButton('friend');
                    showToast("Đã trở thành bạn bè!");
                }
            } catch (e) {
                console.error(e);
                showToast("Lỗi kết nối!");
            }
        }

        // --- LOGIC XỬ LÝ QUYẾT ĐỊNH KẾT BẠN ---

        let currentDecisionSenderId = null;
        let currentDecisionNotifId = null;

        // 1. Hàm hiển thị Modal Quyết định
        function showFriendDecisionModal(senderId, senderName, senderAvatar, notifId) {
            currentDecisionSenderId = senderId;
            currentDecisionNotifId = notifId;

            // Điền thông tin vào Modal
            document.getElementById('fdModalName').textContent = senderName;
            const avtContainer = document.getElementById('fdModalAvatar');
            
            if (senderAvatar && senderAvatar !== 'null') {
                avtContainer.innerHTML = `<img src="${senderAvatar}" class="w-full h-full object-cover">`;
            } else {
                avtContainer.innerHTML = `<span class="text-2xl font-bold text-white">${senderName.charAt(0).toUpperCase()}</span>`;
            }

            // Hiện Modal
            document.getElementById('friendDecisionModal').classList.remove('hidden');
            
            // Đánh dấu thông báo là đã đọc luôn
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
        }

        // 2. Hàm Xử lý Chấp nhận / Từ chối
        async function processFriendDecision(decision) {
            if (!currentDecisionSenderId || !currentUser) return;
            
            const targetId = currentDecisionSenderId;
            const relationId = getRelationId(currentUser.username, targetId);
            const modal = document.getElementById('friendDecisionModal');

            // Ẩn modal ngay cho mượt
            modal.classList.add('hidden');

            try {
                if (decision === 'accept') {
                    // Cập nhật trạng thái thành 'accepted'
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships').doc(relationId).update({
                        status: 'accepted',
                        actionUser: currentUser.username,
                        timestamp: Date.now()
                    });
                    
                    showToast(`Đã trở thành bạn với ${document.getElementById('fdModalName').textContent}!`);
                    
                    // Gửi thông báo lại cho người kia
                    sendNotification(targetId, 'friend_accept', null, null, "đã chấp nhận lời mời");
                } 
                else if (decision === 'decline') {
                    // Xóa relationship
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships').doc(relationId).delete();
                    showToast("Đã từ chối lời mời.");
                }
            } catch (e) {
                console.error(e);
                showToast("Có lỗi xảy ra.");
            }
        }

        // Hàm xử lý khi bấm vào thông báo "Đã chấp nhận kết bạn"
        function handleSimpleRead(notifId) {
            // 1. Đánh dấu đã đọc trong Database
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(notifId).update({ isRead: true });
            
            // 2. Đóng bảng thông báo lại
            toggleNotifications();
            
            // 3. Hiện thông báo nhỏ xác nhận
            showToast("Đã đánh dấu đã đọc.");
        }

        // --- LOGIC TÌM KIẾM BẠN BÈ ---

        let searchTimeout = null;

        // 1. Bật/Tắt Modal Tìm kiếm
        function toggleSearch() {
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('searchInput');
            const list = document.getElementById('searchResultsList');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                input.value = ''; // Reset ô nhập
                list.innerHTML = '<div class="text-center text-gray-600 text-xs mt-10 italic opacity-50">Nhập tên đăng nhập để tìm...</div>';
                setTimeout(() => input.focus(), 100); // Tự động focus vào ô nhập
            } else {
                modal.classList.add('hidden');
            }
        }

        // 2. Xử lý khi nhập liệu (Tìm kiếm)
        async function handleSearch(keyword) {
            // 1. Tối ưu hóa: Xóa @, xóa khoảng trắng và VIẾT HOA 
            // (Vì mã định danh của bạn như @TOITENPHI đang ở dạng viết hoa)
            const term = keyword.replace('@', '').trim().toUpperCase();
            const list = document.getElementById('searchResultsList');

            if (term.length < 1) {
                list.innerHTML = '<div class="text-center text-gray-600 text-xs mt-10 italic opacity-50">Nhập mã @username để tìm...</div>';
                return;
            }

            list.innerHTML = '<div class="text-center text-gray-500 mt-4"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(async () => {
                try {
                    // 2. Tìm kiếm trực tiếp dựa trên ID tài khoản (Document ID)
                    // Chúng ta sẽ lấy Document có ID trùng khớp chính xác với mã bạn nhập
                    const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(term.toLowerCase()).get();
                    
                    // Nếu không tìm thấy bằng chữ thường, thử tìm chính xác theo chuỗi nhập vào
                    let userDoc = doc;
                    if (!userDoc.exists) {
                        userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(term).get();
                    }

                    list.innerHTML = '';

                    if (!userDoc.exists) {
                        list.innerHTML = `
                            <div class="text-center text-gray-500 text-xs mt-8 flex flex-col items-center">
                                <i class="fa-regular fa-face-frown text-2xl mb-2"></i>
                                Không tìm thấy mã "@${term}"
                            </div>`;
                        return;
                    }

                    const user = userDoc.data();
                    const userId = userDoc.id;

                    // Không hiển thị nếu là chính mình
                    if (currentUser && userId === currentUser.username) {
                        list.innerHTML = '<div class="text-center text-gray-600 text-xs mt-10">Đây là mã của bạn!</div>';
                        return;
                    }

                    // 3. Hiển thị kết quả duy nhất tìm được
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-4 bg-app-gold/10 rounded-2xl border border-app-gold/30 hover:bg-app-gold/20 cursor-pointer transition-all animate-zoom-in";
                    
                    let avatarHTML = user.avatarUrl 
                        ? `<img src="${user.avatarUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-app-gold">`
                        : `<div class="w-12 h-12 rounded-full bg-app-gold flex items-center justify-center text-black font-black text-lg">${user.displayName.charAt(0).toUpperCase()}</div>`;

                    div.innerHTML = `
                        ${avatarHTML}
                        <div class="flex-1 min-w-0">
                            <p class="text-white font-black text-sm truncate">${user.displayName}</p>
                            <p class="text-app-gold text-[10px] font-mono font-bold tracking-widest">@${userId.toUpperCase()}</p>
                        </div>
                        <i class="fa-solid fa-chevron-right text-app-gold text-xs"></i>
                    `;

                    div.onclick = () => {
                        toggleSearch();
                        viewUserProfile(userId);
                    };

                    list.appendChild(div);

                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<div class="text-center text-red-500 text-xs mt-4">Lỗi tìm kiếm!</div>';
                }
            }, 400); // Tăng thời gian đợi một chút để người dùng nhập xong
        }

        function toggleRules() {
            const rulesCard = document.getElementById('namingRules');
            rulesCard.classList.toggle('hidden');
        }

        // Tự động đóng bảng luật nếu người dùng nhấn vào input bất kỳ
        document.querySelectorAll('#registerForm input').forEach(input => {
            input.addEventListener('focus', () => {
                document.getElementById('namingRules').classList.add('hidden');
            });
        });

        // --- LOGIC CHAT RIÊNG TƯ (REALTIME) ---

        let currentChatFriendId = null;
        let currentChatRelationId = null;
        let chatUnsubscribe = null;
        let currentChatType = 'private'; // 'private' hoặc 'group'
        let currentGroupId = null;
        let selectedGroupMembers = []; // Dùng khi tạo nhóm
        let chatStatusUnsubscribe = null; // Biến này dùng để "ngắt kết nối" theo dõi khi đổi người chat

        // 1. Hàm mở cửa sổ Chat (Thay thế hàm cũ)
        // --- HÀM START CHAT CHUẨN (DUY NHẤT) ---
        // --- [MỚI] HÀM START CHAT CÓ TRẠNG THÁI REALTIME ---
        // --- [SỬA] HÀM START CHAT CÓ NHẬN AVATAR BAN ĐẦU ---
        // --- [SỬA BƯỚC 1] Thay thế toàn bộ hàm startChatWith này ---
        // TÌM HÀM startChatWith VÀ THAY THẾ TOÀN BỘ NỘI DUNG BÊN TRONG BẰNG ĐOẠN SAU:
        // [ĐÃ SỬA AN TOÀN] Thêm tham số avatar vào vị trí số 3 để khớp với lệnh gọi
        async function startChatWith(friendId, friendName, avatar = null, targetMsgId = null) {


            // --- ĐOẠN KIỂM TRA BẢO MẬT MỚI THÊM ---
            const relationId = getRelationId(currentUser.username, friendId);
            try {
                const relDoc = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('relationships')
                    .doc(relationId).get();

                if (!relDoc.exists || relDoc.data().status !== 'accepted') {
                    showToast("⛔ Không thể chat: Hai người không còn là bạn bè.");
                    return; // Thoát hàm, không mở ChatModal
                }
            } catch (e) {
                console.error("Lỗi kiểm tra bảo mật chat:", e);
                return;
            }
            // --- KẾT THÚC KIỂM TRA ---

            
            
            currentChatType = 'private';
            currentChatFriendId = friendId;
            // Logic lấy ID cuộc trò chuyện giữ nguyên -> Không ảnh hưởng đến xóa/sửa tin
            currentChatRelationId = getRelationId(currentUser.username, friendId);

            openUserInfo();

           
            
            // QUAN TRỌNG: Gán đúng ID tin nhắn vào biến chờ cuộn
            pendingMessageScrollId = targetMsgId;

            // 1. Reset giao diện
            document.getElementById('chatMessages').innerHTML = '<div class="text-center pt-10 text-gray-500 text-xs"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
            
            // 2. Cập nhật Header Chat
            const headerNameEl = document.getElementById('chatHeaderName');
            headerNameEl.textContent = friendName;
            // Gán lại class bao gồm cả class gốc và class sync mới
            headerNameEl.setAttribute('class', `font-bold text-white text-sm sync-group-name-${friendId}`);
            
            // Logic Header Click giữ nguyên
            const chatHeader = document.querySelector('#chatModal .flex.items-center.gap-3.cursor-pointer');
            if (chatHeader) chatHeader.onclick = visitChatPartnerProfile;

            // 3. Hiển thị Avatar (Dùng ngay avatar truyền vào -> Mượt hơn)
            // 3. HIỂN THỊ AVATAR & TRẠNG THÁI (ĐÃ FIX LỖI LUÔN HOẠT ĐỘNG)
            const headerAvtDiv = document.getElementById('chatHeaderAvatar');
            const statusEl = document.getElementById('chatHeaderStatus'); // Cần ID ở Bước A
            const dotEl = document.getElementById('chatHeaderDot');       // Cần ID ở Bước A

            // Hủy theo dõi người cũ nếu đang mở chat người khác
            if (window.chatStatusUnsubscribe) window.chatStatusUnsubscribe();

            // Lắng nghe dữ liệu Realtime của người chat cùng
            window.chatStatusUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('users')
                .doc(friendId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // --- CẬP NHẬT AVATAR ---
                        if (data.avatarUrl) {
                            headerAvtDiv.innerHTML = `<img src="${data.avatarUrl}" class="w-full h-full object-cover sync-group-avatar-${friendId}">`;
                        } else {
                            headerAvtDiv.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-white font-bold text-sm">${friendName.charAt(0).toUpperCase()}</div>`;
                        }

                        // --- CẬP NHẬT TRẠNG THÁI ON/OFF ---
                        const statusEl = document.getElementById('chatHeaderStatus');
                        const dotEl = document.getElementById('chatHeaderDot'); // Dòng này cực kỳ quan trọng
                        const now = Date.now();
                        const lastSeen = data.lastSeen || 0;
                        const diffMinutes = (now - lastSeen) / 60000;
                        const isRealOnline = (data.isOnline === true) && (diffMinutes < 5);

                        if (isRealOnline) {
                            if (statusEl) {
                                statusEl.textContent = "Đang hoạt động";
                                statusEl.className = "text-[10px] text-green-400 font-bold";
                            }
                            if (dotEl) {
                                dotEl.classList.remove('bg-gray-500');
                                dotEl.classList.add('bg-green-500');
                            }
                        } else {
                            if (statusEl) {
                                // Sử dụng hàm timeAgoStatus bạn đã có để hiện "5 phút trước"
                                statusEl.textContent = typeof timeAgoStatus === 'function' ? timeAgoStatus(lastSeen) : "Ngoại tuyến";
                                statusEl.className = "text-[10px] text-gray-500 font-mono";
                            }
                            if (dotEl) {
                                dotEl.classList.remove('bg-green-500');
                                dotEl.classList.add('bg-gray-500');
                            }
                        }
                    }
                });
            

            document.getElementById('chatModal').classList.remove('hidden');
            
            // 4. Đánh dấu đã đọc (Giữ nguyên -> Không ảnh hưởng Seen)
            markPrivateMessagesAsRead(friendId);
            
            // 5. Bắt đầu lắng nghe tin nhắn (Giữ nguyên -> Không ảnh hưởng Load tin/Xóa/Sửa)
            subscribeToMessages();
            
            // Chỉ focus ô nhập liệu nếu KHÔNG cần tìm tin nhắn cũ (để tránh bàn phím che mất tin cần tìm)
            if (!targetMsgId) setTimeout(() => document.getElementById('chatInput').focus(), 300);
        }

        // Hàm bắt đầu chat nhóm
        // --- CẬP NHẬT: GỌI HÀM ĐÁNH DẤU ĐỌC KHI MỞ NHÓM ---
        // Tìm đến hàm startGroupChat và sửa dòng khai báo đầu tiên:
        let groupListener = null; // Khai báo biến toàn cục để quản lý lắng nghe nhóm

        // Biến này thường nằm ngay trên hàm startGroupChat, nếu có rồi thì giữ nguyên, chưa có thì thêm vào
        // let groupListener = null; 

        // --- [SỬA BƯỚC 4] Thay thế toàn bộ hàm startGroupChat ---
        async function startGroupChat(groupId, groupName, members, targetMsgId = null, initialAvatar = null) {

            
           

            // 1. Đánh dấu đã đọc tin nhắn nhóm
            markGroupMessagesAsRead(groupId); 
            
            currentChatType = 'group';
            currentGroupId = groupId;
            currentChatRelationId = groupId; 


            openUserInfo();
            



            pendingMessageScrollId = targetMsgId; 

            


            // --- FIX TRẠNG THÁI CỐ ĐỊNH CHO CHAT NHÓM ---
            // 1. Dừng theo dõi trạng thái của người chat 1-1 trước đó (nếu có)
            if (window.chatStatusUnsubscribe) {
                window.chatStatusUnsubscribe();
                window.chatStatusUnsubscribe = null;
            }

            // 2. Lấy các phần tử giao diện
            const statusEl = document.getElementById('chatHeaderStatus');
            const dotEl = document.getElementById('chatHeaderDot');

            // 3. Thiết lập trạng thái luôn hoạt động cho nhóm
            if (statusEl) {
                statusEl.textContent = "Đang hoạt động";
                statusEl.className = "text-[10px] text-green-400 font-bold";
            }
            if (dotEl) {
                dotEl.classList.remove('bg-gray-500');
                dotEl.classList.add('bg-green-500');
            }
            // --------------------------------------------

            // 2. Hủy lắng nghe nhóm cũ nếu đang mở nhóm khác
            if (groupListener) groupListener();

            // --- [FIX LOGIC CLICK HEADER CHO CHAT NHÓM] ---
            // Tìm thẻ Header và gán lại sự kiện click thành Mở Setting Nhóm
            const chatHeader = document.querySelector('#chatModal .flex.items-center.gap-3.cursor-pointer');
            if (chatHeader) {
                // Chat nhóm -> Bấm vào là mở Cài đặt nhóm
                chatHeader.onclick = () => openGroupSettings(groupId);
            }
            // ----------------------------------------------

            // 3. THIẾT LẬP LẮNG NGHE REALTIME
            groupListener = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                .doc(groupId)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Kiểm tra nếu bị kích khỏi nhóm
                        if (data.members && !data.members.includes(currentUser.username)) {
                            closeChatModal(); 
                            showToast("Bạn đã bị mời ra khỏi nhóm!"); 
                            document.getElementById('groupSettingsModal').classList.add('hidden');
                            return; 
                        }

                        // Cập nhật tên nhóm
                        const headerName = document.getElementById('chatHeaderName');
                        if (headerName && headerName.textContent !== data.name) {
                            headerName.textContent = data.name;
                        }
                        
                        // Cập nhật Avatar Nhóm
                        const headerAvtDiv = document.getElementById('chatHeaderAvatar');
                        if (data.avatarUrl) {
                            headerAvtDiv.innerHTML = `<img src="${data.avatarUrl}" class="w-full h-full object-cover">`;
                            headerAvtDiv.className = "w-9 h-9 rounded-full overflow-hidden border border-gray-700 bg-gray-800 flex items-center justify-center";
                        } else {
                            headerAvtDiv.innerHTML = `<i class="fa-solid fa-users text-white text-sm"></i>`;
                            headerAvtDiv.className = "w-9 h-9 rounded-full overflow-hidden border border-gray-700 bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center";
                        }

                        currentGroupData = { id: doc.id, ...data };

                        prepareGroupTaggingData();

                    } else {
                        closeChatModal();
                        showToast("Nhóm này không còn tồn tại.");
                    }
                });

            // 4. Mở giao diện Chat
            document.getElementById('chatModal').classList.remove('hidden');
            
            // Bắt đầu tải tin nhắn
            subscribeToMessages();
            
            if (!targetMsgId) {
                setTimeout(() => document.getElementById('chatInput').focus(), 300);
            }
        }

        // --- HÀM MỚI: BẤM TỪ CHAT VỀ TRANG CÁ NHÂN ---
        function visitChatPartnerProfile() {
            // 1. Kiểm tra xem đang chat với ai
            if (!currentChatFriendId) return;
            
            // Lưu lại ID người đó vì khi đóng chat biến kia sẽ bị reset
            const targetUserId = currentChatFriendId;

            // 2. Đóng hết các Modal đang che màn hình
            //closeChatModal(); // Đóng khung chat
            //closeUserInfo();  // Đóng danh sách bạn bè

            // 3. Chuyển hướng trang chính về Profile người đó
            viewUserProfile(targetUserId);
        }

        // --- [MỚI] Hàm phụ trợ tính giờ Offline ---
        function timeAgoStatus(timestamp) {
            if (!timestamp) return "Ngoại tuyến";
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            
            if (minutes < 1) return "Hoạt động vừa xong";
            if (minutes < 60) return `Hoạt động ${minutes} phút trước`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `Hoạt động ${hours} giờ trước`;
            const days = Math.floor(hours / 24);
            return `Hoạt động ${days} ngày trước`;
        }

        // 2. Hàm đóng Chat (Quay lại danh sách bạn bè)
        function closeChatModal() {
            document.getElementById('chatModal').classList.add('hidden');
            
            // Hủy lắng nghe tin nhắn
            if (chatUnsubscribe) {
                chatUnsubscribe(); 
                chatUnsubscribe = null;
            }

            // --- [MỚI] Hủy lắng nghe trạng thái Online/Offline ---
            if (window.chatStatusUnsubscribe) {
                window.chatStatusUnsubscribe();
                window.chatStatusUnsubscribe = null;
            }
            // ----------------------------------------------------

            currentChatFriendId = null;
            currentChatRelationId = null;
        }

        // 3. Hàm gửi tin nhắn
        // --- HÀM GỬI TIN NHẮN (ĐÃ CẬP NHẬT CHO GROUP CHAT) ---
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            // Kiểm tra dữ liệu đầu vào
            if (!text || !currentChatRelationId) return;
            // --- KIỂM TRA QUYỀN GỬI TIN (DÀNH CHO CHAT RIÊNG) ---
            if (currentChatType === 'private') {
                const relDoc = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('relationships')
                    .doc(currentChatRelationId).get();
                
                if (!relDoc.exists || relDoc.data().status !== 'accepted') {
                    showToast("⛔ Lỗi: Không thể gửi tin nhắn do đã hủy kết bạn.");
                    closeChatModal(); // Đóng khung chat luôn để ngăn chặn
                    return;
                }
            }
            // -------------------------------------------------


            
            if (!text || text.length > 1000) {
                if(text.length > 1000) showToast("Tin nhắn tối đa 800 ký tự!");
                return;
            }

            
            const suggestBox = document.getElementById('chatGroupTagSuggestions');

            
    

            

            // CHẶN GỬI NẾU ĐÃ BỊ KICK
            if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                if (currentGroupData && currentGroupData.members && !currentGroupData.members.includes(currentUser.username)) {
                    showToast("Bạn không phải thành viên nhóm!");
                    closeChatModal();
                    return;
                }
            }

            // Reset giao diện
            input.value = '';
            input.style.height = 'auto';
            input.focus();
            
            // Ẩn bảng gợi ý tag
            if(suggestBox) suggestBox.classList.add('hidden');

            try {
                let collectionRef;

                // XÁC ĐỊNH NƠI GỬI (GROUP HAY PRIVATE)
                if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                        .doc(currentChatRelationId).collection('messages');
                } else {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                        .doc(currentChatRelationId).collection('messages');
                }

                // LƯU TIN NHẮN VÀO DB
                const docRef = await collectionRef.add({
                    senderId: currentUser.username,
                    senderName: currentUser.displayName,
                    senderAvatar: currentUser.avatarUrl,
                    text: text,
                    timestamp: Date.now(),
                    type: 'text',
                    readBy: []
                });

                // --- XỬ LÝ THÔNG BÁO (ĐÃ FIX LỖI TRÙNG LẶP) ---
                if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                    
                    // Lấy dữ liệu nhóm
                    const groupDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(currentChatRelationId).get();
                    
                    if (groupDoc.exists) {
                        const gData = groupDoc.data();
                        const members = gData.members || [];
                        const groupName = gData.name || "Nhóm";

                        // 1. TÌM DANH SÁCH NGƯỜI ĐƯỢC TAG
                        const mentions = [...text.matchAll(/@([a-zA-Z0-9_]+)/g)].map(m => m[1]);
                        const uniqueMentions = [...new Set(mentions)]; // Loại bỏ trùng

                        // 2. DUYỆT QUA TỪNG THÀNH VIÊN ĐỂ GỬI 1 THÔNG BÁO DUY NHẤT
                        members.forEach(memberId => {
                            if (memberId !== currentUser.username) {
                                
                                let notifContent = "";

                                // --- LOGIC CHỌN NỘI DUNG (QUAN TRỌNG) ---
                                if (uniqueMentions.includes(memberId)) {
                                    // TRƯỜNG HỢP 1: Nếu người này được TAG -> Gửi thông báo đỏ
                                    notifContent = `🔴 Đã nhắc đến bạn trong nhóm ${groupName}: "${text.substring(0, 15)}..."`;
                                } else {
                                    // TRƯỜNG HỢP 2: Không được tag -> Gửi thông báo thường
                                    notifContent = `Nhóm ${groupName}: "${text.substring(0, 20)}${text.length > 20 ? '...' : ''}"`;
                                }

                                // Gửi thông báo (Chỉ 1 lần duy nhất cho mỗi người)
                                sendNotification(
                                    memberId,
                                    'private_message', // Giữ type này để vào hòm thư
                                    null, null,
                                    notifContent,
                                    docRef.id,
                                    currentChatRelationId,
                                    'GROUP_CHAT'
                                );
                            }
                        });

                        // Cập nhật tin nhắn cuối cùng của nhóm
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(currentChatRelationId).update({
                            lastMessage: `${currentUser.displayName}: ${text}`,
                            lastUpdated: Date.now()
                        });
                    }

                } else {
                    // --- CHAT RIÊNG (PRIVATE) ---
                    if (currentChatFriendId) {
                        const notifContent = getNotifContentByType('text', text);
                        sendNotification(
                            currentChatFriendId,
                            'private_message',
                            null, null,
                            notifContent,
                            docRef.id,
                            null,
                            'PRIVATE_CHAT'
                        );
                    }
                }

            } catch (e) {
                console.error("Lỗi gửi tin:", e);
                showToast("Không gửi được tin nhắn");
            }
        }

        // --- LOGIC GỬI FILE TRONG CHAT ---

        async function handleChatFileSelect(e) {
            const file = e.target.files[0];
            if (!file || !currentChatRelationId) return;
            e.target.value = ''; 

            const fileName = file.name.toLowerCase();
            const isImage = file.type.startsWith('image/');
            const isAudio = fileName.endsWith('.mp3') || fileName.endsWith('.m4a');
            const isVideo = fileName.endsWith('.mp4') || fileName.endsWith('.mov');
            
            showToast(isImage ? "Đang gửi ảnh..." : "Đang xử lý file...");

            try {
                let content = isImage ? await compressImageFile(file) : await readFileAsBase64(file);
                let type = isImage ? 'image' : isVideo ? 'video' : 'audio';
                if (isVideo && fileName.endsWith('.mov')) content = content.replace('data:video/quicktime;', 'data:video/mp4;');

                let collectionRef = (currentChatType === 'group') ? 
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(currentChatRelationId).collection('messages') :
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships').doc(currentChatRelationId).collection('messages');

                const docRef = await collectionRef.add({
                    senderId: currentUser.username,
                    senderName: currentUser.displayName, 
                    senderAvatar: currentUser.avatarUrl,
                    text: content,
                    timestamp: Date.now(),
                    type: type,
                    readBy: [] // THÊM DÒNG NÀY
                });

                // Gửi thông báo như cũ...
                const notifContent = getNotifContentByType(type, '');
                if (currentChatType === 'group') {
                    const groupDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(currentChatRelationId).get();
                    groupDoc.data().members.forEach(m => {
                        if(m !== currentUser.username) sendNotification(m, 'private_message', null, type, `Nhóm ${groupDoc.data().name}: ${notifContent}`, docRef.id, currentChatRelationId, 'GROUP_CHAT');
                    });
                } else {
                    sendNotification(currentChatFriendId, 'private_message', null, type, notifContent, docRef.id, null, 'PRIVATE_CHAT');
                }
            } catch (err) { console.error(err); showToast("Lỗi gửi file!"); }
        }

        // Hàm hỗ trợ đọc file (Video/Audio)
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // 4. Hàm lắng nghe tin nhắn (Realtime)
        // 4. Hàm lắng nghe tin nhắn (Realtime) - PHIÊN BẢN FULL ĐÃ SỬA LỖI
        // --- 1. BIẾN TOÀN CỤC (Bắt buộc để ở ngoài cùng) ---
        let pendingMessageScrollId = null; 

        // --- 2. HÀM RIÊNG ĐỂ XỬ LÝ CUỘN VÀ HIGHLIGHT ---
        function tryScrollToMessage(msgId) {
            if (!msgId) return;
            
            // Xóa hiệu ứng highlight cũ (nếu có)
            document.querySelectorAll('.msg-highlight-active').forEach(el => el.classList.remove('msg-highlight-active'));

            let attempts = 0;
            // Tăng thời gian tìm kiếm lên 10 giây (50 lần * 200ms) để chắc chắn tin nhắn kịp tải về
            const maxAttempts = 50; 
            
            const huntInterval = setInterval(() => {
                attempts++;
                const targetElement = document.getElementById(`msg-${msgId}`);
                
                if (targetElement) {
                    clearInterval(huntInterval);
                    pendingMessageScrollId = null; // Reset biến chờ
                    
                    // 1. Cuộn tới tin nhắn (Smooth)
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // 2. Tìm bong bóng chat bên trong để thêm hiệu ứng nháy
                    const bubble = targetElement.querySelector('.message-bubble');
                    if (bubble) {
                        bubble.classList.add('msg-highlight-active');
                        // Tự tắt hiệu ứng sau 3 giây
                        setTimeout(() => {
                            bubble.classList.remove('msg-highlight-active');
                        }, 3000);
                    }
                    
                } else if (attempts >= maxAttempts) {
                    clearInterval(huntInterval);
                    pendingMessageScrollId = null; // Hết thời gian thì thôi
                }
            }, 200);
        }

        // --- HÀM MỚI: Xóa tin nhắn chỉ ở phía mình (Ẩn đi) ---
        // --- HÀM: Xóa tin nhắn phía mình & Xóa luôn thông báo ---
        // --- HÀM: Xóa tin nhắn phía mình & Xóa thông báo CHÍNH CHỦ ---
        function deleteMessageForMe(msgId) {
            if (!currentUser) return;
            
            // 1. Xử lý ẩn tin nhắn khỏi màn hình Chat (Logic cũ)
            const key = `hidden_msgs_${currentUser.username}`;
            let hiddenList = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (!hiddenList.includes(msgId)) {
                hiddenList.push(msgId);
                localStorage.setItem(key, JSON.stringify(hiddenList));
            }

            const msgElement = document.getElementById(`msg-${msgId}`);
            if (msgElement) {
                msgElement.remove();
                showToast("Đã xóa tin nhắn ở phía bạn");
            }

            // 2. [QUAN TRỌNG]: Xóa thông báo liên quan trong hòm thư
            // Dùng 2 điều kiện 'where' để khóa chặt phạm vi xóa
            db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('notifications')
                .where('relatedId', '==', msgId)               // Điều kiện 1: Đúng tin nhắn này
                .where('recipientId', '==', currentUser.username) // Điều kiện 2: Chỉ xóa nếu thông báo này gửi cho TÔI
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const batch = db.batch();
                        snapshot.forEach(doc => {
                            batch.delete(doc.ref); // Chỉ xóa các document tìm được
                        });
                        return batch.commit();
                    }
                })
                .catch(err => {
                    console.log("Lỗi dọn dẹp thông báo:", err);
                });
        }

        // --- 3. HÀM LẮNG NGHE TIN NHẮN CHÍNH ---
        // Bỏ biến pendingMessageScrollId đi cũng được hoặc cứ để kệ nó
        // --- CẬP NHẬT: HÀM HIỂN THỊ TIN NHẮN (Đã sửa lỗi hiển thị Video/Audio) ---
        // --- CẬP NHẬT: HÀM HIỂN THỊ TIN NHẮN (Đã thêm no-search để fix lỗi tìm kiếm) ---
        async function subscribeToMessages() {
            const msgContainer = document.getElementById('chatMessages');
            msgContainer.innerHTML = '<div class="text-center pt-10 text-gray-600 text-xs">Đang tải...</div>';
            
            if (chatUnsubscribe) chatUnsubscribe();

            let clearedTime = 0;
            try {
                const collectionName = (currentChatType === 'group') ? 'groups' : 'relationships';
                const docSnap = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data')
                    .collection(collectionName).doc(currentChatRelationId).get();
                
                if (docSnap.exists) {
                    // Lấy timestamp mà user hiện tại đã bấm xóa
                    clearedTime = docSnap.data()[`clearedAt_${currentUser.username}`] || 0;
                }
            } catch (e) {
                console.log("Lỗi lấy mốc xóa tin:", e);
            }
            
            let collectionRef;
            if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                    .doc(currentChatRelationId).collection('messages');
            } else {
                collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .doc(currentChatRelationId).collection('messages');
            }
            
            chatUnsubscribe = collectionRef
                .orderBy('timestamp', 'asc')
                .limit(100)
                .onSnapshot(async snapshot => {
                    msgContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        msgContainer.innerHTML = '<div class="text-center pt-10 text-gray-500 text-xs">Bắt đầu trò chuyện...</div>';
                        return;
                    }

                    let visibleCount = 0;
                    
                    snapshot.forEach(doc => {
                        const msg = {id: doc.id, ...doc.data()};

                        if (msg.timestamp <= clearedTime) return; 
                        // $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

                        const hiddenKey = `hidden_msgs_${currentUser.username}`;
                        const hiddenList = JSON.parse(localStorage.getItem(hiddenKey) || '[]');
                        if (hiddenList.includes(msg.id)) return;

                        visibleCount++; // Tăng biến đếm
                        

                        // ============================================================
                        // [MỚI]: XỬ LÝ TIN NHẮN HỆ THỐNG (Căn giữa, không avatar)
                        // ============================================================
                        if (msg.type === 'system' || msg.senderId === 'SYSTEM') {
                            const systemDiv = document.createElement('div');
                            systemDiv.className = "flex justify-center my-3 w-full animate-fade-in";
                            
                            // Giao diện: Nền tối mờ, chữ nhỏ, icon thông báo
                            systemDiv.innerHTML = `
                                <div class="bg-white/5 border border-white/10 backdrop-blur-md text-gray-400 text-[10px] px-3 py-1 rounded-full font-bold flex items-center gap-2 shadow-sm">
                                    <i class="fa-solid fa-bullhorn text-app-gold text-[10px]"></i>
                                    <span>${msg.content}</span>
                                </div>
                            `;
                            
                            msgContainer.appendChild(systemDiv);
                            return; // <--- QUAN TRỌNG: Dừng xử lý tin này, chuyển sang tin tiếp theo
                        }

                        const isMe = msg.senderId === currentUser.username;
                        const readBy = msg.readBy || [];

                        // Cập nhật trạng thái "Đã xem" nếu chưa xem
                        if (!isMe && !readBy.includes(currentUser.username)) {
                            collectionRef.doc(msg.id).update({
                                readBy: firebase.firestore.FieldValue.arrayUnion(currentUser.username)
                            }).catch(e => console.log("Lỗi cập nhật đã xem:", e));
                        }

                        // Xử lý Avatar trong Group Chat
                        // --- ĐOẠN ĐÃ SỬA (Copy đè lên đoạn cũ) ---
                        // Xử lý Avatar trong Group Chat
                        // Xử lý Avatar trong Group Chat (ĐÃ ĐỒNG BỘ GIỐNG BÊN NGOÀI)
                        let senderInfoHTML = '';
                        if (typeof currentChatType !== 'undefined' && currentChatType === 'group' && !isMe) {
                            const displayName = msg.senderName || msg.senderId;
                            let avatarHTML;

                            if (msg.senderAvatar) {
                                // Nếu có ảnh -> Dùng thẻ IMG
                                avatarHTML = `<img src="${msg.senderAvatar}" class="w-4 h-4 rounded-full object-cover border border-gray-600 sync-group-avatar-${msg.senderId}">`;
                            } else {
                                // Nếu không có ảnh -> Dùng thẻ DIV (Giống bên ngoài: Nền xám + 1 Chữ cái)
                                const char = displayName.charAt(0).toUpperCase();
                                avatarHTML = `<div class="w-4 h-4 rounded-full bg-gray-700 flex items-center justify-center text-white text-[8px] font-bold border border-gray-600 sync-group-avatar-${msg.senderId}">${char}</div>`;
                            }

                            senderInfoHTML = `
                                <div class="mb-1 ml-1 flex items-center gap-1">
                                    ${avatarHTML}
                                    <span class="text-[9px] text-gray-400 font-bold sync-group-name-${msg.senderId}">${displayName}</span>
                                </div>
                            `;
                        }
                        // ------------------------------------------

                        // --- XỬ LÝ NỘI DUNG TIN NHẮN ---
                        let messageContent = "";
                        // Thêm ID cho thẻ chứa text để dễ dàng tìm DOM khi sửa
                        const contentId = `chat-content-${msg.id}`;

                        if (msg.type === 'image') {
                            messageContent = `<img src="${msg.text}" class="rounded-lg max-w-[200px] cursor-pointer border border-white/10" onclick="viewChatMedia('${msg.text}', 'image')">`;
                        } else if (msg.type === 'video') {
                            messageContent = `
                                <div class="relative max-w-[200px] rounded-lg overflow-hidden border border-white/10 group cursor-pointer" onclick="viewChatMedia('${msg.text}', 'video')">
                                    <video src="${msg.text}" class="w-full max-h-[250px] object-cover bg-black"></video>
                                    <div class="absolute inset-0 flex items-center justify-center bg-black/20 group-hover:bg-black/10 transition-all">
                                        <div class="w-10 h-10 rounded-full bg-black/50 flex items-center justify-center backdrop-blur-sm">
                                            <i class="fa-solid fa-play text-white"></i>
                                        </div>
                                    </div>
                                </div>`;
                        } else if (msg.type === 'audio') {
                            messageContent = `
                                <div class="flex items-center gap-2 min-w-[150px]">
                                    <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white">
                                        <i class="fa-solid fa-music"></i>
                                    </div>
                                    <audio src="${msg.text}" controls class="h-8 w-[180px] opacity-80" style="transform: scale(0.9); transform-origin: left;"></audio>
                                </div>`;
                        } else {
                            // TEXT MESSAGE
                            let formattedText = msg.text;
                            // Xử lý tag tên trong nhóm
                            if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                                formattedText = formattedText.replace(/@([a-zA-Z0-9_]+)/g, (match, username) => {
                                    return `<span class="chat-mention" onclick="viewUserProfile('${username}')">${match}</span>`;
                                });
                            }
                            
                            // [FIX 1] Thêm class 'no-search' vào nhãn đã sửa để không bị tìm kiếm nhầm
                            const editedLabel = msg.isEdited ? `<span class="text-[8px] opacity-60 italic ml-1 block text-right no-search">(đã sửa)</span>` : '';
                            messageContent = `<span id="${contentId}">${formattedText}</span>${editedLabel}`;
                        }

                        // --- TẠO NÚT MENU (3 CHẤM) ---
                        let menuBtnHTML = '';
                        let menuDropdownHTML = '';
                        
                        // Nút Copy (Ai cũng thấy cho tin nhắn Text)
                        const copyBtn = (msg.type === 'text') ? `<button onclick="copyChatText('${encodeURIComponent(msg.text)}')"><i class="fa-regular fa-copy mr-2"></i>Sao chép</button>` : '';
                        
                        // Nút Edit/Delete (Chỉ mình mới thấy)
                        const editBtn = (isMe && msg.type === 'text') ? `<button onclick="enableEditChatMessage('${msg.id}', '${msg.text.replace(/'/g, "\\'")}')"><i class="fa-solid fa-pen mr-2"></i>Sửa</button>` : '';
                        const deleteBtn = (isMe) ? `<button onclick="deleteChatMessage('${msg.id}')" class="delete-btn"><i class="fa-solid fa-trash mr-2"></i>Thu hồi</button>` : '';
                        
                        const deleteForMeBtn = `<button onclick="deleteMessageForMe('${msg.id}')" class="delete-btn"><i class="fa-solid fa-trash mr-2"></i>Xóa</button>`;

                        // Chỉ hiện menu nếu có ít nhất 1 hành động khả thi
                        if (copyBtn || editBtn || deleteBtn || deleteForMeBtn) {
                            menuDropdownHTML = `
                                <div id="chat-menu-${msg.id}" class="chat-menu ${isMe ? 'right-0' : 'left-0'}">
                                    ${copyBtn}
                                    ${editBtn}
                                    ${deleteBtn}      ${deleteForMeBtn} </div>
                            `;

                            // Nút kích hoạt menu (3 chấm) - Giữ nguyên
                            menuBtnHTML = `
                                <button onclick="toggleChatMenu('${msg.id}')" class="w-6 h-6 rounded-full hover:bg-white/10 text-gray-500 hover:text-white flex items-center justify-center transition-colors opacity-100">
                                    <i class="fa-solid fa-ellipsis-vertical text-[10px]"></i>
                                </button>
                            `;
                        }

                        const dateObj = new Date(msg.timestamp);
                        const hours = String(dateObj.getHours()).padStart(2, '0');
                        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const year = dateObj.getFullYear();
                        
                        const fullTime = `${hours}:${minutes} ${day}/${month}/${year}`;
                                
                        let footerStatus = `<span class="opacity-60">${fullTime}</span>`;
                        
                        if (isMe) {
                            if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                                // --- LOGIC NHÓM: HIỆN SỐ NGƯỜI XEM ---
                                const viewCount = readBy.filter(id => id !== currentUser.username).length;
                                if (viewCount > 0) {
                                    footerStatus += ` <span class="text-[9px] text-gray-400 ml-2 font-bold cursor-pointer hover:text-white hover:underline transition-all" onclick="showGroupSeenDetails('${msg.id}')">${viewCount} người đã xem</span>`;
                                } else {
                                    footerStatus += ` <span class="text-[9px] text-gray-500 ml-2">Đã gửi</span>`;
                                }
                            } else {
                                // --- LOGIC RIÊNG: HIỆN "Đã gửi" / "Đã xem" ---
                                if (msg.isRead === true || readBy.length > 0) {
                                    footerStatus += ` <span class="text-[9px] text-gray-400 ml-2">Đã xem</span>`;
                                } else {
                                    footerStatus += ` <span class="text-[9px] text-gray-500 ml-2">Đã gửi</span>`;
                                }
                            }
                        }

                        // --- GỘP HTML ---
                        const div = document.createElement('div');
                        div.id = `msg-${msg.id}`;
                        div.className = `flex w-full ${isMe ? 'justify-end' : 'justify-start'} mb-2 group relative`;
                        
                        const bubbleClass = isMe ? 'msg-me' : 'msg-friend';
                        const footerHTML = `<div class="text-[8px] text-right mt-1 pt-1 border-t border-white/10 select-none no-search">${footerStatus}</div>`;

                        // QUAN TRỌNG: Thêm 'break-all whitespace-pre-wrap' để ép xuống dòng
                        const innerContent = isMe ? 
                            `<div class="flex items-center gap-1"><div class="relative"> ${menuBtnHTML} ${menuDropdownHTML} </div><div class="message-bubble ${bubbleClass} w-fit max-w-full overflow-hidden break-all whitespace-pre-wrap">${messageContent}${footerHTML}</div></div>` : 
                            `<div class="flex items-center gap-1"><div class="message-bubble ${bubbleClass} w-fit max-w-full overflow-hidden break-all whitespace-pre-wrap">${messageContent}${footerHTML}</div><div class="relative"> ${menuBtnHTML} ${menuDropdownHTML} </div></div>`;
                        
                        div.innerHTML = `<div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[85%]">${senderInfoHTML}${innerContent}</div>`;
                        msgContainer.appendChild(div);
                    });

                    if (visibleCount === 0) {
                        msgContainer.innerHTML = '<div class="text-center pt-10 text-gray-500 text-xs">Đoạn chat trống.</div>';
                    }

                    activateRealtimeUserSync();

                    if (pendingMessageScrollId) {
                        tryScrollToMessage(pendingMessageScrollId);
                    } else {
                        setTimeout(() => {
                            msgContainer.scrollTop = msgContainer.scrollHeight;
                        }, 100);
                    }
                });

                
        }

        // --- LOGIC MENU CHAT (SAO CHÉP, SỬA, XÓA) ---

        // 1. Bật/Tắt Menu
        function toggleChatMenu(msgId) {
            // Đóng tất cả menu khác trước
            document.querySelectorAll('.chat-menu').forEach(el => {
                if(el.id !== `chat-menu-${msgId}`) el.classList.remove('show');
            });
            
            const menu = document.getElementById(`chat-menu-${msgId}`);
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // 2. Sao chép tin nhắn
        // Hàm sao chép tin nhắn (Đã nâng cấp để sửa lỗi)
        function copyChatText(text) {
            // Giải mã text nếu nó bị mã hóa (đề phòng trường hợp xuống dòng)
            try {
                text = decodeURIComponent(text);
            } catch (e) {
                // Nếu không phải dạng mã hóa thì giữ nguyên
            }

            // Cách 1: Dùng API hiện đại (Chỉ chạy trên HTTPS hoặc Localhost)
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Đã sao chép!");
                    document.querySelectorAll('.chat-menu').forEach(el => el.classList.remove('show'));
                }).catch(err => {
                    console.log("Cách 1 lỗi, thử cách 2...");
                    fallbackCopyText(text);
                });
            } else {
                // Cách 2: Fallback (Chạy mọi nơi, kể cả mở file trực tiếp)
                fallbackCopyText(text);
            }
        }

        // Hàm dự phòng (Backup)
        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Giấu ô input đi để người dùng không thấy
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("Đã sao chép!");
                    document.querySelectorAll('.chat-menu').forEach(el => el.classList.remove('show'));
                } else {
                    showToast("Không thể sao chép (Trình duyệt chặn)");
                }
            } catch (err) {
                showToast("Lỗi sao chép: " + err);
            }

            document.body.removeChild(textArea);
        }

        // 3. Xóa tin nhắn
        function deleteChatMessage(msgId) {
            if (!currentChatRelationId) return;

            showConfirm("Bạn muốn thu hồi tin nhắn này?", async () => {
                try {
                    // Xác định collection dựa trên loại chat (Nhóm hay Riêng)
                    let collectionRef;
                    if (currentChatType === 'group') {
                        collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                            .doc(currentChatRelationId).collection('messages');
                    } else {
                        collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                            .doc(currentChatRelationId).collection('messages');
                    }

                    await collectionRef.doc(msgId).delete();

                    syncNotification(msgId, null, true);

                    showToast("Đã xóa tin nhắn.");
                } catch (e) {
                    console.error(e);
                    showToast("Lỗi khi xóa!");
                }
            });
        }

        // 4. Bắt đầu sửa tin nhắn (Hiện ô nhập)
        function enableEditChatMessage(msgId, currentText) {
            const textDiv = document.getElementById(`chat-content-${msgId}`);
            const menu = document.getElementById(`chat-menu-${msgId}`);
            if (menu) menu.classList.remove('show'); // Đóng menu

            if (textDiv) {
                // Lưu text gốc để phòng trường hợp hủy
                textDiv.dataset.original = currentText;
                
                // Thay thế bằng ô input
                textDiv.innerHTML = `
                    <div class="flex flex-col gap-2 min-w-[150px]">
                        <input type="text" id="edit-input-${msgId}" class="chat-edit-input" value="${currentText.replace(/"/g, '&quot;')}">
                        <div class="flex gap-2 justify-end">
                            <button onclick="cancelEditChatMessage('${msgId}')" class="text-[10px] font-bold text-gray-400 hover:text-white">Hủy</button>
                            <button onclick="saveEditedChatMessage('${msgId}')" class="text-[10px] font-bold text-app-gold hover:text-yellow-300">Lưu</button>
                        </div>
                    </div>
                `;
                // Focus vào ô input
                setTimeout(() => document.getElementById(`edit-input-${msgId}`).focus(), 100);
            }
        }

        // 5. Hủy sửa
        function cancelEditChatMessage(msgId) {
            const textDiv = document.getElementById(`chat-content-${msgId}`);
            if (textDiv && textDiv.dataset.original) {
                // Khôi phục lại text gốc (có xử lý render link tag nếu cần)
                // Ở đây ta gọi lại hàm xử lý hiển thị text bình thường
                let formatted = textDiv.dataset.original;
                // Nếu là group chat thì format lại mention
                if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                    formatted = formatted.replace(/@([a-zA-Z0-9_]+)/g, (match, username) => {
                        return `<span class="chat-mention" onclick="viewUserProfile('${username}')">${match}</span>`;
                    });
                }
                textDiv.innerHTML = formatted;
            }
        }

        // 6. Lưu tin nhắn đã sửa
        async function saveEditedChatMessage(msgId) {
            const input = document.getElementById(`edit-input-${msgId}`);
            const newText = input.value.trim();
            
            if (!newText) return showToast("Tin nhắn không được để trống!");
            if (!currentChatRelationId) return;

            try {
                let collectionRef;
                if (currentChatType === 'group') {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                        .doc(currentChatRelationId).collection('messages');
                } else {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                        .doc(currentChatRelationId).collection('messages');
                }

                await collectionRef.doc(msgId).update({
                    text: newText,
                    isEdited: true // Đánh dấu là đã sửa
                });

                syncNotification(msgId, newText, false);
                
                showToast("Đã cập nhật!");
            } catch (e) {
                console.error(e);
                showToast("Lỗi cập nhật!");
                cancelEditChatMessage(msgId);
            }
        }

        // Xử lý phím Enter để gửi tin (Shift+Enter để xuống dòng)
        document.getElementById('chatInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });

        function viewChatMedia(src, type) {
            // Tận dụng Modal MiniPreview có sẵn
            const modal = document.getElementById('miniPreviewModal');
            const container = document.getElementById('miniPreviewMedia');
            
            if (type === 'image') {
                container.innerHTML = `<img src="${src}" class="w-full h-full object-contain">`;
            } else if (type === 'video') {
                container.innerHTML = `<video src="${src}" controls autoplay class="w-full h-full object-contain"></video>`;
            }
            
            // Ẩn nút "Nhảy đến bài viết" vì đây là chat
            const jumpBtn = modal.querySelector('div[onclick="jumpToPostFromMini()"]');
            if(jumpBtn) jumpBtn.classList.add('hidden');

            modal.classList.remove('hidden');
        }

        // Hàm cuộn xuống đáy khung chat
        function scrollToBottom() {
            const msgContainer = document.getElementById('chatMessages');
            if (msgContainer) {
                // Dùng setTimeout để đảm bảo giao diện đã được vẽ xong trước khi cuộn
                setTimeout(() => {
                    msgContainer.scrollTop = msgContainer.scrollHeight;
                }, 100); // Đợi 100ms
            }
        }

        // --- LOGIC CÀI ĐẶT & XÓA TIN NHẮN (ĐÃ SỬA LỖI) ---

        // 1. Mở bảng cài đặt
        function openChatSettings() {
            document.getElementById('chatSettingsModal').classList.remove('hidden');
        }

        // 2. Đóng bảng cài đặt
        function closeChatSettings() {
            document.getElementById('chatSettingsModal').classList.add('hidden');
        }

        // 3. Hỏi xác nhận trước khi xóa
        // Thay thế hoặc thêm mới hàm này
        async function confirmDeleteAllMessages() {
            // 1. Kiểm tra ID cuộc hội thoại
            if (!currentChatRelationId) return;

            // 2. Hiển thị thông báo xác nhận rõ ràng
            showConfirm("Xóa toàn bộ tin nhắn phía bạn?", async () => {
                try {
                    // Tạo tên trường dữ liệu riêng cho user hiện tại (VD: clearedAt_username123)
                    const fieldName = `clearedAt_${currentUser.username}`;
                    
                    // Xác định đang là Chat Nhóm hay Chat Riêng để chọn collection đúng
                    const collectionName = (currentChatType === 'group') ? 'groups' : 'relationships';
                    
                    // 3. CẬP NHẬT DATABASE: Chỉ lưu thời gian hiện tại vào document cha (Group/Relationship)
                    // KHÔNG xóa collection 'messages'
                    await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data')
                        .collection(collectionName).doc(currentChatRelationId)
                        .update({
                            [fieldName]: Date.now() // Lưu mốc thời gian xóa
                        });

                    const notifRef = db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('notifications');
                    
                    let query;

                    if (currentChatType === 'group') {
                        // TRƯỜNG HỢP 1: CHAT NHÓM
                        // Tìm thông báo có 'relatedParentId' trùng với ID nhóm
                        query = notifRef
                            .where('recipientId', '==', currentUser.username)
                            .where('relatedParentId', '==', currentChatRelationId);
                    } else {
                        // TRƯỜNG HỢP 2: CHAT RIÊNG 1-1
                        // Tìm thông báo do 'Người kia' (currentChatFriendId) gửi đến
                        if (!currentChatFriendId) {
                            console.log("Không tìm thấy ID người chat, bỏ qua xóa thông báo.");
                        } else {
                            query = notifRef
                                .where('recipientId', '==', currentUser.username)
                                .where('senderId', '==', currentChatFriendId)
                                .where('community', '==', 'PRIVATE_CHAT'); // Chỉ xóa tin nhắn riêng, không xóa kết bạn/like
                        }
                    }

                    if (query) {
                        const notifSnapshot = await query.get();
                        
                        // Thực hiện xóa hàng loạt (Batch Delete)
                        const batch = db.batch();
                        let countNotif = 0;
                        
                        notifSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                            countNotif++;
                        });

                        if (countNotif > 0) {
                            await batch.commit();
                            console.log(`Đã xóa vĩnh viễn ${countNotif} thông báo cũ.`);
                        }
                    }

                    // 4. Xử lý giao diện ngay lập tức
                    document.getElementById('chatMessages').innerHTML = 
                        '<div class="text-center pt-10 text-gray-500 text-xs">Đã xóa lịch sử trò chuyện.</div>';
                    
                    // Đóng menu cài đặt chat
                    closeChatSettings();
                    showToast("Đã xóa đoạn chat.");
                    
                    // (Tùy chọn) Reload lại tin nhắn để áp dụng bộ lọc mới ngay
                    subscribeToMessages();

                } catch (e) {
                    console.error(e);
                    showToast("Lỗi khi xóa lịch sử.");
                }
            });
        }

        // 4. HÀM XÓA TIN NHẮN CHÍNH THỨC (ĐÃ FIX)
        async function deleteAllChatMessages() {
            // Kiểm tra biến ID cuộc trò chuyện
            if (!currentChatRelationId) {
                // Cố gắng khôi phục ID nếu đang chat với ai đó
                if (currentChatFriendId && currentUser) {
                    currentChatRelationId = getRelationId(currentUser.username, currentChatFriendId);
                } else {
                    showToast("Lỗi: Mất kết nối cuộc trò chuyện. Hãy mở lại chat!");
                    return;
                }
            }

            showToast("Đang xóa dữ liệu...");

            try {
                const messagesRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .doc(currentChatRelationId).collection('messages');

                const snapshot = await messagesRef.get();

                if (snapshot.empty) {
                    showToast("Cuộc trò chuyện này đã trống rồi!");
                    resetChatUI(); // Vẫn reset giao diện cho sạch
                    return;
                }

                // Xóa từng tin nhắn (Dùng Batch)
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                showToast("Đã xóa sạch tin nhắn!");
                resetChatUI(); // Làm sạch màn hình chat ngay lập tức

            } catch (e) {
                console.error("Lỗi xóa:", e);
                showToast("Lỗi hệ thống khi xóa!");
            }
        }

        // --- LOGIC KHO LƯU TRỮ MEDIA (CHAT ARCHIVE) ---

        // 1. Mở Kho lưu trữ
        // --- CẬP NHẬT: HÀM MỞ KHO LƯU TRỮ (Đã hỗ trợ Group Chat) ---
        async function openChatArchive() {
            if (!currentChatRelationId) return;

            // Hiển thị Modal
            document.getElementById('chatArchiveModal').classList.remove('hidden');
            const grid = document.getElementById('chatArchiveGrid');
            const emptyState = document.getElementById('chatArchiveEmpty');
            
            // Hiện loading
            grid.innerHTML = '<div class="col-span-3 text-center py-10"><i class="fa-solid fa-circle-notch fa-spin text-app-gold"></i></div>';
            emptyState.classList.add('hidden');

            try {
                let collectionRef;

                // --- PHẦN SỬA CHỮA CHÍNH: Chọn đúng collection Groups hoặc Relationships ---
                if (typeof currentChatType !== 'undefined' && currentChatType === 'group') {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                        .doc(currentChatRelationId).collection('messages');
                } else {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                        .doc(currentChatRelationId).collection('messages');
                }
                // -------------------------------------------------------------------------

                // Lấy dữ liệu tin nhắn (chỉ lấy tin nhắn có type là image hoặc video)
                const snapshot = await collectionRef
                    .orderBy('timestamp', 'desc') // Mới nhất lên đầu
                    .get();

                const mediaItems = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Lọc: Chỉ lấy Image và Video (Audio thường không hiển thị trong kho ảnh)
                    if (data.type === 'image' || data.type === 'video') {
                        mediaItems.push(data);
                    }
                });

                // Render ra Grid
                grid.innerHTML = '';

                if (mediaItems.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                mediaItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "aspect-square bg-gray-900 relative group overflow-hidden cursor-pointer border border-gray-800";
                    
                    let contentHTML = '';
                    
                    if (item.type === 'image') {
                        contentHTML = `<img src="${item.text}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">`;
                    } else if (item.type === 'video') {
                        contentHTML = `
                            <video src="${item.text}" class="w-full h-full object-cover"></video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black/20">
                                <i class="fa-solid fa-play text-white drop-shadow-md text-2xl group-hover:scale-110 transition-transform"></i>
                            </div>
                            <div class="absolute bottom-1 right-1 bg-black/60 px-1.5 rounded text-[8px] font-bold text-white">VIDEO</div>
                        `;
                    }

                    div.innerHTML = contentHTML;
                    
                    // Tái sử dụng hàm viewChatMedia để xem chi tiết
                    div.onclick = () => viewChatMedia(item.text, item.type);

                    grid.appendChild(div);
                });

            } catch (e) {
                console.error(e);
                grid.innerHTML = '<div class="col-span-3 text-center text-red-500 text-xs py-10">Lỗi tải dữ liệu</div>';
            }
        }

        // 2. Đóng Kho lưu trữ
        function closeChatArchive() {
            document.getElementById('chatArchiveModal').classList.add('hidden');
            document.getElementById('chatArchiveGrid').innerHTML = ''; // Dọn dẹp để nhẹ máy
        }

        // Hàm phụ trợ để làm sạch màn hình chat sau khi xóa
        function resetChatUI() {
            const msgContainer = document.getElementById('chatMessages');
            if (msgContainer) {
                msgContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs opacity-50 animate-fade-in">
                        <i class="fa-regular fa-trash-can text-4xl mb-2"></i>
                        <p>Đã xóa toàn bộ cuộc trò chuyện</p>
                    </div>`;
            }
        }

        // Hàm phụ để làm sạch màn hình chat
        function resetChatUI() {
            const msgContainer = document.getElementById('chatMessages');
            if (msgContainer) {
                msgContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs opacity-50 animate-fade-in">
                        <i class="fa-regular fa-trash-can text-4xl mb-2"></i>
                        <p>Đã xóa toàn bộ cuộc trò chuyện</p>
                    </div>`;
            }
        }

        // --- LOGIC TÌM KIẾM TIN NHẮN (NÂNG CẤP: HIGHLIGHT + NAVIGATE) ---

        let searchMatches = []; // Mảng chứa các thẻ <span> đã highlight
        let currentMatchIndex = -1; // Vị trí hiện tại

        // 1. Kích hoạt tìm kiếm
        function activateChatSearch() {
            closeChatSettings();
            document.getElementById('msgSearchBar').classList.remove('hidden');
            const input = document.getElementById('msgSearchInput');
            input.value = '';
            input.focus();
            
            // Gắn sự kiện nhập liệu (Debounce nhẹ để đỡ lag)
            input.oninput = function() {
                executeChatSearch(this.value);
            };
            
            // Gắn sự kiện Enter để tìm tiếp (giống nút Down)
            input.onkeydown = function(e) {
                if(e.key === 'Enter') navigateSearch('down');
            };
        }

        // 2. Tắt tìm kiếm
        function closeChatSearch() {
            document.getElementById('msgSearchBar').classList.add('hidden');
            clearSearchHighlights();
        }

        // 3. Thực thi tìm kiếm
        function executeChatSearch(keyword) {
            clearSearchHighlights(); // Xóa cũ trước khi tìm mới
            keyword = keyword.trim().toLowerCase();
            
            if (!keyword) {
                updateSearchCounter(0, 0);
                return;
            }

            const msgContainer = document.getElementById('chatMessages');
            const bubbles = msgContainer.querySelectorAll('.message-bubble');
            
            // Regex tìm kiếm không phân biệt hoa thường
            const regex = new RegExp(`(${escapeRegExp(keyword)})`, 'gi');

            bubbles.forEach(bubble => {
                highlightTextInNode(bubble, regex);
            });

            // Lấy tất cả các thẻ span vừa được highlight
            searchMatches = Array.from(document.querySelectorAll('.search-highlight'));
            
            if (searchMatches.length > 0) {
                // Mặc định nhảy tới kết quả cuối cùng (mới nhất)
                currentMatchIndex = searchMatches.length - 1; 
                focusMatch(currentMatchIndex);
            } else {
                updateSearchCounter(0, 0);
            }
        }

        // 4. Hàm điều hướng (Lên/Xuống)
        function navigateSearch(direction) {
            if (searchMatches.length === 0) return;

            if (direction === 'up') {
                currentMatchIndex--;
                if (currentMatchIndex < 0) currentMatchIndex = searchMatches.length - 1; // Vòng lại cuối
            } else {
                currentMatchIndex++;
                if (currentMatchIndex >= searchMatches.length) currentMatchIndex = 0; // Vòng về đầu
            }

            focusMatch(currentMatchIndex);
        }

        // 5. Hàm focus vào kết quả (Cuộn tới + Đổi màu active)
        function focusMatch(index) {
            // Xóa class active ở tất cả các kết quả khác
            searchMatches.forEach(el => el.classList.remove('active'));
            
            // Thêm class active cho kết quả hiện tại
            const target = searchMatches[index];
            if (target) {
                target.classList.add('active');
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Cập nhật bộ đếm (Ví dụ: 3/10)
                updateSearchCounter(index + 1, searchMatches.length);
            }
        }

        // Hàm cập nhật text bộ đếm
        function updateSearchCounter(current, total) {
            const label = document.getElementById('searchResultCount');
            if (total === 0) label.textContent = "0 kq";
            else label.textContent = `${current}/${total}`;
        }

        // Hàm đệ quy highlight text (An toàn, không phá vỡ HTML tag)
        // Hàm đệ quy highlight text (PHIÊN BẢN MỚI: Bỏ qua class no-search)
        function highlightTextInNode(element, regex) {
            // Trường hợp 1: Là Node Văn bản (Text Node) -> Thực hiện highlight
            if (element.nodeType === 3) { 
                const text = element.nodeValue;
                if (regex.test(text)) {
                    const span = document.createElement('span');
                    span.innerHTML = text.replace(regex, '<span class="search-highlight">$1</span>');
                    element.replaceWith(span);
                }
            } 
            // Trường hợp 2: Là Thẻ HTML (Element Node) -> Duyệt tiếp con cái
            else if (element.nodeType === 1 && element.childNodes && !/(script|style|img|video|audio)/i.test(element.tagName)) {
                
                // --- ĐOẠN QUAN TRỌNG NHẤT ---
                // Nếu thẻ này có class 'no-search', DỪNG LẠI NGAY, không tìm bên trong nó
                if (element.classList && element.classList.contains('no-search')) {
                    return; 
                }
                // -----------------------------

                // Nếu không bị chặn, tiếp tục duyệt qua các phần tử con
                Array.from(element.childNodes).forEach(child => highlightTextInNode(child, regex));
            }
        }

        // Hàm dọn dẹp highlight (Restore lại text gốc)
        function clearSearchHighlights() {
            searchMatches = [];
            currentMatchIndex = -1;
            updateSearchCounter(0, 0);

            const highlights = document.querySelectorAll('.search-highlight');
            highlights.forEach(span => {
                const parent = span.parentNode;
                // Replace thẻ span highlight bằng chính text bên trong nó
                parent.replaceChild(document.createTextNode(span.textContent), span);
                parent.normalize(); // Gộp các text node rời rạc lại
            });
        }

        // Hàm escape regex để tránh lỗi khi tìm ký tự đặc biệt như ?, *, +
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // --- LOGIC FRIEND ZONE (KHU VỰC CÁ NHÂN) ---

        let friendZoneUnsubscribe = null;

        // --- BƯỚC 2: SỬA FRIEND ZONE FEED (CHỈ HIỆN BÀI THUỘC FRIEND ZONE) ---
        // --- CẬP NHẬT LOGIC FRIEND ZONE (SỬA LỖI KHÔNG MỞ ĐƯỢC BÀI VIẾT) ---
        // --- HÀM MỞ FRIEND ZONE (ĐÃ CẬP NHẬT FULL TÍNH NĂNG) ---
        // --- BƯỚC 4: HÀM KHỞI ĐỘNG FRIEND ZONE (FINAL VERSION) ---
        async function openFriendZone(forceReload = false) {
            if (currentUser && currentUser.isGuest) {
                showToast("Khách không thể truy cập Friend Zone!");
                return;
            }

            // 1. Setup UI: Ẩn hiện Modal
            document.getElementById('userInfoModal').classList.add('hidden');
            document.getElementById('friendZoneModal').classList.remove('hidden');
            
            const list = document.getElementById('friendFeedList');
            const empty = document.getElementById('friendZoneEmpty');

            // 2. Setup UI: Grid/List View
            // Thiết lập class CSS ngay lập tức dựa trên cài đặt cũ
            if (typeof currentFZViewMode !== 'undefined' && currentFZViewMode === 'grid') {
                list.classList.add('grid-view');
            } else {
                list.classList.remove('grid-view');
            }

            // 3. Xử lý hiển thị ban đầu
            // Nếu trong RAM đã có bài viết (do lần mở trước lưu lại) -> Hiện ngay lập tức cho mượt
            if (fzRawPosts.length > 0) {
                renderFriendZoneUI();
            } else {
                // Nếu RAM trống (mở lần đầu tiên) -> Hiện Loading xoay vòng
                list.innerHTML = '<div class="text-center pt-32"><i class="fa-solid fa-circle-notch fa-spin text-app-gold text-3xl"></i><p class="text-xs text-gray-500 mt-3 font-bold">Đang kết nối bạn bè...</p></div>';
                empty.classList.add('hidden');
            }

            // 4. Dọn dẹp các kết nối cũ (nếu có) để tránh trùng lặp
            if (fzUnsubFriends1) fzUnsubFriends1();
            if (fzUnsubFriends2) fzUnsubFriends2();
            if (fzUnsubPosts) fzUnsubPosts();

            // --- LUỒNG 1: THEO DÕI BẠN BÈ (Chiều Mình là User1) ---
            fzUnsubFriends1 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                .where('user1', '==', currentUser.username).where('status', '==', 'accepted')
                .onSnapshot(snapshot => {
                    fzFriendList1 = [];
                    snapshot.forEach(doc => fzFriendList1.push(doc.data().user2));
                    // Dữ liệu bạn bè thay đổi -> Vẽ lại giao diện ngay
                    renderFriendZoneUI();
                });

            // --- LUỒNG 2: THEO DÕI BẠN BÈ (Chiều Mình là User2) ---
            fzUnsubFriends2 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                .where('user2', '==', currentUser.username).where('status', '==', 'accepted')
                .onSnapshot(snapshot => {
                    fzFriendList2 = [];
                    snapshot.forEach(doc => fzFriendList2.push(doc.data().user1));
                    // Dữ liệu bạn bè thay đổi -> Vẽ lại giao diện ngay
                    renderFriendZoneUI();
                });

            // --- LUỒNG 3: THEO DÕI BÀI VIẾT (Lấy 100 bài mới nhất) ---
            fzUnsubPosts = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                .orderBy('timestamp', 'desc')
                .limit(100)
                .onSnapshot(snapshot => {
                    fzRawPosts = []; // Reset kho bài viết thô
                    
                    snapshot.forEach(doc => {
                        // Lưu toàn bộ bài viết vào biến RAM
                        fzRawPosts.push({id: doc.id, ...doc.data()});
                    });
                    
                    // Có bài mới -> Vẽ lại giao diện ngay
                    renderFriendZoneUI();
                });
        }

        // --- BƯỚC 3: THÊM HÀM MỚI NÀY VÀO (Dùng để vẽ giao diện từ dữ liệu đã tải) ---
        // --- BƯỚC 3 (BẢN CHUẨN): HÀM VẼ GIAO DIỆN ---
        function renderFriendZoneUI() {
            const list = document.getElementById('friendFeedList');
            const empty = document.getElementById('friendZoneEmpty');
            
            const uniqueFriends = new Set([...fzFriendList1, ...fzFriendList2, currentUser.username]);
            const fzFinalFriendIds = Array.from(uniqueFriends);

            list.innerHTML = ''; 
            let hasPost = false;

            fzRawPosts.forEach(post => {
                if (fzFinalFriendIds.includes(post.authorId) && post.community === 'FRIEND_ZONE') {
                    
                    let canView = false;
                    if (post.authorId === currentUser.username) canView = true;
                    else if (!post.allowedViewers || post.allowedViewers.length === 0) canView = true;
                    else if (post.allowedViewers.includes('ALL') || post.allowedViewers.includes(currentUser.username)) canView = true;

                    if (canView) {
                        // ĐỒNG BỘ CACHE để khi mở bài viết có dữ liệu
                        if (typeof recentPostsCache !== 'undefined') {
                            const idx = recentPostsCache.findIndex(p => p.id === post.id);
                            if (idx !== -1) recentPostsCache[idx] = post;
                            else recentPostsCache.push(post);
                        }

                        if (currentFZViewMode === 'grid') {
                            // --- CHẾ ĐỘ LƯỚI Y HỆT TRANG CHÍNH ---
                            const gridItem = document.createElement('div');
                            const frameStyle = getFrameColorStyle(post.frameColor || 'gray');
                            
                            
                             // Lấy style màu dựa trên frameColor (gold, pink, blue...)
                            gridItem.className = "post-card aspect-square bg-gray-900 overflow-hidden relative cursor-pointer rounded-lg";

                            gridItem.setAttribute('data-author-id', post.authorId);

                            gridItem.style.setProperty('border', `2px solid ${frameStyle.borderColor}`, 'important');
                            gridItem.style.boxSizing = 'border-box';

                            
                            if (post.frameColor && post.frameColor !== 'gray') {
                                // Hiệu ứng phát sáng cho viền màu
                                gridItem.style.setProperty('box-shadow', frameStyle.shadow, 'important');
                                gridItem.style.zIndex = "1";
                            } else {
                                // Viền mặc định cho bài bình thường
                                gridItem.style.setProperty('border-color', '#374151', 'important');
                            }
                           
                            
                            // SỬA TÊN HÀM TẠI ĐÂY: Dùng openFullPostById thay vì renderTargetPost
                            gridItem.onclick = () => {
                                if (typeof openFullPostById === 'function') {
                                    openFullPostById(post.id);
                                }
                            };

                            let mediaHtml = '';
                            // Lấy URL và Type (hỗ trợ cả post.imageUrl của trang chính và mảng media của friendzone)
                            const displayUrl = post.imageUrl || (post.media && post.media[0] ? post.media[0].url : '');
                            const displayType = post.mediaType || (post.media && post.media[0] ? post.media[0].type : 'image');

                            // --- LOGIC MEDIA ĐÃ ĐỒNG BỘ Y CHANG TRANG CHÍNH ---
                            if (displayType === 'video') {
                                mediaHtml = `
                                    <video src="${displayUrl}" class="w-full h-full object-cover pointer-events-none" playsinline muted preload="metadata"></video>
                                    <i class="fa-solid fa-play absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white drop-shadow-md"></i>`;
                            } 
                            else if (displayType === 'audio') {
                                mediaHtml = `
                                    <div class="w-full h-full bg-black flex items-center justify-center">
                                        <i class="fa-solid fa-music text-app-gold text-2xl"></i>
                                    </div>`;
                            } 
                            else if (displayUrl) {
                                mediaHtml = `<img src="${displayUrl}" class="w-full h-full object-cover pointer-events-none">`;
                            } 
                            else {
                                mediaHtml = `<div class="w-full h-full flex items-center justify-center p-2 text-[10px] text-gray-400 text-center italic bg-gray-800">
                                    ${post.caption ? post.caption.substring(0, 30) + '...' : 'Moment'}
                                </div>`;
                            }
                            
                            gridItem.innerHTML = mediaHtml;
                            list.appendChild(gridItem);
                        } else {
                            // CHẾ ĐỘ DANH SÁCH
                            const wrapper = document.createElement('div');
                            renderPost(wrapper, post.id, post, true);
                            if (wrapper.firstChild) list.appendChild(wrapper.firstChild);
                        }
                        hasPost = true;
                    }
                }
            });

            if (!hasPost) empty.classList.remove('hidden');
            else empty.classList.add('hidden');
        }

        // --- BƯỚC 5: HÀM ĐÓNG FRIEND ZONE (Cập nhật) ---
        function closeFriendZone() {
            document.getElementById('friendZoneModal').classList.add('hidden');

            // --- NGẮT KẾT NỐI REALTIME (Quan trọng) ---
            // Tắt cả 3 luồng nghe để tiết kiệm pin/tài nguyên
            if (fzUnsubFriends1) {
                fzUnsubFriends1();
                fzUnsubFriends1 = null;
            }
            if (fzUnsubFriends2) {
                fzUnsubFriends2();
                fzUnsubFriends2 = null;
            }
            if (fzUnsubPosts) {
                fzUnsubPosts();
                fzUnsubPosts = null;
            }
        }

        // --- LOGIC MỚI: CÁC TÍNH NĂNG RIÊNG CHO FRIEND ZONE ---

        let lastFzHomeTap = 0;

        // 1. NÚT HOME (Click đúp xoay, Click đơn cuộn đầu trang)
        function handleFriendZoneHome() {
            const now = Date.now();
            const container = document.getElementById('friendZoneContainer');
            const icon = document.querySelector('#fzHomeBtn i');
            
            // Nếu bấm 2 lần trong 300ms -> Là Click Đúp
            if (now - lastFzHomeTap < 300) {
                // Hiệu ứng xoay icon
                if(icon) {
                    icon.classList.add('fa-spin');
                    setTimeout(() => icon.classList.remove('fa-spin'), 1000);
                }
                
                // Gọi lại hàm load dữ liệu
                showToast("Đang làm mới Friend Zone...");
                openFriendZone(); 
                
            } else {
                // Click Đơn: Cuộn lên đầu
                container.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            lastFzHomeTap = now;
        }

        // 2. ALBUM RIÊNG (Không ảnh hưởng Album trang chính)
        // --- BƯỚC 3: SỬA ALBUM TRONG FRIEND ZONE (CHỈ HIỆN ẢNH FRIEND ZONE) ---
        // --- HÀM NÚT ALBUM (GÓC PHẢI DƯỚI) ---
        function openFriendZoneAlbum() {
            if (!currentUser) return;
            // Gọi hàm chung, truyền vào ID của chính mình
            viewFriendZoneProfile(currentUser.username);
        }

        function closeFriendZoneAlbum() {
            document.getElementById('friendZoneAlbumModal').classList.add('hidden');
        }

        // --- LOGIC MENU FRIEND ZONE (CẬP NHẬT GIAO DIỆN) ---
        function openFriendZoneMediaOptions() {
            document.getElementById('friendZoneMediaOptions').classList.remove('hidden');
            // Hiệu ứng trượt lên mượt mà (tìm thẻ div con thứ 2 chứa menu)
            setTimeout(() => {
                const menu = document.getElementById('friendZoneMediaOptions').querySelector('.bg-app-dark');
                if(menu) menu.classList.remove('translate-y-full');
            }, 10);
        }

        function closeFriendZoneMediaOptions() {
            const menu = document.getElementById('friendZoneMediaOptions').querySelector('.bg-app-dark');
            if(menu) menu.classList.add('translate-y-full');
            
            setTimeout(() => {
                document.getElementById('friendZoneMediaOptions').classList.add('hidden');
            }, 300);
        }

        // --- LOGIC MỚI ĐƠN GIẢN HƠN (DO GIAO DIỆN ĐÃ CHUẨN) ---
        function triggerFriendZoneUpload(type) {
            closeFriendZoneMediaOptions(); // Đóng menu chọn
            
            // Kích hoạt input file
            if (type === 'photo') document.getElementById('fzInputPhoto').click();
            else if (type === 'audio') document.getElementById('fzInputAudio').click();
            else document.getElementById('fzInputGallery').click();
        }

        // --- LOGIC ĐĂNG BÀI RIÊNG CHO FRIEND ZONE ---

        let selectedFZFile = null; // Biến lưu file riêng cho Friend Zone

        // 1. Xử lý khi chọn file xong -> Mở giao diện FZ Upload
        function handleFZFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFZFile = file; // Lưu file
            
            // Reset các trường nhập liệu
            document.getElementById('fzCaptionInput').value = '';
            updateFZFramePreview('gray');
            
            // Xử lý hiển thị Preview (Giống hệt logic cũ)
            const previewContainer = document.getElementById('fzPreviewContainer');
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image(); img.src = ev.target.result;
                    img.onload = () => {
                        // Nén ảnh sơ bộ để hiển thị cho nhanh
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const s = 800/Math.max(img.width, img.height);
                        c.width = img.width*s; c.height = img.height*s;
                        ctx.drawImage(img,0,0,c.width,c.height);
                        
                        previewContainer.innerHTML = `<img id="fzImagePreview" src="${c.toDataURL('image/jpeg', 0.7)}" class="w-full h-full object-cover">`;
                        document.getElementById('friendZoneUploadOverlay').classList.remove('hidden');
                    }
                }; reader.readAsDataURL(file);
            } 
            else {
                // Video hoặc Audio
                const url = URL.createObjectURL(file);
                const isVideo = file.type.startsWith('video/');
                const tag = isVideo 
                    ? `<video src="${url}" class="w-full h-full object-cover" autoplay loop muted></video>` 
                    : `<div class="w-full h-full flex items-center justify-center bg-black"><i class="fa-solid fa-music text-app-gold text-4xl animate-bounce"></i></div>`;
                
                previewContainer.innerHTML = tag;
                document.getElementById('friendZoneUploadOverlay').classList.remove('hidden');
            }
        }

        // 2. Hàm đóng giao diện đăng FZ
        function closeFZCamera() {
            document.getElementById('friendZoneUploadOverlay').classList.add('hidden');
            document.getElementById('fzPreviewContainer').innerHTML = '';
            document.getElementById('fzCaptionInput').value = ''; 
            // Thêm dòng dưới đây
            document.getElementById('fzCharCount').textContent = '0/100'; 

            document.getElementById('fzc_gray').checked = true; // Reset nút màu xám Friendzone
            updateFZFramePreview('gray');
            selectedFZFile = null;
        }

        // 3. Hàm cập nhật viền preview
        function updateFZFramePreview(color) {
            const wrapper = document.getElementById('fzUploadPreviewWrapper');
            const style = getFrameColorStyle(color);
            wrapper.style.border = `2px solid ${style.borderColor}`;
            wrapper.style.boxShadow = color === 'gray' ? 'none' : style.shadow;
        }

        // 4. Hàm AI Caption riêng cho FZ
       async function generateFZMagicCaption() {
            const img = document.getElementById('fzImagePreview');
            const input = document.getElementById('fzCaptionInput'); 
            const fzCharCount = document.getElementById('fzCharCount');

            if (!selectedFZFile || !selectedFZFile.type.startsWith('image/') || !img) {
                return showToast("AI chỉ hỗ trợ hình ảnh!");
            }
            
            // Prompt thông minh hơn cho Friend Zone
            const prompt = "Viết caption ngắn, thân mật cho bạn bè. Giới hạn tối đa 100 ký tự. Không để trong ngoặc kép.";
            
            const btn = document.querySelector('#friendZoneUploadOverlay .fa-wand-magic-sparkles').parentNode;
            const originalIcon = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            input.placeholder = "AI đang nghĩ..."; 
            input.value = ""; 

            try {
                let result = await callGemini(prompt, img.src);
                
                // --- CHỐT CHẶN CUỐI CÙNG: ÉP CỨNG 100 KÝ TỰ ---
                if (result.length > 100) {
                    result = result.substring(0, 100);
                }

                let i = 0;
                const typeInterval = setInterval(() => {
                    input.value += result.charAt(i); 
                    if (fzCharCount) {
                        fzCharCount.textContent = `${input.value.length}/100`;
                    }
                    i++;
                    if (i >= result.length) {
                        clearInterval(typeInterval);
                    }
                }, 30);
            } catch (e) { 
                showToast("AI đang bận!"); 
            } finally { 
                btn.innerHTML = originalIcon; 
                input.placeholder = "Nói gì đó (Max 100)..."; 
            }
        }

        // 5. HÀM ĐĂNG BÀI CHÍNH THỨC (QUAN TRỌNG NHẤT)
        // --- CẬP NHẬT HÀM ĐĂNG BÀI FRIEND ZONE (CÓ THÔNG BÁO) ---
        // --- HÀM ĐĂNG BÀI FRIEND ZONE (ĐÃ CẬP NHẬT QUYỀN RIÊNG TƯ) ---
        async function publishFriendZonePost() {
            // 1. Kiểm tra có file chưa
            if (!selectedFZFile) return;
            
            // 2. Lấy thông tin từ giao diện
            const caption = document.getElementById('fzCaptionInput').value;
            const colorRadios = document.getElementsByName('fzFrameColor');
            let selectedColor = 'gray';
            for (const r of colorRadios) { if(r.checked) selectedColor = r.value; }
            
            // 3. [MỚI] LẤY DANH SÁCH NGƯỜI XEM (Từ biến toàn cục currentAudience)
            // Nếu chưa chọn hoặc biến không tồn tại -> Mặc định là 'ALL'
            const viewers = (typeof currentAudience !== 'undefined' && currentAudience.length > 0) ? currentAudience : ['ALL'];

            // 4. Hiển thị Loading
            const loadingEl = document.getElementById('fzUploadLoading');
            if (loadingEl) loadingEl.classList.remove('hidden');
            
            // 5. Kiểm tra dung lượng (Giới hạn 0.75MB cho Video/Audio)
            const limitMB = 0.75;
            if (!selectedFZFile.type.startsWith('image/') && selectedFZFile.size > limitMB * 1024 * 1024) { 
                showToast(`File quá nặng (> ${limitMB * 1000}KB).`); 
                if (loadingEl) loadingEl.classList.add('hidden'); 
                return; 
            }

            try {
                let base64Data = ""; 
                let mediaType = 'image';
                
                // 6. XỬ LÝ FILE (Nén ảnh hoặc đọc Video/Audio)
                if (selectedFZFile.type.startsWith('image/')) { 
                    base64Data = await compressImageFile(selectedFZFile); 
                } else { 
                    mediaType = selectedFZFile.type.startsWith('video/') ? 'video' : 'audio'; 
                    base64Data = await new Promise((resolve) => { 
                        const reader = new FileReader(); 
                        reader.onloadend = () => resolve(reader.result); 
                        reader.readAsDataURL(selectedFZFile); 
                    }); 
                    // Fix lỗi file MOV trên iPhone (đổi header sang MP4)
                    if (selectedFZFile.name.toLowerCase().endsWith('.mov')) {
                        base64Data = base64Data.replace('data:video/quicktime;', 'data:video/mp4;');
                    }
                }
                
                // 7. LƯU VÀO DATABASE (FIRESTORE)
                const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts').add({ 
                    authorId: currentUser.username, 
                    authorName: currentUser.displayName, 
                    authorAvatarUrl: currentUser.avatarUrl || null, 
                    imageUrl: base64Data, 
                    mediaType: mediaType, 
                    caption: caption, 
                    community: 'FRIEND_ZONE', // Đánh dấu khu vực
                    timestamp: Date.now(), 
                    aiSummary: null, 
                    frameColor: selectedColor, 
                    likes: [], 
                    trimStart: 0, 
                    commentCount: 0,
                    allowedViewers: viewers // <--- [QUAN TRỌNG] Lưu quyền xem vào đây
                }); 

                // 8. GỬI THÔNG BÁO XÁC NHẬN CHO CHÍNH MÌNH
                // Nếu là ảnh -> gửi base64, nếu video/audio -> gửi loại file để hiện icon
                const notificationThumb = mediaType === 'image' ? base64Data : mediaType;

                await sendNotification(
                    currentUser.username,   // Người nhận (Chính mình)
                    'post',                 // Loại
                    docRef.id,              // ID bài viết
                    notificationThumb,      // Hình ảnh/Icon
                    "Friend Zone",          // Nội dung phụ
                    null, null,             
                    'FRIEND_ZONE'           // Khu vực
                );
                
                // 9. DỌN DẸP & RESET GIAO DIỆN
                
                // Reset biến chọn người xem về mặc định
                if (typeof currentAudience !== 'undefined') currentAudience = ['ALL'];
                
                // Reset text hiển thị trên nút chọn
                const audText = document.getElementById('audienceTextDisplay');
                const audIcon = document.getElementById('audienceIconDisplay');
                if(audText) audText.textContent = "Tất cả bạn bè";
                if(audIcon) audIcon.className = "fa-solid fa-earth-americas text-app-gold text-xs";

                closeFZCamera();
                showToast("Đã đăng lên Friend Zone!");
                
                // 10. Làm mới feed để thấy bài vừa đăng
                openFriendZone();
                
            } catch (e) {
                console.error(e);
                showToast("Lỗi đăng bài: " + e.message);
            }
            
            // Tắt loading
            if (loadingEl) loadingEl.classList.add('hidden');
        }

        // --- 1. LOGIC ANIMATION MENU (TRƯỢT LÊN/XUỐNG) ---
        function openFriendZoneMediaOptions() {
            const modal = document.getElementById('friendZoneMediaOptions');
            modal.classList.remove('hidden');
            
            // Tìm thẻ div con thứ 2 (cái bảng màu đen)
            // Cấu trúc mới: div(container) -> div(bg-app-dark)
            const content = modal.querySelector('.bg-app-dark');
            
            // Đợi 1 chút để browser render xong class 'hidden' rồi mới chạy animation
            setTimeout(() => {
                if(content) content.classList.remove('translate-y-full');
            }, 10);
        }

        function closeFriendZoneMediaOptions() {
            const modal = document.getElementById('friendZoneMediaOptions');
            const content = modal.querySelector('.bg-app-dark');
            
            if(content) content.classList.add('translate-y-full');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Đợi 300ms cho animation chạy xong
        }

        // --- 2. LOGIC KÉO NÚT HOME (PULL TO REFRESH) ---
        (function initFriendZoneGestures() {
            const fzHomeBtn = document.getElementById('fzHomeBtn');
            const pullIndicator = document.getElementById('fzPullRefreshIndicator');
            
            if (!fzHomeBtn || !pullIndicator) return; // An toàn nếu chưa load HTML

            let startY = 0;
            let isDragging = false;
            const threshold = 80; // Khoảng cách kéo cần thiết

            const handleStart = (y) => {
                startY = y;
                isDragging = false;
                pullIndicator.style.transition = 'none';
            };

            const handleMove = (y) => {
                const deltaY = y - startY;
                // Chỉ xử lý khi kéo lên (deltaY < 0)
                if (deltaY < -10) { 
                    isDragging = true;
                    
                    // Tính toán khoảng cách và độ mờ
                    const pullDistance = Math.min(Math.abs(deltaY), 150);
                    const opacity = Math.min(pullDistance / threshold, 1);
                    
                    // Cập nhật giao diện cục tròn
                    pullIndicator.style.transform = `translate(-50%, -${pullDistance}px) scale(${opacity})`;
                    pullIndicator.style.opacity = opacity;
                    
                    // Xoay icon theo độ kéo
                    const icon = pullIndicator.querySelector('i');
                    if(icon) icon.style.transform = `rotate(${pullDistance * 3}deg)`;
                }
            };

            const handleEnd = (y) => {
                const deltaY = y - startY;
                pullIndicator.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                if (isDragging && deltaY < -threshold) {
                    // --- ĐẠT NGƯỠNG: KÍCH HOẠT REFRESH ---
                    const icon = pullIndicator.querySelector('i');
                    if(icon) icon.classList.add('fa-spin');
                    
                    pullIndicator.style.transform = `translate(-50%, -${threshold}px) scale(1.2)`;
                    pullIndicator.style.opacity = '1';
                    
                    // Gọi hàm làm mới Friend Zone
                    showToast("Đang làm mới Friend Zone...");
                    openFriendZone();
                    
                    // Ẩn đi sau 1 giây
                    setTimeout(() => {
                        if(icon) icon.classList.remove('fa-spin');
                        pullIndicator.style.opacity = '0';
                        pullIndicator.style.transform = 'translate(-50%, 0) scale(0)';
                    }, 1000);

                } else {
                    // --- KHÔNG ĐẠT NGƯỠNG HOẶC CLICK ĐƠN ---
                    pullIndicator.style.opacity = '0';
                    pullIndicator.style.transform = 'translate(-50%, 0) scale(0)';
                    
                    // Nếu không kéo (hoặc kéo quá ít) -> Xử lý như Click bình thường
                    if (!isDragging || deltaY > -10) {
                        // Gọi lại logic click cũ (đã có sẵn trong handleFriendZoneHome)
                        // Nhưng ta không cần gọi lại ở đây vì sự kiện onclick HTML vẫn chạy song song
                    }
                }
                
                isDragging = false;
                startY = 0;
            };

            // Gắn sự kiện cảm ứng (Mobile)
            fzHomeBtn.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientY), {passive: true});
            fzHomeBtn.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientY), {passive: true});
            fzHomeBtn.addEventListener('touchend', (e) => handleEnd(e.changedTouches[0].clientY));

            // Gắn sự kiện chuột (PC)
            fzHomeBtn.addEventListener('mousedown', (e) => handleStart(e.clientY));
            
            // Sự kiện chuột cần lắng nghe trên toàn cửa sổ để tránh bị trượt ra ngoài nút
            window.addEventListener('mousemove', (e) => { 
                // Kiểm tra biến cờ toàn cục hoặc check trong hàm này
                // Ở đây ta dùng check đơn giản: nếu startY != 0 tức là đang kéo
                if(startY !== 0) handleMove(e.clientY); 
            });
            
            window.addEventListener('mouseup', (e) => { 
                if(startY !== 0) handleEnd(e.clientY); 
            });

        })(); // Tự động chạy ngay

        // --- LOGIC MỚI: XEM PROFILE TRONG FRIEND ZONE ---
        // --- HÀM XEM PROFILE FRIEND ZONE (ĐÃ VÁ LỖI HIỂN THỊ) ---
        async function viewFriendZoneProfile(targetUserId) {
            const modal = document.getElementById('friendZoneAlbumModal');
            const grid = document.getElementById('friendZoneAlbumGrid');
            const titleElement = document.querySelector('#friendZoneAlbumModal h3');
            
            modal.classList.remove('hidden');
            grid.innerHTML = '<div class="col-span-3 text-center py-20"><i class="fa-solid fa-circle-notch fa-spin text-app-gold text-2xl"></i></div>';

            if (targetUserId === currentUser.username) {
                // TRƯỜNG HỢP 1: Xem chính mình
                if(titleElement) {
                    titleElement.innerHTML = '<i class="fa-solid fa-images"></i> <span>ALBUM CÁ NHÂN FRIENDZONE</span>';
                }
            } else {
                // TRƯỜNG HỢP 2: Xem người khác
                if(titleElement) {
                    // Đặt tiêu đề mặc định trước (như code cũ của bạn)
                    titleElement.innerHTML = `<i class="fa-solid fa-user"></i> <span>ALBUM BẠN BÈ</span>`;
                }

                try {
                    // [QUAN TRỌNG]: Đổi .then() thành await để code dừng lại kiểm tra tại đây
                    const userDoc = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('users')
                        .doc(targetUserId).get();

                    if (!userDoc.exists) {
                        // NẾU USER KHÔNG TỒN TẠI -> Báo lỗi và Dừng hàm ngay
                        showToast("Tài khoản này không tồn tại hoặc đã bị xóa.", "error");
                        modal.classList.add('hidden'); // Đóng modal
                        return; // <--- Lệnh này giúp chặn không cho tải ảnh bên dưới
                    }

                    // Nếu tồn tại -> Cập nhật tên (Logic của bạn)
                    if (titleElement) {
                        const name = userDoc.data().displayName.toUpperCase();
                        titleElement.innerHTML = `<i class="fa-solid fa-user"></i> <span>ALBUM CỦA ${name}</span>`;
                    }

                } catch (err) {
                    console.error("Lỗi check user:", err);
                    // Nếu lỗi mạng, vẫn cho tải ảnh nhưng giữ tiêu đề mặc định "ALBUM BẠN BÈ"
                }
            }

            try {
                const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('posts')
                    .where('authorId', '==', targetUserId)
                    .get();

                let posts = [];
                snapshot.forEach(doc => {
                    const post = {id: doc.id, ...doc.data()};
                    
                    // --- [ĐOẠN VÁ LỖI BẮT ĐẦU] ---
                    if (post.community === 'FRIEND_ZONE') {
                        
                        // KIỂM TRA QUYỀN XEM
                        let canView = false;

                        // 1. Tác giả xem được hết
                        if (post.authorId === currentUser.username) canView = true;
                        // 2. Bài cũ không có trường này -> xem được
                        else if (!post.allowedViewers || post.allowedViewers.length === 0) canView = true;
                        // 3. Check danh sách
                        else {
                            if (post.allowedViewers.includes('ALL')) canView = true;
                            else if (post.allowedViewers.includes(currentUser.username)) canView = true;
                        }

                        // Nếu có quyền mới được push vào danh sách
                        if (canView) {
                            posts.push(post);
                        }
                    }
                    // --- [ĐOẠN VÁ LỖI KẾT THÚC] ---
                });

                posts.sort((a, b) => b.timestamp - a.timestamp);

                grid.innerHTML = '';
                if (posts.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-3 flex flex-col items-center justify-center py-20 opacity-50 text-gray-500">
                            <i class="fa-solid fa-user-shield text-4xl mb-3"></i>
                            <p class="text-xs font-bold uppercase tracking-wider text-center">Không có ảnh nào<br>(Hoặc bạn không có quyền xem)</p>
                        </div>`;
                } else {
                    posts.forEach(post => {
                        const div = document.createElement('div');

                        // 1. Khai báo class gốc
                        let fzProfileClass = 'aspect-square bg-gray-900 relative group overflow-hidden cursor-pointer rounded-lg box-border';
                        
                        // 2. [LOGIC MỚI] Kiểm tra màu để thêm hiệu ứng lấp lánh
                        if (post.frameColor && post.frameColor !== 'gray') {
                            fzProfileClass = 'frame-glitter-effect ' + fzProfileClass;
                        }
                        
                        // 3. Gán class
                        div.className = fzProfileClass;
                        
                        // 4. Set viền và bóng đổ
                        const frameStyle = getFrameColorStyle(post.frameColor || 'gray'); 
                        div.style.border = `2px solid ${frameStyle.borderColor}`;
                        
                        if (post.frameColor && post.frameColor !== 'gray') {
                            div.style.boxShadow = frameStyle.shadow;
                            div.style.zIndex = "1";
                        }
                        
                        let mediaContent;
                        if(post.mediaType === 'video') {
                            mediaContent = `<video src="${post.imageUrl}#t=0.1" class="w-full h-full object-cover"></video><i class="fa-solid fa-play absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white/80"></i>`;
                        } else if(post.mediaType === 'audio') {
                            mediaContent = `<div class="w-full h-full bg-gray-800 flex items-center justify-center"><div class="w-8 h-8 rounded-full bg-app-gold flex items-center justify-center shadow-lg"><i class="fa-solid fa-music text-black text-xs"></i></div></div>`;
                        } else {
                            mediaContent = `<img src="${post.imageUrl}" class="w-full h-full object-cover">`;
                        }
                        
                        div.innerHTML = mediaContent;
                        // Lưu vào cache để khi click vào xem chi tiết không bị lỗi
                        // (Optional: Thêm vào cache nếu cần)
                        if (typeof recentPostsCache !== 'undefined') recentPostsCache.push(post);

                        div.onclick = () => openMiniPreview(post); 
                        grid.appendChild(div);
                    });
                }
            } catch (e) {
                console.error(e);
                grid.innerHTML = '<p class="text-center text-red-500 mt-10 text-xs">Lỗi tải dữ liệu</p>';
            }
        }

        // --- LOGIC MỚI: TÍNH NĂNG NÂNG CAO CHO FRIEND ZONE ---
        let friendIdsCache = []; // Lưu danh sách ID bạn bè để tìm kiếm
        // --- LOGIC CHUYỂN ĐỔI GRID/LIST VIEW CHO FRIEND ZONE ---

        let currentFZViewMode = 'list'; // 1. Khai báo biến trạng thái riêng

        function toggleFriendZoneViewMode() {
            // 2. Đổi trạng thái
            currentFZViewMode = currentFZViewMode === 'list' ? 'grid' : 'list';
            
            const icon = document.getElementById('fzViewModeIcon');
            const list = document.getElementById('friendFeedList');
            
            // 3. Cập nhật Icon và CSS Class
            if (currentFZViewMode === 'grid') {
                icon.className = 'fa-solid fa-list text-xs';
                list.classList.add('grid-view'); // Kích hoạt CSS Grid
            } else {
                icon.className = 'fa-solid fa-table-cells-large text-xs';
                list.classList.remove('grid-view'); // Tắt CSS Grid
            }

            renderFriendZoneUI();
            
            // 4. Gọi lại hàm render để vẽ lại giao diện (Grid/List)
            
        }

        // Cập nhật hàm renderPost để hỗ trợ FZ Grid View
        // (Lưu ý: CSS .grid-view phải được định nghĩa giống trang chính)

        // 2. TÌM KIẾM BẠN BÈ (CHỈ HIỆN BẠN BÈ)
        function toggleFriendZoneSearch() {
            const modal = document.getElementById('fzSearchModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                document.getElementById('fzSearchInput').focus();
                // Reset kết quả
                document.getElementById('fzSearchResults').innerHTML = '<p class="text-center text-gray-600 text-xs italic">Nhập tên để tìm...</p>';
            } else {
                modal.classList.add('hidden');
            }
        }

        async function handleFriendZoneSearch(keyword) {
            const term = keyword.trim().toLowerCase();
            const container = document.getElementById('fzSearchResults');
            
            if (term.length < 1) {
                container.innerHTML = '';
                return;
            }

            // Lọc trong danh sách bạn bè (friendIdsCache được cập nhật ở openFriendZone)
            // Vì friendIdsCache chỉ chứa ID, ta cần fetch info hoặc tìm cách tối ưu
            // Đơn giản nhất: Tìm trong users collection nhưng chỉ lấy những người là bạn
            
            container.innerHTML = '<div class="text-center text-app-gold"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

            try {
                // Tìm user có username chứa từ khóa (Firestore không hỗ trợ search string contain tốt, nên ta tìm chính xác ID trước)
                // Hoặc: Tải danh sách bạn bè chi tiết về rồi lọc JS (tốt cho danh sách < 500 bạn)
                
                // Ở đây mình dùng cách: Tìm user theo ID khớp keyword, sau đó check xem có phải bạn không
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(term).get();
                
                container.innerHTML = '';

                if (doc.exists && friendIdsCache.includes(doc.id)) {
                    // Tìm thấy và LÀ BẠN BÈ
                    const user = doc.data();
                    renderFZSearchResult(container, doc.id, user);
                } else {
                    // Nếu không tìm thấy bằng ID, thử tìm bằng tên hiển thị (cần query)
                    // Demo đơn giản: Thông báo không tìm thấy
                    container.innerHTML = '<p class="text-center text-gray-500 text-xs">Không tìm thấy bạn bè nào khớp mã này.</p>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderFZSearchResult(container, userId, user) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 p-3 bg-gray-800 rounded-xl border border-gray-700 hover:border-app-gold cursor-pointer transition-all";
            
            let avatarHTML = user.avatarUrl 
                ? `<img src="${user.avatarUrl}" class="w-10 h-10 rounded-full object-cover">`
                : `<div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold">${user.displayName.charAt(0)}</div>`;

            div.innerHTML = `
                ${avatarHTML}
                <div class="flex-1">
                    <p class="text-white font-bold text-sm">${user.displayName}</p>
                    <p class="text-gray-500 text-[10px]">@${userId}</p>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-500"></i>
            `;
            
            // CLICK VÀO THÌ MỞ ALBUM FRIEND ZONE CỦA NGƯỜI ĐÓ
            div.onclick = () => {
                toggleFriendZoneSearch(); // Đóng tìm kiếm
                viewFriendZoneProfile(userId); // Mở album FZ
            };
            
            container.appendChild(div);
        }

        // 3. THÔNG BÁO RIÊNG CỦA FRIEND ZONE
        // --- BƯỚC 1: HÀM LẮNG NGHE THÔNG BÁO FZ (CHẠY NGẦM LIÊN TỤC) ---
        let fzNotifUnsubscribe = null;

        function subscribeToFZNotifications() {
            // Nếu chưa đăng nhập hoặc là khách thì thôi
            if (!currentUser || currentUser.isGuest) return;

            if (fzNotifUnsubscribe) fzNotifUnsubscribe();

            fzNotifUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('notifications')
                .where('recipientId', '==', currentUser.username)
                .where('community', '==', 'FRIEND_ZONE') // Chỉ lấy FZ
                .limit(50)
                .onSnapshot(snapshot => {
                    const list = document.getElementById('fzNotifList');
                    const badge = document.getElementById('fzNotifBadge'); // Lấy cái chấm đỏ
                    
                    // 1. XỬ LÝ BADGE (SỐ MÀU ĐỎ)
                    let unreadCount = 0;
                    snapshot.forEach(doc => {
                        if (!doc.data().isRead) unreadCount++;
                    });

                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                        badge.classList.remove('hidden'); // Hiện lên
                    } else {
                        badge.classList.add('hidden'); // Ẩn đi
                    }

                    // 2. XỬ LÝ DANH SÁCH (RENDER LIST)
                    // Chỉ cần render nếu modal đang mở (để tối ưu), hoặc render luôn cũng được
                    if (list) {
                        list.innerHTML = '';
                        if (snapshot.empty) {
                            list.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs gap-3 opacity-50 py-10"><i class="fa-solid fa-wind text-3xl"></i><p>Friend Zone yên ắng quá</p></div>';
                        } else {
                            let notifs = [];
                            snapshot.forEach(doc => notifs.push({id: doc.id, ...doc.data()}));
                            notifs.sort((a, b) => b.timestamp - a.timestamp);

                            notifs.forEach(n => {
                                renderFZNotification(list, n);
                            });
                        }
                    }
                });
        }

        // --- BƯỚC 3: SỬA HÀM BẬT/TẮT MODAL (ĐƠN GIẢN HÓA) ---
        function toggleFriendZoneNotifications() {
            const modal = document.getElementById('fzNotifModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Không cần gọi loadFriendZoneNotifications() nữa vì nó đã tự chạy rồi
            } else {
                modal.classList.add('hidden');
            }
        }

        function loadFriendZoneNotifications() {
            const list = document.getElementById('fzNotifList');
            list.innerHTML = '<div class="text-center pt-10"><i class="fa-solid fa-circle-notch fa-spin text-app-gold"></i></div>';

            if (fzNotifUnsubscribe) fzNotifUnsubscribe();

            // Query: Lấy thông báo của mình, lọc theo community = 'FRIEND_ZONE'
            // Lưu ý: Cần update hàm sendNotification ở Bước 3 để có field 'community'
            fzNotifUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('notifications')
                .where('recipientId', '==', currentUser.username)
                .where('community', '==', 'FRIEND_ZONE') // CHỈ LẤY NOTIF CỦA FZ
                .limit(20)
                .onSnapshot(snapshot => {
                    list.innerHTML = '';
                    if (snapshot.empty) {
                        list.innerHTML = '<p class="text-center text-gray-500 text-xs mt-10">Chưa có thông báo nào trong Friend Zone</p>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const n = {id: doc.id, ...doc.data()};
                        renderFZNotification(list, n);
                    });
                });
        }

        // --- SỬA GIAO DIỆN THÔNG BÁO FRIEND ZONE (CHO GIỐNG TRANG CHÍNH) ---
        // --- SỬA GIAO DIỆN THÔNG BÁO FZ (STYLE TRANG CHÍNH) ---
        // --- SỬA LẠI HÀM RENDER ĐỂ GỌI XỬ LÝ CLICK XỊN ---
        // --- SỬA GIAO DIỆN THÔNG BÁO FZ (STYLE TRANG CHÍNH + THÊM NGÀY GIỜ) ---
        function renderFZNotification(container, n) {
            const div = document.createElement('div');
            
            // Style giữ nguyên như bạn đã ưng ý
            const bgClass = n.isRead 
                ? 'opacity-50 border border-transparent bg-transparent hover:bg-white/5' 
                : 'bg-app-gold/5 border border-app-gold/30 shadow-[inset_0_0_15px_rgba(255,184,0,0.05)] hover:bg-app-gold/10';

            div.className = `flex items-center gap-3 p-4 rounded-2xl transition-all cursor-pointer relative group ${bgClass}`;
            
            // Nội dung & Icon
            let text = "";
            let icon = "";
            
            // --- [MỚI] TẠO CHUỖI NGÀY GIỜ ---
            const dateObj = new Date(n.timestamp);
            const formattedTime = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2, '0')} - ${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            // --------------------------------

            if (n.type === 'like') { 
                text = "đã thích bài viết FZ của bạn."; 
                icon = '<i class="fa-solid fa-heart text-red-500 text-[10px]"></i>'; 
            } else if (n.type === 'like_comment') {
                text = "đã thích bình luận FZ của bạn.";
                icon = '<i class="fa-solid fa-heart text-pink-500 text-[10px]"></i>';
            } else if (n.type === 'comment') { 
                text = "đã bình luận trong FZ."; 
                icon = '<i class="fa-solid fa-comment text-blue-500 text-[10px]"></i>'; 
            } else if (n.type === 'reply_comment') {
                text = "đã trả lời bình luận FZ.";
                icon = '<i class="fa-solid fa-reply text-blue-400 text-[10px]"></i>';
            } else if (n.type === 'mention') {
                text = "đã nhắc đến bạn trong Friend Zone.";
                icon = '<i class="fa-solid fa-at text-purple-500 text-[10px]"></i>';
            } else if (n.type === 'post') { 
                text = "đã đăng khoảnh khắc mới."; 
                icon = '<i class="fa-solid fa-layer-group text-app-gold text-[10px]"></i>'; 
            }

            // Avatar
            let avatar = n.senderAvatar 
                ? `<img src="${n.senderAvatar}" class="w-10 h-10 rounded-full object-cover border border-gray-600 group-hover:border-app-gold transition-colors">` 
                : `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-white text-xs font-bold border border-gray-600">${n.senderName.charAt(0)}</div>`;

            // Thumbnail
            let thumb = '';
            if(n.postImage) {
                if(n.postImage.startsWith('data:image')) {
                    thumb = `<img src="${n.postImage}" class="w-10 h-10 rounded-xl object-cover border border-gray-700 ml-auto shadow-sm group-hover:border-gray-500 transition-colors">`;
                } else {
                    let iconClass = n.postImage === 'video' ? 'fa-circle-play text-blue-400' : 'fa-music text-app-gold';
                    thumb = `<div class="w-10 h-10 rounded-xl bg-gray-800 border border-gray-700 ml-auto flex items-center justify-center shadow-inner"><i class="fa-solid ${iconClass} text-sm"></i></div>`;
                }
            }

            // --- [SỬA Ở ĐÂY] CẬP NHẬT PHẦN HTML HIỂN THỊ THỜI GIAN ---
            div.innerHTML = `
                <button onclick="deleteNotification(event, '${n.id}')" class="absolute top-1 right-1 w-6 h-6 rounded-full bg-black/60 text-gray-400 hover:text-red-500 hover:bg-white flex items-center justify-center transition-all opacity-100 z-[20] shadow-md border border-gray-600">
                    <i class="fa-solid fa-xmark text-[10px]"></i>
                </button>

                <div class="relative shrink-0">
                    ${avatar}
                    <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-app-dark rounded-full border border-gray-700 flex items-center justify-center shadow-sm z-10">
                        ${icon}
                    </div>
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center pr-6"> <p class="text-[13px] text-gray-300 leading-snug">
                        <span class="font-bold text-white group-hover:text-app-gold transition-colors">${n.senderName}</span> ${text}
                    </p>
                    <div class="flex items-center gap-2 mt-0.5">
                        <p class="text-[10px] text-gray-500 font-bold">${timeAgo(n.timestamp)}</p>
                        <span class="text-[8px] text-gray-600">•</span>
                        <p class="text-[10px] text-gray-500 font-mono">${formattedTime}</p>
                    </div>
                </div>
                ${thumb}
            `;

            // --- CẬP NHẬT SỰ KIỆN CLICK ---
            div.onclick = () => {
                if (n.postId) {
                    handleFZNotifClick(n.id, n.postId, n.relatedId, n.relatedParentId);
                } else {
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(n.id).update({ isRead: true });
                }
            };

            container.appendChild(div);
        }
        
        // --- CẬP NHẬT HÀM openFriendZone ĐỂ LƯU CACHE BẠN BÈ VÀ ÁP DỤNG GRID VIEW ---
        // (Bạn hãy thay thế phần đầu của hàm openFriendZone cũ bằng đoạn này để cập nhật cache)
        
        /* CẬP NHẬT TRONG openFriendZone:
           ...
           const friendIds = [currentUser.username];
           // (Code lấy bạn bè cũ...)
           // SAU KHI LẤY XONG friendIds:
           friendIdsCache = friendIds; // <--- CẬP NHẬT BIẾN TOÀN CỤC NÀY
           
           // ÁP DỤNG GRID VIEW CHO LIST
           const list = document.getElementById('friendFeedList');
           if (currentFZViewMode === 'grid') {
               list.classList.add('grid-view');
           } else {
               list.classList.remove('grid-view');
           }
           ...
        */

        // --- HÀM MỚI: ĐÁNH DẤU TẤT CẢ FZ LÀ ĐÃ ĐỌC ---
        async function markAllFZRead() {
            if (!currentUser) return;
            try {
                const batch = db.batch();
                const snap = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications')
                    .where('recipientId', '==', currentUser.username)
                    .where('community', '==', 'FRIEND_ZONE')
                    .where('isRead', '==', false)
                    .get();

                if (snap.empty) {
                    showToast("Đã sạch sẽ!");
                    return;
                }

                snap.forEach(doc => {
                    batch.update(doc.ref, { isRead: true });
                });

                await batch.commit();
                showToast("Đã đánh dấu đọc hết!");
            } catch (e) {
                console.error(e);
            }
        }

        // --- LOGIC DANH BẠ FRIEND ZONE (MỚI) ---

        // 1. Hàm bật/tắt Modal Danh bạ
        function toggleFriendListModal() {
            const modal = document.getElementById('friendListModal');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                loadFriendZoneContacts(); // Tải danh sách khi mở
            } else {
                modal.classList.add('hidden');
            }
        }

        // 2. Hàm tải và hiển thị danh sách bạn bè
        async function loadFriendZoneContacts() {
            const list = document.getElementById('fzContactList');
            list.innerHTML = '<div class="text-center pt-10"><i class="fa-solid fa-circle-notch fa-spin text-app-gold text-2xl"></i></div>';

            if (!currentUser) return;

            try {
                // Lấy danh sách ID bạn bè (status = accepted)
                const friendIds = new Set(); // Dùng Set để tránh trùng lặp

                // Query 1: Mình là user1
                const snap1 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user1', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap1.forEach(doc => friendIds.add(doc.data().user2));

                // Query 2: Mình là user2
                const snap2 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user2', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap2.forEach(doc => friendIds.add(doc.data().user1));

                const idsArray = Array.from(friendIds);

                list.innerHTML = '';

                if (idsArray.length === 0) {
                    list.innerHTML = `
                        <div class="text-center text-gray-500 text-xs mt-10 opacity-60 flex flex-col items-center">
                            <i class="fa-solid fa-user-group text-3xl mb-3"></i>
                            <p>Chưa có bạn bè nào trong danh bạ.</p>
                        </div>`;
                    return;
                }

                // Tải thông tin chi tiết từng người
                for (const friendId of idsArray) {
                    const userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(friendId).get();
                    if (userDoc.exists) {
                        renderFZContactItem(list, friendId, userDoc.data());
                    }
                }

            } catch (e) {
                console.error(e);
                list.innerHTML = '<p class="text-center text-red-500 mt-10 text-xs">Lỗi tải danh bạ</p>';
            }
        }

        // 3. Hàm vẽ giao diện từng người trong danh bạ
        function renderFZContactItem(container, userId, userData) {
            const div = document.createElement('div');
            div.className = "flex items-center gap-4 p-4 bg-gray-800/50 rounded-2xl border border-gray-700 hover:border-app-gold hover:bg-gray-800 cursor-pointer transition-all animate-fade-in group";
            
            // Xử lý Avatar
            let avatarHTML = userData.avatarUrl 
                ? `<img src="${userData.avatarUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-gray-600 group-hover:border-app-gold transition-colors">`
                : `<div class="w-12 h-12 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-lg border-2 border-gray-600 group-hover:border-app-gold">${userData.displayName.charAt(0).toUpperCase()}</div>`;

            div.innerHTML = `
                ${avatarHTML}
                <div class="flex-1 min-w-0">
                    <h4 class="text-white font-bold text-sm truncate group-hover:text-app-gold transition-colors">${userData.displayName}</h4>
                    <p class="text-gray-500 text-[10px] font-mono">@${userId}</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-app-gold group-hover:text-black transition-all">
                    <i class="fa-solid fa-chevron-right text-xs text-gray-400 group-hover:text-black"></i>
                </div>
            `;

            // SỰ KIỆN CLICK QUAN TRỌNG: Mở Album Friend Zone của người đó
            div.onclick = () => {
                // Đóng modal danh bạ
                toggleFriendListModal();
                // Gọi hàm xem profile FZ (Hàm này đã có sẵn trong code gốc của bạn rồi)
                viewFriendZoneProfile(userId);
            };

            container.appendChild(div);
        }

        // Cập nhật bộ đếm ký tự cho Friend Zone khi nhập liệu
        document.getElementById('fzCaptionInput').addEventListener('input', function() {
            const count = this.value.length;
            const countDisplay = document.getElementById('fzCharCount');
            if (countDisplay) {
                countDisplay.textContent = `${count}/100`;
            }
        });

        // --- LOGIC THÔNG BÁO TIN NHẮN RIÊNG (UserInfo Modal) ---

        let msgNotifUnsubscribe = null;

        // 1. Hàm bật/tắt bảng thông báo tin nhắn
        function toggleMsgNotifications() {
            const modal = document.getElementById('msgNotifModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                loadMsgNotifications(); // Tải danh sách
            } else {
                modal.classList.add('hidden');
            }
        }

        // 2. Hàm lắng nghe và đếm số tin nhắn chưa đọc (Chạy ngầm khi mở UserInfo)
        // Biến lưu trữ số lượng tin nhắn chưa đọc theo từng người (để dùng khi render lại list)
        

        let unreadGroupMap = {}; // Thêm biến này

        function subscribeToMsgBadge() {
            if (!currentUser) return;
            
            if (window.msgBadgeUnsubscribe) window.msgBadgeUnsubscribe();

            window.msgBadgeUnsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications')
                .where('recipientId', '==', currentUser.username)
                .where('type', '==', 'private_message')
                .where('isRead', '==', false)
                .onSnapshot(snapshot => {
                    // 1. Reset map
                    unreadMap = {};
                    unreadGroupMap = {}; // Reset map nhóm
                    
                    // 2. Ẩn tất cả badge cũ
                    document.querySelectorAll('[id^="badge-friend-"]').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('[id^="badge-group-"]').forEach(el => el.classList.add('hidden')); // Ẩn badge nhóm
                    
                    // 3. Đếm
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        if (data.community === 'GROUP_CHAT' && data.relatedParentId) {
                            // Nếu là tin nhắn nhóm -> Đếm vào Group Map theo ID Nhóm
                            const groupId = data.relatedParentId;
                            unreadGroupMap[groupId] = (unreadGroupMap[groupId] || 0) + 1;
                        } else {
                            // Tin nhắn riêng -> Đếm vào User Map theo SenderId
                            const sender = data.senderId;
                            unreadMap[sender] = (unreadMap[sender] || 0) + 1;
                        }
                    });

                    // 4. HIỆN BADGE BẠN BÈ
                    Object.keys(unreadMap).forEach(senderId => {
                        const badge = document.getElementById(`badge-friend-${senderId}`);
                        if (badge) badge.classList.remove('hidden');
                    });

                    // 5. HIỆN BADGE NHÓM (Cần cập nhật hàm renderGroupItem để có ID badge-group-...)
                    Object.keys(unreadGroupMap).forEach(groupId => {
                        const badge = document.getElementById(`badge-group-${groupId}`);
                        if (badge) badge.classList.remove('hidden');
                    });

                    // 6. Badge tổng (Phong bì)
                    const totalBadge = document.getElementById('userInfoMsgBadge');
                    if (totalBadge) {
                        const total = snapshot.size;
                        if (total > 0) {
                            totalBadge.textContent = total > 99 ? '99+' : total;
                            totalBadge.classList.remove('hidden');
                        } else {
                            totalBadge.classList.add('hidden');
                        }
                    }
                });
        }
        // Gọi hàm này trong openUserInfo() để bắt đầu lắng nghe
        // BẠN CẦN TÌM HÀM openUserInfo() VÀ THÊM DÒNG subscribeToMsgBadge(); VÀO CUỐI HÀM ĐÓ.

        // 3. Hàm tải danh sách thông báo tin nhắn (Khi bấm vào nút phong bì)
        // Biến toàn cục để quản lý lắng nghe (đặt phía trên hàm hoặc cùng chỗ với các biến unsubscribe khác)
      

        // --- CẬP NHẬT: HÀM LOAD THÔNG BÁO TIN NHẮN (FIX LỖI ĐỌC NHẦM TIN RIÊNG) ---
        // --- [SỬA BƯỚC 3] Thay thế toàn bộ hàm loadMsgNotifications ---
        function loadMsgNotifications() {
            const list = document.getElementById('msgNotifList');
            list.innerHTML = '<div class="text-center pt-10"><i class="fa-solid fa-circle-notch fa-spin text-app-gold"></i></div>';

            if (msgNotifUnsubscribe) msgNotifUnsubscribe();

            msgNotifUnsubscribe = db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('notifications')
                .where('recipientId', '==', currentUser.username)
                .where('type', '==', 'private_message')
                .limit(20)
                .onSnapshot(snapshot => {
                    list.innerHTML = ''; 
                    
                    if (snapshot.empty) {
                        list.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-gray-500 text-xs gap-3 opacity-50 pt-10">
                                <i class="fa-regular fa-envelope-open text-3xl"></i>
                                <p>Không có tin nhắn mới</p>
                            </div>`;
                        return;
                    }

                    let notifs = [];
                    snapshot.forEach(doc => notifs.push({id: doc.id, ...doc.data()}));
                    notifs.sort((a, b) => b.timestamp - a.timestamp);

                    notifs.forEach(n => {
                        const div = document.createElement('div');
                        
                        const bgClass = n.isRead ? 'opacity-50 bg-transparent' : 'bg-blue-600/10 border border-blue-500/30';
                        const dateObj = new Date(n.timestamp);
                        const timeStr = `${dateObj.getHours()}:${String(dateObj.getMinutes()).padStart(2, '0')}`;
                        const dateStr = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;

                        let avatar = n.senderAvatar 
                            ? `<img src="${n.senderAvatar}" class="w-10 h-10 rounded-full object-cover">`
                            : `<div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center font-bold text-white">${n.senderName.charAt(0)}</div>`;

                        const messageContent = n.extraInfo || "Đã gửi tin nhắn cho bạn";

                        
                        let groupLabel = "";
                        if (n.community === 'GROUP_CHAT') {
                            groupLabel = `<span class="bg-app-gold text-black text-[9px] font-bold px-1 rounded ml-1">NHÓM</span>`;
                        }

                        div.className = `flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all hover:bg-white/10 ${bgClass} relative group`;

                        div.innerHTML = `
                            <button onclick="deleteNotification(event, '${n.id}')" 
                                    class="absolute top-1/2 -translate-y-1/2 right-2 w-8 h-8 rounded-full bg-black/80 text-gray-400 hover:text-red-500 hover:bg-white flex items-center justify-center transition-all opacity-100 z-[20] shadow-lg border border-gray-600">
                                <i class="fa-solid fa-trash-can text-xs"></i>
                            </button>

                            <div class="relative">
                                ${avatar}
                                ${!n.isRead ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full border-2 border-app-dark"></div>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center">
                                    <p class="text-white text-xs font-bold truncate">${n.senderName}</p>
                                    ${groupLabel}
                                </div>
                                <p class="text-gray-300 text-[11px] truncate pr-2 mt-0.5">${messageContent}</p>
                                <p class="text-blue-400 text-[9px] font-mono mt-1">
                                    ${timeStr} <span class="text-gray-600 mx-1">|</span> ${dateStr}
                                </p>
                            </div>
                        `;

                        div.onclick = async () => {
                            
                            // --- // MỚI: KIỂM TRA NGƯỜI DÙNG CÒN TỒN TẠI KHÔNG --- 
                            // Chỉ kiểm tra nếu là chat riêng (không phải nhóm)
                            if (n.community !== 'GROUP_CHAT') {
                                try {
                                    const userCheck = await db.collection('artifacts').doc(appId)
                                        .collection('public').doc('data').collection('users')
                                        .doc(n.senderId).get();

                                    if (!userCheck.exists) {
                                        showToast("Người dùng này không tồn tại hoặc đã xóa tài khoản.", "error");
                                        
                                        // Vẫn đánh dấu đã đọc để ẩn thông báo đi (UX)
                                        await db.collection('artifacts').doc(appId)
                                            .collection('public').doc('data').collection('notifications')
                                            .doc(n.id).update({ isRead: true });
                                            
                                        return; // DỪNG LẠI NGAY, KHÔNG MỞ CHAT
                                    }
                                } catch (err) {
                                    console.error("Lỗi check user tin nhắn:", err);
                                }
                            }
                            // --- // KẾT THÚC SỬA ---


                            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications').doc(n.id).update({ isRead: true });
                            toggleMsgNotifications();
                            
                            if (n.community === 'GROUP_CHAT' && n.relatedParentId) {
                                const groupId = n.relatedParentId;
                                const msgId = n.relatedId;
                                showToast("Đang kiểm tra nhóm...");

                                try {
                                    const groupDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(groupId).get();
                                    if (groupDoc.exists) {
                                        const gData = groupDoc.data();
                                        if (gData.members && gData.members.includes(currentUser.username)) {
                                            // SỬA: Truyền thêm gData.avatarUrl vào tham số thứ 5
                                            startGroupChat(groupId, gData.name, gData.members, msgId, gData.avatarUrl); 
                                        } else {
                                            showToast("Bạn đã bị mời ra khỏi nhóm này!");
                                        }
                                    } else {
                                        showToast("Nhóm này không còn tồn tại");
                                    }
                                } catch(e) {}

                            } else {
                                // SỬA: Truyền thêm n.senderAvatar vào tham số thứ 3
                                startChatWith(n.senderId, n.senderName, n.senderAvatar, n.relatedId); 
                            }
                        };
                        
                        list.appendChild(div);
                    });
                });
        }

        // 4. Hàm đánh dấu tất cả tin nhắn là đã đọc
        async function markAllMsgRead() {
            const batch = db.batch();
            const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('notifications')
                .where('recipientId', '==', currentUser.username)
                .where('type', '==', 'private_message')
                .where('isRead', '==', false)
                .get();

            if (snapshot.empty) {
                showToast("Không có tin mới!");
                return;
            }

            snapshot.forEach(doc => {
                batch.update(doc.ref, { isRead: true });
            });

            await batch.commit();
            showToast("Đã đánh dấu đọc hết!");
        }

        // Hàm trợ giúp: Tạo nội dung thông báo kèm Icon đẹp mắt
        // Hàm trợ giúp: Tạo nội dung thông báo kèm Icon đẹp mắt
        function getNotifContentByType(type, textContent) {
            if (type === 'image') {
                return '<i class="fa-solid fa-image text-blue-400 mr-1"></i> Đã gửi một hình ảnh';
            } else if (type === 'video') {
                return '<i class="fa-solid fa-video text-red-500 mr-1"></i> Đã gửi một video';
            } else if (type === 'audio') {
                return '<i class="fa-solid fa-microphone text-app-gold mr-1"></i> Đã gửi tin nhắn thoại';
            } else {
                // SỬA Ở ĐÂY: Thêm prefix "Đã gửi một tin nhắn" vào trước nội dung
                const preview = textContent.length > 20 ? textContent.substring(0, 20) + '...' : textContent;
                return `Đã gửi một tin nhắn: <span class="text-white font-normal">"${preview}"</span>`;
            }
        }

        // --- HÀM MỚI: Đánh dấu tin nhắn của một người là đã đọc ---
        // --- SỬA: CHỈ ĐÁNH DẤU TIN NHẮN RIÊNG LÀ ĐÃ ĐỌC ---
        async function markPrivateMessagesAsRead(senderId) {
            const badge = document.getElementById(`badge-friend-${senderId}`);
            if (badge) badge.classList.add('hidden');

            if (unreadMap[senderId]) delete unreadMap[senderId];

            try {
                const batch = db.batch();
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('notifications')
                    .where('recipientId', '==', currentUser.username)
                    .where('senderId', '==', senderId)
                    .where('type', '==', 'private_message')
                    .where('community', '==', 'PRIVATE_CHAT') // <--- QUAN TRỌNG: Chỉ chọn tin riêng
                    .where('isRead', '==', false)
                    .get();

                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { isRead: true });
                    });
                    await batch.commit();
                }
            } catch (error) {
                console.error("Lỗi khi đánh dấu đã đọc:", error);
            }
        }

        // --- MỚI: HÀM ĐÁNH DẤU TIN NHẮN NHÓM LÀ ĐÃ ĐỌC ---
        async function markGroupMessagesAsRead(groupId) {
            // Ẩn badge nhóm ngay lập tức
            const badge = document.getElementById(`badge-group-${groupId}`);
            if (badge) badge.classList.add('hidden');

            if (unreadGroupMap[groupId]) delete unreadGroupMap[groupId];

            try {
                const batch = db.batch();
                // Tìm tất cả thông báo thuộc Group này (bất kể ai gửi)
                const snapshot = await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('notifications')
                    .where('recipientId', '==', currentUser.username)
                    .where('relatedParentId', '==', groupId) // ID Nhóm
                    .where('community', '==', 'GROUP_CHAT')  // Chỉ chọn tin nhóm
                    .where('isRead', '==', false)
                    .get();

                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        batch.update(doc.ref, { isRead: true });
                    });
                    await batch.commit();
                }
            } catch (error) {
                console.error("Lỗi đánh dấu đọc nhóm:", error);
            }
        }

        // --- LOGIC CHỌN ĐỐI TƯỢNG XEM (AUDIENCE) ---

        let currentAudience = ['ALL']; // Mặc định là tất cả
        let tempAudienceList = []; // Danh sách bạn bè để render

        // 1. Mở Modal và tải danh sách bạn bè
        async function openAudienceModal() {
            const list = document.getElementById('audienceFriendList');
            list.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-circle-notch fa-spin text-app-gold"></i></div>';
            document.getElementById('audienceModal').classList.remove('hidden');

            // Tận dụng lại logic lấy bạn bè từ hàm prepareFriendsForTagging hoặc loadFriendList
            // Ở đây viết gọn lại để lấy danh sách ID và Tên
            const friends = [];
            try {
                // Lấy list ID bạn bè (Code cũ đã có logic này, ta gom lại)
                const friendIds = new Set();
                const snap1 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user1', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap1.forEach(doc => friendIds.add(doc.data().user2));
                const snap2 = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                    .where('user2', '==', currentUser.username).where('status', '==', 'accepted').get();
                snap2.forEach(doc => friendIds.add(doc.data().user1));

                // Lấy thông tin chi tiết
                for (const fid of Array.from(friendIds)) {
                    const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(fid).get();
                    if (doc.exists) friends.push({ id: fid, ...doc.data() });
                }
                
                tempAudienceList = friends; // Lưu cache
                renderAudienceList();

            } catch (e) {
                console.error(e);
                list.innerHTML = '<p class="text-red-500 text-center text-xs">Lỗi tải danh sách</p>';
            }
        }

        // 2. Render danh sách check-box
        function renderAudienceList() {
            const list = document.getElementById('audienceFriendList');
            list.innerHTML = '';
            
            // Check trạng thái UI cho 2 nút gạt chính
            const isAll = currentAudience.includes('ALL');
            const isSelf = currentAudience.includes('SELF');

            updateOptionUI('ALL', isAll);
            updateOptionUI('SELF', isSelf);

            if (tempAudienceList.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center text-xs italic">Chưa có bạn bè nào.</p>';
                return;
            }

            tempAudienceList.forEach(f => {
                const isChecked = currentAudience.includes(f.id);
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all ${isChecked ? 'bg-blue-600/20 border-blue-500' : 'bg-gray-800/30 border-gray-700 hover:bg-gray-800'}`;
                div.onclick = () => toggleSpecificFriend(f.id);

                let avatar = f.avatarUrl 
                    ? `<img src="${f.avatarUrl}" class="w-8 h-8 rounded-full object-cover">`
                    : `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-xs">${f.displayName.charAt(0)}</div>`;

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        ${avatar}
                        <span class="text-white text-xs font-bold">${f.displayName}</span>
                    </div>
                    <div class="w-5 h-5 rounded border ${isChecked ? 'bg-blue-500 border-blue-500 flex items-center justify-center' : 'border-gray-500'}">
                        ${isChecked ? '<i class="fa-solid fa-check text-white text-[10px]"></i>' : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // 3. Helper update UI nút to
        function updateOptionUI(type, isActive) {
            const div = document.getElementById(`opt-${type}`);
            const check = document.getElementById(`check-${type}`);
            const checkParent = check.parentNode;

            if (isActive) {
                div.className = "flex items-center justify-between p-4 rounded-xl bg-app-gold/10 border border-app-gold cursor-pointer transition-all";
                check.classList.remove('hidden');
                checkParent.className = "w-6 h-6 rounded-full border-2 border-app-gold flex items-center justify-center";
            } else {
                div.className = "flex items-center justify-between p-4 rounded-xl bg-gray-800/50 border border-gray-700 cursor-pointer hover:bg-gray-800 transition-all";
                check.classList.add('hidden');
                checkParent.className = "w-6 h-6 rounded-full border-2 border-gray-600 flex items-center justify-center";
            }
        }

        // 4. Xử lý Logic khi bấm chọn
        function toggleAudienceOption(type) {
            if (type === 'ALL') {
                currentAudience = ['ALL']; // Reset về chỉ ALL
            } else if (type === 'SELF') {
                currentAudience = ['SELF']; // Reset về chỉ SELF
            }
            renderAudienceList(); // Vẽ lại để bỏ chọn các cái khác
        }

        function toggleSpecificFriend(fid) {
            // Nếu đang chọn ALL hoặc SELF thì xóa đi để bắt đầu chọn lẻ
            if (currentAudience.includes('ALL') || currentAudience.includes('SELF')) {
                currentAudience = [];
            }

            const index = currentAudience.indexOf(fid);
            if (index > -1) {
                currentAudience.splice(index, 1); // Bỏ chọn
            } else {
                currentAudience.push(fid); // Chọn thêm
            }

            // Nếu bỏ chọn hết thì quay về mặc định ALL (hoặc SELF tùy bạn, ở đây để ALL cho thân thiện)
            if (currentAudience.length === 0) {
                currentAudience = ['ALL'];
            }

            renderAudienceList();
        }

        // 5. Đóng Modal và cập nhật text hiển thị bên ngoài
        function closeAudienceModal() {
            document.getElementById('audienceModal').classList.add('hidden');
            
            const icon = document.getElementById('audienceIconDisplay');
            const text = document.getElementById('audienceTextDisplay');

            if (currentAudience.includes('ALL')) {
                icon.className = "fa-solid fa-earth-americas text-app-gold text-xs";
                text.textContent = "Tất cả bạn bè";
            } else if (currentAudience.includes('SELF')) {
                icon.className = "fa-solid fa-lock text-red-500 text-xs";
                text.textContent = "Chỉ mình tôi";
            } else {
                icon.className = "fa-solid fa-user-group text-blue-500 text-xs";
                text.textContent = `Cụ thể (${currentAudience.length} người)`;
            }
        }

        // --- LOGIC TẠO NHÓM ---

        async function openCreateGroupModal() {
            // Đóng modal user info tạm thời
            document.getElementById('userInfoModal').classList.add('hidden');
            document.getElementById('createGroupModal').classList.remove('hidden');
            
            const container = document.getElementById('selectMemberContainer');
            container.innerHTML = '<div class="text-center"><i class="fa-solid fa-circle-notch fa-spin text-app-gold"></i></div>';
            
            // Reset
            document.getElementById('newGroupName').value = '';
            selectedGroupMembers = [];

            // Tải danh sách bạn bè (Tận dụng hàm prepareFriendsForTagging hoặc logic tương tự)
            await prepareFriendsForTagging(); // Hàm này đã có trong code cũ của bạn để lấy list friendsForTagging
            
            container.innerHTML = '';
            
            if (friendsForTagging.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-xs">Bạn chưa có bạn bè nào để thêm.</p>';
                return;
            }

            friendsForTagging.forEach(friend => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 rounded-xl border border-gray-700 bg-gray-800/50 cursor-pointer hover:bg-gray-800 transition-all";
                div.onclick = () => toggleSelectMember(div, friend.id);
                
                let avatarHTML = friend.avatar 
                        ? `<img src="${friend.avatar}" class="w-8 h-8 rounded-full object-cover">`
                        : `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-xs">${friend.name.charAt(0)}</div>`;

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        ${avatarHTML}
                        <span class="text-white text-sm font-bold">${friend.name}</span>
                    </div>
                    <div class="w-5 h-5 rounded border border-gray-500 flex items-center justify-center checkbox-icon"></div>
                `;
                container.appendChild(div);
            });
        }

        function toggleSelectMember(div, id) {
            const icon = div.querySelector('.checkbox-icon');
            
            if (selectedGroupMembers.includes(id)) {
                // Bỏ chọn
                selectedGroupMembers = selectedGroupMembers.filter(uid => uid !== id);
                div.classList.remove('border-app-gold', 'bg-app-gold/10');
                icon.className = "w-5 h-5 rounded border border-gray-500 flex items-center justify-center checkbox-icon";
                icon.innerHTML = '';
            } else {
                // Chọn
                selectedGroupMembers.push(id);
                div.classList.add('border-app-gold', 'bg-app-gold/10');
                icon.className = "w-5 h-5 rounded border border-app-gold bg-app-gold flex items-center justify-center checkbox-icon";
                icon.innerHTML = '<i class="fa-solid fa-check text-black text-[10px]"></i>';
            }
        }

        async function confirmCreateGroup() {
            const name = document.getElementById('newGroupName').value.trim();
            if (!name) { showToast("Vui lòng nhập tên nhóm!"); return; }
            if (selectedGroupMembers.length < 1) { showToast("Chọn ít nhất 1 thành viên!"); return; }

            try {
                const members = [currentUser.username, ...selectedGroupMembers];
                
                // Tạo nhóm trong DB
                const docRef = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').add({
                    name: name,
                    adminId: currentUser.username,
                    members: members,
                    createdAt: Date.now(),
                    lastMessage: "Nhóm đã được tạo",
                    lastUpdated: Date.now()
                });

                if (docRef && docRef.id) {
                    const invitePromises = selectedGroupMembers.map(memberId => {
                        return sendNotification(
                            memberId,
                            'private_message', // Loại này chỉ vào hòm thư (theo logic của bạn)
                            null, 
                            null,
                            `${currentUser.displayName} đã thêm bạn vào nhóm mới: "${name}"`,
                            null, 
                            docRef.id, // ID của nhóm vừa tạo
                            'GROUP_CHAT' // Đánh dấu loại để lọc khỏi chuông chính
                        );
                    });
                    
                    await Promise.all(invitePromises);
                }

                document.getElementById('createGroupModal').classList.add('hidden');
                showToast("Tạo nhóm thành công!");
                
                // Mở lại UserInfo để thấy nhóm mới
                openUserInfo();
                
            } catch (e) {
                console.error(e);
                showToast("Lỗi tạo nhóm.");
            }
        }

        function checkIsAdmin(groupData, userId) {
            if (!groupData) return false;
            // 1. Admin "trùm" (Người tạo nhóm - adminId cũ)
            if (groupData.adminId === userId) return true;
            
            // 2. Admin "phó" (Được bầu thêm - mảng admins mới)
            if (groupData.admins && Array.isArray(groupData.admins) && groupData.admins.includes(userId)) {
                return true;
            }
            return false;
        }

        // Biến lưu thông tin nhóm đang quản lý
        let currentGroupData = null;

        // 1. Sửa hàm startGroupChat để cho phép bấm vào Header
    

        // 1. Mở giao diện Cài đặt Nhóm với đồng bộ UI
        async function openGroupSettings(groupId) {
            try {
                const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(groupId).get();
                if (!doc.exists) return;
                
                currentGroupData = { id: doc.id, ...doc.data() };
                
                // Cập nhật giao diện Modal
                const nameInput = document.getElementById('groupSettingNameInput');
                const avtContainer = document.getElementById('groupSettingAvatar');
                
                nameInput.value = currentGroupData.name;

                const amIAdmin = checkIsAdmin(currentGroupData, currentUser.username);
                nameInput.disabled = !amIAdmin;

                if (currentGroupData.avatarUrl) {
                    avtContainer.innerHTML = `<img src="${currentGroupData.avatarUrl}" class="w-full h-full object-cover">`;
                } else {
                    avtContainer.innerHTML = `<i class="fa-solid fa-users"></i>`;
                }

                const deleteBtn = document.getElementById('deleteGroupContainer');
                if (deleteBtn) {
                    // Nếu user hiện tại là Admin (adminId khớp username)
                    if (amIAdmin) {
                        deleteBtn.classList.remove('hidden');
                    } else {
                        deleteBtn.classList.add('hidden');
                    }
                }


                renderCurrentMembers();
                renderFriendsToInvite();

                document.getElementById('groupSettingsModal').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        // --- 1. HÀM KIỂM TRA QUYỀN ADMIN (HỖ TRỢ NHIỀU ADMIN) ---
        

        

        function confirmDeleteGroup() {
            if (!currentGroupData || !currentGroupData.id) return;

            showConfirm("Bạn có chắc chắn muốn giải tán nhóm này? Tất cả tin nhắn và thông báo liên quan trong hòm thư của mọi người sẽ bị mất!", async () => {
                try {
                    const groupId = currentGroupData.id;

                    // --- BƯỚC 1: XÓA SẠCH THÔNG BÁO LIÊN QUAN TRONG HÒM THƯ (Của tất cả mọi người) ---
                    // Truy cập vào kho thông báo chung
                    const notifRef = db.collection('artifacts').doc(appId)
                                    .collection('public').doc('data')
                                    .collection('notifications');

                    // Tìm tất cả thông báo mà "relatedParentId" trùng với ID nhóm đang xóa
                    // (Trong code của bạn, tin nhắn nhóm và lời mời đều lưu GroupID vào relatedParentId)
                    const snapshot = await notifRef.where('relatedParentId', '==', groupId).get();

                    // Thực hiện xóa hàng loạt (Batch) cho nhanh
                    const batch = db.batch();
                    if (!snapshot.empty) {
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        console.log(`Đã xóa ${snapshot.size} thông báo liên quan đến nhóm.`);
                    }

                    // --- BƯỚC 2: XÓA NHÓM (Code cũ) ---
                    await db.collection('artifacts').doc(appId)
                            .collection('public').doc('data')
                            .collection('groups').doc(groupId).delete();

                    // --- BƯỚC 3: CẬP NHẬT GIAO DIỆN ---
                    document.getElementById('groupSettingsModal').classList.add('hidden');
                    if (typeof closeChatModal === 'function') closeChatModal();
                    
                    showToast("Đã giải tán nhóm!");
                    
                    if (typeof openUserInfo === 'function') openUserInfo();

                } catch (e) {
                    console.error("Lỗi xóa nhóm:", e);
                    showToast("Có lỗi xảy ra, vui lòng thử lại.");
                }
            });
        }

        

        // 2. Hiển thị thành viên và nút Kích (Chỉ dành cho Admin)
        // Thay thế hàm renderCurrentMembers cũ bằng hàm này
        // --- HÀM HIỂN THỊ THÀNH VIÊN (BẢN FINAL ĐÃ SỬA LỖI CLICK) ---
        // --- HÀM HIỂN THỊ THÀNH VIÊN (BẢN FINAL - GÁN SỰ KIỆN TRỰC TIẾP) ---
        // --- HÀM HIỂN THỊ THÀNH VIÊN (BẢN FINAL - GÁN SỰ KIỆN TRỰC TIẾP) ---
        // --- HÀM HIỂN THỊ THÀNH VIÊN (PHIÊN BẢN DEBUG CLICK) ---
        async function renderCurrentMembers() {
            const container = document.getElementById('currentGroupMemberList');
            container.innerHTML = ''; 
            
            // Cập nhật số lượng
            const memberCountEl = document.getElementById('groupMemberCountLabel');
            if(memberCountEl && currentGroupData) {
                memberCountEl.textContent = `Thành viên (${currentGroupData.members.length})`;
            }

            for (const uid of currentGroupData.members) {
                try {
                    const userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(uid).get();
                    
                    if (userDoc.exists) {
                        const u = userDoc.data();

                        // Kiểm tra quyền
                        // Đảm bảo hàm checkIsAdmin tồn tại, nếu không thì so sánh thủ công
                        const isMemberAdmin = (typeof checkIsAdmin === 'function') 
                                            ? checkIsAdmin(currentGroupData, uid) 
                                            : (currentGroupData.adminId === uid || (currentGroupData.admins && currentGroupData.admins.includes(uid)));
                        
                        const amIAdmin = (typeof checkIsAdmin === 'function') 
                                    ? checkIsAdmin(currentGroupData, currentUser.username)
                                    : (currentGroupData.adminId === currentUser.username || (currentGroupData.admins && currentGroupData.admins.includes(currentUser.username)));
                        
                        // Tạo thẻ DIV bao quanh
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-2 bg-white/5 rounded-xl border border-white/5 mb-2 relative";

                        // Avatar & Tên
                        let avatarHTML;
                        if (u.avatarUrl) {
                            avatarHTML = `<img src="${u.avatarUrl}" class="w-8 h-8 rounded-full object-cover border border-gray-700 pointer-events-none">`;
                        } else {
                            avatarHTML = `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-white text-xs font-bold border border-gray-700 pointer-events-none">${u.displayName.charAt(0).toUpperCase()}</div>`;
                        }

                        div.innerHTML = `
                            ${avatarHTML}
                            <div class="flex flex-col min-w-0 pointer-events-none">
                                <span class="text-xs text-white font-bold truncate">${u.displayName} ${uid === currentUser.username ? '(Bạn)' : ''}</span>
                                <span class="text-[8px] text-gray-500 font-mono">@${uid}</span>
                            </div>
                            ${isMemberAdmin ? '<span class="text-[8px] bg-yellow-500/20 text-yellow-500 px-1.5 py-0.5 rounded-md ml-2 font-black tracking-tighter pointer-events-none border border-yellow-500/30">ADMIN</span>' : ''}
                        `;

                        // --- CONTAINER NÚT (Đẩy sang phải) ---
                        const btnContainer = document.createElement('div');
                        btnContainer.className = "ml-auto flex items-center gap-2 relative z-50";

                        // === NÚT BẦU ADMIN (Vương miện) ===
                        if (amIAdmin && !isMemberAdmin) {
                            const promoteBtn = document.createElement('button');
                            promoteBtn.className = "w-8 h-8 flex items-center justify-center bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500 hover:text-white transition-all cursor-pointer relative z-50";
                            promoteBtn.innerHTML = '<i class="fa-solid fa-crown"></i>';
                            promoteBtn.type = "button";
                            
                            promoteBtn.onclick = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                // [QUAN TRỌNG] GỌI HÀM MỞ MODAL
                                openPromoteModal(currentGroupData.id, uid, u.displayName);
                            };
                            btnContainer.appendChild(promoteBtn);
                        }

                        // === NÚT KÍCH ===
                        if (amIAdmin && uid !== currentUser.username) {
                            const kickBtn = document.createElement('button');
                            kickBtn.className = "text-red-500 text-[10px] font-bold px-2 py-1 bg-red-500/10 rounded-lg hover:bg-red-500 hover:text-white transition-all cursor-pointer";
                            kickBtn.innerText = "KÍCH";
                            kickBtn.type = "button";
                            kickBtn.style.pointerEvents = "auto";
                            kickBtn.style.zIndex = "100";

                            kickBtn.onclick = (e) => {
                                console.log("Đã Click nút Kích");
                                e.preventDefault();
                                e.stopPropagation();
                                kickMember(uid, u.displayName);
                            };
                            
                            btnContainer.appendChild(kickBtn);
                        }

                        div.appendChild(btnContainer);

                        // Sự kiện click dòng (Xem profile)
                        div.onclick = (e) => {
                            // Nếu bấm vào nút thì không mở profile
                            if (e.target.closest('button') || btnContainer.contains(e.target)) return;
                            navigateToProfileFromGroup(uid);
                        };

                        container.appendChild(div);
                    }
                } catch (err) {
                    console.error("Lỗi tải thành viên:", uid, err);
                }
            }
        }

        // --- HÀM MỚI: Tắt hết Chat & Setting rồi mở Profile ---
        function navigateToProfileFromGroup(userId) {
            // 1. Đóng Modal Cài đặt nhóm
            document.getElementById('groupSettingsModal').classList.add('hidden');
            
            // 2. Đóng Modal Chat chính
            closeChatModal(); 
            
            // 3. Đóng luôn cả Modal Danh sách bạn bè (nếu đang mở từ đó)
            document.getElementById('userInfoModal').classList.add('hidden');

            // 4. Gọi hàm mở Profile (Hàm này đã có sẵn logic: 
            //    - Nếu là mình -> Mở Album mình (toggleProfile)
            //    - Nếu là người khác -> Mở Public Profile (viewUserProfile)
            viewUserProfile(userId);
        }

        // 3. Hàm Kích thành viên
        // Hàm xử lý Kích
        // Hàm xử lý Kích - ĐÃ SỬA LỖI CẬP NHẬT DANH SÁCH MỜI
        async function kickMember(userId, userName) {
            showConfirm(`Bạn có chắc muốn mời ${userName} ra khỏi nhóm?`, async () => {
                try {
                    // 1. Xóa trên Database
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                        .doc(currentGroupData.id).update({
                            members: firebase.firestore.FieldValue.arrayRemove(userId)
                        });

                    // 2. [QUAN TRỌNG] Cập nhật dữ liệu cục bộ ngay lập tức
                    // Loại bỏ ID người bị kick ra khỏi mảng members hiện tại trong bộ nhớ
                    if (currentGroupData && currentGroupData.members) {
                        currentGroupData.members = currentGroupData.members.filter(id => id !== userId);
                    }
                    
                    showToast(`Đã kích ${userName}`);

                    // 3. Vẽ lại CẢ HAI danh sách
                    renderCurrentMembers();   // Cập nhật danh sách thành viên (Xóa người đó đi)
                    renderFriendsToInvite();  // Cập nhật danh sách mời (Hiện người đó lại để mời tiếp)
                    
                } catch (e) {
                    console.error(e);
                    showToast("Lỗi khi kích thành viên");
                }
            });
        }

        // 4. Cập nhật tên nhóm (Đồng bộ trực tiếp lên khung chat)
        async function updateGroupName() {
            const btn = document.querySelector('button[onclick="updateGroupName()"]');
            const input = document.getElementById('groupSettingNameInput');
            const newName = input.value.trim();
            
            if (!newName || newName === currentGroupData.name) return;
            
            // Thay đổi trạng thái nút để người dùng biết đang xử lý nhưng không làm mất giao diện
            const originalText = btn.textContent;
            btn.textContent = "...";
            btn.disabled = true;
            
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                    .doc(currentGroupData.id).update({ name: newName });
                
                showToast("Đã cập nhật tên nhóm");
            } catch(e) { 
                showToast("Lỗi cập nhật"); 
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // 5. Cập nhật Avatar nhóm (Đồng bộ trực tiếp lên khung chat)
        // Đổi ảnh nhóm
        // Thay thế hoàn toàn hàm handleGroupAvatarSelect cũ
        async function handleGroupAvatarSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const loadingBtn = document.querySelector('#groupSettingAvatar');
            // Lưu lại nội dung cũ để lỡ lỗi thì rollback (tuỳ chọn)
            const originalContent = loadingBtn.innerHTML; 
            
            // Bật hiệu ứng loading
            loadingBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-white text-3xl"></i>';

            try {
                const base64 = await compressImageFile(file);
                
                // Cập nhật lên Database
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                    .doc(currentGroupData.id).update({ avatarUrl: base64 });
                
                // --- [FIX LỖI 1]: CẬP NHẬT LẠI GIAO DIỆN NGAY LẬP TỨC ---
                // Gán ảnh mới vào ngay, thay thế cho icon loading
                loadingBtn.innerHTML = `<img src="${base64}" class="w-full h-full object-cover">`;
                
                showToast("Đã cập nhật ảnh nhóm thành công");
            } catch (e) { 
                showToast("Lỗi tải ảnh");
                console.error(e);
                // Nếu lỗi thì trả về icon cũ
                loadingBtn.innerHTML = `<i class="fa-solid fa-users"></i>`;
            }
        }

        // 4. Hiển thị bạn bè có thể mời
        async function renderFriendsToInvite() {
            const container = document.getElementById('addMemberToGroupList');

            
            await prepareFriendsForTagging(); // Tận dụng hàm cũ để lấy friendsForTagging
            
            const notInGroup = friendsForTagging.filter(f => !currentGroupData.members.includes(f.id));
            
            if (notInGroup.length === 0) {
                container.innerHTML = '<p class="text-[10px] text-gray-600 italic text-center">Tất cả bạn bè đã ở trong nhóm</p>';
                return;
            }

            notInGroup.forEach(f => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 bg-white/5 rounded-xl hover:bg-app-gold/10 transition-colors cursor-pointer group";
                let avatarHTML;
                if (f.avatar) {
                    avatarHTML = `<img src="${f.avatar}" class="w-7 h-7 rounded-full object-cover">`;
                } else {
                    // Logic: 1 chữ cái đầu + nền xám (bg-gray-700)
                    const char = f.name ? f.name.charAt(0).toUpperCase() : '?';
                    avatarHTML = `<div class="w-7 h-7 rounded-full bg-gray-700 flex items-center justify-center text-white text-[10px] font-bold">${char}</div>`;
                }

                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        ${avatarHTML}
                        <span class="text-xs text-gray-300 group-hover:text-white font-bold">${f.name}</span>
                    </div>
                    <button onclick="inviteToGroup('${f.id}')" class="text-[10px] text-app-gold font-bold">THÊM</button>
                `;

                

                container.appendChild(div);
            });
        }

        

        function triggerGroupAvatarChange() { document.getElementById('groupAvatarInput').click(); }


        // Thay thế hoàn toàn hàm inviteToGroup cũ
        async function inviteToGroup(friendId) {
            try {
                // 1. Cập nhật Database trước
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups')
                    .doc(currentGroupData.id).update({
                        members: firebase.firestore.FieldValue.arrayUnion(friendId)
                    });
                

                sendNotification(
                    friendId,
                    'private_message', // Loại này chỉ vào hòm thư (theo logic của bạn)
                    null,
                    null,
                    `${currentUser.displayName} đã thêm bạn vào nhóm: "${currentGroupData.name}"`,
                    null,
                    currentGroupData.id, // ID của nhóm
                    'GROUP_CHAT' // Đánh dấu loại để lọc khỏi chuông chính
                );
                // --- [FIX LỖI 2]: KIỂM TRA TRƯỚC KHI PUSH ---
                // Chỉ thêm vào danh sách hiển thị nếu ID này CHƯA có trong mảng
                // Điều này ngăn chặn việc thêm trùng nếu Realtime update chạy nhanh hơn code này
                if (!currentGroupData.members.includes(friendId)) {
                    currentGroupData.members.push(friendId);
                }

                showToast("Đã thêm thành viên");
                
                // Render lại giao diện
                renderCurrentMembers();
                renderFriendsToInvite();
            } catch (e) {
                console.error(e);
                showToast("Lỗi khi thêm thành viên: " + e.message);
            }
        }
        
                // --- LOGIC TAG TRONG CHAT NHÓM ---
        let groupMembersForTagging = []; 

        // Hàm chuẩn bị dữ liệu thành viên để tag (Gọi khi vào nhóm)
        async function prepareGroupTaggingData() {
            groupMembersForTagging = [];
            if (!currentGroupData || !currentGroupData.members) return;

            // Lấy thông tin chi tiết các thành viên
            for (const memberId of currentGroupData.members) {
                if (memberId === currentUser.username) continue; // Không tag chính mình

                // Thử tìm trong cache bạn bè trước cho nhanh
                let memberName = memberId;
                let memberAvatar = null;
                
                // Query nhanh user
                try {
                    const doc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(memberId).get();
                    if(doc.exists) {
                        memberName = doc.data().displayName;
                        memberAvatar = doc.data().avatarUrl;
                    }
                } catch(e) {}

                groupMembersForTagging.push({
                    id: memberId,
                    name: memberName,
                    avatar: memberAvatar
                });
            }
        }

        // Hàm render gợi ý
        function renderChatGroupTagSuggestions(list) {
            const box = document.getElementById('chatGroupTagSuggestions');
            box.innerHTML = '';

            list.forEach(user => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 hover:bg-white/10 cursor-pointer border-b border-gray-800 last:border-0 transition-colors bg-gray-900";
                
                let avatarHTML = user.avatar 
                    ? `<img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover">`
                    : `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white">${user.name.charAt(0)}</div>`;

                div.innerHTML = `
                    ${avatarHTML}
                    <div class="flex-1 min-w-0">
                        <p class="text-white text-sm font-bold truncate">${user.name}</p>
                        <p class="text-gray-500 text-[10px]">@${user.id}</p>
                    </div>
                `;

                div.onclick = () => selectGroupTag(user.id);
                box.appendChild(div);
            });
        }

        // Hàm chọn tag
        function selectGroupTag(userId) {
            const input = document.getElementById('chatInput');
            const val = input.value;
            const cursorPos = input.selectionStart;
            const textBeforeCursor = val.slice(0, cursorPos);
            
            const lastAtPos = textBeforeCursor.lastIndexOf('@');
            const newVal = val.slice(0, lastAtPos) + `@${userId} ` + val.slice(cursorPos);
            
            input.value = newVal;
            document.getElementById('chatGroupTagSuggestions').classList.add('hidden');
            input.focus();
        }

        // Lắng nghe sự kiện nhập liệu (@)
        document.getElementById('chatInput').addEventListener('input', function() {
            const suggestBox = document.getElementById('chatGroupTagSuggestions');

            if (currentUser && currentUser.isGuest) {
                suggestBox.classList.add('hidden');
                return;
            }
            
            // ĐIỀU KIỆN 1: Chỉ hoạt động trong Group Chat
            if (typeof currentChatType === 'undefined' || currentChatType !== 'group') {
                suggestBox.classList.add('hidden');
                return;
            }

            const val = this.value;
            const cursorPos = this.selectionStart;
            const textBeforeCursor = val.slice(0, cursorPos);
            const match = textBeforeCursor.match(/@(\w*)$/);

            if (match) {
                const query = match[1].toLowerCase();
                // Lọc thành viên khớp tên hoặc ID
                const matches = groupMembersForTagging.filter(m => 
                    m.id.toLowerCase().includes(query) || 
                    m.name.toLowerCase().includes(query)
                );

                if (matches.length > 0) {
                    renderChatGroupTagSuggestions(matches);
                    suggestBox.classList.remove('hidden');
                } else {
                    suggestBox.classList.add('hidden');
                }
            } else {
                suggestBox.classList.add('hidden');
            }
        });

        // Biến toàn cục lưu danh sách bạn bè realtime
        let realtimeFriendList = new Set();

        function monitorFriendshipRealtime() {
            if (!currentUser) return;

            const handleFriendSnapshot = (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    // Xác định ID của người kia trong mối quan hệ
                    const friendId = (data.user1 === currentUser.username) ? data.user2 : data.user1;

                    if (change.type === 'added' || change.type === 'modified') {
                        if (data.status === 'accepted') {
                            realtimeFriendList.add(friendId);
                        } else {
                            // Nếu status không còn là accepted (bị unfriend/block), xóa khỏi list
                            realtimeFriendList.delete(friendId);
                            removePostsOfNonFriends(friendId); // Gọi hàm xóa bài ngay lập tức
                        }
                    }
                    if (change.type === 'removed') {
                        realtimeFriendList.delete(friendId);
                        removePostsOfNonFriends(friendId); // Gọi hàm xóa bài ngay lập tức
                    }
                });
            };

            // Lắng nghe 2 chiều (mình là user1 hoặc mình là user2)
            db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('relationships')
                .where('user1', '==', currentUser.username)
                .onSnapshot(handleFriendSnapshot);

            db.collection('artifacts').doc(appId)
                .collection('public').doc('data').collection('relationships')
                .where('user2', '==', currentUser.username)
                .onSnapshot(handleFriendSnapshot);
        }

        // Hàm quét và xóa bài viết trên màn hình nếu không còn là bạn
        function removePostsOfNonFriends(targetUserId) {
            // Chỉ áp dụng khi đang ở tab FriendZone
            // (Nếu bạn muốn xóa cả ở Home thì bỏ điều kiện check tab đi)
            const friendFeed = document.getElementById('friendFeedList');
            
            if (friendFeed) {
                // Tìm tất cả bài viết của người vừa unfriend đang hiện trên màn hình
                const postsToRemove = friendFeed.querySelectorAll(`div[data-author-id="${targetUserId}"]`);
                
                postsToRemove.forEach(post => {
                    // Hiệu ứng mờ dần trước khi xóa cho mượt
                    post.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                    post.style.opacity = "0";
                    post.style.transform = "scale(0.9)";
                    
                    setTimeout(() => {
                        post.remove();
                        // Nếu danh sách trống thì hiện thông báo trống
                        if (friendFeed.children.length === 0) {
                            friendFeed.innerHTML = '<div class="text-center text-gray-500 mt-10">Chưa có bài viết nào từ bạn bè</div>';
                        }
                    }, 500);
                });
                
                if (postsToRemove.length > 0) {
                    console.log(`Đã tự động ẩn ${postsToRemove.length} bài viết của ${targetUserId} do thay đổi quan hệ.`);
                }
            }
        }

        // --- LOGIC TỰ ĐỘNG XÓA BÀI/ĐÓNG MODAL KHI HỦY KẾT BẠN (REALTIME CLEANUP) ---

        let relationshipUnsub1 = null;
        let relationshipUnsub2 = null;

        function startRelationshipMonitor() {
            if (!currentUser || currentUser.isGuest) return;

            // Reset nếu đã có kết nối cũ
            if (relationshipUnsub1) relationshipUnsub1();
            if (relationshipUnsub2) relationshipUnsub2();

            // Chiều 1: Mình là user1
            relationshipUnsub1 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                .where('user1', '==', currentUser.username)
                .onSnapshot(snapshot => handleRelChange(snapshot));

            // Chiều 2: Mình là user2
            relationshipUnsub2 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                .where('user2', '==', currentUser.username)
                .onSnapshot(snapshot => handleRelChange(snapshot));
        }

        function handleRelChange(snapshot) {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                // Xác định ID của người kia
                const otherUser = (data.user1 === currentUser.username) ? data.user2 : data.user1;
                
                // Nếu quan hệ bị XÓA (unfriend) hoặc chuyển sang trạng thái KHÔNG PHẢI ACCEPTED (block/pending)
                if (change.type === 'removed' || (change.type === 'modified' && data.status !== 'accepted')) {
                    // Thực hiện hành động "dọn dẹp" ngay lập tức
                    handleImmediateUnfriend(otherUser);
                }
            });
        }

        function handleImmediateUnfriend(targetUserId) {
            console.log(`Phát hiện hủy kết bạn với ${targetUserId}. Đang dọn dẹp giao diện...`);

            // 1. XÓA BÀI VIẾT TRÊN FEED (Friend Zone & Home)
            const selectors = [
                `#friendFeedList div[data-author-id="${targetUserId}"]`, // Bài trong FriendZone
                
            ];

            selectors.forEach(sel => {
                const posts = document.querySelectorAll(sel);
                posts.forEach(post => {
                    // Hiệu ứng biến mất
                    post.style.transition = 'all 0.3s ease';
                    post.style.opacity = '0';
                    post.style.transform = 'scale(0.9)';
                    setTimeout(() => post.remove(), 300);
                });
            });

            // 2. KIỂM TRA MODAL BÀI VIẾT CHI TIẾT (Single Post Modal)
            // Nếu đang mở bài viết của người đó -> Đóng ngay
            const singleModal = document.getElementById('singlePostModal');
            if (!singleModal.classList.contains('hidden')) {
                // Kiểm tra xem bài đang mở có phải của người bị unfriend không
                // (Chúng ta check trong cache recentPostsCache hoặc DOM hiện tại)
                const container = document.getElementById('singlePostContainer');
                const postDiv = container.querySelector(`div[data-author-id="${targetUserId}"]`);
                
                if (postDiv) {
                    closeSinglePost();
                    showToast("⚠️ Bài viết không còn khả dụng (Mất kết nối bạn bè).");
                }
            }

            // 3. KIỂM TRA MODAL BÌNH LUẬN (Comment Modal)
            // Nếu đang mở bình luận của bài viết thuộc về người đó -> Đóng ngay
            const commentModal = document.getElementById('commentModal');
            if (!commentModal.classList.contains('hidden') && currentPostIdForComments) {
                // Tìm bài viết gốc trong cache để xem tác giả là ai
                const post = recentPostsCache.find(p => p.id === currentPostIdForComments);
                if (post && post.authorId === targetUserId) {
                    closeComments();
                    // Nếu Single Post cũng đang mở bên dưới thì đóng luôn
                    closeSinglePost(); 
                    showToast("⚠️ Không thể xem bình luận (Mất kết nối bạn bè).");
                }
            }
            
            // 4. KIỂM TRA ALBUM BẠN BÈ
            const fzAlbumModal = document.getElementById('friendZoneAlbumModal');
            if (!fzAlbumModal.classList.contains('hidden')) {
                // Nếu tiêu đề album có chứa tên người đó hoặc logic nào đó, ở đây ta đóng luôn cho an toàn
                closeFriendZoneAlbum();
            }
        }


        // --- LOGIC XỬ LÝ MENU BÌNH LUẬN ---

        // 1. Bật/Tắt Menu
        function toggleCommentMenu(commentId) {
            const menu = document.getElementById(`menu-options-${commentId}`);
            if (menu) {
                // Đóng tất cả các menu khác đang mở trước
                document.querySelectorAll('.comment-menu').forEach(el => {
                    if(el.id !== `menu-options-${commentId}`) el.classList.add('hidden');
                });
                menu.classList.toggle('hidden');
            }
        }

        // 2. Sao chép nội dung
        // --- LOGIC SAO CHÉP MẠNH MẼ HƠN ---

        function copyCommentText(text) {
            // 1. Đóng menu ngay lập tức
            document.querySelectorAll('.comment-menu').forEach(el => el.classList.add('hidden'));

            // 2. Thử cách hiện đại trước
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Đã sao chép nội dung!");
                }).catch(() => {
                    // Nếu lỗi, chuyển sang cách thủ công
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // Nếu trình duyệt không hỗ trợ API mới -> dùng cách thủ công
                fallbackCopyTextToClipboard(text);
            }
        }

        // Hàm dự phòng (Dùng textarea ẩn để copy)
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Đặt ở vị trí cố định để không làm nhảy giao diện
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0"; // Ẩn đi

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                if(successful) {
                    showToast("Đã sao chép nội dung!");
                } else {
                    showToast("Không thể sao chép.");
                }
            } catch (err) {
                console.error('Lỗi sao chép thủ công:', err);
                showToast("Trình duyệt chặn sao chép.");
            }

            document.body.removeChild(textArea);
        }

        // 3. Xóa bình luận
        function deleteCommentAction(commentId, postId) {
            showConfirm("Bạn muốn xóa bình luận này?", async () => {
                try {
                    // [THAY ĐỔI QUAN TRỌNG] 
                    // Không dùng .delete() nữa mà dùng .update() để giữ lại ID cho thông báo hoạt động
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').doc(commentId).update({
                        isDeleted: true,          // Đánh dấu đã xóa
                        deletedBy: currentUser.username,
                        text: "Bình luận đã bị xóa", // Ghi đè nội dung (để bảo mật)
                        isEdited: false,          // Reset cờ đã sửa
                        likes: []                 // Xóa hết lượt like cũ
                    });

                    // [LƯU Ý] Không giảm commentCount của bài viết nữa 
                    // vì bình luận này vẫn hiển thị (dạng placeholder) trong danh sách.
                    
                    showToast("Đã xóa bình luận.");
                } catch (e) {
                    console.error(e);
                    showToast("Lỗi khi xóa!");
                }
            });
        }

        // --- HÀM XỬ LÝ MENU MỚI (FIX LỖI BỊ CHÌM) ---
        window.toggleCommentMenu = function(event, commentId) {
            event.stopPropagation(); // Ngăn sự kiện click lan ra ngoài

            // 1. Đóng menu cũ nếu đang mở
            const oldMenu = document.getElementById('active-context-menu');
            if (oldMenu) oldMenu.remove();

            // 2. Lấy nội dung các nút chức năng từ div ẩn
            const contentDiv = document.getElementById(`menu-content-${commentId}`);
            if (!contentDiv) return;

            // 3. Tạo menu mới gắn trực tiếp vào body
            const menu = document.createElement('div');
            menu.id = 'active-context-menu';
            
            // Style cho menu (Dùng fixed z-[9999] để nổi lên trên cùng)
            menu.className = "fixed z-[9999] bg-[#1f2937] border border-[#374151] rounded-xl p-1 flex flex-col shadow-2xl min-w-[120px] animate-fade-in";
            
            // Copy nội dung nút vào menu mới
            menu.innerHTML = contentDiv.innerHTML;

            // Style lại cho các nút bên trong đẹp hơn
            const buttons = menu.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.className = "text-left px-3 py-2 text-[11px] font-bold text-gray-300 hover:bg-[#374151] hover:text-white rounded-lg transition-colors flex items-center w-full";
                // Riêng nút xóa cho màu đỏ
                if(btn.innerHTML.includes('Xóa')) {
                    btn.classList.add('text-red-400', 'hover:bg-red-500/10');
                }
            });

            // 4. Tính toán vị trí (Hiển thị ngay tại nút bấm)
            const rect = event.currentTarget.getBoundingClientRect();
            
            // Căn vị trí: Top = đáy nút + 5px
            menu.style.top = (rect.bottom + 5) + 'px';
            
            // Căn trái/phải thông minh (Tránh bị tràn màn hình)
            if (rect.right > window.innerWidth - 130) {
                menu.style.left = (rect.right - 120) + 'px'; // Căn lề phải nút
            } else {
                menu.style.left = rect.left + 'px'; // Căn lề trái nút
            }

            document.body.appendChild(menu);

            // 5. Click ra ngoài thì đóng menu
            // Delay 0ms để tránh sự kiện click hiện tại kích hoạt đóng luôn
            setTimeout(() => {
                const closeMenu = () => {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        };

        // 4. Chuyển sang chế độ Sửa
        function enableEditComment(commentId, currentText) {
            const textDiv = document.getElementById(`comment-content-${commentId}`);
            const menu = document.getElementById(`menu-options-${commentId}`);
            if(menu) menu.classList.add('hidden'); // Ẩn menu đi

            if (textDiv) {
                // Lưu lại text gốc để nếu hủy thì restore
                textDiv.dataset.original = currentText;
                
                textDiv.innerHTML = `
                    <div class="edit-input-wrapper animate-fade-in">
                        <input type="text" id="edit-input-${commentId}" value="${currentText.replace(/"/g, '&quot;')}" class="flex-1 bg-black border border-gray-600 rounded-xl px-3 py-1 text-xs text-white outline-none focus:border-app-gold">
                        <button onclick="saveEditedComment('${commentId}')" class="bg-app-gold text-black px-3 rounded-xl text-[10px] font-bold hover:scale-105"><i class="fa-solid fa-check"></i></button>
                        <button onclick="cancelEditComment('${commentId}')" class="bg-gray-700 text-white px-3 rounded-xl text-[10px] font-bold hover:scale-105"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `;
                // Focus vào ô input
                setTimeout(() => {
                    const inp = document.getElementById(`edit-input-${commentId}`);
                    if(inp) inp.focus();
                }, 100);
            }
        }

        // 5. Hủy Sửa
        function cancelEditComment(commentId) {
            const textDiv = document.getElementById(`comment-content-${commentId}`);
            if (textDiv && textDiv.dataset.original) {
                // Format lại text gốc (bao gồm cả highlight tag @mention nếu có)
                // Ở đây để đơn giản ta hiển thị text gốc, logic renderSingleComment sẽ tự format lại đẹp khi refresh, 
                // nhưng để mượt ta dùng lại hàm formatCommentText
                // Lưu ý: isFriendZone cần lấy từ ngữ cảnh, tạm thời mặc định false hoặc true tùy logic, 
                // nhưng textDiv.dataset.original là raw text.
                textDiv.innerHTML = formatCommentText(textDiv.dataset.original, false); 
            }
        }

        // 6. Lưu Sửa
        async function saveEditedComment(commentId) {
            const input = document.getElementById(`edit-input-${commentId}`);
            const newText = input.value.trim();

            if (!newText) {
                showToast("Bình luận không được để trống!");
                return;
            }

            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('comments').doc(commentId).update({
                    text: newText,
                    isEdited: true // Đánh dấu là đã chỉnh sửa
                });
                showToast("Đã cập nhật!");
                // UI sẽ tự cập nhật nhờ onSnapshot
            } catch (e) {
                console.error(e);
                showToast("Lỗi cập nhật!");
                cancelEditComment(commentId);
            }
        }

        // --- LOGIC MỚI: Xử lý xem ai đã đọc (Nhóm) ---
        
        // --- HÀM XỬ LÝ XEM CHI TIẾT NGƯỜI ĐÃ ĐỌC (MỚI) ---
        async function showGroupSeenDetails(msgId) {
            const modal = document.getElementById('seenByModal');
            const listDiv = document.getElementById('seenByList');
            modal.classList.remove('hidden');
            listDiv.innerHTML = '<div class="text-center py-4 text-gray-500 text-xs"><i class="fa-solid fa-circle-notch fa-spin"></i> Đang tải...</div>';

            try {
                // Lấy dữ liệu tin nhắn mới nhất để có danh sách readBy chính xác
                let collectionRef;
                if (currentChatType === 'group') {
                    collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('groups').doc(currentChatRelationId).collection('messages');
                } else {
                    listDiv.innerHTML = '<div class="text-center py-4 text-gray-500 text-xs">Chỉ hỗ trợ nhóm chat</div>';
                    return;
                }

                const msgDoc = await collectionRef.doc(msgId).get();
                if (!msgDoc.exists) return;

                const readBy = msgDoc.data().readBy || [];
                const viewers = readBy.filter(uid => uid !== currentUser.username); // Loại bỏ chính mình

                if (viewers.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-4 text-gray-500 text-xs">Chưa có ai khác xem</div>';
                    return;
                }

                let html = '';
                // Tải thông tin từng người
                for (const uid of viewers) {
                    // Lấy thông tin user từ cache hoặc DB (ở đây query trực tiếp cho đơn giản)
                    const userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(uid).get();
                    if (userDoc.exists) {
                        const u = userDoc.data();
                        // Logic hiển thị Avatar đồng bộ (DIV xám nếu không có ảnh)
                        let avatarHTML;
                        if (u.avatarUrl) {
                            avatarHTML = `<img src="${u.avatarUrl}" class="w-8 h-8 rounded-full object-cover">`;
                        } else {
                            avatarHTML = `<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-white text-xs font-bold">${u.displayName.charAt(0).toUpperCase()}</div>`;
                        }

                        html += `
                            <div class="flex items-center gap-3 p-2 hover:bg-white/5 rounded-xl cursor-pointer" onclick="document.getElementById('seenByModal').classList.add('hidden'); viewUserProfile('${uid}')">
                                ${avatarHTML}
                                <span class="text-white text-xs font-bold">${u.displayName}</span>
                            </div>`;
                    }
                }
                listDiv.innerHTML = html;

            } catch (e) {
                console.error(e);
                listDiv.innerHTML = '<div class="text-center py-4 text-red-500 text-xs">Lỗi tải danh sách</div>';
            }
        }


        // HÀM PHỤ: XỬ LÝ VIỆC THAY ĐỔI GIAO DIỆN (Tách ra cho gọn)
        function applyUserSyncToDOM(uid, userData) {
            if (!userData) return;

            // 1. Cập nhật TÊN
            const nameEls = document.querySelectorAll(`.sync-group-name-${uid}`);
            nameEls.forEach(el => {
                if (el.textContent !== userData.displayName) {
                    el.textContent = userData.displayName;
                }
            });

            // 2. Cập nhật AVATAR
            const avatarEls = document.querySelectorAll(`.sync-group-avatar-${uid}`);
            avatarEls.forEach(el => {
                // Kiểm tra xem dữ liệu mới là Ảnh hay Chữ
                const hasNewImage = !!userData.avatarUrl;

                // Xử lý thay thế phần tử DOM
                if (hasNewImage) {
                    // --- TRƯỜNG HỢP 1: NGƯỜI DÙNG CÓ ẢNH ---
                    if (el.tagName === 'IMG') {
                        // Nếu đang là thẻ IMG rồi thì chỉ thay src (đỡ giật)
                        if (el.src !== userData.avatarUrl) el.src = userData.avatarUrl;
                    } else {
                        // Nếu đang là thẻ DIV (chữ) -> Thay bằng thẻ IMG
                        const newImg = document.createElement('img');
                        newImg.src = userData.avatarUrl;
                        // Copy lại đúng bộ class gốc (bỏ các class định dạng riêng của div chữ)
                        newImg.className = "w-4 h-4 rounded-full object-cover border border-gray-600"; 
                        newImg.classList.add(`sync-group-avatar-${uid}`); // Thêm lại class định danh
                        el.parentNode.replaceChild(newImg, el);
                    }
                } else {
                    // --- TRƯỜNG HỢP 2: NGƯỜI DÙNG KHÔNG CÓ ẢNH (DÙNG CHỮ CÁI) ---
                    const char = (userData.displayName || "?").charAt(0).toUpperCase();
                    
                    if (el.tagName === 'DIV' && !el.querySelector('img')) {
                        // Nếu đang là DIV rồi -> Chỉ thay chữ
                        el.textContent = char;
                    } else {
                        // Nếu đang là IMG -> Thay bằng thẻ DIV
                        const newDiv = document.createElement('div');
                        // Set cứng bộ class chuẩn cho avatar chữ (giống code gốc của bạn)
                        newDiv.className = "w-4 h-4 rounded-full bg-gray-700 flex items-center justify-center text-white text-[8px] font-bold border border-gray-600";
                        newDiv.classList.add(`sync-group-avatar-${uid}`); // Thêm lại class định danh
                        newDiv.textContent = char;
                        el.parentNode.replaceChild(newDiv, el);
                    }
                }
            });
        }

        // Hàm hiển thị thông báo
       function showToast(message) {
            const toast = document.getElementById('toast');
            // Lưu ý: HTML mới dùng id là 'toastMessage', không phải 'toastMsg'
            const msgEl = document.getElementById('toastMessage'); 
            
            if(!toast || !msgEl) return;
            
            msgEl.textContent = message;

            // SỬA ĐOẠN NÀY: Thay class trượt ngang cũ bằng class trượt dọc mới
            // 1. Hiện lên: Xóa class ẩn (mờ và thụt lên trên)
            toast.classList.remove('opacity-0', '-translate-y-10'); 

            // 2. Tự ẩn sau 3 giây: Thêm lại class ẩn
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-10');
            }, 3000);
        }




        async function openSimpleFriendList() {
            const modal = document.getElementById('simpleFriendListModal');
            const container = document.getElementById('simpleFriendListContent');
            const countText = document.getElementById('simpleFriendCount');

            modal.classList.remove('hidden');
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 opacity-50">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl text-app-gold mb-3"></i>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-white">Đang tìm kiếm...</p>
                </div>
            `;

            try {
                // 1. Lấy danh sách bạn bè đã 'accepted'
                const friendsMap = new Map();
                const [snap1, snap2] = await Promise.all([
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                        .where('user1', '==', currentUser.username).where('status', '==', 'accepted').get(),
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('relationships')
                        .where('user2', '==', currentUser.username).where('status', '==', 'accepted').get()
                ]);

                snap1.forEach(doc => friendsMap.set(doc.data().user2, true));
                snap2.forEach(doc => friendsMap.set(doc.data().user1, true));

                const friendIds = Array.from(friendsMap.keys());
                countText.textContent = `${friendIds.length} người bạn`;
                container.innerHTML = '';

                if (friendIds.length === 0) {
                    container.innerHTML = '<div class="text-center py-20 text-gray-500 text-xs italic">Chưa có bạn bè nào được hiển thị</div>';
                    return;
                }

                // 2. Tải thông tin chi tiết từng người
                for (const fid of friendIds) {
                    const userDoc = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(fid).get();
                    if (userDoc.exists) {
                        const u = userDoc.data();
                        const friendDiv = document.createElement('div');
                        
                        // Thiết kế item tối giản, không có nút Mess
                        friendDiv.className = "flex items-center gap-4 p-4 bg-white/[0.03] rounded-[1.5rem] border border-white/5 hover:border-app-gold/30 transition-all cursor-pointer active:scale-[0.98]";
                        friendDiv.onclick = () => {
                            closeSimpleFriendList();
                            viewUserProfile(fid); // Xem profile người đó
                        };

                        const avatarHTML = u.avatarUrl 
                            ? `<img src="${u.avatarUrl}" class="w-12 h-12 rounded-full object-cover border-2 border-white/10 shadow-lg">`
                            : `<div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center text-white font-bold text-lg">${u.displayName.charAt(0).toUpperCase()}</div>`;

                        friendDiv.innerHTML = `
                            ${avatarHTML}
                            <div class="flex-1 min-w-0">
                                <p class="text-white font-bold text-base truncate">${u.displayName}</p>
                                <p class="text-gray-500 text-[10px] uppercase tracking-wider font-bold">@${fid}</p>
                            </div>
                            <i class="fa-solid fa-chevron-right text-white/20 text-xs pr-2"></i>
                        `;
                        container.appendChild(friendDiv);
                    }
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-center text-red-400 py-10 text-xs">Không thể tải danh sách. Vui lòng thử lại.</p>';
            }
        }

        function closeSimpleFriendList() {
            document.getElementById('simpleFriendListModal').classList.add('hidden');
        }


        // --- HÀM MỚI: CHỈ XỬ LÝ GIAO DIỆN KHI TÀI KHOẢN ĐÃ XÓA ---
        function renderDeletedUserUI(uid) {
            // 1. Đổi tên thành "Tài khoản đã xóa"
            const nameEls = document.querySelectorAll(`.sync-group-name-${uid}`);
            nameEls.forEach(el => {
                el.textContent = "Tài khoản đã xóa";
                el.style.fontStyle = "italic";
                el.style.color = "#9ca3af"; // Màu xám
                el.style.fontWeight = "normal"; 
            });

            // 2. Làm mờ Avatar (Không xóa thẻ để giữ khung)
            const avatarEls = document.querySelectorAll(`.sync-group-avatar-${uid}`);
            avatarEls.forEach(el => {
                if (el.tagName === 'IMG') {
                    // Nếu là ảnh: đổi src sang ảnh xám
                    el.src = "https://ui-avatars.com/api/?name=Del&background=374151&color=fff";
                    el.style.filter = "grayscale(100%) opacity(0.7)";
                } else {
                    // Nếu là div: đổi nội dung
                    el.innerHTML = '<i class="fa-solid fa-user-xmark"></i>';
                    el.style.backgroundColor = "#374151";
                    el.style.color = "#9ca3af";
                }
            });
        }


        // --- HÀM DATABASE (PHIÊN BẢN GỬI TIN HỆ THỐNG CHUẨN) ---
        async function promoteMemberToAdminDB(groupId, targetUserId, targetUserName) {
            try {
                showToast("Đang xử lý...");
                
                const groupRef = db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('groups').doc(groupId);
                
                const doc = await groupRef.get();
                if (!doc.exists) return;
                
                const gData = doc.data();
                let newAdmins = gData.admins || []; 
                
                if (gData.adminId && !newAdmins.includes(gData.adminId)) newAdmins.push(gData.adminId);
                if (newAdmins.includes(targetUserId)) {
                    showToast("Thành viên này đã là Admin rồi!");
                    return;
                }

                newAdmins.push(targetUserId);

                // 1. CẬP NHẬT QUYỀN ADMIN
                await groupRef.update({ admins: newAdmins });

                const currentUserDisplay = currentUser.displayName || currentUser.username;

                // 2. GỬI THÔNG BÁO VÀO HÒM THƯ (Inbox)
                await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('notifications').add({
                        recipientId: targetUserId,
                        senderId: 'SYSTEM',           // Dùng SYSTEM để hiện avatar hệ thống hoặc ẩn
                        senderName: "Thông báo nhóm",
                        senderAvatar: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png', // Icon cái chuông vàng
                        
                        extraInfo: `Bạn đã được thăng chức làm Quản trị viên nhóm ${gData.name}`,
                        content: `Bạn đã được bầu làm Quản trị viên.`,
                        
                        type: 'private_message', 
                        community: 'GROUP_CHAT',
                        relatedId: "SYSTEM_MSG",
                        relatedParentId: groupId,
                        timestamp: Date.now(),
                        isRead: false
                    });

                // 3. GỬI TIN NHẮN HỆ THỐNG VÀO CHAT (Quan trọng: type='system')
                await groupRef.collection('messages').add({
                    senderId: 'SYSTEM',
                    senderName: 'System',
                    avatarUrl: '',
                    
                    // Nội dung tin nhắn
                    content: `${currentUserDisplay} đã bầu ${targetUserName} làm Quản trị viên.`,
                    
                    timestamp: Date.now(),
                    type: 'system', // <--- QUAN TRỌNG: Đánh dấu đây là tin hệ thống
                    isRead: []
                });

                showToast(`Đã bầu ${targetUserName} làm Admin!`);
                
                // Tải lại giao diện
                if(typeof openGroupSettings === 'function') openGroupSettings(groupId);

            } catch (error) {
                console.error("Lỗi:", error);
                showToast("Có lỗi xảy ra", "error");
            }
        }


        // --- HÀM TỰ ĐỘNG RANDOM ADMIN KHI NGƯỜI DÙNG XÓA TÀI KHOẢN ---
        // (Gọi hàm này TRƯỚC KHI xóa doc user)
        // --- HÀM TỰ ĐỘNG RANDOM ADMIN (PHIÊN BẢN QUÉT CẢ DATA CŨ VÀ MỚI) ---
        async function handleGroupsBeforeDelete(userId) {
            // console.log("--- BẮT ĐẦU QUY TRÌNH CHUYỂN QUYỀN ADMIN ---"); 
            
            try {
                const groupsRef = db.collection('artifacts').doc(appId)
                    .collection('public').doc('data').collection('groups');

                // 1. TÌM KIẾM THEO CÁCH MỚI (Mảng admins)
                const q1 = await groupsRef.where('admins', 'array-contains', userId).get();

                // 2. TÌM KIẾM THEO CÁCH CŨ (Trường adminId) - Dành cho các nhóm tạo từ xưa
                const q2 = await groupsRef.where('adminId', '==', userId).get();

                // Gộp kết quả lại và lọc trùng (Dùng Map để đảm bảo mỗi nhóm chỉ xử lý 1 lần)
                const groupsMap = new Map();
                q1.forEach(doc => groupsMap.set(doc.id, doc));
                q2.forEach(doc => groupsMap.set(doc.id, doc));

                if (groupsMap.size === 0) {
                    console.log("Không tìm thấy nhóm nào cần chuyển quyền.");
                    return;
                }

                // Hiện thông báo để bạn biết code đang chạy (DEBUG)
                // alert(`Hệ thống tìm thấy ${groupsMap.size} nhóm cần xử lý admin mới.`);

                // 3. XỬ LÝ TỪNG NHÓM
                const processPromises = Array.from(groupsMap.values()).map(async (groupDoc) => {
                    const gData = groupDoc.data();
                    let currentAdmins = gData.admins || [];
                    
                    // Đảm bảo adminId cũ cũng có trong danh sách để xử lý
                    if (gData.adminId && !currentAdmins.includes(gData.adminId)) {
                        currentAdmins.push(gData.adminId);
                    }

                    // Loại bỏ người đang xóa tài khoản
                    currentAdmins = currentAdmins.filter(id => id !== userId);

                    // TRƯỜNG HỢP A: Vẫn còn Admin khác (Phó nhóm)
                    if (currentAdmins.length > 0) {
                        // Lấy đại người đầu tiên trong danh sách còn lại làm Trưởng nhóm chính (adminId)
                        const nextMainAdmin = currentAdmins[0];
                        return groupDoc.ref.update({ 
                            admins: currentAdmins,
                            adminId: nextMainAdmin
                        });
                    }

                    // TRƯỜNG HỢP B: KHÔNG CÒN ADMIN NÀO (Phải random thành viên thường)
                    else {
                        // Lấy danh sách thành viên còn lại
                        const remainingMembers = (gData.members || []).filter(id => id !== userId);

                        if (remainingMembers.length > 0) {
                            // Random chọn
                            const randomIndex = Math.floor(Math.random() * remainingMembers.length);
                            const newAdminId = remainingMembers[randomIndex];

                            // Lấy tên
                            let newAdminName = newAdminId;
                            const userDoc = await db.collection('artifacts').doc(appId)
                                .collection('public').doc('data').collection('users').doc(newAdminId).get();
                            if (userDoc.exists) newAdminName = userDoc.data().displayName;

                            // Update Database
                            await groupDoc.ref.update({
                                admins: [newAdminId],
                                adminId: newAdminId 
                            });

                            // Gửi tin nhắn hệ thống
                            await groupDoc.ref.collection('messages').add({
                                senderId: 'SYSTEM',
                                senderName: 'System',
                                avatarUrl: '',
                                content: `Trưởng nhóm đã rời đi. Hệ thống đã chọn ngẫu nhiên ${newAdminName} làm Trưởng nhóm mới.`,
                                timestamp: Date.now(),
                                type: 'system',
                                isRead: []
                            });

                            // Gửi thông báo Notification
                            await db.collection('artifacts').doc(appId)
                                .collection('public').doc('data').collection('notifications').add({
                                    recipientId: newAdminId,
                                    senderId: 'SYSTEM',
                                    senderName: "Hệ thống",
                                    senderAvatar: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png',
                                    extraInfo: `Bạn đã được thăng chức làm Quản trị viên nhóm ${gData.name}`,
                                    content: `Bạn đã được bầu làm Quản trị viên.`,
                                    type: 'private_message', 
                                    community: 'GROUP_CHAT',
                                    relatedId: "SYSTEM_MSG",
                                    relatedParentId: groupDoc.id,
                                    timestamp: Date.now(),
                                    isRead: false
                                });
                        } else {
                            // Nhóm trống rỗng -> Xóa danh sách admin
                            await groupDoc.ref.update({ admins: [], adminId: '' });
                        }
                    }
                });

                await Promise.all(processPromises);
                console.log("Đã xử lý xong toàn bộ nhóm.");

            } catch (error) {
                console.error("Lỗi xử lý nhóm:", error);
                alert("Lỗi khi chuyển quyền nhóm: " + error.message);
            }
        }

        async function deleteNotification(event, notifId) {
            event.stopPropagation(); // Ngăn click lan ra ngoài (để không mở bài viết)
            if (!currentUser) return;
            
            // Hiệu ứng UX: Ẩn ngay lập tức dòng thông báo đó
            // Tìm thẻ cha có class 'group' để ẩn
            const el = event.target.closest('.group'); 
            if(el) el.style.display = 'none';

            try {
                await db.collection('artifacts').doc(appId)
                    .collection('public').doc('data')
                    .collection('notifications').doc(notifId).delete();
            } catch (e) {
                console.error(e);
                showToast("Lỗi khi xóa");
                if(el) el.style.display = 'flex'; // Hiện lại nếu lỗi
            }
        }

        // 2. Xóa TẤT CẢ thông báo CHÍNH (Trừ FriendZone & Tin nhắn)
        async function deleteAllMainNotifications() {
            if (!currentUser) return;
            showConfirm("Bạn có chắc muốn XÓA HẾT thông báo chính?", async () => {
                try {
                    showToast("Đang xóa...");
                    const snapshot = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('notifications')
                        .where('recipientId', '==', currentUser.username)
                        .get();
                    
                    const batch = db.batch();
                    let count = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        // Lọc đúng logic hiển thị: Không phải FZ và không phải Private Message
                        if (data.community !== 'FRIEND_ZONE' && data.type !== 'private_message') {
                            batch.delete(doc.ref);
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        await batch.commit();
                        showToast(`Đã xóa sạch ${count} thông báo!`);
                    } else {
                        showToast("Không có thông báo nào để xóa.");
                    }
                } catch (e) {
                    console.error(e);
                    showToast("Có lỗi xảy ra!");
                }
            });
        }

        // 3. Xóa TẤT CẢ thông báo FRIEND ZONE
        async function deleteAllFZNotifications() {
            if (!currentUser) return;
            showConfirm("Xóa sạch thông báo Friend Zone?", async () => {
                try {
                    showToast("Đang dọn dẹp Friend Zone...");
                    const snapshot = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('notifications')
                        .where('recipientId', '==', currentUser.username)
                        .where('community', '==', 'FRIEND_ZONE')
                        .get();
                    
                    const batch = db.batch();
                    if (snapshot.empty) {
                        showToast("Hòm thư đã trống sẵn rồi!");
                        return;
                    }
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showToast("Đã xóa hết thông báo Friend Zone!");
                } catch (e) {
                    console.error(e);
                    showToast("Lỗi khi xóa");
                }
            });
        }

        // 4. Xóa TẤT CẢ thông báo TIN NHẮN (Message)
        async function deleteAllMsgNotifications() {
            if (!currentUser) return;
            showConfirm("Xóa sạch danh sách thông báo tin nhắn?", async () => {
                try {
                    showToast("Đang xóa...");
                    const snapshot = await db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('notifications')
                        .where('recipientId', '==', currentUser.username)
                        .where('type', '==', 'private_message') // Chỉ xóa tin nhắn
                        .get();
                    
                    const batch = db.batch();
                    if (snapshot.empty) {
                        showToast("Không có tin nhắn nào để xóa!");
                        return;
                    }
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    showToast("Đã dọn sạch hộp thư!");
                } catch (e) {
                    console.error(e);
                    showToast("Lỗi khi xóa");
                }
            });
        }

        // --- HÀM THỰC HIỆN BẦU ADMIN (DÁN XUỐNG CUỐI FILE) ---
        // --- HÀM BẦU ADMIN (PHIÊN BẢN DEBUG) ---
        
                // Hàm xử lý thêm thành viên vào nhóm (Có gửi thông báo)
        

        // --- FIX REAL-TIME: ĐỒNG BỘ AVATAR & TÊN CHO GROUP CHAT ---
        // --- KHAI BÁO BIẾN TOÀN CỤC ĐỂ LƯU DATA (CACHE) ---
        // Giúp hiển thị ngay lập tức mà không cần chờ tải lại từ mạng
        window.globalUserCache = window.globalUserCache || {}; 
        window.globalUserListeners = window.globalUserListeners || {};

        // HÀM CHÍNH: KÍCH HOẠT ĐỒNG BỘ
        function activateRealtimeUserSync() {
            // 1. Tìm tất cả ID cần đồng bộ đang hiện trên màn hình
            const syncElements = document.querySelectorAll('[class*="sync-group-"]');
            const userIds = new Set();

            syncElements.forEach(el => {
                // Regex tìm ID sau chuỗi sync-group-avatar- hoặc sync-group-name-
                const match = el.className.match(/sync-group-(?:avatar|name)-([a-zA-Z0-9_]+)/);
                if (match) userIds.add(match[1]);
            });

            // 2. Duyệt qua từng User ID
            userIds.forEach(uid => {
                // BƯỚC QUAN TRỌNG: Nếu đã có dữ liệu trong Cache -> Cập nhật giao diện NGAY LẬP TỨC
                // (Đây là bước sửa lỗi avatar cũ hiện lại khi render lại tin nhắn)
                if (window.globalUserCache[uid]) {
                    applyUserSyncToDOM(uid, window.globalUserCache[uid]);
                }

                // 3. Nếu chưa lắng nghe (Listener) thì mới tạo Listener mới
                if (!window.globalUserListeners[uid]) {
                    window.globalUserListeners[uid] = db.collection('artifacts').doc(appId)
                        .collection('public').doc('data').collection('users').doc(uid)
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                const userData = doc.data();
                                
                                // Lưu vào Cache để dùng cho lần sau
                                window.globalUserCache[uid] = userData;
                                
                                // Cập nhật giao diện
                                applyUserSyncToDOM(uid, userData);
                            } else {
                                // [MỚI]: CHỈ CHẠY KHI TÀI KHOẢN KHÔNG TỒN TẠI (ĐÃ XÓA)
                                
                                // 1. Lưu trạng thái xóa vào cache
                                window.globalUserCache[uid] = { isDeleted: true };
                                
                                // 2. Gọi hàm đổi tên và avatar thành xám
                                renderDeletedUserUI(uid);
                            }
                        }, error => {
                            console.log("Lỗi sync user:", uid);
                        });
                }
            });
        }


        

    </script>
</body>
</html>